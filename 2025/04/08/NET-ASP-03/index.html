<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ASP.NET学习记录-03-中间件管道 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET学习记录-03-中间件管道">
<meta property="og:url" content="https://alsl521.github.io/2025/04/08/NET-ASP-03/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-04-08T11:21:33.000Z">
<meta property="article:modified_time" content="2025-04-10T07:50:52.050Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASP.NET学习记录-03-中间件管道",
  "url": "https://alsl521.github.io/2025/04/08/NET-ASP-03/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-04-08T11:21:33.000Z",
  "dateModified": "2025-04-10T07:50:52.050Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/04/08/NET-ASP-03/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ASP.NET学习记录-03-中间件管道',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ASP.NET学习记录-03-中间件管道</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ASP.NET学习记录-03-中间件管道</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-08T11:21:33.000Z" title="发表于 2025-04-08 19:21:33">2025-04-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-10T07:50:52.050Z" title="更新于 2025-04-10 15:50:52">2025-04-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、中间件管道简介"><a href="#1、中间件管道简介" class="headerlink" title="1、中间件管道简介"></a>1、中间件管道简介</h1><p>在 C# ASP.NET Core 中，<strong>中间件管道</strong>是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：</p>
<hr>
<h2 id="1-中间件管道的基本概念"><a href="#1-中间件管道的基本概念" class="headerlink" title="1. 中间件管道的基本概念"></a>1. <strong>中间件管道的基本概念</strong></h2><ul>
<li><p>中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：</p>
<ul>
<li><p>对请求进行预处理（如日志、身份验证）。</p>
<ul>
<li><p>调用下一个中间件（通过<code> next()</code>），或直接终止处理（短路）。</p>
</li>
<li><p>对响应进行后处理（如修改响应头、记录耗时）。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。</p>
</li>
</ul>
<hr>
<h2 id="2-管道的工作模式：1-n-然后-n-1"><a href="#2-管道的工作模式：1-n-然后-n-1" class="headerlink" title="2. 管道的工作模式：1-n 然后 n-1"></a>2. <strong>管道的工作模式：1-n 然后 n-1</strong></h2><ul>
<li><p>请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。</p>
</li>
<li><p>响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。</p>
<p>示例</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Middleware One: Request Start → Middleware Two: Request Start → Middleware Three: Request Start</span><br><span class="line">→ 终结点处理 →</span><br><span class="line">Middleware Three: Response End → Middleware Two: Response End → Middleware One: Response End</span><br></pre></td></tr></table></figure>

<p>这种模式被称为“俄罗斯套娃”模型  。</p>
</li>
</ul>
<hr>
<h2 id="3-如何配置中间件管道"><a href="#3-如何配置中间件管道" class="headerlink" title="3. 如何配置中间件管道"></a>3. <strong>如何配置中间件管道</strong></h2><p>在 <code>Startup.Configure</code> 方法中通过 <code>IApplicationBuilder</code> 注册中间件，常用方法包括：</p>
<ul>
<li><p><code>Use()</code>：添加可调用下一个中间件的组件（需调用<code>await next()</code>）  。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt; &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Request进入&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(); <span class="comment">// 调用下一个中间件</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Response返回&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Run()</code>：添加终端中间件（不调用<code>next()</code>，直接响应）  。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.Run(<span class="keyword">async</span> context =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Map()</code>：根据请求路径创建分支管道 。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.Map(<span class="string">&quot;/api&quot;</span>, branch =&gt; &#123;</span><br><span class="line">    branch.UseMiddleware&lt;ApiMiddleware&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="4-中间件的关键特性"><a href="#4-中间件的关键特性" class="headerlink" title="4. 中间件的关键特性"></a>4. <strong>中间件的关键特性</strong></h2><ul>
<li><p>短路机制：中间件可选择不调用<code> next()</code> ，直接返回响应（如身份验证失败时）。</p>
</li>
<li><p>依赖注入：可通过构造函数注入服务（如数据库上下文） 。</p>
</li>
<li><p>可重用性：中间件可封装为类，通过<code>UseMiddleware&lt;T&gt;()</code>注册。</p>
</li>
<li><p>在使用ASP. NET时，若要修改请求头，则要在返回响应之前修改。</p>
</li>
</ul>
<hr>
<h2 id="5-典型应用场景"><a href="#5-典型应用场景" class="headerlink" title="5. 典型应用场景"></a>5. <strong>典型应用场景</strong></h2><ul>
<li><p>内置中间件：ASP.NET Core 提供多种内置中间件，如静态文件处理、MVC 路由、错误页面等。</p>
</li>
<li><p>自定义逻辑：例如记录请求日志、跨域处理（CORS）、缓存等 。</p>
</li>
<li><p>跨平台支持：借助 .NET Core，中间件管道可在 Windows、Linux、macOS 上运行 。</p>
</li>
</ul>
<hr>
<h2 id="示例代码（自定义中间件）"><a href="#示例代码（自定义中间件）" class="headerlink" title="示例代码（自定义中间件）"></a>示例代码（自定义中间件）</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoggingMiddleware</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingMiddleware</span>(<span class="params">RequestDelegate next</span>)</span> =&gt; _next = next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;请求路径：<span class="subst">&#123;context.Request.Path&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> _next(context); <span class="comment">// 调用下一个中间件</span></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;响应状态码：<span class="subst">&#123;context.Response.StatusCode&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 注册中间件</span></span><br><span class="line">app.UseMiddleware&lt;LoggingMiddleware&gt;();</span><br></pre></td></tr></table></figure>

<hr>
<p>通过中间件管道，开发者可以灵活构建高效、模块化的 Web 应用，满足不同场景的需求。更多实现细节可参考 ASP.NET Core 文档。</p>
<h1 id="2、中间件管道实现-USE（最小API）"><a href="#2、中间件管道实现-USE（最小API）" class="headerlink" title="2、中间件管道实现-USE（最小API）"></a>2、中间件管道实现-USE（最小API）</h1><p><code>app.Use</code>通常实现常规中间件组件和短路中间件组件</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409193404430.png" alt="image-20250409193404430"></p>
<h1 id="3、短路"><a href="#3、短路" class="headerlink" title="3、短路"></a>3、短路</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">下列代码会报错，因为“next”没有被调用，(context, next)这种写法的前提是“next”被调用</span></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line"><span class="comment">app.Use(async (context, next) =&gt;</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    await context.Response.WriteAsync(&quot;Middleware #2: Before calling next\r\n&quot;);</span></span><br><span class="line"><span class="comment">    //await next(context);</span></span><br><span class="line"><span class="comment">    await context.Response.WriteAsync(&quot;Middleware #2: After calling next\r\n&quot;);</span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409194506514.png" alt="image-20250409194506514"></p>
<h1 id="4、中间件管道实现-RUN（最小API）"><a href="#4、中间件管道实现-RUN（最小API）" class="headerlink" title="4、中间件管道实现-RUN（最小API）"></a>4、中间件管道实现-RUN（最小API）</h1><p><code>app.RUN</code>不传递<code>context</code>到下一个请求委托，仅实现短路中间件组件</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Run(<span class="keyword">async</span> (context) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Processed.\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409195114522.png" alt="image-20250409195114522"></p>
<h1 id="5、中间件管道创建分支-MAP"><a href="#5、中间件管道创建分支-MAP" class="headerlink" title="5、中间件管道创建分支-MAP"></a>5、中间件管道创建分支-MAP</h1><p><img src="/NET-ASP-03/image-20250409195550566.png" alt="image-20250409195550566"></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//“http://localhost:5200/employees/sss”也会跳转到该分支，</span></span><br><span class="line">app.Map(<span class="string">&quot;/employees&quot;</span>, (appBuilder) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: Before calling next\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> next(context);</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: After calling next\r\n&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: Before calling next\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> next(context);</span><br><span class="line">        <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: After calling next\r\n&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<center>
<figure>
<img src="NET-ASP-03/image-20250409195650454.png" style="zoom:80%"/>
<img src="NET-ASP-03/image-20250409195858542.png" style="zoom:80%" />
</figure>
</center>
# 6、中间件管道创建分支-MapWhen

<p><code>MapWhen</code>可以通过访问<code>Http</code>上下文对象，从而在复杂条件下创建中间件管道分支。当<code>MapWhen</code>中的结果为真时将从分支运行，否则在主流程中运行。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.MapWhen((context) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> context.Request.Path.StartsWithSegments(<span class="string">&quot;/employees&quot;</span>) &amp;&amp; context.Request.Query.ContainsKey(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">    (appBuilder) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: Before calling next\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next(context);</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: After calling next\r\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: Before calling next\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next(context);</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: After calling next\r\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409203949864.png" alt="image-20250409203949864"></p>
<p><img src="/NET-ASP-03/image-20250409203958244.png" alt="image-20250409203958244"></p>
<p><img src="/NET-ASP-03/image-20250409204018899.png" alt="image-20250409204018899"></p>
<h1 id="7、运行分支后回到主流程-UseWhen"><a href="#7、运行分支后回到主流程-UseWhen" class="headerlink" title="7、运行分支后回到主流程-UseWhen"></a>7、运行分支后回到主流程-UseWhen</h1><p><code>UseWhen</code>与<code>MapWhen</code>类似，但当分支运行完后，会接着回到主流程中继续运行，直到运行到最终端点。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #1: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.UseWhen((context) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> context.Request.Path.StartsWithSegments(<span class="string">&quot;/employees&quot;</span>) &amp;&amp; context.Request.Query.ContainsKey(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">    (appBuilder) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: Before calling next\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next(context);</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #5: After calling next\r\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        appBuilder.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: Before calling next\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next(context);</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #6: After calling next\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #2: After calling next\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: Before calling next\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;Middleware #3: After calling next\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409205123417.png" alt="image-20250409205123417"></p>
<p><img src="/NET-ASP-03/image-20250409205246172.png" alt="image-20250409205246172"></p>
<h1 id="8、横切-类似于Aspect"><a href="#8、横切-类似于Aspect" class="headerlink" title="8、横切-类似于Aspect"></a>8、横切-类似于Aspect</h1><p>使用自定义中间件</p>
<h2 id="1-MyCustomExceptionHandler-cs"><a href="#1-MyCustomExceptionHandler-cs" class="headerlink" title="1.MyCustomExceptionHandler.cs"></a>1.<code>MyCustomExceptionHandler.cs</code></h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.MiddleComponents</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyCustomExceptionHandler</span> : <span class="title">IMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context, RequestDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                context.Response.ContentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">                <span class="keyword">await</span> next(context);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) </span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;h2&gt;Error:&lt;/h2&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">$&quot;&lt;p&gt;<span class="subst">&#123;ex.Message&#125;</span>&lt;/p&gt;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-MyCustomMiddleware-cs"><a href="#2-MyCustomMiddleware-cs" class="headerlink" title="2.MyCustomMiddleware.cs"></a>2.<code>MyCustomMiddleware.cs</code></h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.MiddleComponents</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyCustomMiddleware</span> : <span class="title">IMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context, RequestDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;My custom middleware: Before calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next(context);</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;My custom middleware: After calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Program-cs"><a href="#3-Program-cs" class="headerlink" title="3.Program.cs"></a>3.<code>Program.cs</code></h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApp.MiddleComponents;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line">builder.Services.AddTransient&lt;MyCustomMiddleware&gt;();</span><br><span class="line">builder.Services.AddTransient&lt;MyCustomExceptionHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.UseMiddleware&lt;MyCustomExceptionHandler&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #1</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    context.Response.ContentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #1: Before calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #1: After calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.UseMiddleware&lt;MyCustomMiddleware&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #2</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (context, next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(<span class="string">&quot;Exception for testing.&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #2: Before calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #2: After calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware #3</span></span><br><span class="line">app.Use(<span class="keyword">async</span> (HttpContext context, RequestDelegate next) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #3: Before calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> next(context);</span><br><span class="line">    <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;&lt;p&gt;Middleware #3: After calling next&lt;/p&gt;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-03/image-20250409212156579.png" alt="image-20250409212156579"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/04/08/NET-ASP-03/">https://alsl521.github.io/2025/04/08/NET-ASP-03/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-03-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">ASP.NET学习记录-03-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-03-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-03-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/14/NET-ASP-06/" title="ASP.NET学习记录-06-最小API结果生产"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="info-item-2">ASP.NET学习记录-06-最小API结果生产</div></div><div class="info-2"><div class="info-item-1">本次学习基础代码如下： Employee.cs 12345678910111213141516171819202122232425262728293031323334353637383940414243444546using System.ComponentModel.DataAnnotations;namespace WebApi.Models&#123;    /// &lt;summary&gt;    /// 员工实体类    /// &lt;/summary&gt;    public class Employee    &#123;        /// &lt;summary&gt;        /// 员工唯一标识符        /// &lt;/summary&gt;        public int Id &#123; get; set; &#125;        /// &lt;summary&gt;        /// 员工姓名        /// &lt;/summary&gt;        public string Name...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a><a class="pagination-related" href="/2025/04/14/NET-ASP-07/" title="ASP.NET学习记录-07-代码组织和依赖注入"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="info-item-2">ASP.NET学习记录-07-代码组织和依赖注入</div></div><div class="info-2"><div class="info-item-1">1、代码组织在 ASP.NET 中，“代码组织”指的是如何结构化代码，以提高可维护性、可读性和可扩展性。这涉及多个方面，包括项目结构、分层架构、模块化设计和最佳实践。  项目结构  在 ASP.NET Core 中，一个典型的项目组织方式如下： 12345678910/MyApp ├── Controllers/      // 处理 HTTP 请求的控制器 ├── Models/           // 数据模型 ├── Views/            // Razor 视图（如果使用 MVC） ├── Services/         // 业务逻辑层 ├── Middleware/       // 自定义中间件 ├── Data/             // 数据访问层（EF Core、存储库等） ├── wwwroot/          // 静态文件（CSS、JS、Images） ├── Program.cs        // 应用程序启动入口 ├── appsettings.json  //...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1、中间件管道简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1. 中间件管道的基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%AE%A1%E9%81%93%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%EF%BC%9A1-n-%E7%84%B6%E5%90%8E-n-1"><span class="toc-number">1.2.</span> <span class="toc-text">2. 管道的工作模式：1-n 然后 n-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93"><span class="toc-number">1.3.</span> <span class="toc-text">3. 如何配置中间件管道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7"><span class="toc-number">1.4.</span> <span class="toc-text">4. 中间件的关键特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.</span> <span class="toc-text">5. 典型应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%EF%BC%88%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">示例代码（自定义中间件）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93%E5%AE%9E%E7%8E%B0-USE%EF%BC%88%E6%9C%80%E5%B0%8FAPI%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">2、中间件管道实现-USE（最小API）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%9F%AD%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">3、短路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93%E5%AE%9E%E7%8E%B0-RUN%EF%BC%88%E6%9C%80%E5%B0%8FAPI%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">4、中间件管道实现-RUN（最小API）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%A1%E9%81%93%E5%88%9B%E5%BB%BA%E5%88%86%E6%94%AF-MAP"><span class="toc-number">5.</span> <span class="toc-text">5、中间件管道创建分支-MAP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81%E8%BF%90%E8%A1%8C%E5%88%86%E6%94%AF%E5%90%8E%E5%9B%9E%E5%88%B0%E4%B8%BB%E6%B5%81%E7%A8%8B-UseWhen"><span class="toc-number">6.</span> <span class="toc-text">7、运行分支后回到主流程-UseWhen</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81%E6%A8%AA%E5%88%87-%E7%B1%BB%E4%BC%BC%E4%BA%8EAspect"><span class="toc-number">7.</span> <span class="toc-text">8、横切-类似于Aspect</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MyCustomExceptionHandler-cs"><span class="toc-number">7.1.</span> <span class="toc-text">1.MyCustomExceptionHandler.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-MyCustomMiddleware-cs"><span class="toc-number">7.2.</span> <span class="toc-text">2.MyCustomMiddleware.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Program-cs"><span class="toc-number">7.3.</span> <span class="toc-text">3.Program.cs</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-12/" title="ASP.NET学习记录-12-实践2-使用MySQL数据库">ASP.NET学习记录-12-实践2-使用MySQL数据库</a><time datetime="2025-04-18T08:11:21.000Z" title="发表于 2025-04-18 16:11:21">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-11/" title="ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API">ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API</a><time datetime="2025-04-18T02:13:44.000Z" title="发表于 2025-04-18 10:13:44">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/16/NET-ASP-10/" title="ASP.NET学习记录-10-过滤">ASP.NET学习记录-10-过滤</a><time datetime="2025-04-16T12:02:16.000Z" title="发表于 2025-04-16 20:02:16">2025-04-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/15/Software/" title="记录必备软件">记录必备软件</a><time datetime="2025-04-15T11:29:21.000Z" title="发表于 2025-04-15 19:29:21">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>