<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ASP.NET学习记录-07-代码组织和依赖注入 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET学习记录-07-代码组织和依赖注入">
<meta property="og:url" content="https://alsl521.github.io/2025/04/14/NET-ASP-07/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-04-14T11:25:07.000Z">
<meta property="article:modified_time" content="2025-04-14T12:21:46.135Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASP.NET学习记录-07-代码组织和依赖注入",
  "url": "https://alsl521.github.io/2025/04/14/NET-ASP-07/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-04-14T11:25:07.000Z",
  "dateModified": "2025-04-14T12:21:46.135Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/04/14/NET-ASP-07/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ASP.NET学习记录-07-代码组织和依赖注入',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ASP.NET学习记录-07-代码组织和依赖注入</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ASP.NET学习记录-07-代码组织和依赖注入</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-14T11:25:07.000Z" title="发表于 2025-04-14 19:25:07">2025-04-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-14T12:21:46.135Z" title="更新于 2025-04-14 20:21:46">2025-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、代码组织"><a href="#1、代码组织" class="headerlink" title="1、代码组织"></a>1、代码组织</h1><p>在 ASP.NET 中，“代码组织”指的是如何<strong>结构化代码</strong>，以提高可维护性、可读性和可扩展性。这涉及多个方面，包括项目结构、分层架构、模块化设计和最佳实践。</p>
<ol>
<li><strong>项目结构</strong></li>
</ol>
<p>在 ASP.NET Core 中，一个典型的项目组织方式如下：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/MyApp</span><br><span class="line"> ├── Controllers/      // 处理 HTTP 请求的控制器</span><br><span class="line"> ├── Models/           // 数据模型</span><br><span class="line"> ├── Views/            // Razor 视图（如果使用 MVC）</span><br><span class="line"> ├── Services/         // 业务逻辑层</span><br><span class="line"> ├── Middleware/       // 自定义中间件</span><br><span class="line"> ├── Data/             // 数据访问层（EF Core、存储库等）</span><br><span class="line"> ├── wwwroot/          // 静态文件（CSS、JS、Images）</span><br><span class="line"> ├── Program.cs        // 应用程序启动入口</span><br><span class="line"> ├── appsettings.json  // 应用程序配置</span><br></pre></td></tr></table></figure>

<p>这种组织方式确保了<strong>职责分离</strong>，使得代码更易管理。</p>
<ol start="2">
<li><strong>分层架构</strong></li>
</ol>
<p>ASP.NET 应用通常采用分层架构，以实现清晰的代码结构：</p>
<ul>
<li><strong>表现层（Controllers, Views）</strong>：负责接收用户请求并呈现数据。</li>
<li><strong>业务逻辑层（Services）</strong>：处理应用核心逻辑，如验证、计算等。</li>
<li><strong>数据访问层（Repositories, Data）</strong>：与数据库交互，封装数据操作。</li>
</ul>
<p>分层架构的好处： ✅ 提高代码的<strong>可维护性</strong> ✅ 便于单独测试每一层 ✅ 支持不同的数据存储（SQL、NoSQL）</p>
<ol start="3">
<li><strong>模块化设计</strong></li>
</ol>
<p><strong>模块化</strong>意味着将功能拆分为独立的组件，比如：</p>
<ul>
<li><strong>中间件（Middleware）</strong>：封装 HTTP 请求处理，如身份验证、日志记录等。</li>
<li><strong>依赖注入（Dependency Injection）</strong>：通过 <code>IServiceCollection</code> 进行依赖管理，减少耦合。</li>
<li><strong>自定义服务（Custom Services）</strong>：比如创建 <code>IMailService</code> 处理邮件发送。</li>
</ul>
<ol start="4">
<li><strong>最佳实践</strong></li>
</ol>
<ul>
<li><strong>使用 <code>SOLID</code> 原则</strong>（单一职责、开闭原则等）</li>
<li><strong>遵循 <code>MVC</code> 设计模式</strong></li>
<li><strong>使用 <code>Minimal API</code> 进行轻量级开发</strong></li>
<li><strong>避免过度耦合，提倡松耦合架构</strong></li>
</ul>
<p><strong>总结</strong>： ASP.NET 的代码组织涉及<strong>文件结构、分层架构、模块化设计和最佳实践</strong>，这些策略能让项目更易维护、更具可扩展性，同时提高开发效率。</p>
<p>Program.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入必要的命名空间</span></span><br><span class="line"><span class="keyword">using</span> System.Text.Json;          <span class="comment">// JSON序列化/反序列化</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Endpoints;          <span class="comment">// 自定义端点定义</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Models;             <span class="comment">// 数据模型</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results;            <span class="comment">// API返回结果处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Web应用构建器</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加问题详情服务(用于错误处理)</span></span><br><span class="line">builder.Services.AddProblemDetails();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建应用程序</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非开发环境配置异常处理中间件</span></span><br><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用状态码页面中间件</span></span><br><span class="line">app.UseStatusCodePages();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 映射员工相关端点</span></span><br><span class="line">app.MapEmployeeEndpoints();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用程序</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p>EmployeeEndpoints.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Models;          <span class="comment">// 引入员工数据模型</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results;        <span class="comment">// 引入自定义返回结果类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Endpoints</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工相关端点定义静态类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EmployeeEndpoints</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 映射所有员工相关端点的扩展方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MapEmployeeEndpoints</span>(<span class="params"><span class="keyword">this</span> WebApplication app</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 根路径GET端点 - 返回欢迎页面HTML</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/&quot;</span>, HtmlResult () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> html = <span class="string">&quot;&lt;h2&gt;Welcome to our API&lt;/h2&gt; Our API is used to learn ASP.NET CORE.&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HtmlResult(html);  <span class="comment">// 使用自定义HtmlResult返回HTML内容</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// GET /employees - 获取所有员工列表</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees&quot;</span>, () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employees = EmployeesRepository.GetEmployees();  <span class="comment">// 从仓库获取员工数据</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Ok(employees);  <span class="comment">// 返回200 OK响应和员工数据</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// GET /employees/&#123;id&#125; - 根据ID获取单个员工</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employee = EmployeesRepository.GetEmployeeById(id);  <span class="comment">// 根据ID查询员工</span></span><br><span class="line">                <span class="keyword">return</span> employee <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">                    ? TypedResults.Ok(employee)  <span class="comment">// 找到则返回200 OK</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 未找到返回404错误</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">$&quot;Employee with the id <span class="subst">&#123;id&#125;</span> doesn&#x27;t exist.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// POST /employees - 创建新员工</span></span><br><span class="line">            app.MapPost(<span class="string">&quot;/employees&quot;</span>, (Employee employee) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证员工数据有效性</span></span><br><span class="line">                <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="literal">null</span> || employee.Id &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;Employee is not provided or is not valid.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">400</span>);  <span class="comment">// 无效数据返回400错误</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                EmployeesRepository.AddEmployee(employee);  <span class="comment">// 添加新员工到仓库</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Created(<span class="string">$&quot;/employees/<span class="subst">&#123;employee.Id&#125;</span>&quot;</span>, employee);  <span class="comment">// 返回201 Created响应</span></span><br><span class="line"></span><br><span class="line">            &#125;).WithParameterValidation();  <span class="comment">// 启用参数自动验证</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// PUT /employees/&#123;id&#125; - 更新员工信息</span></span><br><span class="line">            app.MapPut(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, Employee employee) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证ID一致性</span></span><br><span class="line">                <span class="keyword">if</span> (id != employee.Id)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;Employee id is not the same as id.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">400</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> EmployeesRepository.UpdateEmployee(employee)  <span class="comment">// 尝试更新员工</span></span><br><span class="line">                    ? TypedResults.NoContent()  <span class="comment">// 成功返回204 No Content</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 失败返回404</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;Employee doesn&#x27;t exist.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DELETE /employees/&#123;id&#125; - 删除员工</span></span><br><span class="line">            app.MapDelete(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employee = EmployeesRepository.GetEmployeeById(id);  <span class="comment">// 根据ID获取员工</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> EmployeesRepository.DeleteEmployee(employee)  <span class="comment">// 尝试删除员工</span></span><br><span class="line">                    ? TypedResults.Ok(employee)  <span class="comment">// 成功返回200 OK和被删除员工</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 失败返回404</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">$&quot;Employee with the id <span class="subst">&#123;id&#125;</span> doesn&#x27;t exist.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2、依赖问题"><a href="#2、依赖问题" class="headerlink" title="2、依赖问题"></a>2、依赖问题</h1><p>在 ASP.NET（尤其是 ASP.NET Core）中，**“Dependency Problem”（依赖问题）**通常指的是由于组件、服务或模块之间的依赖关系管理不当，导致系统出现耦合过高、维护困难或运行时错误等问题。</p>
<ol>
<li><strong>常见的依赖问题</strong></li>
</ol>
<p>依赖问题可能有多种表现形式，以下是一些常见情况：</p>
<ul>
<li><strong>紧耦合（Tight Coupling）</strong><ul>
<li>组件或类直接依赖具体实现，而不是依赖抽象（接口）。</li>
<li>使得代码难以扩展或替换，影响可测试性。</li>
</ul>
</li>
<li><strong>循环依赖（Circular Dependency）</strong><ul>
<li>两个或多个类相互依赖，导致无法正确解析依赖项。</li>
<li>例如：<code>A</code> 依赖 <code>B</code>，而 <code>B</code> 又依赖 <code>A</code>，导致对象初始化困难。</li>
</ul>
</li>
<li><strong>服务解析失败（Service Resolution Failure）</strong><ul>
<li>在依赖注入（DI）系统中，某个服务没有正确注册，导致运行时 <code>InvalidOperationException</code>。</li>
</ul>
</li>
<li><strong>错误的作用域（Scope Issue）</strong><ul>
<li>在 ASP.NET Core 的 DI 体系中，<code>Transient</code>、<code>Scoped</code> 和 <code>Singleton</code> 服务作用域如果使用不当，可能会导致意外的行为，例如：<ul>
<li><code>Scoped</code> 服务注入到 <code>Singleton</code> 服务中，导致生命周期不匹配。</li>
<li><code>Transient</code> 服务在短时间内频繁创建，影响性能。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>如何解决依赖问题</strong></li>
</ol>
<p>ASP.NET Core 采用**依赖注入（Dependency Injection，DI）**来管理依赖关系，可以有效减少耦合和提高可维护性。<br> 一些优化方法包括：</p>
<ul>
<li><strong>使用接口（Interface）代替具体实现</strong>：<ul>
<li>例如：<code>IMyService</code> 代替 <code>MyService</code>，避免直接依赖具体实现，使代码更具灵活性。</li>
</ul>
</li>
<li><strong>正确注册服务</strong>：<ul>
<li>在 <code>Program.cs</code> 中，通过 <code>services.AddTransient()</code> 或 <code>services.AddScoped()</code> 来正确注册依赖项。</li>
</ul>
</li>
<li><strong>避免循环依赖</strong>：<ul>
<li>使用<strong>事件驱动</strong>或<strong>Mediator 模式</strong>解耦循环引用的组件。</li>
</ul>
</li>
<li><strong>合理使用依赖作用域</strong>：<ul>
<li><code>Transient</code>（每次请求创建新实例）</li>
<li><code>Scoped</code>（在请求范围内共享实例）</li>
<li><code>Singleton</code>（整个应用生命周期共享实例）</li>
</ul>
</li>
</ul>
<p><strong>总结</strong></p>
<p>在 ASP.NET Core 中，依赖问题通常与<strong>耦合、循环引用、DI 解析失败或作用域错误</strong>相关。通过合理使用<strong>依赖注入（DI）</strong>、<strong>接口代替具体实现</strong>以及<strong>优化服务注册</strong>，可以有效减少这些问题，让应用更加健壮且易于维护。</p>
<h1 id="3、依赖反转"><a href="#3、依赖反转" class="headerlink" title="3、依赖反转"></a>3、依赖反转</h1><p><strong>Dependency Inversion Principle（依赖反转原则，DIP）</strong> 是 <strong>SOLID</strong> 设计原则之一，旨在降低代码耦合，提高可维护性和扩展性。在 ASP.NET（尤其是 ASP.NET Core）中，DIP 主要体现在**依赖注入（Dependency Injection, DI）**的使用。</p>
<p><strong>1. 什么是依赖反转原则？</strong></p>
<p>DIP 由两部分组成：</p>
<ol>
<li><strong>高层模块（High-level Modules）不应该依赖低层模块（Low-level Modules），两者都应该依赖于抽象（Abstraction）。</strong></li>
<li><strong>抽象（Abstraction）不应该依赖具体实现（Concrete Implementation），具体实现应该依赖抽象。</strong></li>
</ol>
<p>简单来说，DIP 让代码更加松耦合，使得高层业务逻辑不会直接绑定到低层细节，从而提高灵活性和可测试性。</p>
<p><strong>2. 在 ASP.NET Core 中如何应用 DIP？</strong></p>
<p>ASP.NET Core 通过 <strong>依赖注入（DI）</strong> 来实现 DIP。示例如下：</p>
<p><strong>(1) 不遵循 DIP（紧耦合代码）</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EmailService _emailService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService = <span class="keyword">new</span> EmailService(); <span class="comment">// 直接依赖具体实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessOrder</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService.SendEmail(<span class="string">&quot;Order processed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 <code>OrderService</code> 直接创建了 <code>EmailService</code>，导致两个类<strong>紧密耦合</strong>，如果要替换 <code>EmailService</code>，必须修改 <code>OrderService</code> 的代码。</p>
<p><strong>(2) 遵循 DIP（使用抽象和 DI）</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmailService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SendEmail</span>(<span class="params"><span class="built_in">string</span> message</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmailService</span> : <span class="title">IEmailService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendEmail</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Email sent: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IEmailService _emailService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IEmailService emailService</span>) <span class="comment">// 依赖抽象</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService = emailService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessOrder</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService.SendEmail(<span class="string">&quot;Order processed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>✅ <strong>高层模块 <code>OrderService</code> 只依赖 <code>IEmailService</code>（抽象）</strong>，而不是 <code>EmailService</code>（具体实现）。</p>
<p>✅ <code>IEmailService</code> 可以有多个实现，如 <code>MockEmailService</code>（用于测试）或 <code>SmsService</code>（发送短信），但不影响 <code>OrderService</code> 的代码。</p>
<p>在 ASP.NET Core 中，可以在 <code>Program.cs</code> 里配置 <strong>依赖注入</strong>：</p>
<p><code>builder.Services.AddTransient();</code></p>
<p>框架会自动提供正确的实现，符合 DIP 规则。</p>
<p><strong>3. DIP 好处</strong></p>
<p>✅ <strong>降低耦合</strong>：高层代码不直接依赖底层具体实现。<br>✅ <strong>更易测试</strong>：可以使用 <code>Mock</code> 替换依赖，进行单元测试。<br>✅ <strong>增强扩展性</strong>：可以随时切换不同的实现，而不影响业务逻辑。</p>
<p><strong>总结</strong></p>
<p>在 ASP.NET Core 中，<strong>依赖反转原则</strong> 通过 <strong>依赖注入（DI）</strong> 来实现，确保高层模块依赖于抽象，而不是具体实现。这种设计方式提升了代码的可维护性、可测试性和扩展性。</p>
<p>Employee.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;  <span class="comment">// 引入数据验证特性</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工数据模型类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Employee</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 员工ID属性</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 员工姓名属性</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 员工职位属性（必填字段）</span></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Position &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 员工薪资属性</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Salary &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数：初始化员工对象</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Employee</span>(<span class="params"><span class="built_in">int</span> id, <span class="built_in">string</span> name, <span class="built_in">string</span> position, <span class="built_in">double</span> salary</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Id = id;          <span class="comment">// 设置员工ID</span></span><br><span class="line">            Name = name;      <span class="comment">// 设置员工姓名</span></span><br><span class="line">            Position = position;  <span class="comment">// 设置员工职位</span></span><br><span class="line">            Salary = salary;  <span class="comment">// 设置员工薪资</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EmployeesRepository.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工数据仓库类（非静态实现）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeesRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 员工列表字段（非静态）</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;Employee&gt; employees = <span class="keyword">new</span> List&lt;Employee&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Employee(<span class="number">1</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;Engineer&quot;</span>, <span class="number">60000</span>),  <span class="comment">// 初始化示例员工1</span></span><br><span class="line">            <span class="keyword">new</span> Employee(<span class="number">2</span>, <span class="string">&quot;Jane Smith&quot;</span>, <span class="string">&quot;Manager&quot;</span>, <span class="number">75000</span>), <span class="comment">// 初始化示例员工2</span></span><br><span class="line">            <span class="keyword">new</span> Employee(<span class="number">3</span>, <span class="string">&quot;Sam Brown&quot;</span>, <span class="string">&quot;Technician&quot;</span>, <span class="number">50000</span>) <span class="comment">// 初始化示例员工3</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有员工列表</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Employee&gt; <span class="title">GetEmployees</span>()</span> =&gt; employees;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据ID查询单个员工</span></span><br><span class="line">        <span class="keyword">public</span> Employee? GetEmployeeById(<span class="built_in">int</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 使用LINQ查询匹配指定ID的员工</span></span><br><span class="line">            <span class="keyword">return</span> employees.FirstOrDefault(x =&gt; x.Id == id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新员工</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEmployee</span>(<span class="params">Employee? employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证员工对象有效性</span></span><br><span class="line">            <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 自动生成新ID（当前最大ID+1）</span></span><br><span class="line">                <span class="built_in">int</span> maxId = employees.Max(x =&gt; x.Id);</span><br><span class="line">                employee.Id = maxId + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 将新员工添加到列表</span></span><br><span class="line">                employees.Add(employee);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新员工信息</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateEmployee</span>(<span class="params">Employee? employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证员工对象有效性</span></span><br><span class="line">            <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 查找要更新的员工记录</span></span><br><span class="line">                <span class="keyword">var</span> emp = employees.FirstOrDefault(x =&gt; x.Id == employee.Id);</span><br><span class="line">                <span class="keyword">if</span> (emp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 更新员工详细信息</span></span><br><span class="line">                    emp.Name = employee.Name;</span><br><span class="line">                    emp.Position = employee.Position;</span><br><span class="line">                    emp.Salary = employee.Salary;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 返回更新成功状态</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 返回更新失败状态</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除员工</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteEmployee</span>(<span class="params">Employee? employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证员工对象有效性</span></span><br><span class="line">            <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从列表中移除指定员工</span></span><br><span class="line">                employees.Remove(employee);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 返回删除成功状态</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 返回删除失败状态</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IEmployeesRepository.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工数据仓库接口定义</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmployeesRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 添加新员工方法</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">AddEmployee</span>(<span class="params">Employee? employee</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除员工方法</span></span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">DeleteEmployee</span>(<span class="params">Employee? employee</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据ID获取单个员工方法</span></span><br><span class="line">        Employee? GetEmployeeById(<span class="built_in">int</span> id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取所有员工列表方法</span></span><br><span class="line">        <span class="function">List&lt;Employee&gt; <span class="title">GetEmployees</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新员工信息方法</span></span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">UpdateEmployee</span>(<span class="params">Employee? employee</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4、控制反转"><a href="#4、控制反转" class="headerlink" title="4、控制反转"></a>4、控制反转</h1><p>在 ASP.NET 中，<strong>Inversion of Control (IoC) Principle</strong>（控制反转原则）是一种设计原则，用于提高代码的灵活性和可维护性。它强调通过将对象创建和依赖管理的责任“反转”到框架或容器中，而不是在类内部直接管理这些依赖。</p>
<p>核心理念</p>
<p>控制反转原则的核心思想是让高层模块不直接控制低层模块的创建或依赖注入，而是通过框架或第三方工具来管理这些依赖。这种反转确保了代码更松耦合，并且便于进行扩展和测试。</p>
<p><strong>ASP.NET 中 IoC 的应用</strong></p>
<p>在 ASP.NET Core 中，IoC 主要通过**依赖注入（Dependency Injection, DI）**来实现。框架提供了一个内置的 IoC 容器，用于管理服务的注册和解析。这是 IoC 最典型的应用场景。</p>
<p><strong>1. 传统方式（未使用 IoC）</strong></p>
<p>如果没有 IoC，类通常会自行创建其依赖项：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EmailService _emailService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService = <span class="keyword">new</span> EmailService(); <span class="comment">// 自己创建依赖项</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessOrder</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService.SendEmail(<span class="string">&quot;Order processed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式将 <code>EmailService</code> 的创建硬编码到 <code>OrderService</code> 中，导致了<strong>紧耦合</strong>，不利于测试和扩展。</p>
<p><strong>2. 使用 IoC 容器（控制反转）</strong></p>
<p>通过 IoC 原则，依赖项的创建交由 IoC 容器负责，而不是类自身控制：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IEmailService _emailService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IEmailService emailService</span>) <span class="comment">// 依赖项通过注入提供</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService = emailService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessOrder</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _emailService.SendEmail(<span class="string">&quot;Order processed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 ASP.NET Core 中，可以在 <code>Program.cs</code> 中注册服务：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddTransient();</span><br></pre></td></tr></table></figure>

<p>当 <code>OrderService</code> 被解析时，IoC 容器会自动提供一个 <code>IEmailService</code> 的实例，而不是 <code>OrderService</code> 自行创建依赖。</p>
<p><strong>IoC 的优点</strong></p>
<ol>
<li><strong>降低耦合</strong>：通过依赖注入解耦类之间的关系，使代码更易维护。</li>
<li><strong>易于测试</strong>：可以用 Mock 替代实际实现，进行单元测试。</li>
<li><strong>提高扩展性</strong>：可以方便地替换或添加新的实现，而不会影响代码逻辑。</li>
<li><strong>支持更复杂的设计模式</strong>：例如 <code>Factory</code>、<code>Service Locator</code> 等。</li>
</ol>
<p><strong>总结</strong></p>
<p>控制反转原则（IoC）通过将依赖管理的责任交给容器，而不是在类内部直接控制对象创建和依赖关系，在 ASP.NET 中主要通过<strong>依赖注入</strong>机制体现。它是一种现代软件开发中非常重要的设计模式，有助于创建松耦合、易扩展和可测试的系统。</p>
<p>EmployeeEndpoints.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Models;          <span class="comment">// 引入员工数据模型</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results;        <span class="comment">// 引入自定义返回结果类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Endpoints</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工相关API端点配置类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EmployeeEndpoints</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 配置员工相关API路由的扩展方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MapEmployeeEndpoints</span>(<span class="params"><span class="keyword">this</span> WebApplication app</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 根路径GET请求 - 返回欢迎页面</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/&quot;</span>, HtmlResult () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> html = <span class="string">&quot;&lt;h2&gt;Welcome to our API&lt;/h2&gt; Our API is used to learn ASP.NET CORE.&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HtmlResult(html);  <span class="comment">// 返回HTML格式的欢迎页面</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// GET /employees - 获取所有员工</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees&quot;</span>, (IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employees = employeesRepository.GetEmployees();  <span class="comment">// 从仓储获取员工列表</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Ok(employees);  <span class="comment">// 返回200状态码和员工数据</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// GET /employees/&#123;id&#125; - 获取单个员工详情</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employee = employeesRepository.GetEmployeeById(id);  <span class="comment">// 根据ID查询员工</span></span><br><span class="line">                <span class="keyword">return</span> employee <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">                    ? TypedResults.Ok(employee)  <span class="comment">// 找到则返回200和员工数据</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 未找到返回404错误</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">$&quot;找不到ID为<span class="subst">&#123;id&#125;</span>的员工&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// POST /employees - 创建新员工</span></span><br><span class="line">            app.MapPost(<span class="string">&quot;/employees&quot;</span>, (Employee employee, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证员工数据有效性</span></span><br><span class="line">                <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="literal">null</span> || employee.Id &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;员工数据无效或未提供&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">400</span>);  <span class="comment">// 无效数据返回400错误</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                employeesRepository.AddEmployee(employee);  <span class="comment">// 添加新员工</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Created(<span class="string">$&quot;/employees/<span class="subst">&#123;employee.Id&#125;</span>&quot;</span>, employee);  <span class="comment">// 返回201创建成功响应</span></span><br><span class="line"></span><br><span class="line">            &#125;).WithParameterValidation();  <span class="comment">// 启用参数自动验证</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// PUT /employees/&#123;id&#125; - 更新员工信息</span></span><br><span class="line">            app.MapPut(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, Employee employee, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证ID一致性</span></span><br><span class="line">                <span class="keyword">if</span> (id != employee.Id)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;员工ID不匹配&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">400</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> employeesRepository.UpdateEmployee(employee)  <span class="comment">// 尝试更新员工</span></span><br><span class="line">                    ? TypedResults.NoContent()  <span class="comment">// 成功返回204无内容</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 失败返回404</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;员工不存在&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DELETE /employees/&#123;id&#125; - 删除员工</span></span><br><span class="line">            app.MapDelete(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> employee = employeesRepository.GetEmployeeById(id);  <span class="comment">// 查询要删除的员工</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> employeesRepository.DeleteEmployee(employee)  <span class="comment">// 尝试删除</span></span><br><span class="line">                    ? TypedResults.Ok(employee)  <span class="comment">// 成功返回200和被删除员工</span></span><br><span class="line">                    : Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;  <span class="comment">// 失败返回404</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">$&quot;找不到ID为<span class="subst">&#123;id&#125;</span>的员工&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Program.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入必要的命名空间</span></span><br><span class="line"><span class="keyword">using</span> System.Text.Json;          <span class="comment">// 用于JSON数据的序列化和反序列化操作</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Endpoints;          <span class="comment">// 引入自定义的API端点定义</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Models;             <span class="comment">// 引入数据模型定义</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results;            <span class="comment">// 引入API返回结果处理相关类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Web应用构建器实例</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加问题详情服务(用于更详细的错误信息处理)</span></span><br><span class="line">builder.Services.AddProblemDetails();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册员工数据仓库服务(使用瞬态生命周期)</span></span><br><span class="line">builder.Services.AddTransient&lt;IEmployeesRepository, EmployeesRepository&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建Web应用程序实例</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非开发环境配置异常处理中间件</span></span><br><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用默认的异常处理中间件</span></span><br><span class="line">    app.UseExceptionHandler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用状态码页面中间件(自动处理HTTP错误状态码)</span></span><br><span class="line">app.UseStatusCodePages();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 映射员工相关的API端点路由</span></span><br><span class="line">app.MapEmployeeEndpoints();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动并运行Web应用程序</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<h1 id="5、生命周期管理"><a href="#5、生命周期管理" class="headerlink" title="5、生命周期管理"></a>5、生命周期管理</h1><p>在 ASP.NET Core 的 <strong>Minimal APIs</strong> 中，“Lifetime Management”（生命周期管理）主要指的是如何管理服务实例的<strong>创建、作用域和释放</strong>，以确保它们在应用运行期间以高效和正确的方式工作。生命周期管理是依赖注入（Dependency Injection, DI）机制的重要组成部分，在 Minimal APIs 中同样适用。</p>
<p><strong>1. 依赖注入中的服务生命周期</strong></p>
<p>ASP.NET Core 使用 <strong>IoC（控制反转）容器</strong> 来管理服务的生命周期。在 Minimal APIs 中，可以通过 <code>Program.cs</code> 注册服务并指定它们的生命周期。</p>
<p>服务生命周期有以下三种类型：</p>
<ul>
<li><p><strong>Transient</strong><br> 每次请求都会创建一个新的服务实例。适用于轻量服务或不需要共享状态的服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddTransient();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Scoped</strong><br> 在同一 HTTP 请求的范围内共享一个服务实例。适用于需要在请求内保持一致性，但不需要跨请求共享的服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddScoped();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Singleton</strong><br> 在应用程序整个生命周期内只创建一个服务实例。适用于共享数据或耗资源较多的服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddSingleton();</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>2. Minimal APIs 中的服务注入与生命周期管理</strong></p>
<p>在 Minimal APIs 中，可以轻松地在终结点中注入服务，并根据服务的生命周期使用它们。例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.MapGet(<span class="string">&quot;/example&quot;</span>, (IMyService service) =&gt; service.DoWork());</span><br></pre></td></tr></table></figure>

<p>上述代码依赖框架的 DI 容器来自动管理 <code>IMyService</code> 的实例。</p>
<p><strong>示例：Scoped 服务的生命周期</strong></p>
<p>如果你在一个请求中调用多个终结点或服务，它们将共享同一个 <code>Scoped</code> 服务实例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddScoped&lt;IMyService, MyService&gt;();</span><br><span class="line">app.MapGet(<span class="string">&quot;/process1&quot;</span>, (IMyService service) =&gt; service.DoWork());</span><br><span class="line">app.MapGet(<span class="string">&quot;/process2&quot;</span>, (IMyService service) =&gt; service.DoWork());</span><br></pre></td></tr></table></figure>

<p>在同一个 HTTP 请求中，两次调用 <code>IMyService</code> 都会使用相同的实例。</p>
<p><strong>3. 生命周期管理的最佳实践</strong></p>
<ul>
<li><strong>选择正确的服务生命周期</strong>：<ul>
<li>如果服务依赖于短时间的操作或无需跨请求共享状态，使用 <strong>Transient</strong>。</li>
<li>如果服务需要在单个请求内共享数据，选择 <strong>Scoped</strong>。</li>
<li>如果服务需要跨请求共享状态或耗资源较多，选择 <strong>Singleton</strong>。</li>
</ul>
</li>
<li><strong>避免生命周期冲突</strong>： 不要注入生命周期较短的服务（如 Scoped 或 Transient）到生命周期较长的服务（如 Singleton），否则可能导致状态不一致或运行时错误。</li>
<li><strong>释放资源</strong>： 容器会自动释放实现了 <code>IDisposable</code> 的服务实例，但确保正确地释放外部资源，例如数据库连接或文件句柄。</li>
</ul>
<p><strong>4. 总结</strong></p>
<p>在 ASP.NET Core Minimal APIs 中，“Lifetime Management” 是通过 DI 容器控制服务实例的创建和释放的机制。它帮助开发者选择适当的服务生命周期，确保资源高效利用，同时避免不必要的状态共享和冲突。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/04/14/NET-ASP-07/">https://alsl521.github.io/2025/04/14/NET-ASP-07/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/14/NET-ASP-06/" title="ASP.NET学习记录-06-最小API结果生产"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ASP.NET学习记录-06-最小API结果生产</div></div><div class="info-2"><div class="info-item-1">本次学习基础代码如下： Employee.cs 12345678910111213141516171819202122232425262728293031323334353637383940414243444546using System.ComponentModel.DataAnnotations;namespace WebApi.Models&#123;    /// &lt;summary&gt;    /// 员工实体类    /// &lt;/summary&gt;    public class Employee    &#123;        /// &lt;summary&gt;        /// 员工唯一标识符        /// &lt;/summary&gt;        public int Id &#123; get; set; &#125;        /// &lt;summary&gt;        /// 员工姓名        /// &lt;/summary&gt;        public string Name...</div></div></div></a><a class="pagination-related" href="/2025/04/14/NET-ASP-08/" title="ASP.NET学习记录-08-MVC路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">ASP.NET学习记录-08-MVC路由</div></div><div class="info-2"><div class="info-item-1">1、什么是controller？为什么用controller？模型-视图-控制器 (MVC) 体系结构模式将应用分成 3 个主要组件：模型 (M)、视图 (V) 和控制器 (C) 。 MVC 模式有助于创建比传统单片应用更易于测试和更新的应用。 基于 MVC 的应用包含：  模型 (M)：是表示应用数据的类。 模型类使用验证逻辑来对该数据强制实施业务规则。 通常，模型对象检索模型状态并将其存储在数据库中。 本教程中，Movie 模型将从数据库中检索电影数据，并将其提供给视图或对其进行更新。 更新后的数据将写入到数据库。 视图 (V)：视图是显示应用用户界面 (UI) 的组件。 此 UI 通常会显示模型数据。 控制器 (C)：具有以下特征的类： 处理浏览器请求。 检索模型数据。 调用返回响应的视图模板。    在 MVC 应用中，视图仅显示信息。 控制器处理用户输入和交互并对其进行响应。 例如，控制器处理 URL 段和查询字符串值，并将这些值传递给模型。 该模型可使用这些值查询数据库。 例如：  https://localhost:5001/Home/Privacy：指定...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-03-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-03-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/11/NET-ASP-05/" title="ASP.NET学习记录-05-模型数据绑定"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">ASP.NET学习记录-05-模型数据绑定</div></div><div class="info-2"><div class="info-item-1">1、模型绑定定义模型绑定是ASP.NET Core中将HTTP请求数据自动映射到方法参数或对象属性的机制。其核心工作流程：  数据来源：  路由参数（URL片段） 查询字符串（?key&#x3D;value） 请求体（表单&#x2F;JSON&#x2F;XML） 请求头 文件上传   典型应用：   12345678910111213// 自动绑定路由参数和查询参数[HttpGet(&quot;/products/&#123;id&#125;&quot;)]public IActionResult GetProduct(int id, [FromQuery] string category) &#123;    // id来自路由参数，category来自查询字符串&#125;// 自动绑定JSON请求体[HttpPost]public IActionResult Create([FromBody] Product product)&#123;    //...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87"><span class="toc-number">1.</span> <span class="toc-text">1、代码组织</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">2、依赖问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"><span class="toc-number">3.</span> <span class="toc-text">3、依赖反转</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC"><span class="toc-number">4.</span> <span class="toc-text">4、控制反转</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">5、生命周期管理</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-12/" title="ASP.NET学习记录-12-实践2-使用MySQL数据库">ASP.NET学习记录-12-实践2-使用MySQL数据库</a><time datetime="2025-04-18T08:11:21.000Z" title="发表于 2025-04-18 16:11:21">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-11/" title="ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API">ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API</a><time datetime="2025-04-18T02:13:44.000Z" title="发表于 2025-04-18 10:13:44">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/16/NET-ASP-10/" title="ASP.NET学习记录-10-过滤">ASP.NET学习记录-10-过滤</a><time datetime="2025-04-16T12:02:16.000Z" title="发表于 2025-04-16 20:02:16">2025-04-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/15/Software/" title="记录必备软件">记录必备软件</a><time datetime="2025-04-15T11:29:21.000Z" title="发表于 2025-04-15 19:29:21">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>