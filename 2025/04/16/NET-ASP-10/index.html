<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ASP.NET学习记录-10-过滤 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET学习记录-10-过滤">
<meta property="og:url" content="https://alsl521.github.io/2025/04/16/NET-ASP-10/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-04-16T12:02:16.000Z">
<meta property="article:modified_time" content="2025-04-18T02:13:22.024Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASP.NET学习记录-10-过滤",
  "url": "https://alsl521.github.io/2025/04/16/NET-ASP-10/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-04-16T12:02:16.000Z",
  "dateModified": "2025-04-18T02:13:22.024Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/04/16/NET-ASP-10/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ASP.NET学习记录-10-过滤',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ASP.NET学习记录-10-过滤</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ASP.NET学习记录-10-过滤</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-16T12:02:16.000Z" title="发表于 2025-04-16 20:02:16">2025-04-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-18T02:13:22.024Z" title="更新于 2025-04-18 10:13:22">2025-04-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="一、ASP-NET-Core-中的过滤管道"><a href="#一、ASP-NET-Core-中的过滤管道" class="headerlink" title="一、ASP.NET Core 中的过滤管道"></a>一、ASP.NET Core 中的过滤管道</h1><h2 id="1-什么是过滤管道？"><a href="#1-什么是过滤管道？" class="headerlink" title="1. 什么是过滤管道？"></a>1. <strong>什么是过滤管道？</strong></h2><p>**过滤管道（Filter Pipeline）**是 ASP.NET Core 请求处理流程中的一个核心机制，由一系列过滤器（Filters）按特定顺序组成。这些过滤器在 MVC 或 Razor Pages 的请求处理管道中，针对不同阶段（如授权、模型绑定、Action 执行等）插入自定义逻辑，实现横切关注点（Cross-Cutting Concerns）的集中处理。</p>
<p>过滤器的类型及执行顺序：</p>
<ul>
<li><p>授权过滤器（Authorization Filters）：最先执行，用于验证用户权限（如是否登录或具备访问权限）。</p>
</li>
<li><p>资源过滤器（Resource Filters）：在授权后执行，常用于缓存或短路管道（如直接返回结果，跳过后续处理）。</p>
</li>
<li><p>操作过滤器（Action Filters）：在 Action 执行前后运行，可修改输入参数或结果（如日志记录、参数校验）。</p>
</li>
<li><p>异常过滤器（Exception Filters）：捕获未处理的异常，统一处理错误响应。</p>
</li>
<li><p>结果过滤器（Result Filters）：在 Action 结果生成后执行，用于修改响应内容（如格式化输出）。</p>
</li>
</ul>
<h2 id="2-为什么需要过滤管道？"><a href="#2-为什么需要过滤管道？" class="headerlink" title="2. 为什么需要过滤管道？"></a>2. <strong>为什么需要过滤管道？</strong></h2><p>过滤管道解决了以下核心问题：</p>
<ol>
<li><p><strong>横切关注点的解耦</strong><br>将通用逻辑（如授权、日志、异常处理）从业务代码中分离，避免重复代码。例如：</p>
<ul>
<li><p>全局异常处理可通过异常过滤器统一捕获并返回友好错误页面。</p>
</li>
<li><p>权限检查通过授权过滤器集中实现，无需在每个 Action 中编写验证逻辑。</p>
</li>
</ul>
</li>
<li><p><strong>灵活性和可扩展性</strong></p>
<ul>
<li><p>作用域灵活：过滤器可全局应用，也可针对特定控制器或 Action 生效。</p>
</li>
<li><p>执行顺序可控：通过作用域（全局→控制器→Action）或<code>IOrderedFilter</code> 接口调整执行顺序。</p>
</li>
</ul>
</li>
<li><p><strong>管道短路与性能优化</strong><br>过滤器可通过设置 <code>context.Result</code> 提前终止请求处理，减少不必要的资源消耗。例如：</p>
<ul>
<li><p>资源过滤器可缓存高频请求的结果，直接返回缓存数据。</p>
</li>
<li><p>授权失败时，授权过滤器直接返回 403 状态码，避免后续处理。</p>
</li>
</ul>
</li>
<li><p><strong>与中间件互补</strong><br>中间件（Middleware）处理底层 HTTP 请求（如静态文件服务、CORS），而过滤器更贴近业务逻辑（如模型验证、Action 执行）。两者的分工使管道更清晰：</p>
<ul>
<li><p>中间件：处理请求级逻辑（如身份认证、日志记录）。</p>
</li>
<li><p>过滤器：处理 MVC 或 Razor Pages 特有的逻辑（如 Action 参数校验）。</p>
</li>
</ul>
</li>
</ol>
<h2 id="3-实际应用场景"><a href="#3-实际应用场景" class="headerlink" title="3. 实际应用场景"></a>3. <strong>实际应用场景</strong></h2><ul>
<li><p>权限控制：通过自定义<code>AuthorizationFilter</code>实现基于角色的访问限制。</p>
</li>
<li><p>日志记录：使用 Action 过滤器记录请求参数和执行时间。</p>
</li>
<li><p>缓存优化：资源过滤器缓存高频查询结果，减少数据库压力。</p>
</li>
<li><p>统一异常处理：异常过滤器捕获所有未处理错误，返回标准化错误响应。</p>
</li>
</ul>
<h2 id="4-过滤管道与中间件的对比"><a href="#4-过滤管道与中间件的对比" class="headerlink" title="4. 过滤管道与中间件的对比"></a>4. <strong>过滤管道与中间件的对比</strong></h2><table>
<thead>
<tr>
<th align="center"><strong>特性</strong></th>
<th align="center"><strong>过滤管道</strong></th>
<th align="center"><strong>中间件</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>作用范围</strong></td>
<td align="center">MVC&#x2F;Razor Pages 特定阶段</td>
<td align="center">全局 HTTP 请求处理</td>
</tr>
<tr>
<td align="center"><strong>常见用途</strong></td>
<td align="center">权限校验、模型绑定、结果格式化</td>
<td align="center">身份认证、静态文件服务、CORS</td>
</tr>
<tr>
<td align="center"><strong>执行顺序</strong></td>
<td align="center">按过滤器类型和作用域分层执行</td>
<td align="center">按注册顺序执行</td>
</tr>
<tr>
<td align="center"><strong>依赖关系</strong></td>
<td align="center">依赖于 MVC 或 Razor Pages 上下文</td>
<td align="center">独立于业务逻辑，处理原始 HTTP 请求</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ASP.NET Core 的过滤管道通过分层、模块化的设计，将通用逻辑集中处理，显著提升代码的可维护性和扩展性。它允许开发者在请求处理的关键阶段插入自定义逻辑，同时通过短路机制优化性能。结合中间件，两者共同构建了一个高效、灵活的请求处理体系。</p>
<h1 id="二、最小API模式Filter"><a href="#二、最小API模式Filter" class="headerlink" title="二、最小API模式Filter"></a>二、最小API模式Filter</h1><p>EmployeeCreateFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Models; <span class="comment">// 引入数据模型命名空间，用于访问Employee类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工创建过滤器，实现IEndpointFilter接口</span></span><br><span class="line">    <span class="comment">// 该过滤器用于在创建员工端点执行前验证请求数据的有效性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeeCreateFilter</span> : <span class="title">IEndpointFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 实现IEndpointFilter接口的InvokeAsync方法</span></span><br><span class="line">        <span class="comment">// 该方法在端点处理程序执行前调用，可以拦截、验证或修改请求</span></span><br><span class="line">        <span class="comment">// context: 包含当前请求上下文，包括请求参数等信息</span></span><br><span class="line">        <span class="comment">// next: 表示过滤器管道中的下一个委托（要么是下一个过滤器，要么是端点处理程序）</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> ValueTask&lt;<span class="built_in">object</span>?&gt; InvokeAsync(EndpointFilterInvocationContext context, EndpointFilterDelegate next)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从请求上下文中获取第一个参数(索引0)，并尝试将其转换为Employee类型</span></span><br><span class="line">            <span class="keyword">var</span> employee = context.GetArgument&lt;Employee&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证员工对象是否有效：检查是否为null及ID是否小于0</span></span><br><span class="line">            <span class="keyword">if</span> (employee <span class="keyword">is</span> <span class="literal">null</span> || employee.Id &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果验证失败，立即返回400 Bad Request状态码</span></span><br><span class="line">                <span class="comment">// 并提供结构化的验证问题描述（基于RFC 7807标准）</span></span><br><span class="line">                <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;Employee is not provided or is not valid.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                statusCode: <span class="number">400</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果验证通过，调用过滤器管道中的下一个委托</span></span><br><span class="line">            <span class="comment">// 这将请求传递给下一个过滤器或最终的端点处理程序</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> next(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EmployeeUpdateFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Models; <span class="comment">// 引入数据模型命名空间，用于访问Employee类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工更新过滤器，实现IEndpointFilter接口</span></span><br><span class="line">    <span class="comment">// 该过滤器用于在更新员工端点执行前验证请求数据的一致性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeeUpdateFilter</span> : <span class="title">IEndpointFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 实现IEndpointFilter接口的InvokeAsync方法</span></span><br><span class="line">        <span class="comment">// 该方法在端点处理程序执行前调用，可以拦截、验证或修改请求</span></span><br><span class="line">        <span class="comment">// context: 包含当前请求上下文，包括请求参数等信息</span></span><br><span class="line">        <span class="comment">// next: 表示过滤器管道中的下一个委托（要么是下一个过滤器，要么是端点处理程序）</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> ValueTask&lt;<span class="built_in">object</span>?&gt; InvokeAsync(EndpointFilterInvocationContext context, EndpointFilterDelegate next)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从请求上下文中获取第一个参数(索引0)，即路由中的id值</span></span><br><span class="line">            <span class="keyword">var</span> id = context.GetArgument&lt;<span class="built_in">int</span>&gt;(<span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从请求上下文中获取第二个参数(索引1)，即请求体中的Employee对象</span></span><br><span class="line">            <span class="keyword">var</span> employee = context.GetArgument&lt;Employee&gt;(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证路由中的id与请求体中Employee对象的Id是否一致</span></span><br><span class="line">            <span class="comment">// 这是一个重要的业务规则，确保API使用的一致性</span></span><br><span class="line">            <span class="keyword">if</span> (id != employee.Id)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果不一致，立即返回400 Bad Request状态码</span></span><br><span class="line">                <span class="comment">// 并提供结构化的验证问题描述（基于RFC 7807标准）</span></span><br><span class="line">                <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;Employee id is not the same as id.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                statusCode: <span class="number">400</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果验证通过，调用过滤器管道中的下一个委托</span></span><br><span class="line">            <span class="comment">// 这将请求传递给下一个过滤器或最终的端点处理程序</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> next(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnsureEmployeeExistsFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Models; <span class="comment">// 引入数据模型命名空间，用于访问IEmployeesRepository接口</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保员工存在的过滤器，实现IEndpointFilter接口</span></span><br><span class="line">    <span class="comment">// 该过滤器用于在处理特定员工的端点执行前验证该员工是否存在</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnsureEmployeeExistsFilter</span> : <span class="title">IEndpointFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 员工仓储接口的私有字段，用于查询员工信息</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IEmployeesRepository employeesRepository;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数，通过依赖注入接收员工仓储实例</span></span><br><span class="line">        <span class="comment">// 这种方式使过滤器可以访问数据层而无需直接创建仓储实例</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EnsureEmployeeExistsFilter</span>(<span class="params">IEmployeesRepository employeesRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.employeesRepository = employeesRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现IEndpointFilter接口的InvokeAsync方法</span></span><br><span class="line">        <span class="comment">// 该方法在端点处理程序执行前调用，可以拦截、验证或修改请求</span></span><br><span class="line">        <span class="comment">// context: 包含当前请求上下文，包括请求参数等信息</span></span><br><span class="line">        <span class="comment">// next: 表示过滤器管道中的下一个委托（要么是下一个过滤器，要么是端点处理程序）</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> ValueTask&lt;<span class="built_in">object</span>?&gt; InvokeAsync(EndpointFilterInvocationContext context, EndpointFilterDelegate next)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从请求上下文中获取第一个参数(索引0)，即员工ID</span></span><br><span class="line">            <span class="keyword">var</span> id = context.GetArgument&lt;<span class="built_in">int</span>&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用仓储检查指定ID的员工是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.employeesRepository.EmployeeExists(id))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果员工不存在，立即返回404 Not Found状态码</span></span><br><span class="line">                <span class="comment">// 并提供结构化的验证问题描述（基于RFC 7807标准）</span></span><br><span class="line">                <span class="keyword">return</span> Microsoft.AspNetCore.Http.Results.ValidationProblem(<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#123;<span class="string">&quot;id&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">$&quot;Employee with the id <span class="subst">&#123;id&#125;</span> doesn&#x27;t exist.&quot;</span> &#125; &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    statusCode: <span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果员工存在，调用过滤器管道中的下一个委托</span></span><br><span class="line">            <span class="comment">// 这将请求传递给下一个过滤器或最终的端点处理程序</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> next(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EmployeeEndpoints.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApi.Filters; <span class="comment">// 引入过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Models; <span class="comment">// 引入数据模型的命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results; <span class="comment">// 引入自定义结果类型的命名空间</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> System.Net.Mime.MediaTypeNames; <span class="comment">// 引入媒体类型常量，用于内容协商</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApi.Endpoints</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 员工相关端点的静态类，用于组织和封装所有与员工资源相关的API路由</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EmployeeEndpoints</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 扩展方法，用于将所有员工相关的端点映射到WebApplication实例</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">MapEmployeeEndpoints</span>(<span class="params"><span class="keyword">this</span> WebApplication app</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 映射根路径，返回简单的HTML欢迎信息</span></span><br><span class="line">            <span class="comment">// 使用自定义HtmlResult类型来处理HTML响应</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/&quot;</span>, HtmlResult () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> html = <span class="string">&quot;&lt;h2&gt;Welcome to our API&lt;/h2&gt; Our API is used to learn ASP.NET CORE.&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HtmlResult(html);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射GET请求到&quot;/employees&quot;路径，返回所有员工</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees&quot;</span>, (IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从仓储中获取所有员工</span></span><br><span class="line">                <span class="keyword">var</span> employees = employeesRepository.GetEmployees();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 返回200 OK状态码和员工列表</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Ok(employees);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射GET请求到&quot;/employees/&#123;id&#125;&quot;路径，返回指定ID的员工</span></span><br><span class="line">            <span class="comment">// 路由参数约束&quot;:int&quot;确保ID是整数类型</span></span><br><span class="line">            app.MapGet(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从仓储中获取特定ID的员工</span></span><br><span class="line">                <span class="keyword">var</span> employee = employeesRepository.GetEmployeeById(id);</span><br><span class="line">                <span class="comment">// 返回200 OK状态码和员工信息</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Ok(employee);</span><br><span class="line">            &#125;).AddEndpointFilter&lt;EnsureEmployeeExistsFilter&gt;(); <span class="comment">// 添加员工存在性检查过滤器</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射POST请求到&quot;/employees&quot;路径，用于创建新员工</span></span><br><span class="line">            app.MapPost(<span class="string">&quot;/employees&quot;</span>, (Employee employee, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 添加员工到仓储</span></span><br><span class="line">                employeesRepository.AddEmployee(employee);</span><br><span class="line">                <span class="comment">// 返回201 Created状态码，包含新创建资源的位置和资源本身</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Created(<span class="string">$&quot;/employees/<span class="subst">&#123;employee.Id&#125;</span>&quot;</span>, employee);</span><br><span class="line"></span><br><span class="line">            &#125;).AddEndpointFilter&lt;EmployeeCreateFilter&gt;() <span class="comment">// 添加员工创建验证过滤器</span></span><br><span class="line">              .WithParameterValidation(); <span class="comment">// 启用参数验证，自动验证模型状态</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射PUT请求到&quot;/employees/&#123;id&#125;&quot;路径，用于更新指定ID的员工</span></span><br><span class="line">            app.MapPut(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, Employee employee, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 尝试更新员工信息并返回更新结果</span></span><br><span class="line">                <span class="keyword">return</span> employeesRepository.UpdateEmployee(employee);</span><br><span class="line">            &#125;).AddEndpointFilter&lt;EnsureEmployeeExistsFilter&gt;() <span class="comment">// 添加员工存在性检查过滤器</span></span><br><span class="line">              .AddEndpointFilter&lt;EmployeeUpdateFilter&gt;() <span class="comment">// 添加员工更新验证过滤器（检查ID一致性）</span></span><br><span class="line">              .WithParameterValidation(); <span class="comment">// 启用参数验证，自动验证模型状态</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 映射DELETE请求到&quot;/employees/&#123;id&#125;&quot;路径，用于删除指定ID的员工</span></span><br><span class="line">            app.MapDelete(<span class="string">&quot;/employees/&#123;id:int&#125;&quot;</span>, (<span class="built_in">int</span> id, IEmployeesRepository employeesRepository) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 获取要删除的员工信息</span></span><br><span class="line">                <span class="keyword">var</span> employee = employeesRepository.GetEmployeeById(id);</span><br><span class="line">                <span class="comment">// 返回200 OK状态码和被删除的员工信息</span></span><br><span class="line">                <span class="keyword">return</span> TypedResults.Ok(employee);</span><br><span class="line">            &#125;).AddEndpointFilter&lt;EnsureEmployeeExistsFilter&gt;(); <span class="comment">// 添加员工存在性检查过滤器</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Program.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text.Json; <span class="comment">// 引入 JSON 序列化/反序列化所需的命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Endpoints; <span class="comment">// 引入自定义端点配置的命名空间  </span></span><br><span class="line"><span class="keyword">using</span> WebApi.Models; <span class="comment">// 引入数据模型的命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApi.Results; <span class="comment">// 引入结果处理相关的命名空间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ASP.NET Core 应用程序构建器实例</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加 ProblemDetails 服务，用于标准化错误响应</span></span><br><span class="line"><span class="comment">// 这符合 RFC 7807 规范，提供结构化的错误信息</span></span><br><span class="line">builder.Services.AddProblemDetails();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册员工仓储服务，使用单例模式</span></span><br><span class="line"><span class="comment">// IEmployeesRepository 被注入为 EmployeesRepository 的实现</span></span><br><span class="line">builder.Services.AddSingleton&lt;IEmployeesRepository, EmployeesRepository&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建应用程序实例</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在非开发环境中启用异常处理中间件</span></span><br><span class="line"><span class="comment">// 这会捕获未处理的异常并返回友好的错误页面，而不是详细的异常信息</span></span><br><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用状态码页面中间件</span></span><br><span class="line"><span class="comment">// 当请求返回特定状态码时提供更友好的响应</span></span><br><span class="line">app.UseStatusCodePages();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置员工相关的 API 端点</span></span><br><span class="line"><span class="comment">// 该方法在 WebApi.Endpoints 命名空间中定义</span></span><br><span class="line">app.MapEmployeeEndpoints();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用程序，开始监听请求</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<h1 id="三、MVC模式Filter"><a href="#三、MVC模式Filter" class="headerlink" title="三、MVC模式Filter"></a>三、MVC模式Filter</h1><p>ASP.NET Core MVC 的过滤器（Filter）是一种基于 <strong>AOP（面向切面编程）</strong> 的机制，允许开发者在请求处理管道的不同阶段插入自定义逻辑。以下是对五种过滤器的详细说明，涵盖其作用、执行顺序、实现方式及典型应用场景：</p>
<p><img src="/NET-ASP-10/endpoint.png" alt="endpoint"></p>
<hr>
<h2 id="1-Authorization-Filter（授权过滤器）"><a href="#1-Authorization-Filter（授权过滤器）" class="headerlink" title="1.Authorization Filter（授权过滤器）"></a>1.<strong>Authorization Filter（授权过滤器）</strong></h2><p><strong>核心作用</strong>：<br>验证用户权限，确保请求合法且用户具备访问资源或操作的资格。<br>​<strong>​执行顺序​</strong>​：<br>在所有过滤器中 ​<strong>​最先执行​</strong>​，若未通过验证，直接短路后续管道。</p>
<p>实现方式：</p>
<ol>
<li><p><strong>内置特性</strong>：<br>使用 <code>[Authorize]</code> 特性，支持全局、控制器或 Action 级别的权限控制：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(Roles = <span class="string">&quot;Admin&quot;</span>)</span>]  <span class="comment">// 仅允许管理员访问</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AdminController</span> : <span class="title">Controller</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>自定义实现</strong>：<br>继承 <code>IAuthorizationFilter</code> 或 <code>IAsyncAuthorizationFilter</code> 接口，编写逻辑：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAuthFilter</span> : <span class="title">IAuthorizationFilter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnAuthorization</span>(<span class="params">AuthorizationFilterContext context</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsUserAdmin(context.HttpContext.User)) &#123;</span><br><span class="line">            context.Result = <span class="keyword">new</span> ForbidResult();  <span class="comment">// 返回 403</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>典型场景</strong>：</p>
<ul>
<li><p>角色&#x2F;策略验证（如仅允许登录用户访问）</p>
</li>
<li><p>非 HTTPS 请求拦截（如<code>[RequireHttps]</code>）</p>
</li>
</ul>
<hr>
<h2 id="2-Resource-Filter（资源过滤器）"><a href="#2-Resource-Filter（资源过滤器）" class="headerlink" title="2.Resource Filter（资源过滤器）"></a>2.<strong>Resource Filter（资源过滤器）</strong></h2><p><strong>核心作用</strong>：<br>在 ​<strong>​模型绑定前​</strong>​ 或 ​<strong>​结果生成后​</strong>​ 执行逻辑，常用于性能优化或管道短路。<br>​<strong>​执行顺序​</strong>​：<br>紧随授权过滤器之后，分为 <code>OnResourceExecuting</code>（执行前）和 <code>OnResourceExecuted</code>（执行后）。</p>
<p>实现方式：</p>
<ol>
<li><p><strong>同步接口</strong>：<code>IResourceFilter</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CacheResourceFilter</span> : <span class="title">IResourceFilter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuting</span>(<span class="params">ResourceExecutingContext context</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 检查缓存是否存在，若存在直接返回结果</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuted</span>(<span class="params">ResourceExecutedContext context</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 将结果存入缓存</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>异步接口</strong>：<code>IAsyncResourceFilter</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AsyncResourceFilter</span> : <span class="title">IAsyncResourceFilter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnResourceExecutionAsync</span>(<span class="params">...</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 异步缓存逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>典型场景</strong>：</p>
<ul>
<li><p>请求结果缓存（减少数据库查询）</p>
</li>
<li><p>请求预处理（如压缩响应数据）</p>
</li>
</ul>
<hr>
<h2 id="3-Action-Filter（动作过滤器）"><a href="#3-Action-Filter（动作过滤器）" class="headerlink" title="3.Action Filter（动作过滤器）"></a>3.<strong>Action Filter（动作过滤器）</strong></h2><p><strong>核心作用</strong>：<br>在 ​<strong>​Action 方法执行前后​</strong>​ 插入逻辑，适用于与业务逻辑密切相关的操作。<br>​<strong>​执行顺序​</strong>​：<br>在资源过滤器之后，模型绑定完成后触发。</p>
<p>实现方式：</p>
<ol>
<li><p><strong>特性继承</strong>：<br>继承 <code>ActionFilterAttribute</code>，覆盖 <code>OnActionExecuting</code> 和 <code>OnActionExecuted</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogActionFilter</span> : <span class="title">ActionFilterAttribute</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span> &#123;</span><br><span class="line">        LogRequestParams(context.HttpContext.Request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>直接接口实现</strong>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomActionFilter</span> : <span class="title">IActionFilter</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>典型场景</strong>：</p>
<ul>
<li><p>请求参数校验（如验证模型合法性）</p>
</li>
<li><p>日志记录（记录请求耗时、参数）</p>
</li>
</ul>
<hr>
<h2 id="4-Result-Filter（结果过滤器）"><a href="#4-Result-Filter（结果过滤器）" class="headerlink" title="4.Result Filter（结果过滤器）"></a>4.<strong>Result Filter（结果过滤器）</strong></h2><p><strong>核心作用</strong>：<br>在 ​<strong>​Action 结果生成后​</strong>​ 修改响应内容，如格式化输出或添加统一响应头。<br>​<strong>​执行顺序​</strong>​：<br>在 Action 方法执行后，结果返回客户端前执行。</p>
<p>实现方式：</p>
<ol>
<li><p><strong>同步接口</strong>：<code>IResultFilter</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AddHeaderFilter</span> : <span class="title">IResultFilter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResultExecuting</span>(<span class="params">ResultExecutingContext context</span>)</span> &#123;</span><br><span class="line">        context.HttpContext.Response.Headers.Add(<span class="string">&quot;X-Custom-Header&quot;</span>, <span class="string">&quot;Value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>异步接口</strong>：<code>IAsyncResultFilter</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AsyncResultFilter</span> : <span class="title">IAsyncResultFilter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnResultExecutionAsync</span>(<span class="params">...</span>)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>典型场景</strong>：</p>
<ul>
<li><p>统一响应格式（如 JSON 包装）</p>
</li>
<li><p>动态修改视图结果（如根据设备类型返回不同 HTML）</p>
</li>
</ul>
<hr>
<h2 id="5-Exception-Filter（异常过滤器）"><a href="#5-Exception-Filter（异常过滤器）" class="headerlink" title="5.Exception Filter（异常过滤器）"></a>5.<strong>Exception Filter（异常过滤器）</strong></h2><p><strong>核心作用</strong>：<br>捕获 ​<strong>​未处理的异常​</strong>​，统一返回错误信息，避免敏感信息泄露。<br>​<strong>​执行顺序​</strong>​：<br>仅在发生异常时触发，优先级高于全局异常中间件。</p>
<p>实现方式：</p>
<ol>
<li><p>特性继承：继承<code>ExceptionFilterAttribute</code>，覆盖<code>OnException</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomExceptionFilter</span> : <span class="title">ExceptionFilterAttribute</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext context</span>)</span> &#123;</span><br><span class="line">        context.Result = <span class="keyword">new</span> JsonResult(<span class="keyword">new</span> &#123; Error = <span class="string">&quot;系统异常&quot;</span> &#125;);</span><br><span class="line">        context.ExceptionHandled = <span class="literal">true</span>;  <span class="comment">// 标记已处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>典型场景</strong>：</p>
<ul>
<li><p>全局异常处理（返回友好错误页）</p>
</li>
<li><p>日志记录（记录异常堆栈）</p>
</li>
</ul>
<hr>
<blockquote>
<h3 id="关键注意事项"><a href="#关键注意事项" class="headerlink" title="关键注意事项"></a><strong>关键注意事项</strong></h3><ol>
<li><p>执行顺序：整体顺序为 授权 → 资源 → 动作 → 结果，异常过滤器仅在出错时触发。</p>
</li>
<li><p>作用域优先级：Action 级别 &gt; 控制器级别 &gt; 全局级别（“就近原则”）。</p>
</li>
<li><p>生命周期配置：避免将<code>DbContext</code>等 Scoped 服务注册为 Singleton，否则可能导致线程安全问题。</p>
</li>
</ol>
<p>通过合理组合这五类过滤器，开发者可以实现 <strong>横切关注点的解耦</strong>，提升代码复用率与可维护性。例如，一个电商系统可通过授权过滤器管理权限、动作过滤器记录操作日志、异常过滤器统一处理支付失败等场景。</p>
</blockquote>
<h2 id="6-Filter-Scopes"><a href="#6-Filter-Scopes" class="headerlink" title="6.Filter Scopes"></a>6.Filter Scopes</h2><p>ASP.NET Core MVC 中的过滤器作用域（Filter Scopes）分为 <strong>Action（方法级）</strong>、<strong>Controller（控制器级）</strong> 和 <strong>Global（全局级）</strong>，它们决定了过滤器的应用范围和执行优先级。以下是三种作用域的详细说明及实际应用指导：</p>
<hr>
<h3 id="1-Action-作用域（方法级）"><a href="#1-Action-作用域（方法级）" class="headerlink" title="1. Action 作用域（方法级）"></a><strong>1. Action 作用域（方法级）</strong></h3><p><strong>定义</strong>：<br>将过滤器直接应用于 ​<strong>​单个 Action 方法​</strong>​，仅对该方法的请求处理生效。<br>​<strong>​特点​</strong>​：</p>
<ul>
<li><strong>最细粒度</strong>：精准控制某个具体方法的逻辑（如权限校验、日志记录）。</li>
<li><strong>优先级最高</strong>：在同类型过滤器中，Action 级别的逻辑最先执行。</li>
</ul>
<p><strong>配置方式</strong>：<br>在 Action 方法上通过特性（Attribute）标记：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TypeFilter(typeof(CustomActionFilter))</span>]  <span class="comment">// 手动依赖注入</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUser</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>特定方法需要独立逻辑（如某个接口需要额外权限）。</li>
<li>临时覆盖全局或控制器级别的过滤器行为。</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>若同时存在多个同类型过滤器，按声明顺序执行。</li>
<li>避免滥用，否则可能导致代码冗余。</li>
</ul>
<hr>
<h3 id="2-Controller-作用域（控制器级）"><a href="#2-Controller-作用域（控制器级）" class="headerlink" title="2. Controller 作用域（控制器级）"></a><strong>2. Controller 作用域（控制器级）</strong></h3><p><strong>定义</strong>：<br>将过滤器应用于 ​<strong>​整个 Controller 类​</strong>​，对所有属于该控制器的 Action 方法生效。<br>​<strong>​特点​</strong>​：</p>
<ul>
<li><strong>批量管理</strong>：统一处理多个方法的公共逻辑（如控制器级别的日志或权限）。</li>
<li><strong>优先级次之</strong>：在同类型过滤器中，执行顺序位于全局过滤器和 Action 过滤器之间。</li>
</ul>
<p><strong>配置方式</strong>：<br>在 Controller 类上添加特性：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(Roles = <span class="string">&quot;Admin&quot;</span>)</span>]  <span class="comment">// 该控制器下所有 Action 仅允许管理员访问</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AdminController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Action 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>控制器内所有方法共享的权限控制（如管理员专属模块）。</li>
<li>统一处理模型验证或异常捕获（如整个订单模块的异常处理）。</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>若某个 Action 需要排除控制器级过滤器，可使用 <code>[AllowAnonymous]</code> 等特性覆盖。</li>
<li>控制器级过滤器会影响所有派生类（除非子类显式重写）。</li>
</ul>
<hr>
<h3 id="3-Global-作用域（全局级）"><a href="#3-Global-作用域（全局级）" class="headerlink" title="3. Global 作用域（全局级）"></a><strong>3. Global 作用域（全局级）</strong></h3><p><strong>定义</strong>：<br>将过滤器注册为 ​<strong>​全局应用级别​</strong>​，对所有 Controller 和 Action 方法生效。<br>​<strong>​特点​</strong>​：</p>
<ul>
<li><strong>最广泛覆盖</strong>：适用于全站通用逻辑（如全局异常处理、请求日志）。</li>
<li><strong>优先级最低</strong>：在同类型过滤器中，全局过滤器最后执行。</li>
</ul>
<p><strong>配置方式</strong>：<br>在 <code>Program.cs</code> 或 <code>Startup.cs</code> 中全局注册：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加全局异常过滤器</span></span><br><span class="line">builder.Services.AddControllersWithViews(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.Filters.Add&lt;GlobalExceptionFilter&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>统一错误处理（返回标准化错误 JSON）。</li>
<li>全站请求日志记录（记录每个请求的耗时和参数）。</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>谨慎注册全局过滤器，避免性能损耗（如频繁的日志写入）。</li>
<li>可通过 <code>[AllowAnonymous]</code> 或自定义逻辑跳过全局过滤器。</li>
</ul>
<hr>
<h3 id="三者的执行顺序与优先级"><a href="#三者的执行顺序与优先级" class="headerlink" title="三者的执行顺序与优先级"></a><strong>三者的执行顺序与优先级</strong></h3><p>在请求处理管道中，同类型过滤器的执行顺序为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Global → Controller → Action  </span><br></pre></td></tr></table></figure>

<p>但实际顺序还受过滤器类型影响（如授权过滤器始终最先执行）。<br>​<strong>​示例​</strong>​：</p>
<ul>
<li>若全局、控制器、Action 均注册了 <code>ActionFilter</code>，执行顺序为：<br><code>Global → Controller → Action</code>（OnActionExecuting）<br>然后反向执行 <code>OnActionExecuted</code>：<code>Action → Controller → Global</code>。</li>
</ul>
<hr>
<h3 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a><strong>对比总结</strong></h3><table>
<thead>
<tr>
<th align="center"><strong>作用域</strong></th>
<th align="center"><strong>应用范围</strong></th>
<th align="center"><strong>优先级</strong></th>
<th align="center"><strong>典型用途</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Global</strong></td>
<td align="center">整个应用程序</td>
<td align="center">最低</td>
<td align="center">全局异常处理、日志记录、跨域配置</td>
</tr>
<tr>
<td align="center"><strong>Controller</strong></td>
<td align="center">单个控制器及其所有 Action</td>
<td align="center">中</td>
<td align="center">模块化权限控制（如管理员专属控制器）</td>
</tr>
<tr>
<td align="center"><strong>Action</strong></td>
<td align="center">单个 Action 方法</td>
<td align="center">最高</td>
<td align="center">精细校验（如特定接口的限流或参数校验）</td>
</tr>
</tbody></table>
<hr>
<h3 id="实际应用建议"><a href="#实际应用建议" class="headerlink" title="实际应用建议"></a><strong>实际应用建议</strong></h3><ol>
<li><strong>按需选择作用域</strong>：<ul>
<li>优先使用 <strong>Controller 或 Action 级别</strong>，避免全局过滤器过度侵入代码。</li>
<li>全局过滤器适用于必须全站生效的逻辑（如安全防护）。</li>
</ul>
</li>
<li><strong>灵活组合使用</strong>：<ul>
<li>例如，全局处理异常 + 控制器级权限控制 + Action 级日志记录。</li>
</ul>
</li>
<li><strong>注意生命周期</strong>：<ul>
<li>全局过滤器若依赖 Scoped 服务（如 DbContext），需显式配置作用域。</li>
</ul>
</li>
</ol>
<p>通过合理使用三种作用域，您可以高效管理横切关注点（Cross-Cutting Concerns），构建高内聚、低耦合的 ASP.NET Core MVC 应用。</p>
<h2 id="7-代码实现"><a href="#7-代码实现" class="headerlink" title="7.代码实现"></a>7.代码实现</h2><h3 id="AddHeaderFilter-cs"><a href="#AddHeaderFilter-cs" class="headerlink" title="AddHeaderFilter.cs"></a>AddHeaderFilter.cs</h3><p>Filters&#x2F;AddHeaderFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// AddHeaderFilter 类，同时作为特性(Attribute)和结果过滤器(IResultFilter)</span></span><br><span class="line">    <span class="comment">// 作为特性可以通过标注方式应用于控制器或动作方法</span></span><br><span class="line">    <span class="comment">// 实现 IResultFilter 接口可以在结果执行前后进行拦截处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AddHeaderFilter</span> : <span class="title">Attribute</span>, <span class="title">IResultFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 要添加的 HTTP 头名称属性</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 要添加的 HTTP 头值属性</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResultFilter 接口的 OnResultExecuted 方法</span></span><br><span class="line">        <span class="comment">// 在结果执行完成后调用，本例中不需要任何操作，所以方法体为空</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResultExecuted</span>(<span class="params">ResultExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 结果执行后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResultFilter 接口的 OnResultExecuting 方法</span></span><br><span class="line">        <span class="comment">// 在结果执行前调用，用于添加 HTTP 响应头</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResultExecuting</span>(<span class="params">ResultExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 进行一系列检查，确保可以安全地添加响应头：</span></span><br><span class="line">            <span class="comment">// 1. 确保响应对象不为空</span></span><br><span class="line">            <span class="comment">// 2. 确保名称和值属性已设置</span></span><br><span class="line">            <span class="comment">// 3. 确保响应头集合不为空</span></span><br><span class="line">            <span class="comment">// 4. 确保不重复添加同名的响应头</span></span><br><span class="line">            <span class="keyword">if</span> (context.HttpContext.Response != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="keyword">this</span>.Name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="keyword">this</span>.Value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                context.HttpContext.Response.Headers <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                !context.HttpContext.Response.Headers.ContainsKey(<span class="keyword">this</span>.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 向 HTTP 响应中添加指定的头信息</span></span><br><span class="line">                context.HttpContext.Response.Headers.Add(Name, Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EndpointExpiresFilter-cs"><a href="#EndpointExpiresFilter-cs" class="headerlink" title="EndpointExpiresFilter.cs"></a>EndpointExpiresFilter.cs</h3><p>Filters&#x2F;EndpointExpiresFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// EndpointExpiresFilter 类，同时作为特性(Attribute)和资源过滤器(IResourceFilter)</span></span><br><span class="line">    <span class="comment">// 作为特性可以通过标注方式应用于控制器或动作方法</span></span><br><span class="line">    <span class="comment">// 实现 IResourceFilter 接口可以在资源执行前后进行拦截处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EndpointExpiresFilter</span> : <span class="title">Attribute</span>, <span class="title">IResourceFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 过期日期属性，可以在应用过滤器时设置</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ExpiryDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResourceFilter 接口的 OnResourceExecuting 方法</span></span><br><span class="line">        <span class="comment">// 在资源执行前调用，用于检查端点是否已过期</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuting</span>(<span class="params">ResourceExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 尝试将字符串类型的过期日期转换为 DateTime 类型</span></span><br><span class="line">            <span class="keyword">if</span> (DateTime.TryParse(ExpiryDate, <span class="keyword">out</span> DateTime expiryDate))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果当前时间已经超过了过期日期</span></span><br><span class="line">                <span class="keyword">if</span> (DateTime.Now &gt; expiryDate) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 设置结果为 400 Bad Request，阻止进一步的处理</span></span><br><span class="line">                    <span class="comment">// 这会导致请求立即终止，返回 400 状态码</span></span><br><span class="line">                    context.Result = <span class="keyword">new</span> BadRequestResult();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResourceFilter 接口的 OnResourceExecuted 方法</span></span><br><span class="line">        <span class="comment">// 在资源执行后调用，本例中不需要任何操作，所以方法体为空</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuted</span>(<span class="params">ResourceExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 资源执行后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EnsureDepartmentExistsFilter-cs"><a href="#EnsureDepartmentExistsFilter-cs" class="headerlink" title="EnsureDepartmentExistsFilter.cs"></a>EnsureDepartmentExistsFilter.cs</h3><p>Filters&#x2F;EnsureDepartmentExistsFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="comment">// 引入辅助类命名空间，用于处理模型状态错误</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Helpers;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间，用于访问部门仓储接口</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保部门存在的过滤器，继承自 ActionFilterAttribute</span></span><br><span class="line">    <span class="comment">// 这种方式比实现接口更方便，因为基类已经实现了所有接口方法，我们只需重写需要的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnsureDepartmentExistsFilter</span>: <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重写 OnActionExecuting 方法，在控制器动作执行前调用</span></span><br><span class="line">        <span class="comment">// 用于验证请求的部门是否存在</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 调用基类方法，确保基本功能正常</span></span><br><span class="line">            <span class="keyword">base</span>.OnActionExecuting(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从动作参数中获取部门ID</span></span><br><span class="line">            <span class="comment">// 这里假设动作方法有一个名为&quot;id&quot;的参数，并且可以转换为int类型</span></span><br><span class="line">            <span class="keyword">var</span> departmentId = (<span class="built_in">int</span>)context.ActionArguments[<span class="string">&quot;id&quot;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用依赖注入从请求服务中获取部门仓储服务</span></span><br><span class="line">            <span class="keyword">var</span> departmentsRepository = context.HttpContext.RequestServices.GetService&lt;IDepartmentsRepository&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查部门是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (!departmentsRepository.DepartmentExists(departmentId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果部门不存在，添加模型错误</span></span><br><span class="line">                context.ModelState.AddModelError(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;Department not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建视图结果，指定使用&quot;Error&quot;视图</span></span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">new</span> ViewResult &#123; ViewName = <span class="string">&quot;Error&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取当前控制器实例</span></span><br><span class="line">                <span class="keyword">var</span> controller = context.Controller <span class="keyword">as</span> Controller;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 复制控制器的ViewData到结果中，保留已有的视图数据</span></span><br><span class="line">                result.ViewData = controller.ViewData;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置模型为模型状态错误列表，使用辅助方法提取错误</span></span><br><span class="line">                result.ViewData.Model = ModelStateHelper.GetErrors(context.ModelState);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置操作结果，中断正常的执行流程，转而显示错误视图</span></span><br><span class="line">                context.Result = result; </span><br><span class="line"></span><br><span class="line">                <span class="comment">// 下面是注释掉的原始控制器代码，作为参考</span></span><br><span class="line">                <span class="comment">// 在过滤器中，我们需要以不同方式处理，因为这里没有直接的ModelState和View方法</span></span><br><span class="line">                <span class="comment">//ModelState.AddModelError(&quot;id&quot;, &quot;Department not found.&quot;);</span></span><br><span class="line">                <span class="comment">//return View(&quot;Error&quot;, ModelStateHelper.GetErrors(ModelState));</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EnsureEmployeeExistsPageFilter-cs"><a href="#EnsureEmployeeExistsPageFilter-cs" class="headerlink" title="EnsureEmployeeExistsPageFilter.cs"></a>EnsureEmployeeExistsPageFilter.cs</h3><p>Filters&#x2F;EnsureEmployeeExistsPageFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="comment">// 引入辅助类命名空间，用于处理模型状态错误</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Helpers;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间，用于访问员工仓储接口</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"><span class="comment">// 引入员工页面命名空间，访问相关页面模型</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Pages.Employees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保员工存在的页面过滤器，同时作为特性(Attribute)和页面过滤器(IPageFilter)</span></span><br><span class="line">    <span class="comment">// 用于Razor Pages场景下验证员工是否存在</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnsureEmployeeExistsPageFilter</span> : <span class="title">Attribute</span>, <span class="title">IPageFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerExecuted 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序执行后调用，本例中不需要任何操作，所以方法体为空</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerExecuted</span>(<span class="params">PageHandlerExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 页面处理程序执行后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerExecuting 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序执行前调用，用于验证员工是否存在</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerExecuting</span>(<span class="params">PageHandlerExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果当前处理程序是OnGet方法，直接返回，不做验证</span></span><br><span class="line">            <span class="comment">// 这是因为GET请求通常是初始加载页面，此时可能还没有指定员工ID</span></span><br><span class="line">            <span class="keyword">if</span> (context.HandlerMethod <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> &amp;&amp; context.HandlerMethod.MethodInfo.Name == <span class="string">&quot;OnGet&quot;</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用依赖注入从请求服务中获取员工仓储服务</span></span><br><span class="line">            <span class="keyword">var</span> employeeRespository = context.HttpContext.RequestServices.GetService&lt;IEmployeesRepository&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试获取员工ID，可能来自两个不同的来源</span></span><br><span class="line">            <span class="built_in">object</span>? employeeId;</span><br><span class="line">            <span class="keyword">if</span> (context.HandlerArguments.ContainsKey(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">                <span class="comment">// 如果处理程序参数中包含id，直接使用它</span></span><br><span class="line">                employeeId = context.HandlerArguments[<span class="string">&quot;id&quot;</span>];</span><br><span class="line">            <span class="keyword">else</span>            </span><br><span class="line">                <span class="comment">// 否则，从页面模型中提取员工ID（适用于编辑场景）</span></span><br><span class="line">                employeeId = ((EditModel)context.HandlerInstance).EmployeeViewModel.Employee.Id;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查员工是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (!employeeRespository.EmployeeExists((<span class="built_in">int</span>)employeeId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果员工不存在，添加模型错误</span></span><br><span class="line">                context.ModelState.AddModelError(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;Employee not found.&quot;</span>);</span><br><span class="line">                <span class="comment">// 使用辅助方法提取模型状态错误</span></span><br><span class="line">                <span class="keyword">var</span> errors = ModelStateHelper.GetErrors(context.ModelState);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置结果为重定向到错误页面，并传递错误信息</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> RedirectToPageResult(<span class="string">&quot;/Error&quot;</span>, <span class="keyword">new</span> &#123; errors &#125;);</span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerSelected 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序被选择后、执行前调用，本例中不需要任何操作</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerSelected</span>(<span class="params">PageHandlerSelectedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 页面处理程序选择后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EnsureValidModelStateFilter-cs"><a href="#EnsureValidModelStateFilter-cs" class="headerlink" title="EnsureValidModelStateFilter.cs"></a>EnsureValidModelStateFilter.cs</h3><p>Filters&#x2F;EnsureValidModelStateFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="comment">// 引入辅助类命名空间，用于处理模型状态错误</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Helpers;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保模型状态有效的过滤器，继承自 ActionFilterAttribute</span></span><br><span class="line">    <span class="comment">// 该过滤器用于在控制器动作执行前验证模型状态是否有效</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnsureValidModelStateFilter</span> : <span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重写 OnActionExecuting 方法，在控制器动作执行前调用</span></span><br><span class="line">        <span class="comment">// 用于验证模型状态是否有效</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 调用基类方法，确保基本功能正常</span></span><br><span class="line">            <span class="keyword">base</span>.OnActionExecuting(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查模型状态是否有效</span></span><br><span class="line">            <span class="keyword">if</span> (!context.ModelState.IsValid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果模型状态无效，创建一个视图结果，指定使用&quot;Error&quot;视图</span></span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">new</span> ViewResult &#123; ViewName = <span class="string">&quot;Error&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取当前控制器实例</span></span><br><span class="line">                <span class="keyword">var</span> controller = context.Controller <span class="keyword">as</span> Controller;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 复制控制器的ViewData到结果中，保留已有的视图数据</span></span><br><span class="line">                result.ViewData = controller.ViewData;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置模型为模型状态错误列表，使用辅助方法提取错误</span></span><br><span class="line">                result.ViewData.Model = ModelStateHelper.GetErrors(context.ModelState);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置操作结果，中断正常的执行流程，转而显示错误视图</span></span><br><span class="line">                context.Result = result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EnsureValidModelStatePageFilter-cs"><a href="#EnsureValidModelStatePageFilter-cs" class="headerlink" title="EnsureValidModelStatePageFilter.cs"></a>EnsureValidModelStatePageFilter.cs</h3><p>Filters&#x2F;EnsureValidModelStatePageFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="comment">// 引入辅助类命名空间，用于处理模型状态错误</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Helpers;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保模型状态有效的页面过滤器，同时作为特性(Attribute)和页面过滤器(IPageFilter)</span></span><br><span class="line">    <span class="comment">// 用于Razor Pages场景下验证模型状态是否有效</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnsureValidModelStatePageFilter</span> : <span class="title">Attribute</span>, <span class="title">IPageFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerExecuted 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序执行后调用，本例中不需要任何操作，所以方法体为空</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerExecuted</span>(<span class="params">PageHandlerExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 页面处理程序执行后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerExecuting 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序执行前调用，用于验证模型状态是否有效</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerExecuting</span>(<span class="params">PageHandlerExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查模型状态是否有效</span></span><br><span class="line">            <span class="keyword">if</span> (!context.ModelState.IsValid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果模型状态无效，使用辅助方法提取模型状态错误</span></span><br><span class="line">                <span class="keyword">var</span> errors = ModelStateHelper.GetErrors(context.ModelState);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置结果为重定向到错误页面，并传递错误信息</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> RedirectToPageResult(<span class="string">&quot;/Error&quot;</span>, <span class="keyword">new</span> &#123; errors &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IPageFilter 接口的 OnPageHandlerSelected 方法</span></span><br><span class="line">        <span class="comment">// 在页面处理程序被选择后、执行前调用，本例中不需要任何操作</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnPageHandlerSelected</span>(<span class="params">PageHandlerSelectedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 页面处理程序选择后的逻辑，此处不需要任何处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HandleExceptionsFilter-cs"><a href="#HandleExceptionsFilter-cs" class="headerlink" title="HandleExceptionsFilter.cs"></a>HandleExceptionsFilter.cs</h3><p>Filters&#x2F;HandleExceptionsFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 异常处理过滤器，继承自 ExceptionFilterAttribute</span></span><br><span class="line">    <span class="comment">// 用于捕获并处理控制器或页面处理程序中发生的未处理异常</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HandleExceptionsFilter</span> : <span class="title">ExceptionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重写 OnException 方法，当发生未处理的异常时调用</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 调用基类方法，确保基本功能正常</span></span><br><span class="line">            <span class="keyword">base</span>.OnException(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建一个符合 RFC 7807 标准的问题详情对象</span></span><br><span class="line">            <span class="comment">// 这种格式是 RESTful API 中表示错误信息的推荐方式</span></span><br><span class="line">            <span class="keyword">var</span> error = <span class="keyword">new</span> ProblemDetails</span><br><span class="line">            &#123;</span><br><span class="line">                Title = <span class="string">&quot;An error occurred&quot;</span>, <span class="comment">// 错误的简短标题</span></span><br><span class="line">                Detail = context.Exception.ToString(), <span class="comment">// 详细的异常信息，包含堆栈跟踪</span></span><br><span class="line">                Status = <span class="number">500</span> <span class="comment">// HTTP 状态码：500 Internal Server Error</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置操作结果为包含问题详情的对象结果</span></span><br><span class="line">            context.Result = <span class="keyword">new</span> ObjectResult(error)</span><br><span class="line">            &#123;</span><br><span class="line">                StatusCode = <span class="number">500</span> <span class="comment">// 设置 HTTP 响应状态码为 500</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 标记异常为已处理，防止异常继续向上传播</span></span><br><span class="line">            <span class="comment">// 这会阻止 ASP.NET Core 的默认异常处理逻辑执行</span></span><br><span class="line">            context.ExceptionHandled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpecialAuthorizationFilter-cs"><a href="#SpecialAuthorizationFilter-cs" class="headerlink" title="SpecialAuthorizationFilter.cs"></a>SpecialAuthorizationFilter.cs</h3><p>Filters&#x2F;SpecialAuthorizationFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入基本的 MVC 命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 特殊授权过滤器，同时作为特性(Attribute)和授权过滤器(IAuthorizationFilter)</span></span><br><span class="line">    <span class="comment">// 用于实现自定义的授权逻辑，验证用户是否有权访问特定资源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SpecialAuthorizationFilter</span> : <span class="title">Attribute</span>, <span class="title">IAuthorizationFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 实现 IAuthorizationFilter 接口的 OnAuthorization 方法</span></span><br><span class="line">        <span class="comment">// 在控制器动作或页面处理程序执行前调用，用于验证用户授权</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnAuthorization</span>(<span class="params">AuthorizationFilterContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取当前请求中的用户信息</span></span><br><span class="line">            <span class="keyword">var</span> user = context.HttpContext.User;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查用户是否存在且已经过身份验证</span></span><br><span class="line">            <span class="keyword">if</span> (user <span class="keyword">is</span> <span class="literal">null</span> || user.Identity <span class="keyword">is</span> <span class="literal">null</span> || !user.Identity.IsAuthenticated)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果用户未通过身份验证，返回401 Unauthorized状态码</span></span><br><span class="line">                <span class="comment">// 这表示请求需要用户认证</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> UnauthorizedResult();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查用户是否具有特定的声明（自定义授权规则）</span></span><br><span class="line">            <span class="comment">// 这里检查用户是否有一个类型为&quot;CustomClaim&quot;且值为&quot;CustomValue&quot;的声明</span></span><br><span class="line">            <span class="keyword">if</span> (!user.HasClaim(c =&gt; c.Type == <span class="string">&quot;CustomClaim&quot;</span> &amp;&amp; c.Value == <span class="string">&quot;CustomValue&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果用户没有所需声明，返回403 Forbidden状态码</span></span><br><span class="line">                <span class="comment">// 这表示服务器理解请求但拒绝授权</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> ForbidResult();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WriteToConsoleResourceFilter-cs"><a href="#WriteToConsoleResourceFilter-cs" class="headerlink" title="WriteToConsoleResourceFilter.cs"></a>WriteToConsoleResourceFilter.cs</h3><p>Filters&#x2F;WriteToConsoleResourceFilter.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 MVC 过滤器相关的命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 控制台日志资源过滤器，同时实现三个接口：</span></span><br><span class="line">    <span class="comment">// 1. Attribute - 使其可作为特性应用于控制器或动作方法</span></span><br><span class="line">    <span class="comment">// 2. IResourceFilter - 资源过滤器接口，在管道早期和晚期执行</span></span><br><span class="line">    <span class="comment">// 3. IOrderedFilter - 有序过滤器接口，允许指定执行顺序</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WriteToConsoleResourceFilter</span> : <span class="title">Attribute</span>, <span class="title">IResourceFilter</span>, <span class="title">IOrderedFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 描述属性，可在应用过滤器时设置，用于标识过滤器实例</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Description &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 顺序属性，实现IOrderedFilter接口要求</span></span><br><span class="line">        <span class="comment">// 数值越小的过滤器越先执行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数，设置默认描述为&quot;Global&quot;</span></span><br><span class="line">        <span class="comment">// 这通常表示它是全局注册的过滤器实例</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WriteToConsoleResourceFilter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Description = <span class="string">&quot;Global&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResourceFilter 接口的 OnResourceExecuting 方法</span></span><br><span class="line">        <span class="comment">// 在资源执行前调用，用于记录请求开始处理的日志</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuting</span>(<span class="params">ResourceExecutingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 输出当前正在执行的动作信息到控制台</span></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Executing <span class="subst">&#123;Description&#125;</span> - <span class="subst">&#123;context.ActionDescriptor.DisplayName&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现 IResourceFilter 接口的 OnResourceExecuted 方法</span></span><br><span class="line">        <span class="comment">// 在资源执行后调用，用于记录请求完成处理的日志</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnResourceExecuted</span>(<span class="params">ResourceExecutedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 输出当前已执行完毕的动作信息到控制台</span></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Executed <span class="subst">&#123;Description&#125;</span> - <span class="subst">&#123;context.ActionDescriptor.DisplayName&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DepartmentsController-cs"><a href="#DepartmentsController-cs" class="headerlink" title="DepartmentsController.cs"></a>DepartmentsController.cs</h3><p>Controllers&#x2F;DepartmentsController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 ASP.NET Core 授权相关命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</span><br><span class="line"><span class="comment">// 引入 ASP.NET Core MVC 相关命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入自定义过滤器命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Filters;</span><br><span class="line"><span class="comment">// 引入辅助类命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Helpers;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"><span class="comment">// 引入媒体类型常量，用于内容协商</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">static</span> System.Net.Mime.MediaTypeNames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 为整个控制器应用控制台日志资源过滤器，跟踪所有动作方法的执行</span></span><br><span class="line">    [<span class="meta">WriteToConsoleResourceFilter(Description = <span class="string">&quot;Departments Controller&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DepartmentsController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 部门仓储接口的私有字段</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDepartmentsRepository departmentsRepository;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数，通过依赖注入接收部门仓储实例</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DepartmentsController</span>(<span class="params">IDepartmentsRepository departmentsRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.departmentsRepository = departmentsRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理GET请求的Index动作方法，显示部门列表页面</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="comment">// 应用资源过滤器，设置描述和高优先级顺序(-1值使其较早执行)</span></span><br><span class="line">        [<span class="meta">WriteToConsoleResourceFilter(Description = <span class="string">&quot;Index Method&quot;</span>, Order = -1)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="comment">// 返回默认的Index视图</span></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以下是被注释掉的部门搜索方法，使用了部分视图实现</span></span><br><span class="line">        <span class="comment">//[Route(&quot;/department-list/&#123;filter?&#125;&quot;)]</span></span><br><span class="line">        <span class="comment">//public IActionResult SearchDepartments(string? filter)</span></span><br><span class="line">        <span class="comment">//&#123;   </span></span><br><span class="line">        <span class="comment">//    var departments = departmentsRepository.GetDepartments(filter);</span></span><br><span class="line">        <span class="comment">//    return PartialView(&quot;_DepartmentList&quot;, departments);</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理部门搜索请求的动作方法，使用视图组件实现</span></span><br><span class="line">        [<span class="meta">Route(<span class="string">&quot;/department-list/&#123;filter?&#125;&quot;</span>)</span>] <span class="comment">// 自定义路由，filter参数可选</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">SearchDepartments</span>(<span class="params"><span class="built_in">string</span>? filter</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 返回DepartmentList视图组件，传递filter参数</span></span><br><span class="line">            <span class="keyword">return</span> ViewComponent(<span class="string">&quot;DepartmentList&quot;</span>, <span class="keyword">new</span> &#123; filter &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理GET请求的Details动作方法，显示部门详情</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="comment">// 应用过期过滤器，设置此API端点的过期日期</span></span><br><span class="line">        [<span class="meta">EndpointExpiresFilter(ExpiryDate = <span class="string">&quot;2028-01-18&quot;</span>)</span>]</span><br><span class="line">        <span class="comment">// 应用确保部门存在的过滤器，在执行前验证部门是否存在</span></span><br><span class="line">        [<span class="meta">EnsureDepartmentExistsFilter</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取指定ID的部门</span></span><br><span class="line">            <span class="keyword">var</span> department = departmentsRepository.GetDepartmentById(id);            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回Details视图，传递部门对象作为模型</span></span><br><span class="line">            <span class="keyword">return</span> View(department);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理POST请求的Edit动作方法，更新部门信息</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="comment">// 应用模型状态验证过滤器，确保提交的数据有效</span></span><br><span class="line">        [<span class="meta">EnsureValidModelStateFilter</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Edit</span>(<span class="params">Department department</span>)</span></span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">// 更新部门信息</span></span><br><span class="line">            departmentsRepository.UpdateDepartment(department);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重定向到Index动作方法</span></span><br><span class="line">            <span class="keyword">return</span> RedirectToAction(<span class="keyword">nameof</span>(Index));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理GET请求的Create动作方法，显示创建部门表单</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Create</span>()</span></span><br><span class="line">        &#123;           </span><br><span class="line">            <span class="comment">// 返回Create视图，传递一个新的部门对象作为模型</span></span><br><span class="line">            <span class="keyword">return</span> View(<span class="keyword">new</span> Department());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理POST请求的Create动作方法，创建新部门</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="comment">// 应用模型状态验证过滤器，确保提交的数据有效</span></span><br><span class="line">        [<span class="meta">EnsureValidModelStateFilter</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Create</span>(<span class="params">Department department</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 添加新部门</span></span><br><span class="line">            departmentsRepository.AddDepartment(department);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重定向到Index动作方法</span></span><br><span class="line">            <span class="keyword">return</span> RedirectToAction(<span class="keyword">nameof</span>(Index));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理POST请求的Delete动作方法，删除部门</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="comment">// 应用确保部门存在的过滤器，在执行前验证部门是否存在</span></span><br><span class="line">        [<span class="meta">EnsureDepartmentExistsFilter</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Delete</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取指定ID的部门</span></span><br><span class="line">            <span class="keyword">var</span> department = departmentsRepository.GetDepartmentById(id);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 删除部门</span></span><br><span class="line">            departmentsRepository.DeleteDepartment(department);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重定向到Index动作方法</span></span><br><span class="line">            <span class="keyword">return</span> RedirectToAction(<span class="keyword">nameof</span>(Index));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理GET请求的GetDepartments动作方法，返回所有部门的JSON数据</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="comment">// 应用异常处理过滤器，捕获并处理未处理的异常</span></span><br><span class="line">        [<span class="meta">HandleExceptionsFilter</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetDepartments</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 异常测试代码（已注释）</span></span><br><span class="line">            <span class="comment">//throw new ApplicationException(&quot;Testing exception handling for web api endpoints.&quot;);</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取所有部门</span></span><br><span class="line">            <span class="keyword">var</span> departments = departmentsRepository.GetDepartments();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将部门列表序列化为JSON并返回</span></span><br><span class="line">            <span class="keyword">return</span> Json(departments);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HomeController-cs"><a href="#HomeController-cs" class="headerlink" title="HomeController.cs"></a>HomeController.cs</h3><p>Controllers&#x2F;HomeController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 ASP.NET Core MVC 相关命名空间</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="comment">// 引入自定义过滤器命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApp.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 为整个控制器应用添加HTTP头过滤器</span></span><br><span class="line">    <span class="comment">// 这将为所有从该控制器返回的响应添加一个名为&quot;MyHeader&quot;值为&quot;MyValue&quot;的HTTP头</span></span><br><span class="line">    [<span class="meta">AddHeaderFilter(Name = <span class="string">&quot;MyHeader&quot;</span>, Value = <span class="string">&quot;MyValue&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 处理默认请求的Index动作方法，显示首页</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 返回默认的Index视图</span></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Program-cs"><a href="#Program-cs" class="headerlink" title="Program.cs"></a>Program.cs</h3><p>Program.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入自定义过滤器命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Filters;</span><br><span class="line"><span class="comment">// 引入数据模型命名空间</span></span><br><span class="line"><span class="keyword">using</span> WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ASP.NET Core 应用程序构建器实例</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加 MVC 控制器和视图服务</span></span><br><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line"><span class="comment">// 添加 Razor Pages 服务，并配置 MVC 选项</span></span><br><span class="line">builder.Services.AddRazorPages().AddMvcOptions(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 全局注册控制台日志资源过滤器，将在每个请求中执行</span></span><br><span class="line">    options.Filters.Add&lt;WriteToConsoleResourceFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册部门仓储服务，使用单例模式（整个应用程序生命周期内使用同一实例）</span></span><br><span class="line">builder.Services.AddSingleton&lt;IDepartmentsRepository, DepartmentsRepository&gt;();</span><br><span class="line"><span class="comment">// 注册员工仓储服务，使用单例模式</span></span><br><span class="line">builder.Services.AddSingleton&lt;IEmployeesRepository, EmployeesRepository&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建应用程序实例</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用静态文件中间件，并配置响应头</span></span><br><span class="line">app.UseStaticFiles(<span class="keyword">new</span> StaticFileOptions</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 为静态文件配置响应准备事件处理程序</span></span><br><span class="line">    OnPrepareResponse = ctx =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 添加缓存控制头，设置公共缓存最长时间为600秒（10分钟）</span></span><br><span class="line">        ctx.Context.Response.Headers.Append(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;public,max-age=600&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加过期时间头，设置为10分钟后</span></span><br><span class="line">        ctx.Context.Response.Headers.Append(<span class="string">&quot;Expires&quot;</span>, DateTime.UtcNow.AddMinutes(<span class="number">10</span>).ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用路由中间件</span></span><br><span class="line">app.UseRouting();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置终结点路由</span></span><br><span class="line">app.UseEndpoints(endpoints =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 配置默认的控制器路由</span></span><br><span class="line">    <span class="comment">// name: 路由名称</span></span><br><span class="line">    <span class="comment">// pattern: 路由模式，格式为&quot;&#123;控制器&#125;/&#123;动作&#125;/&#123;可选id&#125;&quot;</span></span><br><span class="line">    <span class="comment">// 默认控制器为Home，默认动作为Index，id参数可选</span></span><br><span class="line">    endpoints.MapControllerRoute(</span><br><span class="line">        name: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        pattern: <span class="string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 映射Razor页面路由</span></span><br><span class="line">    endpoints.MapRazorPages();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用程序，开始监听请求</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p><img src="/NET-ASP-10/image-20250418095855989.png" alt="image-20250418095855989"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/04/16/NET-ASP-10/">https://alsl521.github.io/2025/04/16/NET-ASP-10/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/15/Software/" title="记录必备软件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">记录必备软件</div></div><div class="info-2"><div class="info-item-1">1、PC v2rayN  地址：https://github.com/2dust/v2rayN potplayer（LAV+MAD） 地址：https://potplayer.daum.net/ Bandizip 地址：https://www.bandisoft.com/bandizip/ qbittorrent 地址：https://github.com/c0re100/qBittorrent-Enhanced-Edition Uninstall Tool  2、手机 v2rayNG  地址：https://github.com/2dust/v2rayNG  </div></div></div></a><a class="pagination-related" href="/2025/04/18/NET-ASP-11/" title="ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API</div></div><div class="info-2"><div class="info-item-1">1、初始化项目本实践将创建以下 API：     API 说明 请求正文 响应正文    GET /api/todoitems 获取所有待办事项 无 待办事项的数组   GET /api/todoitems/&#123;id&#125; 按 ID 获取项 无 待办事项   POST /api/todoitems 添加新项 待办事项 待办事项   PUT /api/todoitems/&#123;id&#125; 更新现有项 待办事项 无   DELETE /api/todoitems/&#123;id&#125; 删除项 无 无   1.初始化项目首先要确保安装必备的相关内容，即ASP.NET和Web开发。  在此基础上，创建项目：  首先选择合理的项目模板   随后选择并输入名称，具体内容随意   依据需求选择，本次不使用HTTPS，随后创建项目。    2.项目内容介绍：  该项目是一个典型的 ASP.NET Core Web 应用项目，采用标准的 MVC（模型-视图-控制器）分层架构。  1. 项目整体架构 分层逻辑： 控制器（Controllers）：处理 HTTP...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-03-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-03-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/14/NET-ASP-06/" title="ASP.NET学习记录-06-最小API结果生产"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="info-item-2">ASP.NET学习记录-06-最小API结果生产</div></div><div class="info-2"><div class="info-item-1">本次学习基础代码如下： Employee.cs 12345678910111213141516171819202122232425262728293031323334353637383940414243444546using System.ComponentModel.DataAnnotations;namespace WebApi.Models&#123;    /// &lt;summary&gt;    /// 员工实体类    /// &lt;/summary&gt;    public class Employee    &#123;        /// &lt;summary&gt;        /// 员工唯一标识符        /// &lt;/summary&gt;        public int Id &#123; get; set; &#125;        /// &lt;summary&gt;        /// 员工姓名        /// &lt;/summary&gt;        public string Name...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81ASP-NET-Core-%E4%B8%AD%E7%9A%84%E8%BF%87%E6%BB%A4%E7%AE%A1%E9%81%93"><span class="toc-number">1.</span> <span class="toc-text">一、ASP.NET Core 中的过滤管道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%87%E6%BB%A4%E7%AE%A1%E9%81%93%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">1. 什么是过滤管道？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%BF%87%E6%BB%A4%E7%AE%A1%E9%81%93%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 为什么需要过滤管道？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.</span> <span class="toc-text">3. 实际应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%BF%87%E6%BB%A4%E7%AE%A1%E9%81%93%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">1.4.</span> <span class="toc-text">4. 过滤管道与中间件的对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%9C%80%E5%B0%8FAPI%E6%A8%A1%E5%BC%8FFilter"><span class="toc-number">2.</span> <span class="toc-text">二、最小API模式Filter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81MVC%E6%A8%A1%E5%BC%8FFilter"><span class="toc-number">3.</span> <span class="toc-text">三、MVC模式Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Authorization-Filter%EF%BC%88%E6%8E%88%E6%9D%83%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">1.Authorization Filter（授权过滤器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Resource-Filter%EF%BC%88%E8%B5%84%E6%BA%90%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">2.Resource Filter（资源过滤器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Action-Filter%EF%BC%88%E5%8A%A8%E4%BD%9C%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.Action Filter（动作过滤器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Result-Filter%EF%BC%88%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">4.Result Filter（结果过滤器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Exception-Filter%EF%BC%88%E5%BC%82%E5%B8%B8%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">3.5.</span> <span class="toc-text">5.Exception Filter（异常过滤器）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">3.5.1.</span> <span class="toc-text">关键注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Filter-Scopes"><span class="toc-number">3.6.</span> <span class="toc-text">6.Filter Scopes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Action-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88%E6%96%B9%E6%B3%95%E7%BA%A7%EF%BC%89"><span class="toc-number">3.6.1.</span> <span class="toc-text">1. Action 作用域（方法级）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Controller-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88%E6%8E%A7%E5%88%B6%E5%99%A8%E7%BA%A7%EF%BC%89"><span class="toc-number">3.6.2.</span> <span class="toc-text">2. Controller 作用域（控制器级）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Global-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88%E5%85%A8%E5%B1%80%E7%BA%A7%EF%BC%89"><span class="toc-number">3.6.3.</span> <span class="toc-text">3. Global 作用域（全局级）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E8%80%85%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E4%B8%8E%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.6.4.</span> <span class="toc-text">三者的执行顺序与优先级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="toc-number">3.6.5.</span> <span class="toc-text">对比总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.6.6.</span> <span class="toc-text">实际应用建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.7.</span> <span class="toc-text">7.代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AddHeaderFilter-cs"><span class="toc-number">3.7.1.</span> <span class="toc-text">AddHeaderFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EndpointExpiresFilter-cs"><span class="toc-number">3.7.2.</span> <span class="toc-text">EndpointExpiresFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnsureDepartmentExistsFilter-cs"><span class="toc-number">3.7.3.</span> <span class="toc-text">EnsureDepartmentExistsFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnsureEmployeeExistsPageFilter-cs"><span class="toc-number">3.7.4.</span> <span class="toc-text">EnsureEmployeeExistsPageFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnsureValidModelStateFilter-cs"><span class="toc-number">3.7.5.</span> <span class="toc-text">EnsureValidModelStateFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnsureValidModelStatePageFilter-cs"><span class="toc-number">3.7.6.</span> <span class="toc-text">EnsureValidModelStatePageFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HandleExceptionsFilter-cs"><span class="toc-number">3.7.7.</span> <span class="toc-text">HandleExceptionsFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpecialAuthorizationFilter-cs"><span class="toc-number">3.7.8.</span> <span class="toc-text">SpecialAuthorizationFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WriteToConsoleResourceFilter-cs"><span class="toc-number">3.7.9.</span> <span class="toc-text">WriteToConsoleResourceFilter.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DepartmentsController-cs"><span class="toc-number">3.7.10.</span> <span class="toc-text">DepartmentsController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HomeController-cs"><span class="toc-number">3.7.11.</span> <span class="toc-text">HomeController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Program-cs"><span class="toc-number">3.7.12.</span> <span class="toc-text">Program.cs</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-12/" title="ASP.NET学习记录-12-实践2-使用MySQL数据库">ASP.NET学习记录-12-实践2-使用MySQL数据库</a><time datetime="2025-04-18T08:11:21.000Z" title="发表于 2025-04-18 16:11:21">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/18/NET-ASP-11/" title="ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API">ASP.NET学习记录-11-实践1-使用 ASP.NET Core 生成基于控制器的 Web API</a><time datetime="2025-04-18T02:13:44.000Z" title="发表于 2025-04-18 10:13:44">2025-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/16/NET-ASP-10/" title="ASP.NET学习记录-10-过滤">ASP.NET学习记录-10-过滤</a><time datetime="2025-04-16T12:02:16.000Z" title="发表于 2025-04-16 20:02:16">2025-04-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/15/Software/" title="记录必备软件">记录必备软件</a><time datetime="2025-04-15T11:29:21.000Z" title="发表于 2025-04-15 19:29:21">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>