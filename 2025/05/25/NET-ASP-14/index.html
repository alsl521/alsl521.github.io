<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ASP.NET学习记录-14-实战-Day01 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET学习记录-14-实战-Day01">
<meta property="og:url" content="https://alsl521.github.io/2025/05/25/NET-ASP-14/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-05-25T12:02:17.000Z">
<meta property="article:modified_time" content="2025-05-26T11:25:55.717Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASP.NET学习记录-14-实战-Day01",
  "url": "https://alsl521.github.io/2025/05/25/NET-ASP-14/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-05-25T12:02:17.000Z",
  "dateModified": "2025-05-26T11:25:55.717Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/05/25/NET-ASP-14/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ASP.NET学习记录-14-实战-Day01',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ASP.NET学习记录-14-实战-Day01</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ASP.NET学习记录-14-实战-Day01</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-25T12:02:17.000Z" title="发表于 2025-05-25 20:02:17">2025-05-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-26T11:25:55.717Z" title="更新于 2025-05-26 19:25:55">2025-05-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、项目简介"><a href="#1、项目简介" class="headerlink" title="1、项目简介"></a>1、项目简介</h1><p>本项目为学习项目，由哔哩哔哩<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av315565756?p=1">黑马程序员Java项目实战《苍穹外卖》，最适合新手的SpringBoot+SSM的企业级Java项目实战</a>为蓝本，将所有代码更改为ASP.NET Core 6.0，构建单体应用。</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525201603559.png" alt="image-20250525201603559"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525201654787.png" alt="image-20250525201654787"></p>
<h1 id="2、数据准备"><a href="#2、数据准备" class="headerlink" title="2、数据准备"></a>2、数据准备</h1><p>依据资料，将所需内容进行基准准备。</p>
<p>在搭建数据库时，为进行模拟，使用Docker Hub模拟Linux中的构建与使用</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525201751571.png" alt="image-20250525201751571"></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql -d -p <span class="number">33061</span>:<span class="number">3306</span> --restart unless-stopped -e MYSQL_ROOT_PASSWORD=mysql mysql</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250525202013861.png" alt="image-20250525202013861"></p>
<p>并且使用工具导入sql脚本，从而构建数据库。</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525202134024.png" alt="image-20250525202134024"></p>
<h1 id="3、内容初步重构"><a href="#3、内容初步重构" class="headerlink" title="3、内容初步重构"></a>3、内容初步重构</h1><p>依据给的初始资料，将内容进行初步重构。首先创建各类相关文件夹，随后将SkyPojo中的内容全部重建。</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525202507664.png" alt="image-20250525202507664"></p>
<h2 id="1、数据库重构"><a href="#1、数据库重构" class="headerlink" title="1、数据库重构"></a>1、数据库重构</h2><p>由于ASP.NET Core中并不像Java一样，因此构建<code>SkyDbContext.cs</code>，负责与MySQL数据库的交互，管理实体到数据库表的映射关系。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.config</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 天空外卖数据库上下文类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类继承自DbContext，作为Entity Framework Core的核心组件，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 负责与MySQL数据库的交互，管理实体到数据库表的映射关系。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供实体集合的访问和跟踪变更，支持CRUD操作和事务管理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkyDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入接收数据库配置</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 接收ASP.NET Core依赖注入系统提供的配置参数，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包含数据库连接字符串、提供程序设置等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;options&quot;&gt;</span>数据库上下文配置选项<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SkyDbContext</span>(<span class="params">DbContextOptions&lt;SkyDbContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 实体集合定义</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 地址簿实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的address_book表，存储用户配送地址信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;AddressBook&gt; AddressBooks &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的category表，存储菜品和套餐分类<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Category&gt; Categories &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的dish表，存储菜品基本信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Dish&gt; Dishes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品口味实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的dish_flavor表，存储菜品的口味选项<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;DishFlavor&gt; DishFlavors &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的employee表，存储系统员工账户信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Employee&gt; Employees &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 订单详情实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的order_detail表，存储订单中的菜品明细<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;OrderDetail&gt; OrderDetails &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 订单实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的orders表，存储用户订单主体信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Orders&gt; Orders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的setmeal表，存储套餐基本信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Setmeal&gt; Setmeals &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐菜品关系实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的setmeal_dish表，存储套餐与菜品的多对多关系<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;SetmealDish&gt; SetmealDishes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 购物车实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的shopping_cart表，存储用户购物车商品<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;ShoppingCart&gt; ShoppingCarts &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户实体集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>映射到数据库中的user表，存储移动端用户账户信息<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;User&gt; Users &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 配置实体与数据库表的映射关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在此方法中使用Fluent API进行数据库映射的详细配置，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包括表名映射、主键设置、外键关系、索引等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此配置优先级高于数据注解(Attributes)。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;modelBuilder&quot;&gt;</span>模型构建器，用于配置实体映射<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ============================================</span></span><br><span class="line">            <span class="comment">// 表名映射配置</span></span><br><span class="line">            <span class="comment">// 按照snake_case命名约定配置数据库表名</span></span><br><span class="line">            <span class="comment">// ============================================</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 地址簿实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;AddressBook&gt;().ToTable(<span class="string">&quot;address_book&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 分类实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;Category&gt;().ToTable(<span class="string">&quot;category&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 菜品实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;Dish&gt;().ToTable(<span class="string">&quot;dish&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 菜品口味实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;DishFlavor&gt;().ToTable(<span class="string">&quot;dish_flavor&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 员工实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;Employee&gt;().ToTable(<span class="string">&quot;employee&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 订单详情实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;OrderDetail&gt;().ToTable(<span class="string">&quot;order_detail&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 订单实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;Orders&gt;().ToTable(<span class="string">&quot;orders&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 套餐实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;Setmeal&gt;().ToTable(<span class="string">&quot;setmeal&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 套餐菜品关系实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;SetmealDish&gt;().ToTable(<span class="string">&quot;setmeal_dish&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 购物车实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;ShoppingCart&gt;().ToTable(<span class="string">&quot;shopping_cart&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用户实体映射配置</span></span><br><span class="line">            modelBuilder.Entity&lt;User&gt;().ToTable(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、依赖项注入"><a href="#2、依赖项注入" class="headerlink" title="2、依赖项注入"></a>2、依赖项注入</h2><p>将服务注册逻辑从Program.cs中分离，提高代码的组织性和可维护性。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service.Impl;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper.Impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.config</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 依赖注入扩展类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供统一的服务注册扩展方法，集中管理应用程序的依赖注入配置。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过使用此类，可以将服务注册逻辑从Program.cs中分离，提高代码的组织性和可维护性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 遵循依赖注入设计模式，实现松耦合、可测试的应用程序架构。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DependencyInjectionExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 应用服务注册</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注册应用程序核心业务服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将服务接口与其具体实现类关联，使控制器可以通过构造函数注入这些服务。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 所有服务均使用Scoped生命周期，确保在同一HTTP请求上下文中共享同一实例。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>ASP.NET Core服务集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>配置后的服务集合，支持方法链式调用<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当添加新的服务接口和实现时，应在此方法中注册它们。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">RegisterApplicationServices</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ====================================================</span></span><br><span class="line">            <span class="comment">// 业务服务层注册 - 处理业务逻辑和操作编排</span></span><br><span class="line">            <span class="comment">// ====================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 员工管理服务 - 处理员工认证和信息管理</span></span><br><span class="line">            services.AddScoped&lt;IEmployeeService, EmployeeServiceImpl&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ====================================================</span></span><br><span class="line">            <span class="comment">// 数据访问层注册 - 处理数据库交互</span></span><br><span class="line">            <span class="comment">// ====================================================</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 员工数据映射器 - 处理员工数据的CRUD操作</span></span><br><span class="line">            services.AddScoped&lt;IEmployeeMapper, EmployeeMapperImpl&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> services;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 公共入口点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注册应用程序中的所有服务 - 主入口点</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法作为Program.cs中调用的单一入口点，集中调用各个专门的服务注册方法。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 以这种方式组织依赖注入，可以让Program.cs保持简洁，同时便于服务注册的管理和扩展。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>ASP.NET Core服务集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>配置后的服务集合，支持方法链式调用<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在Program.cs中使用:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> var builder = WebApplication.CreateBuilder(args);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> builder.Services.RegisterAllServices();</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">RegisterAllServices</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 注册业务核心服务</span></span><br><span class="line">            services.RegisterApplicationServices();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> services;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、全局异常处理器"><a href="#3、全局异常处理器" class="headerlink" title="3、全局异常处理器"></a>3、全局异常处理器</h2><p>由于在测试时经常出现问题，因此添加全局异常处理器，从而确保能够给用户合理的反馈。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.Handler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 全局异常处理器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 捕获并统一处理整个应用程序中抛出的异常，提供规范化的错误响应。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 区分业务异常和系统异常，确保向客户端返回友好且一致的错误信息。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在ASP.NET Core中，通过实现ExceptionFilterAttribute来拦截所有未处理的异常，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 替代传统的try-catch块，简化控制器代码并提供集中式异常处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 处理流程：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 捕获异常并区分业务异常和系统异常</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 记录详细的异常日志</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 转换异常为标准Result响应对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 设置适当的HTTP状态码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> : <span class="title">ExceptionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于记录异常详情，便于问题排查和系统监控</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;GlobalExceptionHandler&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入获取日志服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通过ASP.NET Core依赖注入系统获取ILogger接口的实现，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于记录异常信息和处理过程。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器实例<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当logger为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GlobalExceptionHandler</span>(<span class="params">ILogger&lt;GlobalExceptionHandler&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异常发生时的处理方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当应用程序中抛出未处理的异常时，此方法会被ASP.NET Core管道调用，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 对异常进行分类处理，并返回标准化的错误响应。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异常上下文，包含异常信息和HTTP请求/响应上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取请求信息用于日志记录</span></span><br><span class="line">            <span class="keyword">var</span> request = context.HttpContext.Request;</span><br><span class="line">            <span class="keyword">var</span> requestPath = request.Path;</span><br><span class="line">            <span class="keyword">var</span> requestMethod = request.Method;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 捕获请求体数据（用于POST等包含请求体的请求）</span></span><br><span class="line">            <span class="built_in">string</span> requestBody = <span class="string">&quot;[无请求体]&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (request.HasFormContentType)</span><br><span class="line">            &#123;</span><br><span class="line">                requestBody = <span class="string">&quot;[表单数据]&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (request.ContentLength.HasValue &amp;&amp; request.ContentLength &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 注意：这里不能读取请求体，因为在过滤器中请求体可能已经被读取</span></span><br><span class="line">                    <span class="comment">// 在生产环境中，可以考虑使用中间件捕获请求体</span></span><br><span class="line">                    requestBody = <span class="string">&quot;[请求体数据]&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    requestBody = <span class="string">&quot;[无法读取请求体]&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查异常是否为业务异常</span></span><br><span class="line">            <span class="keyword">if</span> (context.Exception <span class="keyword">is</span> BaseException baseException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 记录业务异常，使用Information级别，因为这是预期内的异常</span></span><br><span class="line">                _logger.LogInformation(</span><br><span class="line">                    <span class="string">&quot;业务异常 - 请求:&#123;Method&#125; &#123;Path&#125; - 错误:&#123;Message&#125; - 请求数据:&#123;RequestBody&#125;&quot;</span>,</span><br><span class="line">                    requestMethod, requestPath, baseException.Message, requestBody);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建标准错误结果响应</span></span><br><span class="line">                <span class="keyword">var</span> result = Result&lt;<span class="built_in">object</span>&gt;.Error(baseException.Message);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置HTTP响应</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> ObjectResult(result)</span><br><span class="line">                &#123;</span><br><span class="line">                    StatusCode = StatusCodes.Status200OK <span class="comment">// 业务异常返回200状态码，错误信息在result对象中</span></span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 标记异常已处理，阻止异常继续传播</span></span><br><span class="line">                context.ExceptionHandled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 系统异常更为严重，使用Error级别，并记录完整的异常堆栈</span></span><br><span class="line">                _logger.LogError(context.Exception,</span><br><span class="line">                    <span class="string">&quot;系统异常 - 请求:&#123;Method&#125; &#123;Path&#125; - 错误:&#123;Message&#125; - 堆栈:&#123;StackTrace&#125; - 请求数据:&#123;RequestBody&#125;&quot;</span>,</span><br><span class="line">                    requestMethod, requestPath, context.Exception.Message,</span><br><span class="line">                    context.Exception.StackTrace, requestBody);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对于非业务异常，返回友好的通用错误信息，避免暴露系统细节</span></span><br><span class="line">                <span class="keyword">var</span> result = Result&lt;<span class="built_in">object</span>&gt;.Error(<span class="string">&quot;系统繁忙，请稍后再试&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置HTTP响应</span></span><br><span class="line">                context.Result = <span class="keyword">new</span> ObjectResult(result)</span><br><span class="line">                &#123;</span><br><span class="line">                    StatusCode = StatusCodes.Status500InternalServerError <span class="comment">// 系统异常返回500状态码</span></span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 标记异常已处理</span></span><br><span class="line">                context.ExceptionHandled = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用基类方法，确保执行完整的异常处理流程</span></span><br><span class="line">            <span class="keyword">base</span>.OnException(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 全局异常处理扩展方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供简洁的扩展方法，用于在应用启动时注册全局异常处理器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 遵循ASP.NET Core的服务注册模式，简化Program.cs的配置代码。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GlobalExceptionHandlerExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 为现有的MVC构建器添加全局异常处理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当已经调用了AddControllers()后，可以使用此方法添加全局异常处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;builder&quot;&gt;</span>MVC构建器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>MVC构建器，支持方法链式调用<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在Program.cs中使用:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> builder.Services.AddControllers().AddGlobalExceptionHandler();</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IMvcBuilder <span class="title">AddGlobalExceptionHandler</span>(<span class="params"><span class="keyword">this</span> IMvcBuilder builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.AddMvcOptions(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.Filters.Add&lt;GlobalExceptionHandler&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> builder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4、修改Program-cs"><a href="#4、修改Program-cs" class="headerlink" title="4、修改Program.cs"></a>4、修改Program.cs</h2><p>将上述修改后的内容注入到Program.cs中，以使用</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 应用程序入口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置服务、中间件和启动ASP.NET Core Web API</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 引用命名空间</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;                <span class="comment">// 提供Entity Framework Core数据库交互功能</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;     <span class="comment">// 提供依赖注入服务</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;          <span class="comment">// 包含应用配置属性类</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;              <span class="comment">// 包含应用服务配置</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Handler;             <span class="comment">// 包含全局异常处理器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序构建和配置</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Web应用程序构建器</span></span><br><span class="line"><span class="comment">// WebApplicationBuilder提供配置、日志记录和服务注册的API</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 服务注册</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据库服务配置</span></span><br><span class="line"><span class="comment">// 注册SkyDbContext作为Entity Framework数据上下文</span></span><br><span class="line"><span class="comment">// 配置使用MySQL作为数据库提供程序，并使用appsettings.json中的连接字符串</span></span><br><span class="line">builder.Services.AddDbContext&lt;SkyDbContext&gt;(options =&gt;</span><br><span class="line">    options.UseMySql(</span><br><span class="line">        <span class="comment">// 从配置文件获取连接字符串，支持开发/测试/生产环境配置分离</span></span><br><span class="line">        builder.Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>),</span><br><span class="line">        <span class="comment">// 指定MySQL数据库版本，确保兼容性</span></span><br><span class="line">        <span class="keyword">new</span> MySqlServerVersion(<span class="keyword">new</span> Version(<span class="number">9</span>, <span class="number">3</span>, <span class="number">0</span>))</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// JWT认证配置</span></span><br><span class="line"><span class="comment">// 将appsettings.json中的JwtConfig节绑定到JwtProperties类</span></span><br><span class="line"><span class="comment">// 用于JWT令牌生成和验证</span></span><br><span class="line">builder.Services.Configure&lt;JwtProperties&gt;(builder.Configuration.GetSection(<span class="string">&quot;JwtConfig&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// MVC控制器服务</span></span><br><span class="line"><span class="comment">// 注册ASP.NET Core MVC服务，支持API控制器</span></span><br><span class="line"><span class="comment">// 允许应用程序处理HTTP请求并返回响应</span></span><br><span class="line">builder.Services.AddControllers().AddGlobalExceptionHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量注册应用服务</span></span><br><span class="line"><span class="comment">// 使用自定义扩展方法注册所有业务服务、映射器和仓储</span></span><br><span class="line"><span class="comment">// 避免在Program.cs中手动注册每个服务，提高代码维护性</span></span><br><span class="line">builder.Services.RegisterAllServices();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序实例构建和中间件配置</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建应用程序实例</span></span><br><span class="line"><span class="comment">// 基于上述配置创建Web应用实例</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 中间件管道配置</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置控制器路由</span></span><br><span class="line"><span class="comment">// 将HTTP请求路由映射到对应的控制器操作方法</span></span><br><span class="line"><span class="comment">// 如: /admin/employee/login 将映射到EmployeeController的Login方法</span></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序启动</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动应用程序并开始监听HTTP请求</span></span><br><span class="line"><span class="comment">// 程序将持续运行，直到被明确停止</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<h2 id="5、修改appsettings-json"><a href="#5、修改appsettings-json" class="headerlink" title="5、修改appsettings.json"></a>5、修改appsettings.json</h2><p>因为引入了数据库与JWT，因此需要修改以适应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">/* ====================================</span></span><br><span class="line"><span class="comment">   * 日志配置</span></span><br><span class="line"><span class="comment">   * 控制应用程序不同部分的日志记录级别</span></span><br><span class="line"><span class="comment">   * ==================================== */</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">/* 默认日志级别为Information，记录普通操作信息 */</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">/* AspNetCore框架日志级别为Warning，只记录警告和错误 */</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ====================================</span></span><br><span class="line"><span class="comment">   * 数据库连接配置</span></span><br><span class="line"><span class="comment">   * 定义与MySQL数据库的连接参数</span></span><br><span class="line"><span class="comment">   * ==================================== */</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* 主要数据库连接字符串</span></span><br><span class="line"><span class="comment">     * server: 数据库服务器地址</span></span><br><span class="line"><span class="comment">     * port: MySQL端口号</span></span><br><span class="line"><span class="comment">     * database: 应用程序使用的数据库名称</span></span><br><span class="line"><span class="comment">     * uid: 数据库用户名</span></span><br><span class="line"><span class="comment">     * pwd: 数据库密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">&quot;DefaultConnection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server=localhost;port=33061;database=sky_take_out;uid=root;pwd=mysql;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ====================================</span></span><br><span class="line"><span class="comment">   * Kestrel服务器配置</span></span><br><span class="line"><span class="comment">   * ASP.NET Core内置Web服务器设置</span></span><br><span class="line"><span class="comment">   * ==================================== */</span></span><br><span class="line">  <span class="attr">&quot;Kestrel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">/* HTTP服务配置，应用程序将在8080端口监听请求 */</span></span><br><span class="line">      <span class="attr">&quot;Http&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ====================================</span></span><br><span class="line"><span class="comment">   * JWT认证配置</span></span><br><span class="line"><span class="comment">   * 用于生成和验证身份令牌</span></span><br><span class="line"><span class="comment">   * ==================================== */</span></span><br><span class="line">  <span class="attr">&quot;JwtConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* 管理员端API的密钥，用于签名和验证管理接口的JWT令牌，jwt签名加密时使用的秘钥*/</span></span><br><span class="line">    <span class="attr">&quot;AdminSecretKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AdminSecretKey_sky1234567890123456789012&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">/* 管理员令牌有效期(毫秒)，默认为2小时 */</span></span><br><span class="line">    <span class="attr">&quot;AdminTtl&quot;</span><span class="punctuation">:</span> <span class="number">7200000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">/* 管理员端API的令牌名称，用于标识JWT令牌，前端传递过来的令牌名称*/</span></span><br><span class="line">    <span class="attr">&quot;AdminTokenName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;token&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ====================================</span></span><br><span class="line"><span class="comment">   * 主机限制配置</span></span><br><span class="line"><span class="comment">   * 指定允许哪些主机访问应用程序</span></span><br><span class="line"><span class="comment">   * ==================================== */</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="comment">/* &quot;*&quot;表示允许所有主机访问，生产环境建议限制特定域名 */</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="4、Employee相关内容"><a href="#4、Employee相关内容" class="headerlink" title="4、Employee相关内容"></a>4、Employee相关内容</h1><h2 id="1、EmployeeController-cs重建"><a href="#1、EmployeeController-cs重建" class="headerlink" title="1、EmployeeController.cs重建"></a>1、EmployeeController.cs重建</h2><p> 文件位置：ProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs</p>
<p>依据初始代码进行重建</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.constant;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.utils;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.Controllers.Admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工管理控制器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供系统后台员工账户相关的API接口，包括员工登录和退出功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 作为管理系统的入口点，用于验证员工身份并颁发JWT令牌。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/employee&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeeController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工服务接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 提供员工相关的业务逻辑处理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IEmployeeService _employeeService;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT配置属性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包含管理员和用户JWT令牌生成所需的配置</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JwtProperties _jwtProperties;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于记录控制器操作和异常情况</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;EmployeeController&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化控制器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ASP.NET Core依赖注入系统会自动提供所需的服务实例。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 遵循依赖倒置原则，通过接口而非具体实现建立依赖。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeService&quot;&gt;</span>员工服务实现，提供员工业务逻辑处理<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;jwtOptions&quot;&gt;</span>JWT配置选项，提供令牌生成所需的密钥和有效期<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器，用于记录操作日志<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EmployeeController</span>(<span class="params">IEmployeeService employeeService, IOptions&lt;JwtProperties&gt; jwtOptions, ILogger&lt;EmployeeController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _employeeService = employeeService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeService));</span><br><span class="line">            _jwtProperties = jwtOptions?.Value ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(jwtOptions));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工登录接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证员工用户名和密码，成功后生成JWT令牌并返回员工基本信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此接口作为系统的认证入口点，接收前端提交的登录凭证。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeLoginDTO&quot;&gt;</span>员工登录数据传输对象，包含用户名和密码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 统一封装的结果对象，包含:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 状态码(1表示成功)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 员工信息(ID、用户名、姓名)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - JWT令牌(用于后续认证)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求示例:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> POST /admin/employee/login</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>    &quot;username&quot;: &quot;admin&quot;,</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>    &quot;password&quot;: &quot;123456&quot;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;login&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;EmployeeLoginVO&gt;&gt; Login([FromBody] EmployeeLoginDTO employeeLoginDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录登录尝试，脱敏显示，避免密码泄露</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;员工登录尝试：&#123;EmployeeInfo&#125;&quot;</span>, employeeLoginDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用业务服务层进行登录验证</span></span><br><span class="line">            <span class="comment">// 如果验证失败，服务层会抛出对应异常</span></span><br><span class="line">            Employee employee = <span class="keyword">await</span> _employeeService.LoginAsync(employeeLoginDTO);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;员工 &#123;Username&#125;(&#123;Id&#125;) 登录成功&quot;</span>, employee.Username, employee.Id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 登录成功后，生成jwt令牌</span></span><br><span class="line">            <span class="keyword">var</span> claims = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                &#123; JwtClaimsConstant.EMP_ID, employee.Id &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> token = JwtUtil.CreateJWT(</span><br><span class="line">                _jwtProperties.AdminSecretKey,</span><br><span class="line">                _jwtProperties.AdminTtl,</span><br><span class="line">                claims);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建返回的登录视图对象</span></span><br><span class="line">            <span class="keyword">var</span> employeeLoginVO = <span class="keyword">new</span> EmployeeLoginVO</span><br><span class="line">            &#123;</span><br><span class="line">                Id = employee.Id,</span><br><span class="line">                UserName = employee.Username,</span><br><span class="line">                Name = employee.Name,</span><br><span class="line">                Token = token</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result&lt;EmployeeLoginVO&gt;.Success(employeeLoginVO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工退出登录接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 基于JWT的无状态认证中，服务端不需要实际处理退出逻辑。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 客户端只需删除本地存储的令牌即可完成&quot;退出&quot;操作。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>统一封装的成功结果对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求示例:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> POST /admin/employee/logout</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;logout&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Result&lt;<span class="built_in">string</span>&gt; <span class="title">Logout</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录退出请求</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;员工退出登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在JWT认证模式下，服务端不需要处理退出逻辑</span></span><br><span class="line">            <span class="comment">// JWT是无状态的，服务端不维护会话信息</span></span><br><span class="line">            <span class="comment">// 客户端只需要删除本地存储的token即可</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回成功信息</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;退出成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、EmployeeService"><a href="#2、EmployeeService" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h2><p>接口：ProgramBackEnd\SkyServer\service\IEmployeeService.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工服务接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义系统中员工相关的业务操作契约，是员工管理模块的核心服务接口。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口遵循职责单一原则，专注于员工账户管理和验证等核心业务功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现类应处理所有业务逻辑和异常情况，确保返回值或异常信息符合系统规范。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 控制器通过依赖注入获取此接口的实现，实现表现层与业务逻辑层的解耦。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmployeeService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工登录认证</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证员工的登录凭证，包括用户名存在性、密码正确性和账号状态检查。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 成功则返回员工实体信息，失败则抛出对应的业务异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeLoginDTO&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工登录数据传输对象，包含用户名和密码。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户名和密码都不应为空，密码通常以加密形式存储在数据库中。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证成功的员工实体对象，包含ID、用户名、姓名等完整信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此信息可用于后续JWT令牌生成和权限判断。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;Employee&gt; <span class="title">LoginAsync</span>(<span class="params">EmployeeLoginDTO employeeLoginDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现： ProgramBackEnd\SkyServer\service\Impl\EmployeeServiceImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.constant;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工服务实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现<span class="doctag">&lt;see cref=&quot;IEmployeeService&quot;/&gt;</span>接口，提供员工账户管理和认证的核心业务逻辑。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类处理员工登录验证、密码比对和账号状态检查等操作，确保系统安全性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该实现遵循三层架构设计，通过依赖注入的数据访问层处理数据持久化，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自身专注于业务规则和异常处理，保持业务逻辑的独立性和可测试性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeeServiceImpl</span> : <span class="title">IEmployeeService</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工数据访问对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 负责与数据库交互，执行员工相关的CRUD操作</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IEmployeeMapper _employeeMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于记录业务操作和异常信息，便于系统监控和问题排查</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;EmployeeServiceImpl&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入获取所需服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 依赖注入方式将数据访问层和日志服务注入到业务层，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 符合依赖倒置原则，便于单元测试和模块替换。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeMapper&quot;&gt;</span>员工数据访问对象，提供数据库操作能力<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器，用于记录操作日志<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>任何参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EmployeeServiceImpl</span>(<span class="params">IEmployeeMapper employeeMapper, ILogger&lt;EmployeeServiceImpl&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _employeeMapper = employeeMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeMapper));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工登录认证实现</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证员工登录凭据，包含三个主要步骤：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 根据用户名查询员工记录</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 验证账号存在性、密码正确性和账号状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 返回验证成功的员工信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeLoginDTO&quot;&gt;</span>员工登录数据，包含用户名和密码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>登录成功的员工完整信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;AccountNotFoundException&quot;&gt;</span>当用户名不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;PasswordErrorException&quot;&gt;</span>当密码不匹配时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;AccountLockedException&quot;&gt;</span>当账号被锁定时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">LoginAsync</span>(<span class="params">EmployeeLoginDTO employeeLoginDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (employeeLoginDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeLoginDTO), <span class="string">&quot;登录信息不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> username = employeeLoginDTO.Username?.Trim();</span><br><span class="line">            <span class="built_in">string</span> password = employeeLoginDTO.Password;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证用户名和密码不为空</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(username))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;用户名不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeLoginDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(password))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;密码不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeLoginDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;员工登录尝试：用户名 &#123;Username&#125;&quot;</span>, username);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 根据用户名查询数据库中的员工记录</span></span><br><span class="line">            Employee employee = <span class="keyword">await</span> _employeeMapper.GetByUsernameAsync(username);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span></span><br><span class="line">            <span class="comment">// 2.1 检查账号是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (employee == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 账号不存在，记录警告日志并抛出业务异常</span></span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 不存在&quot;</span>, username);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AccountNotFoundException(MessageConstant.ACCOUNT_NOT_FOUND);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.2 验证密码</span></span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">             * 密码验证说明：</span></span><br><span class="line"><span class="comment">             * 目前实现为明文比对，生产环境应使用加密存储和验证</span></span><br><span class="line"><span class="comment">             * 推荐使用PBKDF2、BCrypt等安全哈希算法</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (password != employee.Password)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 密码错误，记录警告日志并抛出业务异常</span></span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 密码错误&quot;</span>, username);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PasswordErrorException(MessageConstant.PASSWORD_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.3 检查账号状态</span></span><br><span class="line">            <span class="keyword">if</span> (employee.Status == StatusConstant.DISABLE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 账号被锁定，记录警告日志并抛出业务异常</span></span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 账号已被禁用&quot;</span>, username);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AccountLockedException(MessageConstant.ACCOUNT_LOCKED);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 登录成功，记录信息日志</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;登录成功：用户 &#123;Username&#125;(&#123;Name&#125;) ID:&#123;Id&#125;&quot;</span>,username, employee.Name, employee.Id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 返回员工实体对象，用于生成JWT令牌</span></span><br><span class="line">            <span class="keyword">return</span> employee;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、EmployeeMapper"><a href="#3、EmployeeMapper" class="headerlink" title="3、EmployeeMapper"></a>3、EmployeeMapper</h2><p>接口：ProgramBackEnd\SkyServer\mapper\IEmployeeMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义员工实体与数据库交互的数据访问操作。此接口作为数据访问层的核心组件，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 负责提供员工数据的查询、创建、更新和删除等基本操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在系统架构中，该接口位于数据访问层，由存储库模式实现，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使业务逻辑层能够以松耦合方式操作员工数据，而不依赖具体的数据访问技术。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口对应Java项目中的EmployeeMapper接口，在C#中采用异步模式提高系统性能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现类应处理所有与数据库交互的细节，包括连接管理、SQL执行和异常处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmployeeMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据用户名查询员工信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在数据库中通过用户名(Username)精确匹配查找员工记录，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回包含员工完整信息的实体对象。此方法通常用于登录验证和账户查询。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;username&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 要查询的员工用户名，不区分大小写，不应为null或空字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 与用户名匹配的员工实体对象。如果未找到匹配记录，则返回null。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的Employee对象包含员工的完整信息，包括ID、姓名、密码（已加密）及状态等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;System.ArgumentNullException&quot;&gt;</span>当username参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;System.Data.Common.DbException&quot;&gt;</span>当数据库访问出错时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 实现注意：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 查询应该是精确匹配，而非模糊查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 用户名通常不区分大小写，实现时应考虑数据库的大小写敏感性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 为提高性能，可考虑对用户名列添加索引</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;Employee&gt; <span class="title">GetByUsernameAsync</span>(<span class="params"><span class="built_in">string</span> username</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现： ProgramBackEnd\SkyServer\mapper\Impl\EmployeeMapperImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现<span class="doctag">&lt;see cref=&quot;IEmployeeMapper&quot;/&gt;</span>接口，使用Entity Framework Core提供员工数据的数据库操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类位于数据访问层，负责将业务逻辑与数据持久化机制隔离，提高系统的可维护性和可测试性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该类通过依赖注入获取数据库上下文，处理员工相关数据的CRUD操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法实现都采用异步模式，符合现代.NET应用开发的最佳实践。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeeMapperImpl</span> : <span class="title">IEmployeeMapper</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 提供对数据库的访问能力，包含所有实体集合和管理数据库连接。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通过依赖注入获得，生命周期由ASP.NET Core框架管理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _context;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 遵循依赖注入设计模式，由ASP.NET Core DI容器提供SkyDbContext实例。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>数据库上下文实例，提供数据库访问能力<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当skyDbContext为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EmployeeMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _context = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据用户名查询员工信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在数据库中通过用户名精确匹配查找员工记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用Entity Framework Core的异步方法提高性能，特别是在高并发环境下。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;username&quot;&gt;</span>要查询的员工用户名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 匹配的员工实体；如果未找到匹配记录则返回null</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当username参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">GetByUsernameAsync</span>(<span class="params"><span class="built_in">string</span> username</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(username))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(username), <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用LINQ查询，通过FirstOrDefaultAsync异步获取结果</span></span><br><span class="line">            <span class="comment">// FirstOrDefaultAsync在找不到匹配记录时返回null而不是抛出异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> _context.Employees.FirstOrDefaultAsync(e =&gt; e.Username == username);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、JWT使用"><a href="#4、JWT使用" class="headerlink" title="4、JWT使用"></a>4、JWT使用</h2><p>在“EmployeeController.cs”中使用了JWT令牌相关，因此也要重写。</p>
<h3 id="1、JwtClaimsConstant"><a href="#1、JwtClaimsConstant" class="headerlink" title="1、JwtClaimsConstant"></a>1、JwtClaimsConstant</h3><p>首先是JWT声明相关常量</p>
<p>ProgramBackEnd\SkyCommon\constant\JwtClaimsConstant.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.constant</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT声明相关常量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义JWT(JSON Web Token)令牌中使用的标准和自定义声明(Claims)的键名。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 这些常量用于确保系统在生成和验证JWT令牌时使用一致的声明标识符。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT声明是令牌中包含的键值对信息，用于传递用户身份和相关信息，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分为员工端(B端)和用户端(C端)两套声明体系。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">JwtClaimsConstant</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 员工ID的声明键名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于员工登录后生成的管理端JWT令牌中，存储员工的唯一标识符。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此声明在后续API请求中用于识别员工身份和权限验证。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> EMP_ID = <span class="string">&quot;empId&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户ID的声明键名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于C端用户登录后生成的用户端JWT令牌中，存储用户的唯一标识符。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主要标识移动端用户身份，用于个性化服务和访问控制。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> USER_ID = <span class="string">&quot;userId&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 手机号的声明键名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于在JWT令牌中存储用户的联系电话。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主要用于C端用户的令牌中，便于快速获取用户联系方式，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 但应注意手机号属于敏感个人信息，需谨慎处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> PHONE = <span class="string">&quot;phone&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户名的声明键名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于存储登录账号名称。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在员工令牌中存储员工的登录账号名，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在用户令牌中可能存储微信昵称或注册的用户名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> USERNAME = <span class="string">&quot;username&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 姓名的声明键名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于存储用户或员工的真实姓名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 可用于系统日志记录、操作审计和界面展示当前登录用户信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> NAME = <span class="string">&quot;name&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、Jwt工具"><a href="#2、Jwt工具" class="headerlink" title="2、Jwt工具"></a>2、Jwt工具</h3><p>Jwt工具用以辅助构建、解析JWT</p>
<p>ProgramBackEnd\SkyCommon\utils\JwtUtil.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.utils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT(JSON Web Token)工具类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供JWT令牌的生成、解析和验证功能。JWT是一种基于JSON的开放标准(RFC 7519)，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于在各方之间安全地传输信息。令牌中包含经过数字签名的声明(claims)，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用于身份验证和信息交换。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT由三部分组成，以点(.)分隔：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 头部(Header) - 包含令牌类型和使用的签名算法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 载荷(Payload) - 包含声明(claims)，即要传输的数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 签名(Signature) - 用于验证令牌未被篡改</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本工具类使用HMAC-SHA256(HS256)算法进行签名，确保令牌的完整性和真实性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">JwtUtil</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建JWT令牌</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成一个包含指定声明和过期时间的JWT令牌，使用HS256算法签名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成的令牌可用于客户端的身份验证和会话管理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;secretKey&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT密钥，用于签名令牌。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 应使用足够长且随机的字符串，建议至少32个字符。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ttlMillis&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT令牌有效期(毫秒)。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 设置合理的过期时间可以减少令牌被盗用的风险。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;claims&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 要包含在JWT中的声明信息，如用户ID、角色等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Key为声明名称，Value为声明值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>生成的JWT令牌字符串<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当secretKey为null或空时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ttlMillis小于或等于0时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用示例:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> var claims = new Dictionary&amp;lt;string, object&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     &#123; &quot;userId&quot;, 123 &#125;,</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     &#123; &quot;role&quot;, &quot;admin&quot; &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> string token = JwtUtil.CreateJWT(&quot;your-secure-key&quot;, 7200000, claims); // 有效期2小时</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">CreateJWT</span>(<span class="params"><span class="built_in">string</span> secretKey, <span class="built_in">long</span> ttlMillis, Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; claims</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(secretKey))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(secretKey), <span class="string">&quot;JWT密钥不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ttlMillis &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;令牌有效期必须大于0&quot;</span>, <span class="keyword">nameof</span>(ttlMillis));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算过期时间</span></span><br><span class="line">            <span class="keyword">var</span> issuedAt = DateTime.UtcNow;</span><br><span class="line">            <span class="keyword">var</span> expiration = issuedAt.AddMilliseconds(ttlMillis);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建安全密钥</span></span><br><span class="line">            <span class="keyword">var</span> key = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建签名证书</span></span><br><span class="line">            <span class="keyword">var</span> credentials = <span class="keyword">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建JWT安全令牌描述符</span></span><br><span class="line">            <span class="keyword">var</span> tokenDescriptor = <span class="keyword">new</span> SecurityTokenDescriptor</span><br><span class="line">            &#123;</span><br><span class="line">                IssuedAt = issuedAt,          <span class="comment">// 令牌签发时间</span></span><br><span class="line">                NotBefore = issuedAt,         <span class="comment">// 令牌生效时间</span></span><br><span class="line">                Expires = expiration,          <span class="comment">// 令牌过期时间</span></span><br><span class="line">                SigningCredentials = credentials  <span class="comment">// 签名证书</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加自定义声明</span></span><br><span class="line">            <span class="keyword">if</span> (claims != <span class="literal">null</span> &amp;&amp; claims.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> claimsList = <span class="keyword">new</span> List&lt;Claim&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> claim <span class="keyword">in</span> claims)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 将各种类型的值转换为字符串，处理null值</span></span><br><span class="line">                    <span class="built_in">string</span> <span class="keyword">value</span> = claim.Value?.ToString() ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    claimsList.Add(<span class="keyword">new</span> Claim(claim.Key, <span class="keyword">value</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                tokenDescriptor.Subject = <span class="keyword">new</span> ClaimsIdentity(claimsList);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建JWT处理器并生成令牌</span></span><br><span class="line">            <span class="keyword">var</span> tokenHandler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line">            <span class="keyword">var</span> token = tokenHandler.CreateToken(tokenDescriptor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将令牌序列化为字符串并返回</span></span><br><span class="line">            <span class="keyword">return</span> tokenHandler.WriteToken(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5、exception"><a href="#5、exception" class="headerlink" title="5、exception"></a>5、exception</h2><p>由于需要很多的特定报错，因此构建ProgramBackEnd\SkyCommon\exception中的文件</p>
<h3 id="1、BaseException-cs"><a href="#1、BaseException-cs" class="headerlink" title="1、BaseException.cs"></a>1、BaseException.cs</h3><p>构建为基础异常，作为基类。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 业务异常基类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于表示系统中的业务逻辑异常，与技术性异常(如NullReferenceException)相区分。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 业务异常通常表示由于业务规则限制而无法完成操作，例如账号锁定、权限不足等。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有具体的业务异常类型都应继承此类，以便全局异常处理器能够区分业务异常和系统异常，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 从而提供友好的错误消息而非技术细节。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用业务异常的优点：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 提供明确的业务含义，便于前端显示友好错误信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 与技术异常区分，便于异常处理和日志记录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 规范化异常处理流程，提高代码可维护性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseException</span> : <span class="title">Exception</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认无参构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个不带错误消息的业务异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通常建议使用带消息的构造函数，以提供更明确的错误信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new BaseException();</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseException</span>() : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 带错误消息的构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个包含特定错误消息的业务异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这是最常用的构造函数，提供清晰的业务错误说明。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 错误消息，描述发生的业务异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此消息可能会显示给最终用户，应当简洁明了且不包含敏感信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new BaseException(&quot;用户名或密码错误&quot;);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseException</span>(<span class="params"><span class="built_in">string</span> message</span>) : <span class="title">base</span>(<span class="params">message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、AccountNotFoundException"><a href="#2、AccountNotFoundException" class="headerlink" title="2、AccountNotFoundException"></a>2、AccountNotFoundException</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 账号不存在异常</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当系统无法找到用户请求的账号时抛出此异常。通常发生在登录、密码重置或</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查询特定用户信息等操作中，表示所查询的账号标识符（如用户名、ID等）在系统中不存在。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此异常属于业务逻辑异常，应当由全局异常处理器捕获并转换为用户友好的错误消息。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用场景：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 用户登录时提供了不存在的用户名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 通过ID查询用户信息但该ID不存在</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 密码重置流程中输入了未注册的账号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AccountNotFoundException</span> : <span class="title">BaseException</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认无参构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个不带错误消息的账号不存在异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 推荐使用带消息的构造函数，以提供更明确的错误原因。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new AccountNotFoundException();</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AccountNotFoundException</span>() : <span class="title">base</span>(<span class="params"><span class="string">&quot;用户不存在，请重新输入&quot;</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 带错误消息的构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个包含特定错误消息的账号不存在异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这是最常用的构造方式，提供清晰的错误描述。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 错误消息，描述账号不存在的具体情况。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 例如：&quot;用户&#x27;admin&#x27;不存在&quot;或&quot;找不到ID为123的账户&quot;。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new AccountNotFoundException(&quot;用户名&#x27;admin&#x27;不存在，请检查输入或注册新账号&quot;);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AccountNotFoundException</span>(<span class="params"><span class="built_in">string</span> message</span>) : <span class="title">base</span>(<span class="params">message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250525214627241.png" alt="image-20250525214627241"></p>
<h3 id="3、PasswordErrorException"><a href="#3、PasswordErrorException" class="headerlink" title="3、PasswordErrorException"></a>3、PasswordErrorException</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Runtime.Serialization;</span><br><span class="line">using System.Security.Authentication;</span><br><span class="line"></span><br><span class="line">namespace ProgramBackEnd.SkyCommon.exception</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 密码错误异常</span><br><span class="line">    /// &lt;para&gt;</span><br><span class="line">    /// 当用户提供的密码与系统中存储的密码不匹配时抛出此异常。此异常通常发生在用户登录、</span><br><span class="line">    /// 修改密码或其他需要密码验证的操作中，表示身份验证失败。</span><br><span class="line">    /// &lt;/para&gt;</span><br><span class="line">    /// &lt;para&gt;</span><br><span class="line">    /// 作为业务异常的一种，此异常应当由全局异常处理器捕获并转换为对用户友好的错误消息，</span><br><span class="line">    /// 而不暴露技术细节或安全敏感信息。</span><br><span class="line">    /// &lt;/para&gt;</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;remarks&gt;</span><br><span class="line">    /// 使用场景：</span><br><span class="line">    /// - 用户登录时提供了错误的密码</span><br><span class="line">    /// - 更改密码时，原密码验证失败</span><br><span class="line">    /// - API认证过程中提供了错误的凭证</span><br><span class="line">    /// </span><br><span class="line">    /// 安全注意事项：</span><br><span class="line">    /// - 不应在错误消息中指明密码的具体错误（如长度不足、缺少特殊字符等）</span><br><span class="line">    /// - 应考虑实现登录失败尝试次数限制，防止暴力破解</span><br><span class="line">    /// &lt;/remarks&gt;</span><br><span class="line">    [Serializable]</span><br><span class="line">    public class PasswordErrorException : BaseException</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 默认无参构造函数</span><br><span class="line">        /// &lt;para&gt;</span><br><span class="line">        /// 创建一个带有标准错误消息的密码错误异常。</span><br><span class="line">        /// &lt;/para&gt;</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;example&gt;</span><br><span class="line">        /// &lt;code&gt;</span><br><span class="line">        /// throw new PasswordErrorException();</span><br><span class="line">        /// // 将使用默认消息：&quot;密码错误，请重新输入&quot;</span><br><span class="line">        /// &lt;/code&gt;</span><br><span class="line">        /// &lt;/example&gt;</span><br><span class="line">        public PasswordErrorException() : base(&quot;密码错误，请重新输入&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 带错误消息的构造函数</span><br><span class="line">        /// &lt;para&gt;</span><br><span class="line">        /// 创建一个包含自定义错误消息的密码错误异常。</span><br><span class="line">        /// 这是最常用的构造方式，可提供更具体或更友好的错误描述。</span><br><span class="line">        /// &lt;/para&gt;</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;message&quot;&gt;</span><br><span class="line">        /// 错误消息，描述密码错误的具体情况。</span><br><span class="line">        /// 出于安全考虑，消息不应包含有关密码规则或密码错误原因的详细信息。</span><br><span class="line">        /// &lt;/param&gt;</span><br><span class="line">        /// &lt;example&gt;</span><br><span class="line">        /// &lt;code&gt;</span><br><span class="line">        /// throw new PasswordErrorException(&quot;用户名或密码不正确，请检查后重试&quot;);</span><br><span class="line">        /// &lt;/code&gt;</span><br><span class="line">        /// &lt;/example&gt;</span><br><span class="line">        public PasswordErrorException(string message) : base(message)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250525214645489.png" alt="image-20250525214645489"></p>
<h3 id="4、AccountLockedException"><a href="#4、AccountLockedException" class="headerlink" title="4、AccountLockedException"></a>4、AccountLockedException</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.exception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 账号被锁定异常</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当用户账号因安全策略或管理操作被锁定而无法登录或执行操作时抛出此异常。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 账号锁定通常源于多次登录失败、管理员手动锁定、违反使用条款等安全策略。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此异常属于业务逻辑异常，用于区分其他登录失败原因（如密码错误、账号不存在等），</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 应当由全局异常处理器捕获并转换为明确的用户提示信息。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用场景：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 用户多次输入错误密码导致账号自动锁定</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 管理员通过后台将账号设置为锁定状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 系统检测到异常行为自动锁定账号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 用户账号处于禁用状态尝试登录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 建议处理方式：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 提供明确的解锁指引（如联系管理员、等待锁定期过后）</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 记录详细的锁定原因和时间，便于审计和解锁决策</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AccountLockedException</span> : <span class="title">BaseException</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认无参构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个带有标准错误消息的账号锁定异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new AccountLockedException();</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> // 将使用默认消息：&quot;账号已被锁定，请联系管理员&quot;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AccountLockedException</span>() : <span class="title">base</span>(<span class="params"><span class="string">&quot;账号已被锁定，请联系管理员&quot;</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 带错误消息的构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建一个包含自定义错误消息的账号锁定异常。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 可以提供更具体的锁定原因或解锁指引。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 错误消息，描述账号被锁定的原因或解锁方式。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 应提供清晰的后续操作指引，如何解锁或何时可再次尝试。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> throw new AccountLockedException(&quot;您的账号因多次登录失败已被锁定，请30分钟后再试&quot;);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AccountLockedException</span>(<span class="params"><span class="built_in">string</span> message</span>) : <span class="title">base</span>(<span class="params">message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250525214754513.png" alt="image-20250525214754513"></p>
<h3 id="5、完整登录内容"><a href="#5、完整登录内容" class="headerlink" title="5、完整登录内容"></a>5、完整登录内容</h3><p>当完全正确时，可以正常登录</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250525214915657.png" alt="image-20250525214915657"></p>
<h1 id="4、完善登录功能"><a href="#4、完善登录功能" class="headerlink" title="4、完善登录功能"></a>4、完善登录功能</h1><p>由于现在时明文加密，现在将其改编为MD5加密</p>
<h2 id="1、MD5Util"><a href="#1、MD5Util" class="headerlink" title="1、MD5Util"></a>1、MD5Util</h2><p>将MD5工具类进行封装</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.utils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MD5加密工具类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供MD5哈希计算功能，主要用于密码加密等场景。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注意：仅作为示例，生产环境应使用更安全的加密算法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MD5Util</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 计算字符串的MD5哈希值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>要计算哈希的字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>MD5哈希值的十六进制字符串表示<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ComputeHash</span>(<span class="params"><span class="built_in">string</span> input</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> md5 = MD5.Create())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] inputBytes = Encoding.UTF8.GetBytes(input);</span><br><span class="line">                <span class="built_in">byte</span>[] hashBytes = md5.ComputeHash(inputBytes);</span><br><span class="line">                <span class="comment">// 将字节数组转换为十六进制字符串</span></span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="built_in">byte</span> b <span class="keyword">in</span> hashBytes)</span><br><span class="line">                &#123;</span><br><span class="line">                    sb.Append(b.ToString(<span class="string">&quot;x2&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.ToString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、EmployeeService-1"><a href="#2、EmployeeService-1" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h2><p>修改EmployeeService中的实现，将代码替换</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工登录认证实现</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 验证员工登录凭据，包含三个主要步骤：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 根据用户名查询员工记录</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 验证账号存在性、密码正确性和账号状态</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 返回验证成功的员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeLoginDTO&quot;&gt;</span>员工登录数据，包含用户名和密码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>登录成功的员工完整信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;AccountNotFoundException&quot;&gt;</span>当用户名不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;PasswordErrorException&quot;&gt;</span>当密码不匹配时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;AccountLockedException&quot;&gt;</span>当账号被锁定时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">LoginAsync</span>(<span class="params">EmployeeLoginDTO employeeLoginDTO</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (employeeLoginDTO == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeLoginDTO), <span class="string">&quot;登录信息不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> username = employeeLoginDTO.Username?.Trim();</span><br><span class="line">    <span class="built_in">string</span> password = employeeLoginDTO.Password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证用户名和密码不为空</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(username))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;用户名不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeLoginDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(password))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;密码不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeLoginDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;员工登录尝试：用户名 &#123;Username&#125;&quot;</span>, username);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 根据用户名查询数据库中的员工记录</span></span><br><span class="line">    Employee employee = <span class="keyword">await</span> _employeeMapper.GetByUsernameAsync(username);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span></span><br><span class="line">    <span class="comment">// 2.1 检查账号是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (employee == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 账号不存在，记录警告日志并抛出业务异常</span></span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 不存在&quot;</span>, username);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AccountNotFoundException(MessageConstant.ACCOUNT_NOT_FOUND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.2 验证密码</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 密码验证说明：</span></span><br><span class="line"><span class="comment">     * 使用MD5加密算法进行密码验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (MD5Util.ComputeHash(password) != employee.Password)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 密码错误，记录警告日志并抛出业务异常</span></span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 密码错误&quot;</span>, username);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PasswordErrorException(MessageConstant.PASSWORD_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.3 检查账号状态</span></span><br><span class="line">    <span class="keyword">if</span> (employee.Status == StatusConstant.DISABLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 账号被锁定，记录警告日志并抛出业务异常</span></span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;登录失败：用户名 &#123;Username&#125; 账号已被禁用&quot;</span>, username);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AccountLockedException(MessageConstant.ACCOUNT_LOCKED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 登录成功，记录信息日志</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;登录成功：用户 &#123;Username&#125;(&#123;Name&#125;) ID:&#123;Id&#125;&quot;</span>,username, employee.Name, employee.Id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 返回员工实体对象，用于生成JWT令牌</span></span><br><span class="line">    <span class="keyword">return</span> employee;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/05/25/NET-ASP-14/">https://alsl521.github.io/2025/05/25/NET-ASP-14/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ASP.NET学习记录-13-实践2-数据库进阶</div></div><div class="info-2"><div class="info-item-1">1、分页在TodoItemController.cs中添加如下代码 123456789101112131415161718192021222324/// &lt;summary&gt;/// 获取分页的待办事项列表/// 处理HTTP GET请求，路由为 &quot;api/TodoItem/paged&quot;/// 接收查询参数pageNumber和pageSize/// &lt;/summary&gt;/// &lt;param name=&quot;pageNumber&quot;&gt;当前页码，默认为1，从查询字符串中获取&lt;/param&gt;/// &lt;param name=&quot;pageSize&quot;&gt;每页记录数，默认为10，从查询字符串中获取&lt;/param&gt;/// &lt;returns&gt;包含分页待办事项列表的HTTP 200成功响应&lt;/returns&gt;[HttpGet(&quot;paged&quot;)] // 指定此方法处理路由为 &quot;api/TodoItem/paged&quot;...</div></div></div></a><a class="pagination-related" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">ASP.NET学习记录-15-实战-Day02</div></div><div class="info-2"><div class="info-item-1">1、员工管理界面 1、新增员工1、EmployeeController.csProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs 该文件中添加如下内容： 1234567891011121314151617181920212223/// &lt;summary&gt;/// 新增员工接口/// &lt;para&gt;/// 创建新员工账户，设置默认密码并保存员工基本信息。/// 只有已认证的管理员可以调用此接口。/// &lt;/para&gt;/// &lt;/summary&gt;/// &lt;param name=&quot;employeeDTO&quot;&gt;员工数据传输对象，包含新员工的基本信息&lt;/param&gt;/// &lt;returns&gt;统一封装的成功结果对象&lt;/returns&gt;/// &lt;response code=&quot;200&quot;&gt;返回保存成功的信息&lt;/response&gt;[HttpPost]public async...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/09/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-09</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-04-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-04-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/11/NET-ASP-05/" title="ASP.NET学习记录-05-模型数据绑定"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">ASP.NET学习记录-05-模型数据绑定</div></div><div class="info-2"><div class="info-item-1">1、模型绑定定义模型绑定是ASP.NET Core中将HTTP请求数据自动映射到方法参数或对象属性的机制。其核心工作流程：  数据来源：  路由参数（URL片段） 查询字符串（?key&#x3D;value） 请求体（表单&#x2F;JSON&#x2F;XML） 请求头 文件上传   典型应用：   12345678910111213// 自动绑定路由参数和查询参数[HttpGet(&quot;/products/&#123;id&#125;&quot;)]public IActionResult GetProduct(int id, [FromQuery] string category) &#123;    // id来自路由参数，category来自查询字符串&#125;// 自动绑定JSON请求体[HttpPost]public IActionResult Create([FromBody] Product product)&#123;    //...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1、项目简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">2、数据准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E5%86%85%E5%AE%B9%E5%88%9D%E6%AD%A5%E9%87%8D%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">3、内容初步重构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E9%87%8D%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">1、数据库重构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BE%9D%E8%B5%96%E9%A1%B9%E6%B3%A8%E5%85%A5"><span class="toc-number">3.2.</span> <span class="toc-text">2、依赖项注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">3.3.</span> <span class="toc-text">3、全局异常处理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E4%BF%AE%E6%94%B9Program-cs"><span class="toc-number">3.4.</span> <span class="toc-text">4、修改Program.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E4%BF%AE%E6%94%B9appsettings-json"><span class="toc-number">3.5.</span> <span class="toc-text">5、修改appsettings.json</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81Employee%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">4、Employee相关内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81EmployeeController-cs%E9%87%8D%E5%BB%BA"><span class="toc-number">4.1.</span> <span class="toc-text">1、EmployeeController.cs重建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81EmployeeService"><span class="toc-number">4.2.</span> <span class="toc-text">2、EmployeeService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81EmployeeMapper"><span class="toc-number">4.3.</span> <span class="toc-text">3、EmployeeMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81JWT%E4%BD%BF%E7%94%A8"><span class="toc-number">4.4.</span> <span class="toc-text">4、JWT使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81JwtClaimsConstant"><span class="toc-number">4.4.1.</span> <span class="toc-text">1、JwtClaimsConstant</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Jwt%E5%B7%A5%E5%85%B7"><span class="toc-number">4.4.2.</span> <span class="toc-text">2、Jwt工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81exception"><span class="toc-number">4.5.</span> <span class="toc-text">5、exception</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81BaseException-cs"><span class="toc-number">4.5.1.</span> <span class="toc-text">1、BaseException.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81AccountNotFoundException"><span class="toc-number">4.5.2.</span> <span class="toc-text">2、AccountNotFoundException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81PasswordErrorException"><span class="toc-number">4.5.3.</span> <span class="toc-text">3、PasswordErrorException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81AccountLockedException"><span class="toc-number">4.5.4.</span> <span class="toc-text">4、AccountLockedException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%AE%8C%E6%95%B4%E7%99%BB%E5%BD%95%E5%86%85%E5%AE%B9"><span class="toc-number">4.5.5.</span> <span class="toc-text">5、完整登录内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E5%AE%8C%E5%96%84%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">5.</span> <span class="toc-text">4、完善登录功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81MD5Util"><span class="toc-number">5.1.</span> <span class="toc-text">1、MD5Util</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81EmployeeService-1"><span class="toc-number">5.2.</span> <span class="toc-text">2、EmployeeService</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/05/NET-ASP-17/" title="NET-ASP-17-实战-Day04">NET-ASP-17-实战-Day04</a><time datetime="2025-06-05T01:57:52.000Z" title="发表于 2025-06-05 09:57:52">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03">NET-ASP-16-实战-Day03</a><time datetime="2025-05-28T02:57:23.000Z" title="发表于 2025-05-28 10:57:23">2025-05-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02">ASP.NET学习记录-15-实战-Day02</a><time datetime="2025-05-26T11:25:36.000Z" title="发表于 2025-05-26 19:25:36">2025-05-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/NET-ASP-14/" title="ASP.NET学习记录-14-实战-Day01">ASP.NET学习记录-14-实战-Day01</a><time datetime="2025-05-25T12:02:17.000Z" title="发表于 2025-05-25 20:02:17">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>