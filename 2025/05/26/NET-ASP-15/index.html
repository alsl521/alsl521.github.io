<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ASP.NET学习记录-15-实战-Day02 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET学习记录-15-实战-Day02">
<meta property="og:url" content="https://alsl521.github.io/2025/05/26/NET-ASP-15/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-05-26T11:25:36.000Z">
<meta property="article:modified_time" content="2025-05-27T14:07:17.192Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ASP.NET学习记录-15-实战-Day02",
  "url": "https://alsl521.github.io/2025/05/26/NET-ASP-15/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-05-26T11:25:36.000Z",
  "dateModified": "2025-05-27T14:07:17.192Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/05/26/NET-ASP-15/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ASP.NET学习记录-15-实战-Day02',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">ASP.NET学习记录-15-实战-Day02</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ASP.NET学习记录-15-实战-Day02</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-26T11:25:36.000Z" title="发表于 2025-05-26 19:25:36">2025-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-27T14:07:17.192Z" title="更新于 2025-05-27 22:07:17">2025-05-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、员工管理界面"><a href="#1、员工管理界面" class="headerlink" title="1、员工管理界面"></a>1、员工管理界面</h1><p><img src="/2023/12/08/CPlusPlus02/mage-20250526192815441.png" alt="image-20250526192815441"></p>
<h2 id="1、新增员工"><a href="#1、新增员工" class="headerlink" title="1、新增员工"></a>1、新增员工</h2><h3 id="1、EmployeeController-cs"><a href="#1、EmployeeController-cs" class="headerlink" title="1、EmployeeController.cs"></a>1、EmployeeController.cs</h3><p>ProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs</p>
<p>该文件中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新增员工接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建新员工账户，设置默认密码并保存员工基本信息。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 只有已认证的管理员可以调用此接口。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span>员工数据传输对象，包含新员工的基本信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>统一封装的成功结果对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回保存成功的信息<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Save([FromBody] EmployeeDTO employeeDTO)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录操作，但不记录详细信息以避免敏感数据泄露</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;创建新员工: &#123;Name&#125;&quot;</span>, employeeDTO.Name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用业务服务保存员工信息</span></span><br><span class="line">    <span class="comment">// 业务层会处理数据验证、默认值设置和持久化</span></span><br><span class="line">    <span class="keyword">await</span> _employeeService.Save(employeeDTO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回成功响应</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;员工创建成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、EmployeeService"><a href="#2、EmployeeService" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h3><p>在ProgramBackEnd\SkyServer\service\IEmployeeService.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新增员工</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建新的员工账户，包括以下操作:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证必要字段的有效性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 设置默认密码并加密</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 设置账号状态为启用</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 保存员工信息到数据库</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工数据传输对象，包含:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Username: 登录用户名，必须唯一</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工真实姓名</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Phone: 联系电话</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Sex: 性别</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - IdNumber: 身份证号码</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建成功的员工实体对象，包含系统生成的ID和默认配置。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当用户名已存在或数据验证失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当必填字段为空时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function">Task&lt;Employee&gt; <span class="title">Save</span>(<span class="params">EmployeeDTO employeeDTO</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\service\Impl\EmployeeServiceImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建新员工</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span>员工信息数据传输对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>创建成功的员工实体，包含系统生成的ID<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>未找到当前登录用户信息时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">Save</span>(<span class="params">EmployeeDTO employeeDTO</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 获取当前操作人ID：用于审计跟踪</span></span><br><span class="line">    <span class="built_in">long</span>? currentEmpId = BaseContext.GetCurrentId();</span><br><span class="line">    <span class="keyword">if</span> (!currentEmpId.HasValue)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;创建员工失败：未能获取当前操作人信息&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 验证员工信息的完整性和有效性</span></span><br><span class="line">    <span class="keyword">if</span> (employeeDTO == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeDTO), <span class="string">&quot;员工信息不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(employeeDTO.Username))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;用户名不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(employeeDTO.Name))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;姓名不能为空&quot;</span>, <span class="keyword">nameof</span>(employeeDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以添加更多的数据验证逻辑，如手机号格式、身份证号有效性等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 构建员工实体对象：设置默认值和审计字段</span></span><br><span class="line">    DateTime now = DateTime.Now;</span><br><span class="line">    Employee employee = <span class="keyword">new</span> Employee</span><br><span class="line">    &#123;</span><br><span class="line">        Username = employeeDTO.Username?.Trim(),</span><br><span class="line">        Name = employeeDTO.Name?.Trim(),</span><br><span class="line">        <span class="comment">// 使用系统默认密码并加密存储</span></span><br><span class="line">        Password = MD5Util.ComputeHash(PasswordConstant.DEFAULT_PASSWORD),</span><br><span class="line">        Phone = employeeDTO.Phone?.Trim(),</span><br><span class="line">        Sex = employeeDTO.Sex?.Trim(),</span><br><span class="line">        IdNumber = employeeDTO.IdNumber?.Trim(),</span><br><span class="line">        <span class="comment">// 默认启用状态</span></span><br><span class="line">        Status = StatusConstant.ENABLE,</span><br><span class="line">        <span class="comment">// 设置审计字段</span></span><br><span class="line">        CreateTime = now,</span><br><span class="line">        UpdateTime = now,</span><br><span class="line">        CreateUser = currentEmpId.Value,</span><br><span class="line">        UpdateUser = currentEmpId.Value</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 保存员工数据并返回结果</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;创建员工：用户名 &#123;Username&#125;, 姓名 &#123;Name&#125;&quot;</span>,</span><br><span class="line">        employee.Username, employee.Name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> _employeeMapper.Insert(employee);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、EmployeeMapper"><a href="#3、EmployeeMapper" class="headerlink" title="3、EmployeeMapper"></a>3、EmployeeMapper</h3><p>在ProgramBackEnd\SkyServer\mapper\IEmployeeMapper.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新增员工记录</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employee&quot;&gt;</span>要插入的员工实体<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 包含自动生成ID的员工实体对象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当employee为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>数据库唯一约束冲突或其他更新错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此方法将员工信息插入数据库，并返回包含自动生成ID的完整实体。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现应确保:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. ID字段由数据库自动生成</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 创建时间和更新时间正确设置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 处理唯一键约束(如用户名唯一)冲突</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function">Task&lt;Employee&gt; <span class="title">Insert</span>(<span class="params">Employee employee</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\mapper\Impl\EmployeeMapperImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新增员工记录</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employee&quot;&gt;</span>员工实体<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含生成ID的员工实体<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当employee为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>数据库更新失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">Insert</span>(<span class="params">Employee employee</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (employee == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employee), <span class="string">&quot;员工对象不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 使用异步方法添加实体</span></span><br><span class="line">        <span class="comment">// 注：无需手动设置ID，由数据库自增列生成</span></span><br><span class="line">        <span class="keyword">await</span> _context.Employees.AddAsync(employee);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交更改到数据库</span></span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回包含数据库生成ID的实体对象</span></span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (DbUpdateException ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 处理唯一键约束冲突等数据库错误</span></span><br><span class="line">        <span class="comment">// 提供更具体的错误信息，便于上层处理</span></span><br><span class="line">        <span class="built_in">string</span> errorMessage = ex.InnerException?.Message?.Contains(<span class="string">&quot;Duplicate entry&quot;</span>) == <span class="literal">true</span></span><br><span class="line">            ? <span class="string">&quot;员工用户名已存在，请使用其他用户名&quot;</span></span><br><span class="line">            : <span class="string">$&quot;保存员工数据时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DbUpdateException(errorMessage, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 处理其他未预期的异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;保存员工数据时发生未知错误&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于在Employee中需要指定创建与更新成员的指定者，因此需要通过拦截器等内容注入到ThreadLocal中</p>
<h3 id="4、JwtTokenValidationMiddleware-cs"><a href="#4、JwtTokenValidationMiddleware-cs" class="headerlink" title="4、JwtTokenValidationMiddleware.cs"></a>4、JwtTokenValidationMiddleware.cs</h3><p>在ProgramBackEnd\SkyServer\Middlewares\JwtTokenValidationMiddleware.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.constant;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.context;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.utils;</span><br><span class="line"><span class="keyword">using</span> System.Text.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.Middlewares</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT令牌验证中间件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 拦截对管理后台的请求，进行身份认证和授权管理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 集成了令牌验证的所有逻辑，无需依赖外部拦截器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JwtTokenValidationMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求处理管道中的下一个委托</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;JwtTokenValidationMiddleware&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT配置属性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JwtProperties _jwtProperties;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 不需要验证令牌的路径集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> HashSet&lt;<span class="built_in">string</span>&gt; _excludedPaths = <span class="keyword">new</span>(StringComparer.OrdinalIgnoreCase)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;/admin/employee/login&quot;</span></span><br><span class="line">            <span class="comment">// 可在此处添加其他免验证的路径</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;next&quot;&gt;</span>请求管道中的下一个中间件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录服务<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;jwtOptions&quot;&gt;</span>JWT配置选项<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">JwtTokenValidationMiddleware</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            RequestDelegate next,</span></span></span><br><span class="line"><span class="params"><span class="function">            ILogger&lt;JwtTokenValidationMiddleware&gt; logger,</span></span></span><br><span class="line"><span class="params"><span class="function">            IOptions&lt;JwtProperties&gt; jwtOptions</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _next = next ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(next), <span class="string">&quot;请求委托不能为空&quot;</span>);</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger), <span class="string">&quot;日志记录器不能为空&quot;</span>);</span><br><span class="line">            _jwtProperties = jwtOptions?.Value ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(jwtOptions), <span class="string">&quot;JWT配置不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 处理HTTP请求的核心方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>HTTP上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>异步任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> path = context.Request.Path.Value?.ToLower() ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判断是否需要进行令牌验证（与Java版本的拦截器注册逻辑对应）</span></span><br><span class="line">                <span class="keyword">if</span> (path.StartsWith(<span class="string">&quot;/admin/&quot;</span>, StringComparison.OrdinalIgnoreCase) &amp;&amp; !_excludedPaths.Contains(path))</span><br><span class="line">                &#123;</span><br><span class="line">                    _logger.LogInformation(<span class="string">&quot;开始JWT验证: &#123;Path&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 验证令牌</span></span><br><span class="line">                    <span class="keyword">var</span> (success, employeeId) = ValidateToken(context);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!success)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 验证失败，返回401响应</span></span><br><span class="line">                        _logger.LogWarning(<span class="string">&quot;JWT验证失败: &#123;Path&#125;&quot;</span>, context.Request.Path);</span><br><span class="line">                        <span class="keyword">await</span> SendUnauthorizedResponseAsync(context);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 验证成功，将员工ID存储在请求上下文和线程本地存储中</span></span><br><span class="line">                    context.Items[<span class="string">&quot;EmpId&quot;</span>] = employeeId;</span><br><span class="line">                    BaseContext.SetCurrentId(employeeId);</span><br><span class="line">                    _logger.LogInformation(<span class="string">&quot;员工ID &#123;EmpId&#125; 已设置到请求上下文和线程存储&quot;</span>, employeeId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 验证通过或不需验证，继续请求处理</span></span><br><span class="line">                <span class="keyword">await</span> _next(context);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 请求结束后清理线程本地存储，防止内存泄漏</span></span><br><span class="line">                BaseContext.RemoveCurrentId();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证JWT令牌的有效性并提取员工ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>HTTP请求上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>验证结果，包含是否成功和员工ID<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> (<span class="built_in">bool</span> Success, <span class="built_in">long</span> EmployeeId) ValidateToken(HttpContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从HTTP请求头获取令牌</span></span><br><span class="line">                <span class="built_in">string</span> token = ExtractToken(context);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(token))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 解析JWT令牌</span></span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;正在验证JWT令牌&quot;</span>);</span><br><span class="line">                Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; claims = JwtUtil.ParseJWT(_jwtProperties.AdminSecretKey, token);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 提取员工ID声明</span></span><br><span class="line">                <span class="keyword">if</span> (!TryGetEmployeeId(claims, <span class="keyword">out</span> <span class="built_in">long</span> empId))</span><br><span class="line">                &#123;</span><br><span class="line">                    _logger.LogWarning(<span class="string">&quot;JWT令牌不包含有效的员工ID&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> (<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;JWT验证成功, 员工ID: &#123;EmpId&#125;&quot;</span>, empId);</span><br><span class="line">                <span class="keyword">return</span> (<span class="literal">true</span>, empId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(ex, <span class="string">&quot;JWT验证过程发生异常: &#123;Message&#125;&quot;</span>, ex.Message);</span><br><span class="line">                <span class="keyword">return</span> (<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从HTTP请求头中提取JWT令牌</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>HTTP上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>JWT令牌字符串，未找到则返回null<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">ExtractToken</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查请求头中是否包含指定名称的令牌</span></span><br><span class="line">            <span class="keyword">if</span> (!context.Request.Headers.TryGetValue(_jwtProperties.AdminTokenName, <span class="keyword">out</span> <span class="keyword">var</span> tokenValues) || tokenValues.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;请求缺少JWT令牌: &#123;TokenName&#125;&quot;</span>, _jwtProperties.AdminTokenName);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> token = tokenValues.First();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(token))</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;JWT令牌为空&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> token;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 尝试从JWT声明中提取员工ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;claims&quot;&gt;</span>JWT声明字典<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeId&quot;&gt;</span>提取的员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>是否成功提取<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">TryGetEmployeeId</span>(<span class="params">Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; claims, <span class="keyword">out</span> <span class="built_in">long</span> employeeId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            employeeId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否包含员工ID声明</span></span><br><span class="line">            <span class="keyword">if</span> (!claims.TryGetValue(JwtClaimsConstant.EMP_ID, <span class="keyword">out</span> <span class="built_in">object</span> empIdObj) || empIdObj == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试将声明值转换为长整型</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                employeeId = Convert.ToInt64(empIdObj.ToString());</span><br><span class="line">                <span class="keyword">return</span> employeeId &gt; <span class="number">0</span>; <span class="comment">// 确保ID有效（大于0）</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (FormatException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(ex, <span class="string">&quot;员工ID格式无效: &#123;Value&#125;&quot;</span>, empIdObj);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (OverflowException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(ex, <span class="string">&quot;员工ID数值溢出: &#123;Value&#125;&quot;</span>, empIdObj);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 发送未授权响应</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>HTTP上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">SendUnauthorizedResponseAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 设置响应状态码和内容类型</span></span><br><span class="line">            context.Response.StatusCode = StatusCodes.Status200OK; <span class="comment">// 使用200但在数据中标记错误</span></span><br><span class="line">            context.Response.ContentType = <span class="string">&quot;application/json; charset=utf-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建标准错误响应</span></span><br><span class="line">            <span class="keyword">var</span> result = Result&lt;<span class="built_in">string</span>&gt;.Error(MessageConstant.NOT_LOGIN);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入JSON响应</span></span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsJsonAsync(result, <span class="keyword">new</span> JsonSerializerOptions</span><br><span class="line">            &#123;</span><br><span class="line">                PropertyNamingPolicy = JsonNamingPolicy.CamelCase</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、JwtUtil"><a href="#5、JwtUtil" class="headerlink" title="5、JwtUtil"></a>5、JwtUtil</h3><p>在ProgramBackEnd\SkyCommon\utils\JwtUtil.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.utils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT(JSON Web Token)工具类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供JWT令牌的生成、解析和验证功能。JWT是一种基于JSON的开放标准(RFC 7519)，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于在各方之间安全地传输信息。令牌中包含经过数字签名的声明(claims)，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用于身份验证和信息交换。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT由三部分组成，以点(.)分隔：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 头部(Header) - 包含令牌类型和使用的签名算法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 载荷(Payload) - 包含声明(claims)，即要传输的数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 签名(Signature) - 用于验证令牌未被篡改</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本工具类使用HMAC-SHA256(HS256)算法进行签名，确保令牌的完整性和真实性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">JwtUtil</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建JWT令牌</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成一个包含指定声明和过期时间的JWT令牌，使用HS256算法签名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成的令牌可用于客户端的身份验证和会话管理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;secretKey&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT密钥，用于签名令牌。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 应使用足够长且随机的字符串，建议至少32个字符。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ttlMillis&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT令牌有效期(毫秒)。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 设置合理的过期时间可以减少令牌被盗用的风险。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;claims&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 要包含在JWT中的声明信息，如用户ID、角色等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Key为声明名称，Value为声明值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>生成的JWT令牌字符串<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当secretKey为null或空时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ttlMillis小于或等于0时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用示例:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> var claims = new Dictionary&amp;lt;string, object&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     &#123; &quot;userId&quot;, 123 &#125;,</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     &#123; &quot;role&quot;, &quot;admin&quot; &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> string token = JwtUtil.CreateJWT(&quot;your-secure-key&quot;, 7200000, claims); // 有效期2小时</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">CreateJWT</span>(<span class="params"><span class="built_in">string</span> secretKey, <span class="built_in">long</span> ttlMillis, Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; claims</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(secretKey))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(secretKey), <span class="string">&quot;JWT密钥不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ttlMillis &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;令牌有效期必须大于0&quot;</span>, <span class="keyword">nameof</span>(ttlMillis));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算过期时间</span></span><br><span class="line">            <span class="keyword">var</span> issuedAt = DateTime.UtcNow;</span><br><span class="line">            <span class="keyword">var</span> expiration = issuedAt.AddMilliseconds(ttlMillis);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建安全密钥</span></span><br><span class="line">            <span class="keyword">var</span> key = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建签名证书</span></span><br><span class="line">            <span class="keyword">var</span> credentials = <span class="keyword">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建JWT安全令牌描述符</span></span><br><span class="line">            <span class="keyword">var</span> tokenDescriptor = <span class="keyword">new</span> SecurityTokenDescriptor</span><br><span class="line">            &#123;</span><br><span class="line">                IssuedAt = issuedAt,          <span class="comment">// 令牌签发时间</span></span><br><span class="line">                NotBefore = issuedAt,         <span class="comment">// 令牌生效时间</span></span><br><span class="line">                Expires = expiration,          <span class="comment">// 令牌过期时间</span></span><br><span class="line">                SigningCredentials = credentials  <span class="comment">// 签名证书</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加自定义声明</span></span><br><span class="line">            <span class="keyword">if</span> (claims != <span class="literal">null</span> &amp;&amp; claims.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> claimsList = <span class="keyword">new</span> List&lt;Claim&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> claim <span class="keyword">in</span> claims)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 将各种类型的值转换为字符串，处理null值</span></span><br><span class="line">                    <span class="built_in">string</span> <span class="keyword">value</span> = claim.Value?.ToString() ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    claimsList.Add(<span class="keyword">new</span> Claim(claim.Key, <span class="keyword">value</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                tokenDescriptor.Subject = <span class="keyword">new</span> ClaimsIdentity(claimsList);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建JWT处理器并生成令牌</span></span><br><span class="line">            <span class="keyword">var</span> tokenHandler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line">            <span class="keyword">var</span> token = tokenHandler.CreateToken(tokenDescriptor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将令牌序列化为字符串并返回</span></span><br><span class="line">            <span class="keyword">return</span> tokenHandler.WriteToken(token);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 解析JWT令牌</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证并解析JWT令牌，提取包含的声明信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法会验证令牌的签名和有效期。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;secretKey&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT密钥，用于验证令牌签名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 必须与创建令牌时使用的密钥相同。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;token&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 要解析的JWT令牌字符串。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JWT中包含的声明集合。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Key为声明名称，Value为声明值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当secretKey或token为null或空时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;SecurityTokenException&quot;&gt;</span>当令牌签名无效或已过期时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;FormatException&quot;&gt;</span>当令牌格式不正确时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用示例:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> try </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     var claims = JwtUtil.ParseJWT(&quot;your-secure-key&quot;, token);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     var userId = Convert.ToInt64(claims[&quot;userId&quot;]);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> catch (SecurityTokenException ex)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     // 处理无效令牌的情况</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; <span class="title">ParseJWT</span>(<span class="params"><span class="built_in">string</span> secretKey, <span class="built_in">string</span> token</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(secretKey))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(secretKey), <span class="string">&quot;JWT密钥不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(token))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(token), <span class="string">&quot;JWT令牌不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建令牌验证参数</span></span><br><span class="line">            <span class="keyword">var</span> tokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证签名密钥</span></span><br><span class="line">                ValidateIssuerSigningKey = <span class="literal">true</span>,</span><br><span class="line">                IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)),</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 不验证发行者</span></span><br><span class="line">                ValidateIssuer = <span class="literal">false</span>,</span><br><span class="line">                ValidIssuer = <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 不验证受众</span></span><br><span class="line">                ValidateAudience = <span class="literal">false</span>,</span><br><span class="line">                ValidAudience = <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 验证生命周期</span></span><br><span class="line">                ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置时钟偏差为零，严格验证过期时间</span></span><br><span class="line">                ClockSkew = TimeSpan.Zero,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 要求令牌存在过期时间声明</span></span><br><span class="line">                RequireExpirationTime = <span class="literal">true</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建JWT处理器</span></span><br><span class="line">            <span class="keyword">var</span> tokenHandler = <span class="keyword">new</span> JwtSecurityTokenHandler();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 验证并解析令牌</span></span><br><span class="line">                ClaimsPrincipal principal = tokenHandler.ValidateToken(token, tokenValidationParameters, <span class="keyword">out</span> SecurityToken validatedToken);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确保使用的是预期的安全算法</span></span><br><span class="line">                <span class="keyword">if</span> (!(validatedToken <span class="keyword">is</span> JwtSecurityToken jwtToken) ||</span><br><span class="line">                    !jwtToken.Header.Alg.Equals(SecurityAlgorithms.HmacSha256, StringComparison.InvariantCultureIgnoreCase))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityTokenException(<span class="string">&quot;无效的令牌&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取所有声明并转换为Dictionary</span></span><br><span class="line">                <span class="keyword">var</span> claims = principal.Claims;</span><br><span class="line">                <span class="keyword">var</span> claimsDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> claim <span class="keyword">in</span> claims)</span><br><span class="line">                &#123;</span><br><span class="line">                    claimsDictionary[claim.Type] = claim.Value;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> claimsDictionary;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SecurityTokenExpiredException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 令牌已过期</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JWTTokenException(<span class="string">&quot;令牌已过期&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SecurityTokenInvalidSignatureException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 令牌签名无效</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JWTTokenException(<span class="string">&quot;令牌签名无效&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SecurityTokenException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 其他安全令牌异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JWTTokenException(<span class="string">$&quot;令牌验证失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6、Program-cs"><a href="#6、Program-cs" class="headerlink" title="6、Program.cs"></a>6、Program.cs</h3><p>在ProgramBackEnd\Program.cs中添加如下内容以使用中间件：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 应用程序入口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置服务、中间件和启动ASP.NET Core Web API。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 这是ASP.NET Core应用程序的主入口点，负责整个应用的配置和启动流程。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 引用命名空间</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;                <span class="comment">// 提供Entity Framework Core数据库交互功能</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;     <span class="comment">// 提供依赖注入容器和服务注册功能</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;          <span class="comment">// 包含应用配置属性类，如JWT设置</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;              <span class="comment">// 包含应用服务配置和数据库上下文</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Handler;             <span class="comment">// 包含全局异常处理器，提供统一错误处理</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Interceptors;        <span class="comment">// 包含JWT令牌验证拦截器</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Middlewares;         <span class="comment">// 包含自定义中间件组件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序构建和初始化</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Web应用程序构建器</span></span><br><span class="line"><span class="comment">// WebApplicationBuilder是ASP.NET Core应用程序的基础构建块</span></span><br><span class="line"><span class="comment">// 提供配置源、日志提供程序和服务容器的统一接口</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 服务容器配置部分</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 数据库上下文配置</span></span><br><span class="line"><span class="comment">// 注册Entity Framework数据库上下文，并配置MySQL提供程序</span></span><br><span class="line">builder.Services.AddDbContext&lt;SkyDbContext&gt;(options =&gt;</span><br><span class="line">    options.UseMySql(</span><br><span class="line">        <span class="comment">// 从配置文件获取连接字符串，便于不同环境使用不同数据库</span></span><br><span class="line">        builder.Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>),</span><br><span class="line">        <span class="comment">// 指定MySQL服务器版本，确保EF Core生成兼容SQL</span></span><br><span class="line">        <span class="keyword">new</span> MySqlServerVersion(<span class="keyword">new</span> Version(<span class="number">9</span>, <span class="number">3</span>, <span class="number">0</span>))</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. JWT身份验证配置</span></span><br><span class="line"><span class="comment">// 将配置文件中的JWT设置绑定到强类型对象</span></span><br><span class="line"><span class="comment">// 这样可以在应用程序中以类型安全的方式访问JWT设置</span></span><br><span class="line">builder.Services.Configure&lt;JwtProperties&gt;(builder.Configuration.GetSection(<span class="string">&quot;JwtConfig&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Web框架服务注册</span></span><br><span class="line"><span class="comment">// 添加MVC控制器支持，并注册全局异常处理过滤器</span></span><br><span class="line"><span class="comment">// 这使应用程序能够处理HTTP请求并通过控制器返回响应</span></span><br><span class="line">builder.Services.AddControllers().AddGlobalExceptionHandler(); <span class="comment">// 自定义扩展方法，注册全局异常处理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 业务服务注册</span></span><br><span class="line"><span class="comment">// 使用扩展方法批量注册所有业务服务、数据访问组件和工具服务</span></span><br><span class="line"><span class="comment">// 这种方式避免在Program.cs中列出所有服务，保持代码整洁</span></span><br><span class="line">builder.Services.RegisterAllServices();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序实例构建</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于上述服务和配置构建WebApplication实例</span></span><br><span class="line"><span class="comment">// 此步骤完成服务容器的构建并准备HTTP请求处理管道</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// HTTP请求处理管道配置（中间件注册）</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：中间件的注册顺序决定了它们的执行顺序</span></span><br><span class="line"><span class="comment">// 这对于正确处理请求至关重要</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开发环境特定中间件</span></span><br><span class="line"><span class="comment">// 如果需要为开发环境配置特定中间件（如开发者异常页），可以在此添加</span></span><br><span class="line"><span class="comment">// if (app.Environment.IsDevelopment())</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     app.UseDeveloperExceptionPage();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 基础设施中间件</span></span><br><span class="line"><span class="comment">// 配置路由中间件，建立请求路由系统</span></span><br><span class="line">app.UseRouting();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 身份验证与授权中间件</span></span><br><span class="line"><span class="comment">// JWT令牌验证中间件，拦截请求并验证身份令牌</span></span><br><span class="line"><span class="comment">// 位于路由之后，确保路由已解析，但在终端中间件之前</span></span><br><span class="line">app.UseMiddleware&lt;JwtTokenValidationMiddleware&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 终端中间件</span></span><br><span class="line"><span class="comment">// 将HTTP请求映射到对应的控制器端点</span></span><br><span class="line"><span class="comment">// 如：/admin/employee/login 将映射到EmployeeController的Login方法</span></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"><span class="comment">// 应用程序启动</span></span><br><span class="line"><span class="comment">// ======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动Web主机并开始监听HTTP请求</span></span><br><span class="line"><span class="comment">// 应用程序将持续运行，直到被明确停止或发生未处理异常</span></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure>

<p>用户存在：</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250527091626581.png" alt="image-20250527091626581"></p>
<p>用户未存在：</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250527091716732.png" alt="image-20250527091716732"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250527091738099.png" alt="image-20250527091738099"></p>
<h2 id="2、员工分页查询"><a href="#2、员工分页查询" class="headerlink" title="2、员工分页查询"></a>2、员工分页查询</h2><h3 id="1、EmployeeController-cs-1"><a href="#1、EmployeeController-cs-1" class="headerlink" title="1、EmployeeController.cs"></a>1、EmployeeController.cs</h3><p>ProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs</p>
<p>该文件中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件获取员工列表，支持按姓名筛选并进行分页。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此接口为管理员提供员工信息的分页浏览功能，便于员工管理。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于筛选</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数，控制返回数据量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 统一封装的结果对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 状态码(1表示成功)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 分页数据(总记录数和当前页数据列表)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回查询结果，包含员工列表和分页信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;page&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;PageResult&gt;&gt; Page([FromQuery] EmployeePageQueryDTO employeePageQueryDTO)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录查询参数日志，便于问题排查和性能监控</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;员工分页查询开始，查询参数：&#123;EmployeePageQueryDTO&#125;&quot;</span>, employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用业务服务执行查询，分离控制器和业务逻辑</span></span><br><span class="line">        PageResult pageResult = <span class="keyword">await</span> _employeeService.PageQuery(employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录查询结果的基本信息</span></span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;员工分页查询成功，共返回 &#123;Count&#125; 条记录，总记录数 &#123;Total&#125;&quot;</span>,pageResult.Records?.Count ?? <span class="number">0</span>, pageResult.Total);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回成功结果，使用统一的响应格式</span></span><br><span class="line">        <span class="keyword">return</span> Result&lt;PageResult&gt;.Success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 记录异常信息，但不在此处处理异常</span></span><br><span class="line">        <span class="comment">// 异常将由全局异常处理器捕获并转换为适当的HTTP响应</span></span><br><span class="line">        _logger.LogError(ex, <span class="string">&quot;员工分页查询异常：&#123;Message&#125;&quot;</span>, ex.Message);</span><br><span class="line">        <span class="keyword">throw</span>; <span class="comment">// 重新抛出异常，交由全局异常处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、EmployeeService-1"><a href="#2、EmployeeService-1" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h3><p>在ProgramBackEnd\SkyServer\service\IEmployeeService.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件获取员工列表并进行分页处理，支持以下功能：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 按员工姓名进行模糊查询</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 分页获取员工数据，控制返回数据量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 按创建时间降序排序，确保最新员工排在前面</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于模糊匹配筛选</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始计数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数，控制返回数据量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 分页结果对象(PageResult)，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Total: 满足条件的总记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Records: 当前页的员工记录列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回的员工信息不包含敏感字段如密码</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当分页参数无效(如页码小于1)时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 该方法实现需遵循以下原则：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 确保数据安全，过滤敏感字段</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 优化查询性能，避免全表扫描</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 处理空结果情况，返回空列表而非null</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function">Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">EmployeePageQueryDTO employeePageQueryDTO</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\service\Impl\EmployeeServiceImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询实现</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件获取员工列表并进行分页处理，主要功能包括：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证并规范化分页参数，确保查询有效执行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 调用数据访问层执行实际查询操作</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 封装查询结果为统一的分页响应结构</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于模糊匹配筛选</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始计数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数，控制返回数据量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 分页结果对象(PageResult)，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Total: 满足条件的总记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Records: 当前页的员工记录列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 方法执行流程：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 参数校验与默认值设置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 委托数据访问层执行查询</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 封装返回数据，隐藏敏感信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">EmployeePageQueryDTO employeePageQueryDTO</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;开始执行员工分页查询，查询参数：&#123;EmployeePageQueryDTO&#125;&quot;</span>, employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 参数验证与规范化：确保查询参数有效，提供合理默认值</span></span><br><span class="line">        <span class="keyword">if</span> (employeePageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeePageQueryDTO), <span class="string">&quot;分页查询参数不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规范化页码：小于1则设为默认值1</span></span><br><span class="line">        <span class="keyword">if</span> (employeePageQueryDTO.Page &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogWarning(<span class="string">&quot;页码参数无效(值为&#123;Page&#125;)，已自动调整为默认值1&quot;</span>, employeePageQueryDTO.Page);</span><br><span class="line">            employeePageQueryDTO.Page = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规范化页大小：小于1则设为默认值10</span></span><br><span class="line">        <span class="keyword">if</span> (employeePageQueryDTO.PageSize &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogWarning(<span class="string">&quot;每页记录数参数无效(值为&#123;PageSize&#125;)，已自动调整为默认值10&quot;</span>, employeePageQueryDTO.PageSize);</span><br><span class="line">            employeePageQueryDTO.PageSize = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 调用数据访问层执行查询：通过数据映射器获取分页数据</span></span><br><span class="line">        <span class="comment">// 使用元组解构接收查询结果，直观明了</span></span><br><span class="line">        (<span class="built_in">int</span> total, List&lt;Employee&gt; employees) = <span class="keyword">await</span> _employeeMapper.PageQuery(employeePageQueryDTO);</span><br><span class="line">        _logger.LogDebug(<span class="string">&quot;查询成功，共获取&#123;Count&#125;条记录，总记录数&#123;Total&#125;&quot;</span>, employees.Count, total);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建标准化的分页结果对象</span></span><br><span class="line">        PageResult pageResult = <span class="keyword">new</span> PageResult</span><br><span class="line">        &#123;</span><br><span class="line">            Total = total,                <span class="comment">// 设置满足条件的总记录数</span></span><br><span class="line">            Records = employees           <span class="comment">// 设置当前页的数据列表</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;员工分页查询成功完成，返回记录数：&#123;Count&#125;&quot;</span>, employees.Count);</span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 捕获并记录异常，但保持异常传播以便全局异常处理器处理</span></span><br><span class="line">        _logger.LogError(ex, <span class="string">&quot;员工分页查询过程中发生异常：&#123;Message&#125;&quot;</span>, ex.Message);</span><br><span class="line">        <span class="keyword">throw</span>; <span class="comment">// 重新抛出异常，保持原始堆栈信息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、EmployeeMapper-1"><a href="#3、EmployeeMapper-1" class="headerlink" title="3、EmployeeMapper"></a>3、EmployeeMapper</h3><p>在ProgramBackEnd\SkyServer\mapper\IEmployeeMapper.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件从数据库中检索员工记录并分页返回。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 支持按员工姓名进行模糊搜索，并对结果集进行分页处理。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 作为数据访问层的核心方法，直接与数据库交互。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于模糊匹配查询</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始计数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数，控制返回数据量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回元组，包含两个元素：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - total: 满足条件的总记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - employees: 当前页的员工记录列表，已按创建时间降序排序</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>查询参数对象为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>查询执行过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现注意事项：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 必须添加明确的排序(如按创建时间降序)，避免Skip/Take操作引起的不确定结果</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 查询应先执行Count获取总数，再执行分页查询以提高性能</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 查询需考虑大数据量场景下的性能优化，如合理利用索引</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 需处理姓名参数的SQL注入风险，确保查询安全</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 典型实现示例：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> var query = _context.Employees;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> // 添加条件过滤</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> if (!string.IsNullOrEmpty(dto.Name))</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     query = query.Where(e =&gt; e.Name.Contains(dto.Name));</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> int total = await query.CountAsync();</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> // 排序并分页</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> var employees = await query</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     .OrderByDescending(e =&gt; e.CreateTime)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     .Skip((dto.Page - 1) * dto.PageSize)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     .Take(dto.PageSize)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     .ToListAsync();</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> return (total, employees);</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">Task&lt;(<span class="built_in">int</span> total, List&lt;Employee&gt; employees)&gt; PageQuery(EmployeePageQueryDTO employeePageQueryDTO);</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\mapper\Impl\EmployeeMapperImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询实现</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件从数据库检索员工记录并进行分页处理。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 支持按员工姓名模糊搜索，结果按创建时间降序排列。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于模糊匹配</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回包含两个元素的元组：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - total: 满足条件的总记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - employees: 当前页的员工记录列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>数据库查询执行出错时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;(<span class="built_in">int</span> total, List&lt;Employee&gt; employees)&gt; PageQuery(EmployeePageQueryDTO employeePageQueryDTO)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证：确保查询参数有效</span></span><br><span class="line">    <span class="keyword">if</span> (employeePageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeePageQueryDTO), <span class="string">&quot;查询参数不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 提取和规范化分页参数</span></span><br><span class="line">    <span class="built_in">int</span> pageNumber = Math.Max(<span class="number">1</span>, employeePageQueryDTO.Page); <span class="comment">// 确保页码至少为1</span></span><br><span class="line">    <span class="built_in">int</span> pageSize = Math.Max(<span class="number">1</span>, employeePageQueryDTO.PageSize); <span class="comment">// 确保每页大小至少为1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 构建基础查询</span></span><br><span class="line">        <span class="comment">// 从员工表开始查询，后续添加条件、排序和分页</span></span><br><span class="line">        IQueryable&lt;Employee&gt; query = _context.Employees;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 添加条件过滤</span></span><br><span class="line">        <span class="comment">// 如果提供了姓名参数，使用Contains进行模糊匹配</span></span><br><span class="line">        <span class="comment">// EF Core会将此转换为SQL的LIKE操作</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(employeePageQueryDTO.Name))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> name = employeePageQueryDTO.Name.Trim();</span><br><span class="line">            query = query.Where(e =&gt; e.Name.Contains(name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 查询满足条件的总记录数</span></span><br><span class="line">        <span class="comment">// 在应用分页前执行COUNT查询，获取总记录数</span></span><br><span class="line">        <span class="built_in">int</span> total = <span class="keyword">await</span> query.CountAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 应用排序和分页并执行查询</span></span><br><span class="line">        <span class="comment">// 排序确保分页结果一致性，避免EF Core警告</span></span><br><span class="line">        List&lt;Employee&gt; employees = <span class="keyword">await</span> query</span><br><span class="line">            <span class="comment">// 主排序：按创建时间降序，展示最新员工</span></span><br><span class="line">            .OrderByDescending(e =&gt; e.CreateTime)</span><br><span class="line">            <span class="comment">// 次排序：按ID升序，确保完全确定的顺序</span></span><br><span class="line">            .ThenBy(e =&gt; e.Id)</span><br><span class="line">            <span class="comment">// 计算跳过的记录数</span></span><br><span class="line">            .Skip((pageNumber - <span class="number">1</span>) * pageSize)</span><br><span class="line">            <span class="comment">// 获取当前页的记录数</span></span><br><span class="line">            .Take(pageSize)</span><br><span class="line">            <span class="comment">// 异步执行查询并将结果转为列表</span></span><br><span class="line">            .ToListAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 返回查询结果</span></span><br><span class="line">        <span class="comment">// 使用值元组返回总记录数和当前页数据</span></span><br><span class="line">        <span class="keyword">return</span> (total, employees);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 8. 异常处理</span></span><br><span class="line">        <span class="comment">// 捕获并转换数据库异常，提供更明确的错误信息</span></span><br><span class="line">        <span class="comment">// 保留原始异常作为内部异常，便于调试</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;执行员工分页查询时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于分页查询中涉及日期格式的转换，因此构建中间件以自动优化格式。</p>
<h3 id="4、JacksonObjectMapper"><a href="#4、JacksonObjectMapper" class="headerlink" title="4、JacksonObjectMapper"></a>4、JacksonObjectMapper</h3><p>在ProgramBackEnd\SkyCommon\json\JacksonObjectMapper.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Converters;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Globalization;</span><br><span class="line"><span class="keyword">using</span> JsonConverter = Newtonsoft.Json.JsonConverter;</span><br><span class="line"><span class="keyword">using</span> JsonSerializer = Newtonsoft.Json.JsonSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 对象映射器：基于Newtonsoft.Json将C#对象与JSON字符串之间进行转换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>- 将JSON字符串转换为C#对象：反序列化（Deserialization）<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>- 将C#对象转换为JSON字符串：序列化（Serialization）<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JacksonObjectMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认日期格式（年-月-日）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> DEFAULT_DATE_FORMAT = <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认日期时间格式（年-月-日 时:分）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> DEFAULT_DATE_TIME_FORMAT = <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认时间格式（时:分:秒）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> DEFAULT_TIME_FORMAT = <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JSON序列化配置</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JsonSerializerSettings _settings;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数：创建一个预配置的对象映射器实例</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">JacksonObjectMapper</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 初始化JSON序列化配置</span></span><br><span class="line">            _settings = <span class="keyword">new</span> JsonSerializerSettings</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 处理未知属性：忽略而不抛出异常</span></span><br><span class="line">                MissingMemberHandling = MissingMemberHandling.Ignore,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 处理空值：序列化时忽略空值</span></span><br><span class="line">                NullValueHandling = NullValueHandling.Ignore,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 属性名称策略：使用驼峰命名法（首字母小写）</span></span><br><span class="line">                ContractResolver = <span class="keyword">new</span> CamelCasePropertyNamesContractResolver()</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册日期时间格式转换器</span></span><br><span class="line">            _settings.Converters.Add(<span class="keyword">new</span> IsoDateTimeConverter</span><br><span class="line">            &#123;</span><br><span class="line">                DateTimeFormat = DEFAULT_DATE_TIME_FORMAT,</span><br><span class="line">                Culture = CultureInfo.InvariantCulture</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册日期格式转换器</span></span><br><span class="line">            _settings.Converters.Add(<span class="keyword">new</span> DateOnlyJsonConverter(DEFAULT_DATE_FORMAT));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册时间格式转换器</span></span><br><span class="line">            _settings.Converters.Add(<span class="keyword">new</span> TimeOnlyJsonConverter(DEFAULT_TIME_FORMAT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将对象序列化为JSON字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>要序列化的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>序列化后的JSON字符串<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">WriteValueAsString</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> JsonConvert.SerializeObject(obj, _settings);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将JSON字符串反序列化为指定类型的对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>目标对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;json&quot;&gt;</span>JSON字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>反序列化后的强类型对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">ReadValue</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> JsonConvert.DeserializeObject&lt;T&gt;(json, _settings);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取当前配置的JSON序列化设置</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>JSON序列化配置<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> JsonSerializerSettings <span class="title">GetSerializerSettings</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _settings;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 日期类型JSON转换器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>处理日期（DateTime）的序列化和反序列化，仅包含日期部分<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DateOnlyJsonConverter</span> : <span class="title">JsonConverter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日期格式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _dateFormat;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dateFormat&quot;&gt;</span>指定的日期格式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateOnlyJsonConverter</span>(<span class="params"><span class="built_in">string</span> dateFormat</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dateFormat = dateFormat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 确定此转换器是否可以转换指定的对象类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">CanConvert</span>(<span class="params">Type objectType</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> objectType == <span class="keyword">typeof</span>(DateTime) || objectType == <span class="keyword">typeof</span>(DateTime?);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取JSON并转换为日期对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">object</span> <span class="title">ReadJson</span>(<span class="params">JsonReader reader, Type objectType, <span class="built_in">object</span> existingValue, JsonSerializer serializer</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (reader.TokenType == JsonToken.Null)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> dateStr = reader.Value?.ToString();</span><br><span class="line">            <span class="keyword">if</span> (DateTime.TryParseExact(dateStr, _dateFormat, CultureInfo.InvariantCulture,</span><br><span class="line">                                     DateTimeStyles.None, <span class="keyword">out</span> DateTime date))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> date.Date; <span class="comment">// 只返回日期部分</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试使用默认解析</span></span><br><span class="line">            <span class="keyword">return</span> DateTime.Parse(dateStr, CultureInfo.InvariantCulture);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将日期对象转换为JSON</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WriteJson</span>(<span class="params">JsonWriter writer, <span class="built_in">object</span> <span class="keyword">value</span>, JsonSerializer serializer</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteNull();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            writer.WriteValue(((DateTime)<span class="keyword">value</span>).ToString(_dateFormat, CultureInfo.InvariantCulture));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 时间类型JSON转换器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span>处理时间（TimeSpan）的序列化和反序列化<span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimeOnlyJsonConverter</span> : <span class="title">JsonConverter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 时间格式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _timeFormat;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;timeFormat&quot;&gt;</span>指定的时间格式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeOnlyJsonConverter</span>(<span class="params"><span class="built_in">string</span> timeFormat</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _timeFormat = timeFormat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 确定此转换器是否可以转换指定的对象类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">CanConvert</span>(<span class="params">Type objectType</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> objectType == <span class="keyword">typeof</span>(TimeSpan) || objectType == <span class="keyword">typeof</span>(TimeSpan?);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取JSON并转换为时间对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">object</span> <span class="title">ReadJson</span>(<span class="params">JsonReader reader, Type objectType, <span class="built_in">object</span> existingValue, JsonSerializer serializer</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (reader.TokenType == JsonToken.Null)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> timeStr = reader.Value?.ToString();</span><br><span class="line">            <span class="keyword">if</span> (TimeSpan.TryParseExact(timeStr, _timeFormat, CultureInfo.InvariantCulture, <span class="keyword">out</span> TimeSpan time))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> time;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试使用默认解析</span></span><br><span class="line">            <span class="keyword">return</span> TimeSpan.Parse(timeStr, CultureInfo.InvariantCulture);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将时间对象转换为JSON</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WriteJson</span>(<span class="params">JsonWriter writer, <span class="built_in">object</span> <span class="keyword">value</span>, JsonSerializer serializer</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.WriteNull();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> timeSpan = (TimeSpan)<span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">var</span> formattedTime = <span class="string">$&quot;<span class="subst">&#123;timeSpan.Hours:D2&#125;</span>:<span class="subst">&#123;timeSpan.Minutes:D2&#125;</span>:<span class="subst">&#123;timeSpan.Seconds:D2&#125;</span>&quot;</span>;</span><br><span class="line">            writer.WriteValue(formattedTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、JsonFormatterMiddleware"><a href="#5、JsonFormatterMiddleware" class="headerlink" title="5、JsonFormatterMiddleware"></a>5、JsonFormatterMiddleware</h3><p>在ProgramBackEnd\SkyServer\Middlewares\JsonFormatterMiddleware.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.json;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.Middlewares</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JSON格式化中间件：统一处理HTTP响应中的JSON序列化格式</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 主要功能：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 拦截所有HTTP响应并检测JSON内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 对JSON类型的响应进行统一的格式化处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 确保所有JSON响应采用一致的日期格式、命名规则和序列化策略</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JsonFormatterMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求处理管道中的下一个委托</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JSON对象映射器，负责统一的序列化和反序列化逻辑</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JacksonObjectMapper _jacksonMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 初始化JSON格式化中间件</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;next&quot;&gt;</span>请求委托，表示管道中的下一个中间件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当next参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">JsonFormatterMiddleware</span>(<span class="params">RequestDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _next = next ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(next));</span><br><span class="line">            _jacksonMapper = <span class="keyword">new</span> JacksonObjectMapper();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 处理HTTP请求的核心方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>HTTP上下文，包含请求和响应信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当context参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (context == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(context));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存原始响应流，以便后续还原</span></span><br><span class="line">            <span class="keyword">var</span> originalBodyStream = context.Response.Body;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 创建内存流用于暂存和处理响应内容</span></span><br><span class="line">                <span class="keyword">using</span> <span class="keyword">var</span> responseBody = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                context.Response.Body = responseBody;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用管道中的下一个中间件，处理请求并生成响应</span></span><br><span class="line">                <span class="keyword">await</span> _next(context);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 仅当响应是JSON格式时才进行处理</span></span><br><span class="line">                <span class="keyword">if</span> (IsJsonResponse(context.Response))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> FormatJsonResponseAsync(context.Response, responseBody);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将处理后的响应内容写回原始流</span></span><br><span class="line">                responseBody.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line">                <span class="keyword">await</span> responseBody.CopyToAsync(originalBodyStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 确保始终还原原始响应流，防止响应管道被破坏</span></span><br><span class="line">                context.Response.Body = originalBodyStream;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 检查响应是否为JSON格式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;response&quot;&gt;</span>HTTP响应对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>如果是JSON响应则返回true，否则返回false<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsJsonResponse</span>(<span class="params">HttpResponse response</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查Content-Type是否包含application/json</span></span><br><span class="line">            <span class="keyword">return</span> response.ContentType != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                   response.ContentType.ToLower().Contains(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 格式化JSON响应内容</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;response&quot;&gt;</span>HTTP响应对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;responseStream&quot;&gt;</span>包含原始响应内容的内存流<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">FormatJsonResponseAsync</span>(<span class="params">HttpResponse response, MemoryStream responseStream</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 重置流位置以读取完整内容</span></span><br><span class="line">            responseStream.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取原始响应内容</span></span><br><span class="line">            <span class="keyword">var</span> responseBodyText = <span class="keyword">await</span> <span class="keyword">new</span> StreamReader(responseStream).ReadToEndAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 只有当响应内容非空时才进行处理</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(responseBodyText))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将原始JSON反序列化为动态对象</span></span><br><span class="line">                <span class="keyword">var</span> deserializedObject = JsonConvert.DeserializeObject(responseBodyText);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用JacksonObjectMapper重新序列化，应用统一的格式规则</span></span><br><span class="line">                <span class="keyword">var</span> reformattedJson = _jacksonMapper.WriteValueAsString(deserializedObject);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 清空响应流准备写入格式化后的内容</span></span><br><span class="line">                responseStream.SetLength(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将格式化后的JSON写入响应流</span></span><br><span class="line">                <span class="keyword">var</span> bytes = Encoding.UTF8.GetBytes(reformattedJson);</span><br><span class="line">                <span class="keyword">await</span> responseStream.WriteAsync(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (JsonException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 处理JSON解析错误，保留原始内容</span></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;JSON格式化失败: <span class="subst">&#123;ex.Message&#125;</span>, 路径: <span class="subst">&#123;ex.Path&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重置流并写回原始内容，确保响应不受影响</span></span><br><span class="line">                responseStream.SetLength(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">var</span> bytes = Encoding.UTF8.GetBytes(responseBodyText);</span><br><span class="line">                <span class="keyword">await</span> responseStream.WriteAsync(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获其他可能的异常</span></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;JSON处理过程中发生意外错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 还原原始内容</span></span><br><span class="line">                responseStream.SetLength(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">var</span> bytes = Encoding.UTF8.GetBytes(responseBodyText);</span><br><span class="line">                <span class="keyword">await</span> responseStream.WriteAsync(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250527152113819.png" alt="image-20250527152113819"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250527152147219.png" alt="image-20250527152147219"></p>
<h2 id="3、启用、禁用员工账户"><a href="#3、启用、禁用员工账户" class="headerlink" title="3、启用、禁用员工账户"></a>3、启用、禁用员工账户</h2><h3 id="1、EmployeeController-cs-2"><a href="#1、EmployeeController-cs-2" class="headerlink" title="1、EmployeeController.cs"></a>1、EmployeeController.cs</h3><p>ProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs</p>
<p>该文件中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 启用或禁用员工账号</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据传入的状态值修改员工账号的可用状态。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 状态值：1表示启用账号，0表示禁用账号。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1=启用，0=禁用<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，包含成功提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回统一封装的结果对象，提示修改成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值不是0或1时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;EntityNotFoundException&quot;&gt;</span>当指定ID的员工不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">[<span class="meta">HttpPost(<span class="string">&quot;status/&#123;status&#125;&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; StartOrStop([FromRoute] <span class="built_in">int</span> status, [FromQuery] <span class="built_in">long</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (status != <span class="number">0</span> &amp;&amp; status != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;员工状态修改失败：无效的状态值 &#123;Status&#125;，员工ID &#123;Id&#125;&quot;</span>, status, id);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;状态值只能是0(禁用)或1(启用)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录操作开始，明确操作类型</span></span><br><span class="line">    <span class="built_in">string</span> actionType = status == <span class="number">1</span> ? <span class="string">&quot;启用&quot;</span> : <span class="string">&quot;禁用&quot;</span>;</span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;正在&#123;ActionType&#125;员工账号，员工ID：&#123;Id&#125;&quot;</span>, actionType, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用业务服务处理启用或禁用操作</span></span><br><span class="line">    <span class="keyword">await</span> _employeeService.StartOrStop(status, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录操作成功</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;已成功&#123;ActionType&#125;员工账号，员工ID：&#123;Id&#125;&quot;</span>, actionType, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回操作结果</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">$&quot;员工账号<span class="subst">&#123;actionType&#125;</span>成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、EmployeeService-2"><a href="#2、EmployeeService-2" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h3><p>在ProgramBackEnd\SkyServer\service\IEmployeeService.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 启用或禁用员工账号</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据指定的状态值修改员工账号的可用状态，执行以下操作:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证员工ID的有效性和存在性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 验证状态值的合法性(必须为0或1)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 更新员工状态并记录修改时间</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 保存更改到数据库并返回更新后的员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 目标状态值：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 1：启用账号，允许员工登录系统</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 0：禁用账号，阻止员工登录系统</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>员工ID，标识要修改状态的员工记录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新后的员工实体对象，包含最新的状态信息和修改时间戳。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于向调用方确认操作已成功执行。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值不是0或1时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;EntityNotFoundException&quot;&gt;</span>当指定ID的员工不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当操作违反业务规则时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此方法实现了账号状态管理功能，是员工管理中的关键操作。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 状态变更会立即生效，影响员工的系统访问权限。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function">Task&lt;Employee&gt; <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\service\Impl\EmployeeServiceImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 启用或禁用员工账号</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据传入的状态值修改员工账号状态，实现账号的启用和禁用功能。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行流程：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证状态值是否合法(0或1)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 获取当前登录用户ID用于审计</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 构建员工状态更新对象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 调用数据访问层执行更新</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态值：1表示启用，0表示禁用<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要修改状态的员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>更新后的员工实体对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值不是0或1时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当未获取到当前登录用户信息时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;EntityNotFoundException&quot;&gt;</span>当员工ID不存在时抛出(由数据层处理)<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee&gt; <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证：确保状态值合法</span></span><br><span class="line">    <span class="keyword">if</span> (status != StatusConstant.ENABLE &amp;&amp; status != StatusConstant.DISABLE)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;修改员工状态失败：无效的状态值 &#123;Status&#125;，员工ID &#123;Id&#125;&quot;</span>, status, id);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;状态值只能是0(禁用)或1(启用)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 获取当前操作人ID：用于审计跟踪</span></span><br><span class="line">    <span class="built_in">long</span>? currentEmpId = BaseContext.GetCurrentId();</span><br><span class="line">    <span class="keyword">if</span> (!currentEmpId.HasValue)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;修改员工状态失败：未能获取当前操作人信息&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> actionType = status == StatusConstant.ENABLE ? <span class="string">&quot;启用&quot;</span> : <span class="string">&quot;禁用&quot;</span>;</span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;开始&#123;ActionType&#125;员工账号，员工ID：&#123;Id&#125;，操作人ID：&#123;OperatorId&#125;&quot;</span>, </span><br><span class="line">        actionType, id, currentEmpId.Value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 构建仅包含必要更新字段的员工实体</span></span><br><span class="line">    Employee employee = <span class="keyword">new</span> Employee</span><br><span class="line">    &#123;</span><br><span class="line">        Id = id,               <span class="comment">// 指定要更新的员工ID</span></span><br><span class="line">        Status = status,       <span class="comment">// 设置新状态</span></span><br><span class="line">        UpdateTime = DateTime.Now,  <span class="comment">// 记录更新时间</span></span><br><span class="line">        UpdateUser = currentEmpId.Value  <span class="comment">// 记录操作人</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4. 调用数据访问层执行更新操作</span></span><br><span class="line">        <span class="comment">// 注意：Update方法应实现为只更新非null字段</span></span><br><span class="line">        employee = <span class="keyword">await</span> _employeeMapper.Update(employee);</span><br><span class="line">        </span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;已成功&#123;ActionType&#125;员工账号，员工ID：&#123;Id&#125;&quot;</span>, actionType, id);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogError(ex, <span class="string">&quot;员工状态修改失败，员工ID：&#123;Id&#125;，目标状态：&#123;Status&#125;&quot;</span>, id, status);</span><br><span class="line">        <span class="keyword">throw</span>; <span class="comment">// 保留原始异常，由全局异常处理器处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、EmployeeMapper-2"><a href="#3、EmployeeMapper-2" class="headerlink" title="3、EmployeeMapper"></a>3、EmployeeMapper</h3><p>在ProgramBackEnd\SkyServer\mapper\IEmployeeMapper.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据提供的员工实体对象，更新数据库中对应员工的信息。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 采用部分更新策略，只更新实体对象中非null/非默认值的字段，</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 保留其他字段的现有值。作为数据访问层的核心更新方法，</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 负责将业务层的变更持久化到数据库。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employee&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 包含更新字段的员工实体对象，必须设置有效的Id属性，</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 其他属性值为null时将不被更新。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新后的完整员工实体对象，包含所有最新的字段值。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于向调用方确认更新结果和提供最新数据。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当employee参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当employee.Id无效或不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>当数据库更新操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当发生其他数据访问错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现注意事项：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 必须验证员工ID的有效性和存在性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 只更新提供的非null字段，保留其他字段现有值</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 自动维护UpdateTime字段为当前时间</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 处理并发更新冲突，如使用乐观锁或悲观锁策略</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 5. 确保唯一键约束不被违反(如用户名唯一)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 6. 更新后返回完整的员工实体对象，包括所有已更新和未更新的字段</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 典型用例包括：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 员工账号状态变更(启用/禁用)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 员工基本信息修改(联系方式、密码等)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - 员工权限或角色调整</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function">Task&lt;Employee&gt; <span class="title">Update</span>(<span class="params">Employee employee</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\mapper\Impl\EmployeeMapperImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询实现</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据查询条件从数据库检索员工记录并进行分页处理。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 支持按员工姓名模糊搜索，结果按创建时间降序排列。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeePageQueryDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工分页查询数据传输对象，包含：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工姓名(可选)，用于模糊匹配</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回包含两个元素的元组：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - total: 满足条件的总记录数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - employees: 当前页的员工记录列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>数据库查询执行出错时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;(<span class="built_in">int</span> total, List&lt;Employee&gt; employees)&gt; PageQuery(EmployeePageQueryDTO employeePageQueryDTO)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证：确保查询参数有效</span></span><br><span class="line">    <span class="keyword">if</span> (employeePageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeePageQueryDTO), <span class="string">&quot;查询参数不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 提取和规范化分页参数</span></span><br><span class="line">    <span class="built_in">int</span> pageNumber = Math.Max(<span class="number">1</span>, employeePageQueryDTO.Page); <span class="comment">// 确保页码至少为1</span></span><br><span class="line">    <span class="built_in">int</span> pageSize = Math.Max(<span class="number">1</span>, employeePageQueryDTO.PageSize); <span class="comment">// 确保每页大小至少为1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 构建基础查询</span></span><br><span class="line">        <span class="comment">// 从员工表开始查询，后续添加条件、排序和分页</span></span><br><span class="line">        IQueryable&lt;Employee&gt; query = _context.Employees;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 添加条件过滤</span></span><br><span class="line">        <span class="comment">// 如果提供了姓名参数，使用Contains进行模糊匹配</span></span><br><span class="line">        <span class="comment">// EF Core会将此转换为SQL的LIKE操作</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(employeePageQueryDTO.Name))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> name = employeePageQueryDTO.Name.Trim();</span><br><span class="line">            query = query.Where(e =&gt; e.Name.Contains(name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 查询满足条件的总记录数</span></span><br><span class="line">        <span class="comment">// 在应用分页前执行COUNT查询，获取总记录数</span></span><br><span class="line">        <span class="built_in">int</span> total = <span class="keyword">await</span> query.CountAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 应用排序和分页并执行查询</span></span><br><span class="line">        <span class="comment">// 排序确保分页结果一致性，避免EF Core警告</span></span><br><span class="line">        List&lt;Employee&gt; employees = <span class="keyword">await</span> query</span><br><span class="line">            <span class="comment">// 主排序：按创建时间降序，展示最新员工</span></span><br><span class="line">            .OrderByDescending(e =&gt; e.CreateTime)</span><br><span class="line">            <span class="comment">// 次排序：按ID升序，确保完全确定的顺序</span></span><br><span class="line">            .ThenBy(e =&gt; e.Id)</span><br><span class="line">            <span class="comment">// 计算跳过的记录数</span></span><br><span class="line">            .Skip((pageNumber - <span class="number">1</span>) * pageSize)</span><br><span class="line">            <span class="comment">// 获取当前页的记录数</span></span><br><span class="line">            .Take(pageSize)</span><br><span class="line">            <span class="comment">// 异步执行查询并将结果转为列表</span></span><br><span class="line">            .ToListAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 返回查询结果</span></span><br><span class="line">        <span class="comment">// 使用值元组返回总记录数和当前页数据</span></span><br><span class="line">        <span class="keyword">return</span> (total, employees);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 8. 异常处理</span></span><br><span class="line">        <span class="comment">// 捕获并转换数据库异常，提供更明确的错误信息</span></span><br><span class="line">        <span class="comment">// 保留原始异常作为内部异常，便于调试</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;执行员工分页查询时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250527164504782.png" alt="image-20250527164504782"></p>
<h2 id="4、编辑员工"><a href="#4、编辑员工" class="headerlink" title="4、编辑员工"></a>4、编辑员工</h2><h3 id="1、EmployeeController-cs-3"><a href="#1、EmployeeController-cs-3" class="headerlink" title="1、EmployeeController.cs"></a>1、EmployeeController.cs</h3><p>ProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs</p>
<p>该文件中完整内容如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据ID查询员工详细信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定员工的完整信息，供前端展示或编辑使用。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回信息中会过滤敏感字段如密码，确保数据安全。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要查询的员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含员工详细信息的结果对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回员工详细信息<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当查询的员工ID不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;Employee&gt;&gt; GetById([FromRoute] <span class="built_in">long</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录查询操作，便于审计追踪</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;查询员工详细信息，员工ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用业务服务获取员工信息</span></span><br><span class="line">    Employee employee = <span class="keyword">await</span> _employeeService.GetById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证查询结果，处理员工不存在的情况</span></span><br><span class="line">    <span class="keyword">if</span> (employee == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;未找到员工信息，员工ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;未找到ID为<span class="subst">&#123;id&#125;</span>的员工&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;员工信息查询成功，员工ID：&#123;Id&#125;，姓名：&#123;Name&#125;&quot;</span>, id, employee.Name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回成功结果，包含员工信息</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;Employee&gt;.Success(employee);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新员工信息接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 修改现有员工的基本信息，如姓名、联系方式等。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 只有已认证的管理员可以调用此接口，且只能修改允许的字段。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span>包含更新信息的员工DTO对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>统一封装的操作结果对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回更新成功的信息<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当提供的员工ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;EntityNotFoundException&quot;&gt;</span>当指定ID的员工不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">[<span class="meta">HttpPut</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Update([FromBody] EmployeeDTO employeeDTO)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 记录更新操作，包含必要的上下文信息</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;更新员工信息，员工ID：&#123;Id&#125;，姓名：&#123;Name&#125;&quot;</span>, employeeDTO.Id, employeeDTO.Name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用业务服务执行更新操作</span></span><br><span class="line">    <span class="comment">// 业务层负责验证数据完整性、更新审计字段并持久化</span></span><br><span class="line">    <span class="keyword">await</span> _employeeService.Update(employeeDTO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录操作成功</span></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;员工信息更新成功，员工ID：&#123;Id&#125;&quot;</span>, employeeDTO.Id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回统一的成功响应</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;员工信息更新成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、EmployeeService-3"><a href="#2、EmployeeService-3" class="headerlink" title="2、EmployeeService"></a>2、EmployeeService</h3><p>在ProgramBackEnd\SkyServer\service\IEmployeeService.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据ID查询员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定ID的员工详细信息，执行以下操作:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证员工ID的有效性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 从数据库查询对应的员工记录</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 过滤敏感信息(如密码)后返回给调用方</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要查询的员工ID，系统中员工的唯一标识<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 员工实体对象，包含员工的基本信息，但不包含敏感字段如密码。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 如果指定ID的员工不存在，则返回null。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当员工ID无效(小于等于0)时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此方法通常用于员工信息展示、编辑前的数据获取等场景。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现时应注意移除敏感信息，确保数据安全。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">Task&lt;Employee?&gt; GetById(<span class="built_in">long</span> id);</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 修改现有员工的信息，执行以下操作:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证员工ID的有效性和存在性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 验证更新数据的有效性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 选择性地更新提供的非空字段</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 记录更新时间和操作人</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 5. 将更改保存到数据库</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 包含更新信息的员工数据传输对象，包含:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Id: 要更新的员工ID，必须有效</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Username: 登录用户名(可选)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Name: 员工真实姓名(可选)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Phone: 联系电话(可选)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Sex: 性别(可选)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - IdNumber: 身份证号码(可选)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当employeeDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当员工ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;EntityNotFoundException&quot;&gt;</span>当指定ID的员工不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当更新操作违反业务规则时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此方法实现了员工基本信息的更新功能，只更新提供的非空字段。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现时应注意验证数据有效性，确保符合业务规则。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="function">Task <span class="title">Update</span>(<span class="params">EmployeeDTO employeeDTO</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\service\Impl\EmployeeServiceImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据ID查询员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定ID的员工详细信息，并移除敏感信息（如密码）后返回。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行流程：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证员工ID的有效性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 调用数据访问层查询员工详细信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 处理安全敏感字段，移除密码等信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要查询的员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>员工实体对象，不包含密码等敏感信息；如未找到则返回null<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效（小于等于0）时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 此方法通常用于前端展示员工信息或获取员工编辑初始数据。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 基于安全考虑，返回的员工信息中密码字段将被清除。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee?&gt; GetById(<span class="built_in">long</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (id &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;查询员工信息失败：无效的员工ID &#123;Id&#125;&quot;</span>, id);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;员工ID必须大于0&quot;</span>, <span class="keyword">nameof</span>(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;查询员工信息，员工ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 调用数据访问层查询员工详细信息</span></span><br><span class="line">    Employee? employee = <span class="keyword">await</span> _employeeMapper.GetById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 处理结果（如未找到员工）</span></span><br><span class="line">    <span class="keyword">if</span> (employee == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;未找到指定的员工信息，员工ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 处理安全敏感字段：清除密码信息</span></span><br><span class="line">    employee.Password = <span class="literal">null</span>; <span class="comment">// 移除敏感信息，确保安全</span></span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;成功获取员工信息，员工ID：&#123;Id&#125;，姓名：&#123;Name&#125;&quot;</span>, id, employee.Name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> employee;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据DTO中的信息更新员工记录，采用部分更新策略，</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 只更新DTO中非空字段，保留其他字段的现有值。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 确保更新操作的审计信息完整可追溯。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;employeeDTO&quot;&gt;</span>包含更新信息的员工DTO对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当employeeDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当员工ID无效或不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当未能获取当前登录用户信息时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">EmployeeDTO employeeDTO</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (employeeDTO == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(employeeDTO), <span class="string">&quot;员工信息不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (employeeDTO.Id &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;员工ID无效&quot;</span>, <span class="keyword">nameof</span>(employeeDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取当前操作人信息用于审计</span></span><br><span class="line">    <span class="built_in">long</span>? currentEmpId = BaseContext.GetCurrentId();</span><br><span class="line">    <span class="keyword">if</span> (!currentEmpId.HasValue)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogWarning(<span class="string">&quot;更新员工信息失败：未能获取当前操作人信息&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;开始更新员工信息，员工ID：&#123;Id&#125;，操作人ID：&#123;OperatorId&#125;&quot;</span>, employeeDTO.Id, currentEmpId.Value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 创建员工实体并设置基础信息</span></span><br><span class="line">    Employee employee = <span class="keyword">new</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        Id = employeeDTO.Id,</span><br><span class="line">        UpdateTime = DateTime.Now,</span><br><span class="line">        UpdateUser = currentEmpId.Value</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 复制属性（忽略空值和ID字段）</span></span><br><span class="line">    <span class="comment">// 注：此处使用PropertyUtil工具类完成属性复制，仅复制非空属性</span></span><br><span class="line">    PropertyUtil.CopyPropertiesIgnoreNull(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 调用数据访问层执行更新操作</span></span><br><span class="line">    <span class="keyword">await</span> _employeeMapper.Update(employee);</span><br><span class="line"></span><br><span class="line">    _logger.LogInformation(<span class="string">&quot;员工信息更新成功，员工ID：&#123;Id&#125;&quot;</span>, employeeDTO.Id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、EmployeeMapper-3"><a href="#3、EmployeeMapper-3" class="headerlink" title="3、EmployeeMapper"></a>3、EmployeeMapper</h3><p>在ProgramBackEnd\SkyServer\mapper\IEmployeeMapper.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据ID查询员工详细信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 从数据库中检索指定ID的员工完整信息。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 作为数据访问层的基础查询方法，提供单一员工记录的详细数据获取能力。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通常用于员工信息展示、编辑前的数据获取以及其他需要完整员工信息的操作。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要查询的员工ID，数据库记录的唯一标识<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 匹配ID的员工实体对象；若未找到对应记录则返回null</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回的实体包含员工的所有字段信息，包括敏感数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效（小于等于0）时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>查询执行过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 实现注意事项：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 确保参数验证，避免无效ID值</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 优化查询性能，利用主键索引</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 处理未找到记录的情况，返回null而非抛出异常</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4. 记录查询异常，提供有意义的错误信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 业务层应负责过滤返回数据中的敏感字段（如密码），确保数据安全。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">Task&lt;Employee?&gt; GetById(<span class="built_in">long</span> id);</span><br></pre></td></tr></table></figure>

<p>在ProgramBackEnd\SkyServer\mapper\Impl\EmployeeMapperImpl.cs中添加如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据ID查询员工详细信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 从数据库中检索指定ID的员工完整信息。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 操作流程：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 验证ID参数有效性</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 查询数据库获取员工信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 3. 处理查询结果，包括未找到情况</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要查询的员工ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>匹配的员工实体对象；未找到则返回null<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效（小于等于0）时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>查询执行过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Employee?&gt; GetById(<span class="built_in">long</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 参数验证</span></span><br><span class="line">    <span class="keyword">if</span> (id &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;员工ID必须大于0&quot;</span>, <span class="keyword">nameof</span>(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 2. 使用异步方法执行查询</span></span><br><span class="line">        <span class="comment">// FirstOrDefaultAsync在未找到记录时返回null而不是抛出异常</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> _context.Employees.FirstOrDefaultAsync(e =&gt; e.Id == id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 异常处理：捕获并转换数据库异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;查询ID为 <span class="subst">&#123;id&#125;</span> 的员工信息时发生错误&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250527184423407.png" alt="image-20250527184423407"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250527184443493.png" alt="image-20250527184443493"></p>
<h1 id="2、分类管理界面"><a href="#2、分类管理界面" class="headerlink" title="2、分类管理界面"></a>2、分类管理界面</h1><p><img src="/2023/12/08/CPlusPlus02/mage-20250526192808226.png" alt="image-20250526192808226"></p>
<h2 id="1、CategoryController"><a href="#1、CategoryController" class="headerlink" title="1、CategoryController"></a>1、CategoryController</h2><p>ProgramBackEnd\SkyServer\controller\admin\CategoryController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.controller.admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类管理控制器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品和套餐分类的CRUD和状态管理API接口。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 作为系统后台分类管理模块的核心控制器，处理分类数据的各种操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该控制器提供以下功能：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 新增分类信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 分页查询分类信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 删除指定分类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 修改分类信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 5. 启用或禁用分类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 6. 根据类型查询分类列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/category&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;CategoryController&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类服务接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ICategoryService _categoryService;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化控制器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryService&quot;&gt;</span>分类服务实现<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CategoryController</span>(<span class="params">ILogger&lt;CategoryController&gt; logger, ICategoryService categoryService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger;</span><br><span class="line">            _categoryService = categoryService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建新的分类记录，可用于添加菜品分类或套餐分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类创建后即可在相应的菜品管理或套餐管理中使用。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span>分类信息数据传输对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，包含成功提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回统一封装的成功结果对象<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Save([FromBody] CategoryDTO categoryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始保存分类信息: &#123;@CategoryDTO&#125;&quot;</span>, categoryDTO);</span><br><span class="line">            <span class="keyword">await</span> _categoryService.Save(categoryDTO);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;分类保存成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件分页获取分类列表，支持按名称模糊查询和类型过滤。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主要用于后台分类管理页面的数据展示。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryPageQueryDTO&quot;&gt;</span>分类分页查询参数，包含页码、每页大小、名称和类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含分页结果的统一响应对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回分页数据，包含总记录数和当前页数据集合<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;page&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;PageResult&gt;&gt; Page([FromQuery] CategoryPageQueryDTO categoryPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;获取分类分页信息: &#123;@CategoryPageQueryDTO&#125;&quot;</span>, categoryPageQueryDTO);</span><br><span class="line">            PageResult page = <span class="keyword">await</span> _categoryService.PageQuery(categoryPageQueryDTO);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;PageResult&gt;.Success(page);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除指定分类。删除前会检查该分类是否有关联的菜品或套餐，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果存在关联数据则不允许删除，以保持数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要删除的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，包含成功提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回统一封装的成功结果对象<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>当分类关联了菜品或套餐时返回错误信息<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpDelete</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; DeleteById([FromQuery] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;删除分类，ID: &#123;Id&#125;&quot;</span>, id);</span><br><span class="line">            <span class="keyword">await</span> _categoryService.DeleteById(id);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;删除分类成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改现有分类的基本信息，如名称和排序值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于维护和调整分类数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span>包含更新信息的分类数据传输对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，包含成功提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回统一封装的成功结果对象<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPut</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Update([FromBody] CategoryDTO categoryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;更新分类信息: &#123;@CategoryDTO&#125;&quot;</span>, categoryDTO);</span><br><span class="line">            <span class="keyword">await</span> _categoryService.Update(categoryDTO);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;修改分类成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 启用或禁用分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据传入的状态值修改分类的可用状态。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 状态值：1表示启用，0表示禁用。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1=启用，0=禁用<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，包含成功提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回统一封装的成功结果对象<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;status/&#123;status&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; StartOrStop([FromRoute] <span class="built_in">int</span> status, [FromQuery] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;更改分类状态，ID: &#123;Id&#125;，目标状态: &#123;Status&#125;&quot;</span>, id, status);</span><br><span class="line">            <span class="keyword">await</span> _categoryService.StartOrStop(status, id);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;修改分类状态成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据类型查询分类列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定类型的所有分类，不分页。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 类型：1表示菜品分类，2表示套餐分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主要用于新增菜品或套餐时的分类选择下拉列表。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>分类类型：1=菜品分类，2=套餐分类<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含分类列表的统一响应对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回指定类型的分类列表数据<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;list&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;List&lt;Category&gt;&gt;&gt; List([FromQuery] <span class="built_in">int</span> type)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;获取分类列表，类型: &#123;Type&#125;&quot;</span>, type);</span><br><span class="line">            List&lt;Category&gt; categories = <span class="keyword">await</span> _categoryService.GetCategoriesByType(type);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;List&lt;Category&gt;&gt;.Success(categories);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、CategoryService"><a href="#2、CategoryService" class="headerlink" title="2、CategoryService"></a>2、CategoryService</h2><p>ProgramBackEnd\SkyServer\service\ICategoryService.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类服务接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义系统中分类相关的业务操作契约，是分类管理模块的核心服务接口。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品分类和套餐分类的增删改查、状态管理等功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该接口遵循以下设计原则:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 职责单一: 专注于分类管理相关的业务逻辑</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 接口隔离: 只定义必要的方法，避免臃肿</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 异步设计: 所有操作均返回Task，提高系统响应性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 面向业务: 方法命名和参数设计贴近业务需求</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICategoryService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建新的分类记录，包括以下步骤：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证分类必要信息的有效性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 确保分类名称的唯一性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 设置适当的状态和审计字段</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 4. 持久化分类信息到数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类数据传输对象，包含：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Type: 分类类型(1:菜品分类,2:套餐分类)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name: 分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Sort: 排序优先级</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当分类数据无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当分类名称已存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Save</span>(<span class="params">CategoryDTO categoryDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除指定分类，包括以下步骤：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证分类ID的有效性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 检查分类是否关联了菜品或套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 如无关联，执行物理删除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要删除的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当分类已关联菜品或套餐时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据DTO中的信息更新分类记录，包括以下步骤：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证分类ID和更新数据的有效性</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 检查分类名称唯一性(若修改了名称)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 更新分类信息并记录审计信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包含更新信息的分类DTO对象，包含：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Id: 分类ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Type: 分类类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name: 分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Sort: 排序优先级</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当分类ID或数据无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当分类名称已被其他分类使用时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">CategoryDTO categoryDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件分页获取分类列表，包括以下步骤：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证并规范化分页参数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 应用查询条件(名称模糊匹配和类型筛选)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 按排序字段和创建时间排序</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 4. 分页返回结果</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryPageQueryDTO&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询参数，包含：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Page: 页码</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name: 分类名称(可选，用于模糊查询)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Type: 分类类型(可选，用于精确筛选)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果对象，包含总记录数和当前页数据列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">CategoryPageQueryDTO categoryPageQueryDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 启用或禁用分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改分类的可用状态，实现分类的启用或禁用功能。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 禁用的分类将不会在前端展示，也不能用于新建菜品或套餐。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态值：1表示启用，0表示禁用<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要修改状态的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值不是0或1时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BusinessException&quot;&gt;</span>当分类不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据类型查询分类列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定类型的所有可用分类，不分页，通常用于下拉选择。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 只返回状态为启用的分类，按照排序字段升序排列。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类类型：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 1: 菜品分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 2: 套餐分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分类列表，包含ID、名称等信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法通常用于菜品管理或套餐管理模块中的分类选择下拉列表。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;Category&gt;&gt; GetCategoriesByType(<span class="built_in">int</span> type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProgramBackEnd\SkyServer\service\Impl\CategoryServiceImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.constant;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.context;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.utils;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类服务实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现<span class="doctag">&lt;see cref=&quot;ICategoryService&quot;/&gt;</span>接口，提供分类管理的核心业务逻辑。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 处理菜品分类和套餐分类的增删改查，以及状态管理等操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此实现采用以下设计原则:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 三层架构：通过依赖注入与数据访问层解耦</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 单一职责：专注于分类管理的业务逻辑</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 审计追踪：所有操作都记录操作人和时间戳</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 防御式编程：进行必要的参数验证和用户权限检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryServiceImpl</span> : <span class="title">ICategoryService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类数据访问对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ICategoryMapper _categoryMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;CategoryServiceImpl&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入获取所需服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryMapper&quot;&gt;</span>分类数据访问对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CategoryServiceImpl</span>(<span class="params">ICategoryMapper categoryMapper, ILogger&lt;CategoryServiceImpl&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _categoryMapper = categoryMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(categoryMapper));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除指定分类。在实际业务中，删除前应检查该分类是否已关联菜品或套餐，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如有关联，则不允许删除，确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要删除的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;删除分类失败：无效的分类ID &#123;Id&#125;&quot;</span>, id);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类ID无效&quot;</span>, <span class="keyword">nameof</span>(id));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始删除分类，ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line">            <span class="keyword">await</span> _categoryMapper.DeleteById(id);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分类删除成功，ID：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据类型查询分类列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定类型的所有可用分类，主要用于前端下拉选择。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法通常返回状态为启用的分类，按排序字段排序。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>分类类型：1=菜品分类，2=套餐分类<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定类型的分类列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Category&gt;&gt; GetCategoriesByType(<span class="built_in">int</span> type)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;查询分类列表，类型：&#123;Type&#125;&quot;</span>, type);</span><br><span class="line">            List&lt;Category&gt; categories = <span class="keyword">await</span> _categoryMapper.GetCategoriesByType(type);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;查询到&#123;Count&#125;条分类记录，类型：&#123;Type&#125;&quot;</span>, categories.Count, type);</span><br><span class="line">            <span class="keyword">return</span> categories;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件分页获取分类列表，支持按名称和类型筛选。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryPageQueryDTO&quot;&gt;</span>分类分页查询参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果对象，包含总记录数和当前页数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">CategoryPageQueryDTO categoryPageQueryDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始执行分类分页查询，参数：&#123;@CategoryPageQueryDTO&#125;&quot;</span>, categoryPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 执行分页查询，获取结果元组</span></span><br><span class="line">            (<span class="built_in">int</span> total, List&lt;Category&gt; categories) = <span class="keyword">await</span> _categoryMapper.PageQuery(categoryPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 构建标准化的分页结果对象</span></span><br><span class="line">            PageResult pageResult = <span class="keyword">new</span>()</span><br><span class="line">            &#123;</span><br><span class="line">                Total = total,         <span class="comment">// 设置满足条件的总记录数</span></span><br><span class="line">                Records = categories   <span class="comment">// 设置当前页的数据列表</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分类分页查询完成，共返回&#123;Count&#125;条记录，总记录数&#123;Total&#125;&quot;</span>, categories.Count, total);</span><br><span class="line">            <span class="keyword">return</span> pageResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建新的分类记录，设置默认状态和审计信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span>分类数据传输对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当当前用户未登录或分类数据无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Save</span>(<span class="params">CategoryDTO categoryDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 获取当前登录用户ID，用于审计</span></span><br><span class="line">            <span class="built_in">long</span>? currentUserId = BaseContext.GetCurrentId();</span><br><span class="line">            <span class="keyword">if</span> (currentUserId == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;新增分类失败：未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;当前用户ID不能为空，请先登录&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 验证分类数据</span></span><br><span class="line">            <span class="keyword">if</span> (categoryDTO == <span class="literal">null</span> || <span class="built_in">string</span>.IsNullOrEmpty(categoryDTO.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;新增分类失败：分类数据无效&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类数据无效&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建分类实体并设置属性</span></span><br><span class="line">            Category category = <span class="keyword">new</span> Category();</span><br><span class="line">            PropertyUtil.CopyProperties(categoryDTO, category);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 设置审计字段和默认状态</span></span><br><span class="line">            DateTime now = DateTime.Now;</span><br><span class="line">            category.CreateUser = currentUserId.Value;</span><br><span class="line">            category.UpdateUser = currentUserId.Value;</span><br><span class="line">            category.CreateTime = now;</span><br><span class="line">            category.UpdateTime = now;</span><br><span class="line">            category.Status = StatusConstant.ENABLE; <span class="comment">// 默认启用状态</span></span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;准备保存分类信息: &#123;@Category&#125;&quot;</span>, category);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 持久化到数据库</span></span><br><span class="line">            <span class="keyword">await</span> _categoryMapper.Insert(category);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分类信息保存成功，名称：&#123;Name&#125;, 类型：&#123;Type&#125;&quot;</span>, category.Name, category.Type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 启用或禁用分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类的可用状态，同时记录操作人和时间。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 状态值：1表示启用，0表示禁用。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值不是0或1时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (status != StatusConstant.ENABLE &amp;&amp; status != StatusConstant.DISABLE)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;分类状态修改失败：无效的状态值 &#123;Status&#125;&quot;</span>, status);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;状态值只能是0(禁用)或1(启用)&quot;</span>, <span class="keyword">nameof</span>(status));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;分类状态修改失败：无效的分类ID &#123;Id&#125;&quot;</span>, id);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类ID无效&quot;</span>, <span class="keyword">nameof</span>(id));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 获取当前操作人ID</span></span><br><span class="line">            <span class="built_in">long</span>? currentUserId = BaseContext.GetCurrentId();</span><br><span class="line">            <span class="keyword">if</span> (currentUserId == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;分类状态修改失败：未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 构建更新实体</span></span><br><span class="line">            <span class="built_in">string</span> actionType = status == StatusConstant.ENABLE ? <span class="string">&quot;启用&quot;</span> : <span class="string">&quot;禁用&quot;</span>;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始&#123;ActionType&#125;分类，ID：&#123;Id&#125;&quot;</span>, actionType, id);</span><br><span class="line"></span><br><span class="line">            Category category = <span class="keyword">new</span> Category</span><br><span class="line">            &#123;</span><br><span class="line">                Id = id,</span><br><span class="line">                Status = status,</span><br><span class="line">                UpdateUser = currentUserId.Value,</span><br><span class="line">                UpdateTime = DateTime.Now</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 执行更新</span></span><br><span class="line">            <span class="keyword">await</span> _categoryMapper.Update(category);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;已成功&#123;ActionType&#125;分类，ID：&#123;Id&#125;&quot;</span>, actionType, id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据DTO中的信息更新分类记录，记录修改人和时间。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryDTO&quot;&gt;</span>包含更新信息的分类DTO对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当分类ID无效或当前用户未登录时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">CategoryDTO categoryDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (categoryDTO == <span class="literal">null</span> || categoryDTO.Id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;更新分类失败：无效的分类数据或ID&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类数据或ID无效&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 获取当前操作人ID</span></span><br><span class="line">            <span class="built_in">long</span>? currentUserId = BaseContext.GetCurrentId();</span><br><span class="line">            <span class="keyword">if</span> (currentUserId == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogWarning(<span class="string">&quot;更新分类失败：未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;未获取到当前登录用户信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始更新分类信息，ID：&#123;Id&#125;，名称：&#123;Name&#125;&quot;</span>, categoryDTO.Id, categoryDTO.Name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建分类实体并设置属性</span></span><br><span class="line">            Category category = <span class="keyword">new</span> Category();</span><br><span class="line">            PropertyUtil.CopyProperties(categoryDTO, category);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 设置审计字段</span></span><br><span class="line">            category.UpdateUser = currentUserId.Value;</span><br><span class="line">            category.UpdateTime = DateTime.Now;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 执行更新</span></span><br><span class="line">            <span class="keyword">await</span> _categoryMapper.Update(category);</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分类信息更新成功，ID：&#123;Id&#125;&quot;</span>, categoryDTO.Id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3、CategoryMapper"><a href="#3、CategoryMapper" class="headerlink" title="3、CategoryMapper"></a>3、CategoryMapper</h2><p>ProgramBackEnd\SkyServer\mapper\ICategoryMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与数据库交互的分类相关数据操作，作为数据访问层的核心组件。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品分类和套餐分类的基础CRUD功能，实现业务逻辑与数据访问的解耦。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设计原则:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 职责单一: 专注于分类实体的数据访问操作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 持久化中立: 不暴露底层数据库实现细节</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 异步优先: 所有操作均为异步，提高系统吞吐量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 接口隔离: 提供最小必要的操作集合，避免接口臃肿</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICategoryMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增分类记录</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将分类信息持久化到数据库，包括分类名称、类型、排序值、状态等信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;category&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 要插入的分类实体，应包含完整的分类信息，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包括审计字段(CreateTime, UpdateTime, CreateUser, UpdateUser)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当category参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>当数据库插入操作失败时抛出，如唯一索引冲突<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类名称在同一类型中应保持唯一性，实现时应考虑唯一约束的处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Insert</span>(<span class="params">Category category</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据提供的分类实体，更新数据库中对应记录的信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 采用部分更新策略，只更新非null字段，保留其他字段的现有值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;category&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包含更新信息的分类实体，必须设置Id属性；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 其他属性如为null则不更新对应字段</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当category为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当分类ID无效或不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>当数据库更新失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">Category category</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从数据库中物理删除指定ID的分类记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要删除的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在实际系统中，删除分类前应确保该分类没有关联的菜品或套餐。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此检查逻辑通常在服务层实现。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件从数据库获取分类记录，并进行分页处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持按分类名称模糊搜索和类型精确筛选。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryPageQueryDTO&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询参数对象，包含：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Page: 当前页码，从1开始计数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - PageSize: 每页记录数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name: 分类名称(可选)，用于模糊查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Type: 分类类型(可选)，用于精确筛选</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回元组，包含两个元素：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - total: 满足条件的总记录数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - categories: 当前页的分类记录列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的分类列表应按排序字段(Sort)升序排列，确保前端展示顺序一致。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 对于未指定排序值的记录，通常按创建时间排序作为次要排序条件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;(<span class="built_in">int</span> total, List&lt;Category&gt; categories)&gt; PageQuery(CategoryPageQueryDTO categoryPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据类型查询分类列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定类型的所有分类记录，通常用于下拉选择。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类类型：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 1: 菜品分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 2: 套餐分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定类型的分类列表，按排序字段升序排列<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法通常只返回状态为启用(Status=1)的分类，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 以确保前端只能选择有效的分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;Category&gt;&gt; GetCategoriesByType(<span class="built_in">int</span> type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProgramBackEnd\SkyServer\mapper\Impl\CategoryMapperImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现分类数据的持久化操作，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品和套餐分类的CRUD功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 作为数据访问层的具体实现，连接业务层与数据库。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此实现具有以下特点:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 异步优先：所有数据库操作均采用异步方法，避免阻塞线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 防御式编程：使用合理的空值检查和错误处理保障数据一致性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 查询优化：优化查询条件以提高数据库性能</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 4. 部分更新：更新操作仅修改非空字段，保留其他现有值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 5. 依赖注入：通过构造函数注入数据上下文，便于单元测试</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryMapperImpl</span> : <span class="title">ICategoryMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入获取数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当skyDbContext为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CategoryMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext), <span class="string">&quot;数据库上下文不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除分类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从数据库中物理删除指定ID的分类记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果记录不存在，不执行任何操作。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>要删除的分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 因为使用了FindAsync方法，所以可以处理记录不存在的情况。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在业务层应验证是否有关联的菜品或套餐，以确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证ID有效性</span></span><br><span class="line">            <span class="keyword">if</span> (id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类ID必须大于0&quot;</span>, <span class="keyword">nameof</span>(id));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用FindAsync高效查询主键，返回null表示记录不存在</span></span><br><span class="line">            <span class="keyword">var</span> category = <span class="keyword">await</span> _skyDbContext.Categories.FindAsync(id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 仅当记录存在时才执行删除操作</span></span><br><span class="line">            <span class="keyword">if</span> (category != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _skyDbContext.Categories.Remove(category);</span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据类型查询分类列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定类型的所有分类记录，主要用于前端下拉选择。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的分类按照Sort字段升序排序，确保前端展示顺序一致。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>分类类型：1=菜品分类，2=套餐分类<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定类型的分类列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通常此方法只应返回状态为启用(Status=1)的分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在实际业务中，可能需要进一步实现此筛选条件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Category&gt;&gt; GetCategoriesByType(<span class="built_in">int</span> type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 构建基础查询</span></span><br><span class="line">            IQueryable&lt;Category&gt; query = _skyDbContext.Categories;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据类型进行筛选，int是值类型不需要null检查</span></span><br><span class="line">            query = query.Where(c =&gt; c.Type == type);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 优先按Sort字段升序排序，便于前端直接展示</span></span><br><span class="line">            <span class="comment">// 如Sort相同，则按创建时间排序</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> query</span><br><span class="line">                .OrderBy(c =&gt; c.Sort)</span><br><span class="line">                .ThenBy(c =&gt; c.CreateTime)</span><br><span class="line">                .ToListAsync();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增分类记录</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将分类信息持久化到数据库，包括分类名称、类型、排序值、状态等信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;category&quot;&gt;</span>要插入的分类实体<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当category为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Insert</span>(<span class="params">Category category</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (category == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(category), <span class="string">&quot;分类对象不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用异步方法添加实体并保存</span></span><br><span class="line">            <span class="keyword">await</span> _skyDbContext.Categories.AddAsync(category);</span><br><span class="line">            <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分类分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件从数据库获取分类记录，并进行分页处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持按分类名称模糊搜索和类型精确筛选。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryPageQueryDTO&quot;&gt;</span>分类分页查询参数对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含总记录数和当前页数据的元组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;(<span class="built_in">int</span> total, List&lt;Category&gt; categories)&gt; PageQuery(CategoryPageQueryDTO categoryPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (categoryPageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(categoryPageQueryDTO), <span class="string">&quot;查询参数不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 提取和规范化分页参数</span></span><br><span class="line">            <span class="built_in">int</span> pageNumber = Math.Max(<span class="number">1</span>, categoryPageQueryDTO.Page); <span class="comment">// 确保页码至少为1</span></span><br><span class="line">            <span class="built_in">int</span> pageSize = Math.Max(<span class="number">1</span>, categoryPageQueryDTO.PageSize); <span class="comment">// 确保每页大小至少为1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 构建基础查询</span></span><br><span class="line">            IQueryable&lt;Category&gt; query = _skyDbContext.Categories;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 添加名称过滤条件（如果提供）</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(categoryPageQueryDTO.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> name = categoryPageQueryDTO.Name.Trim();</span><br><span class="line">                <span class="comment">// 添加空值检查，防止c.Name为null时调用Contains导致异常</span></span><br><span class="line">                query = query.Where(c =&gt; c.Name != <span class="literal">null</span> &amp;&amp; c.Name.Contains(name));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 添加类型过滤条件（如果提供）</span></span><br><span class="line">            <span class="keyword">if</span> (categoryPageQueryDTO.Type.HasValue)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> type = categoryPageQueryDTO.Type.Value;</span><br><span class="line">                query = query.Where(c =&gt; c.Type == type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6. 查询满足条件的总记录数</span></span><br><span class="line">            <span class="built_in">int</span> total = <span class="keyword">await</span> query.CountAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7. 应用排序和分页并执行查询</span></span><br><span class="line">            List&lt;Category&gt; categories = <span class="keyword">await</span> query</span><br><span class="line">                <span class="comment">// 主排序：优先按Sort字段升序（符合前端展示需求）</span></span><br><span class="line">                .OrderBy(c =&gt; c.Sort)</span><br><span class="line">                <span class="comment">// 次排序：按创建时间降序，新创建的分类优先展示</span></span><br><span class="line">                .ThenByDescending(c =&gt; c.CreateTime)</span><br><span class="line">                <span class="comment">// 再次排序：按ID升序，确保完全确定的顺序</span></span><br><span class="line">                .ThenBy(c =&gt; c.Id)</span><br><span class="line">                <span class="comment">// 分页处理</span></span><br><span class="line">                .Skip((pageNumber - <span class="number">1</span>) * pageSize)</span><br><span class="line">                .Take(pageSize)</span><br><span class="line">                <span class="comment">// 异步执行查询并转为列表</span></span><br><span class="line">                .ToListAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 8. 返回查询结果</span></span><br><span class="line">            <span class="keyword">return</span> (total, categories);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据提供的分类实体，更新数据库中对应记录的信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 采用部分更新策略，只更新非null字段，保留其他字段的现有值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;category&quot;&gt;</span>包含更新信息的分类实体<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当category为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当指定ID的分类记录不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;DbUpdateException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">Category category</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (category == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(category), <span class="string">&quot;分类对象不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (category.Id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;分类ID无效&quot;</span>, <span class="keyword">nameof</span>(category));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 查询现有分类记录</span></span><br><span class="line">            <span class="keyword">var</span> existingCategory = <span class="keyword">await</span> _skyDbContext.Categories.FirstOrDefaultAsync(c =&gt; c.Id == category.Id)</span><br><span class="line">                ?? <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;未找到ID为 <span class="subst">&#123;category.Id&#125;</span> 的分类记录&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 选择性更新非空/非默认字段</span></span><br><span class="line">            <span class="comment">// 分类基本信息更新</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(category.Name))</span><br><span class="line">                existingCategory.Name = category.Name;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类型更新 (1: 菜品分类, 2: 套餐分类)</span></span><br><span class="line">            <span class="keyword">if</span> (category.Type.HasValue)</span><br><span class="line">                existingCategory.Type = category.Type;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 排序字段更新</span></span><br><span class="line">            <span class="keyword">if</span> (category.Sort.HasValue)</span><br><span class="line">                existingCategory.Sort = category.Sort;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 状态更新 (0: 禁用, 1: 启用)</span></span><br><span class="line">            <span class="keyword">if</span> (category.Status.HasValue)</span><br><span class="line">                existingCategory.Status = category.Status;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 更新审计字段</span></span><br><span class="line">            <span class="keyword">if</span> (category.UpdateTime != <span class="literal">default</span>)</span><br><span class="line">                existingCategory.UpdateTime = category.UpdateTime;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新操作人ID（如果提供）</span></span><br><span class="line">            <span class="keyword">if</span> (category.UpdateUser &gt; <span class="number">0</span>)</span><br><span class="line">                existingCategory.UpdateUser = category.UpdateUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 提交更改到数据库</span></span><br><span class="line">            <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4、结果展示"><a href="#4、结果展示" class="headerlink" title="4、结果展示"></a>4、结果展示</h2><h3 id="1、新增分类"><a href="#1、新增分类" class="headerlink" title="1、新增分类"></a>1、新增分类</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220530708.png" alt="image-20250527220530708"></p>
<h3 id="2、分类分页查询"><a href="#2、分类分页查询" class="headerlink" title="2、分类分页查询"></a>2、分类分页查询</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220510550.png" alt="image-20250527220510550"></p>
<h3 id="3、删除分类"><a href="#3、删除分类" class="headerlink" title="3、删除分类"></a>3、删除分类</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220554666.png" alt="image-20250527220554666"></p>
<h3 id="4、更新分类信息"><a href="#4、更新分类信息" class="headerlink" title="4、更新分类信息"></a>4、更新分类信息</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220608822.png" alt="image-20250527220608822"></p>
<h3 id="5、启用或禁用分类"><a href="#5、启用或禁用分类" class="headerlink" title="5、启用或禁用分类"></a>5、启用或禁用分类</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220623262.png" alt="image-20250527220623262"></p>
<h3 id="6、根据类型查询分类列表"><a href="#6、根据类型查询分类列表" class="headerlink" title="6、根据类型查询分类列表"></a>6、根据类型查询分类列表</h3><p><img src="/2023/12/08/CPlusPlus02/mage-20250527220706074.png" alt="image-20250527220706074"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/05/26/NET-ASP-15/">https://alsl521.github.io/2025/05/26/NET-ASP-15/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/05/25/NET-ASP-14/" title="ASP.NET学习记录-14-实战-Day01"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ASP.NET学习记录-14-实战-Day01</div></div><div class="info-2"><div class="info-item-1">1、项目简介本项目为学习项目，由哔哩哔哩黑马程序员Java项目实战《苍穹外卖》，最适合新手的SpringBoot+SSM的企业级Java项目实战为蓝本，将所有代码更改为ASP.NET Core 6.0，构建单体应用。   2、数据准备依据资料，将所需内容进行基准准备。 在搭建数据库时，为进行模拟，使用Docker Hub模拟Linux中的构建与使用  1docker run --name mysql -d -p 33061:3306 --restart unless-stopped -e MYSQL_ROOT_PASSWORD=mysql mysql   并且使用工具导入sql脚本，从而构建数据库。  3、内容初步重构依据给的初始资料，将内容进行初步重构。首先创建各类相关文件夹，随后将SkyPojo中的内容全部重建。  1、数据库重构由于ASP.NET...</div></div></div></a><a class="pagination-related" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">NET-ASP-16-实战-Day03</div></div><div class="info-2"><div class="info-item-1">1、部署Redis首先搜寻并拉取Redis  随后输入如下代码运行Redis 1docker run -p 6379:6379 -d redis:latest redis-server  随后在下面的页面配置密码  通过输入 123redis-cliconfig set requirepass [mypassword]config get requirepass  设定、查看密码  2、部署Minio首先拉取Minio  随后输入 1docker run -d -p 9000:9000 -p 9090:9090 --name minio --restart=always -e &quot;MINIO_BROWSER_REDIRECT_URL=http://localhost:9000&quot; -e &quot;MINIO_ROOT_USER=minioadmin&quot; -e &quot;MINIO_ROOT_PASSWORD=minioadmin&quot; minio/minio:RELEASE.2024-09-13T20-26-02Z server /data...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/09/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-09</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-04-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-04-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/11/NET-ASP-05/" title="ASP.NET学习记录-05-模型数据绑定"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">ASP.NET学习记录-05-模型数据绑定</div></div><div class="info-2"><div class="info-item-1">1、模型绑定定义模型绑定是ASP.NET Core中将HTTP请求数据自动映射到方法参数或对象属性的机制。其核心工作流程：  数据来源：  路由参数（URL片段） 查询字符串（?key&#x3D;value） 请求体（表单&#x2F;JSON&#x2F;XML） 请求头 文件上传   典型应用：   12345678910111213// 自动绑定路由参数和查询参数[HttpGet(&quot;/products/&#123;id&#125;&quot;)]public IActionResult GetProduct(int id, [FromQuery] string category) &#123;    // id来自路由参数，category来自查询字符串&#125;// 自动绑定JSON请求体[HttpPost]public IActionResult Create([FromBody] Product product)&#123;    //...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">1、员工管理界面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5"><span class="toc-number">1.1.</span> <span class="toc-text">1、新增员工</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81EmployeeController-cs"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、EmployeeController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81EmployeeService"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、EmployeeService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81EmployeeMapper"><span class="toc-number">1.1.3.</span> <span class="toc-text">3、EmployeeMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81JwtTokenValidationMiddleware-cs"><span class="toc-number">1.1.4.</span> <span class="toc-text">4、JwtTokenValidationMiddleware.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81JwtUtil"><span class="toc-number">1.1.5.</span> <span class="toc-text">5、JwtUtil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Program-cs"><span class="toc-number">1.1.6.</span> <span class="toc-text">6、Program.cs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%91%98%E5%B7%A5%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.</span> <span class="toc-text">2、员工分页查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81EmployeeController-cs-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、EmployeeController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81EmployeeService-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、EmployeeService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81EmployeeMapper-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、EmployeeMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81JacksonObjectMapper"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、JacksonObjectMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81JsonFormatterMiddleware"><span class="toc-number">1.2.5.</span> <span class="toc-text">5、JsonFormatterMiddleware</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%90%AF%E7%94%A8%E3%80%81%E7%A6%81%E7%94%A8%E5%91%98%E5%B7%A5%E8%B4%A6%E6%88%B7"><span class="toc-number">1.3.</span> <span class="toc-text">3、启用、禁用员工账户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81EmployeeController-cs-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">1、EmployeeController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81EmployeeService-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">2、EmployeeService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81EmployeeMapper-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">3、EmployeeMapper</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%BC%96%E8%BE%91%E5%91%98%E5%B7%A5"><span class="toc-number">1.4.</span> <span class="toc-text">4、编辑员工</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81EmployeeController-cs-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、EmployeeController.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81EmployeeService-3"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、EmployeeService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81EmployeeMapper-3"><span class="toc-number">1.4.3.</span> <span class="toc-text">3、EmployeeMapper</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">2.</span> <span class="toc-text">2、分类管理界面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81CategoryController"><span class="toc-number">2.1.</span> <span class="toc-text">1、CategoryController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81CategoryService"><span class="toc-number">2.2.</span> <span class="toc-text">2、CategoryService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81CategoryMapper"><span class="toc-number">2.3.</span> <span class="toc-text">3、CategoryMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">2.4.</span> <span class="toc-text">4、结果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%96%B0%E5%A2%9E%E5%88%86%E7%B1%BB"><span class="toc-number">2.4.1.</span> <span class="toc-text">1、新增分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%86%E7%B1%BB%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.4.2.</span> <span class="toc-text">2、分类分页查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%A0%E9%99%A4%E5%88%86%E7%B1%BB"><span class="toc-number">2.4.3.</span> <span class="toc-text">3、删除分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%9B%B4%E6%96%B0%E5%88%86%E7%B1%BB%E4%BF%A1%E6%81%AF"><span class="toc-number">2.4.4.</span> <span class="toc-text">4、更新分类信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%90%AF%E7%94%A8%E6%88%96%E7%A6%81%E7%94%A8%E5%88%86%E7%B1%BB"><span class="toc-number">2.4.5.</span> <span class="toc-text">5、启用或禁用分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E5%88%97%E8%A1%A8"><span class="toc-number">2.4.6.</span> <span class="toc-text">6、根据类型查询分类列表</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/05/NET-ASP-17/" title="NET-ASP-17-实战-Day04">NET-ASP-17-实战-Day04</a><time datetime="2025-06-05T01:57:52.000Z" title="发表于 2025-06-05 09:57:52">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03">NET-ASP-16-实战-Day03</a><time datetime="2025-05-28T02:57:23.000Z" title="发表于 2025-05-28 10:57:23">2025-05-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02">ASP.NET学习记录-15-实战-Day02</a><time datetime="2025-05-26T11:25:36.000Z" title="发表于 2025-05-26 19:25:36">2025-05-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/NET-ASP-14/" title="ASP.NET学习记录-14-实战-Day01">ASP.NET学习记录-14-实战-Day01</a><time datetime="2025-05-25T12:02:17.000Z" title="发表于 2025-05-25 20:02:17">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>