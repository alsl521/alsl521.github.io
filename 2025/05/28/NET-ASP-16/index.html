<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>NET-ASP-16-实战-Day03 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:type" content="article">
<meta property="og:title" content="NET-ASP-16-实战-Day03">
<meta property="og:url" content="https://alsl521.github.io/2025/05/28/NET-ASP-16/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-05-28T02:57:23.000Z">
<meta property="article:modified_time" content="2025-06-05T02:02:19.829Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "NET-ASP-16-实战-Day03",
  "url": "https://alsl521.github.io/2025/05/28/NET-ASP-16/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-05-28T02:57:23.000Z",
  "dateModified": "2025-06-05T02:02:19.829Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/05/28/NET-ASP-16/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NET-ASP-16-实战-Day03',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">NET-ASP-16-实战-Day03</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">NET-ASP-16-实战-Day03</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-28T02:57:23.000Z" title="发表于 2025-05-28 10:57:23">2025-05-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-05T02:02:19.829Z" title="更新于 2025-06-05 10:02:19">2025-06-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、部署Redis"><a href="#1、部署Redis" class="headerlink" title="1、部署Redis"></a>1、部署Redis</h1><p>首先搜寻并拉取Redis</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250528154106383.png" alt="image-20250528154106383"></p>
<p>随后输入如下代码运行Redis</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p <span class="number">6379</span>:<span class="number">6379</span> -d redis:latest redis-server</span><br></pre></td></tr></table></figure>

<p>随后在下面的页面配置密码</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250528155046154.png" alt="image-20250528155046154"></p>
<p>通过输入</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">config <span class="built_in">set</span> requirepass [mypassword]</span><br><span class="line">config get requirepass</span><br></pre></td></tr></table></figure>

<p>设定、查看密码</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250528155303719.png" alt="image-20250528155303719"></p>
<h1 id="2、部署Minio"><a href="#2、部署Minio" class="headerlink" title="2、部署Minio"></a>2、部署Minio</h1><p>首先拉取Minio</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250528155350117.png" alt="image-20250528155350117"></p>
<p>随后输入</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">9000</span>:<span class="number">9000</span> -p <span class="number">9090</span>:<span class="number">9090</span> --name minio --restart=always -e &quot;MINIO_BROWSER_REDIRECT_URL=http://localhost:<span class="number">9000</span>&quot; -e &quot;MINIO_ROOT_USER=minioadmin&quot; -e &quot;MINIO_ROOT_PASSWORD=minioadmin&quot; minio/minio:RELEASE.<span class="number">2024</span>-<span class="number">09</span>-<span class="number">13</span>T20-<span class="number">26</span>-<span class="number">02</span>Z server /data --console-address &quot;:<span class="number">9000</span>&quot; -address &quot;:<span class="number">9090</span>&quot;</span><br></pre></td></tr></table></figure>

<p>以启动运行Minio</p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250528160250833.png" alt="image-20250528160250833"></p>
<h1 id="3、系统配置"><a href="#3、系统配置" class="headerlink" title="3、系统配置"></a>3、系统配置</h1><h2 id="1、appsettings-json"><a href="#1、appsettings-json" class="headerlink" title="1、appsettings.json"></a>1、appsettings.json</h2><p>在appsettings.json中设定需要使用的详细信息，如路由、密码等内容。</p>
<p>ProgramBackEnd\appsettings.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * 日志配置（Logging Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 控制应用程序各组件的日志记录行为、格式和详细程度</span></span><br><span class="line"><span class="comment">   * Controls the logging behavior, format and verbosity for app components</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* 不同命名空间的日志级别设置 */</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span> <span class="comment">// 默认记录&quot;Information&quot;及以上级别的日志</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span> <span class="comment">// ASP.NET Core框架组件只记录&quot;Warning&quot;及以上级别</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">/* 控制台日志输出格式配置 */</span></span><br><span class="line">    <span class="attr">&quot;Console&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;FormatterName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simple&quot;</span><span class="punctuation">,</span> <span class="comment">// 使用简单格式化器，提供简洁的日志输出</span></span><br><span class="line">      <span class="attr">&quot;FormatterOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;TimestampFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss &quot;</span><span class="punctuation">,</span> <span class="comment">// 日志时间戳格式</span></span><br><span class="line">        <span class="attr">&quot;UseUtcTimestamp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 使用本地时间而非UTC时间</span></span><br><span class="line">        <span class="attr">&quot;SingleLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> <span class="comment">// 每条日志占用单行，便于阅读和解析</span></span><br><span class="line">        <span class="attr">&quot;IncludeScopes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span> <span class="comment">// 不包含日志作用域信息，简化输出</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * 数据库连接配置（Database Connection Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 定义应用程序与数据库交互所需的连接参数</span></span><br><span class="line"><span class="comment">   * Defines connection parameters for database interactions</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* MySQL主数据库连接字符串 */</span></span><br><span class="line">    <span class="attr">&quot;DefaultConnection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server=localhost;port=33061;database=sky_take_out;uid=root;pwd=mysql;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">/* 各参数说明:</span></span><br><span class="line"><span class="comment">     * server: 数据库服务器地址（本地开发环境）</span></span><br><span class="line"><span class="comment">     * port: MySQL服务端口（33061，非标准端口，避免与默认MySQL端口冲突）</span></span><br><span class="line"><span class="comment">     * database: 应用程序使用的数据库名称（sky_take_out）</span></span><br><span class="line"><span class="comment">     * uid: 数据库访问用户名（root，生产环境建议使用限制权限的专用账号）</span></span><br><span class="line"><span class="comment">     * pwd: 数据库访问密码（mysql，生产环境应使用强密码）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Redis缓存服务器连接字符串 */</span></span><br><span class="line">    <span class="attr">&quot;Redis&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:6379,password=redis,ssl=false,abortConnect=false&quot;</span></span><br><span class="line">    <span class="comment">/* 各参数说明:</span></span><br><span class="line"><span class="comment">     * localhost:6379: Redis服务器地址和端口（标准Redis端口）</span></span><br><span class="line"><span class="comment">     * password: Redis服务器访问密码（简单密码，生产环境应更强）</span></span><br><span class="line"><span class="comment">     * ssl: 是否使用SSL加密连接（开发环境关闭）</span></span><br><span class="line"><span class="comment">     * abortConnect: 连接失败时是否立即终止（设为false允许重试连接）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * Kestrel服务器配置（Kestrel Server Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 配置ASP.NET Core内置Web服务器的监听地址和端口</span></span><br><span class="line"><span class="comment">   * Configures the built-in web server address and port</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;Kestrel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Endpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Http&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080&quot;</span> <span class="comment">// 应用监听在本地8080端口（避免与其他常用端口冲突）</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * MinIO对象存储配置（MinIO Object Storage Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 配置与MinIO服务连接参数，用于文件上传和管理</span></span><br><span class="line"><span class="comment">   * Configures connection parameters for MinIO service for file storage</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;MinioSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Endpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:9090&quot;</span><span class="punctuation">,</span> <span class="comment">// MinIO服务端点地址和端口</span></span><br><span class="line">    <span class="attr">&quot;AccessKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minioadmin&quot;</span><span class="punctuation">,</span> <span class="comment">// 访问密钥（默认值，生产环境应更改）</span></span><br><span class="line">    <span class="attr">&quot;SecretKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minioadmin&quot;</span><span class="punctuation">,</span> <span class="comment">// 秘密密钥（默认值，生产环境应更改）</span></span><br><span class="line">    <span class="attr">&quot;BucketName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="comment">// 存储桶名称，用于组织文件存储</span></span><br><span class="line">    <span class="attr">&quot;UseSSL&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span> <span class="comment">// 是否使用SSL连接（开发环境通常关闭）</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * JWT认证配置（JWT Authentication Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 定义JWT令牌生成和验证所需的密钥和参数</span></span><br><span class="line"><span class="comment">   * Defines keys and parameters for JWT token generation and validation</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;JwtConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">/* 管理员访问令牌配置 */</span></span><br><span class="line">    <span class="attr">&quot;AdminSecretKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AdminSecretKey_sky1234567890123456789012&quot;</span><span class="punctuation">,</span> <span class="comment">// 管理后台JWT签名密钥（至少32字符）</span></span><br><span class="line">    <span class="attr">&quot;AdminTtl&quot;</span><span class="punctuation">:</span> <span class="number">7200000</span><span class="punctuation">,</span> <span class="comment">// 管理员令牌有效期，单位毫秒（2小时）</span></span><br><span class="line">    <span class="attr">&quot;AdminTokenName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;token&quot;</span><span class="punctuation">,</span> <span class="comment">// 前端请求中传递管理员令牌的参数名称</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 普通用户访问令牌配置 */</span></span><br><span class="line">    <span class="attr">&quot;UserSecretKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UserSecretKey_sky12345678901234567890123&quot;</span><span class="punctuation">,</span> <span class="comment">// 用户端JWT签名密钥（与管理端分开）</span></span><br><span class="line">    <span class="attr">&quot;UserTtl&quot;</span><span class="punctuation">:</span> <span class="number">7200000</span> <span class="comment">// 用户令牌有效期，单位毫秒（2小时）</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* =================================================================</span></span><br><span class="line"><span class="comment">   * CORS和主机限制配置（CORS and Host Restriction Configuration）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 指定允许访问应用程序的主机名和域</span></span><br><span class="line"><span class="comment">   * Specifies allowed host names and domains for application access</span></span><br><span class="line"><span class="comment">   * ================================================================= */</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span> <span class="comment">// &quot;*&quot;表示允许所有主机访问（开发环境适用）</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="2、Program-cs"><a href="#2、Program-cs" class="headerlink" title="2、Program.cs"></a>2、Program.cs</h2><p>ProgramBackEnd\Program.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 应用程序入口类（Application Entry Point）</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置服务、中间件和启动ASP.NET Core Web API。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 本文件是整个应用程序的核心骨架，定义了服务注册、中间件管道和启动流程。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Configures services, middleware pipeline and launches the ASP.NET Core Web API.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This file represents the backbone of the entire application.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 引用命名空间（Namespace Imports）</span></span><br><span class="line"><span class="comment">// 按功能分组并排序，提高代码的组织性和可读性</span></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 框架核心组件</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;                <span class="comment">// Entity Framework Core - ORM框架，提供数据访问和对象关系映射</span></span><br><span class="line"><span class="comment">// 项目组件</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;          <span class="comment">// 应用配置属性类，包含JWT、MinIO等配置模型</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;              <span class="comment">// 应用服务配置，包含数据库上下文和服务注册扩展方法</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Handler;             <span class="comment">// 异常处理器，提供全局统一的错误处理机制</span></span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.Middlewares;         <span class="comment">// 自定义中间件，实现请求/响应处理和身份验证等功能</span></span><br><span class="line"><span class="comment">// 第三方组件</span></span><br><span class="line"><span class="keyword">using</span> StackExchange.Redis;                          <span class="comment">// Redis客户端库，提供高性能的分布式缓存访问能力</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 应用程序启动配置（Application Bootstrap Configuration）</span></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 创建应用构建器</span></span><br><span class="line"><span class="comment">// WebApplicationBuilder是ASP.NET Core应用程序的启动点，整合了配置、日志和DI容器</span></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(<span class="keyword">args</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 依赖注入服务配置（Dependency Injection Services Configuration）</span></span><br><span class="line"><span class="comment">// 遵循&quot;先配置基础设施，后配置业务服务&quot;的原则</span></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 数据存储基础设施配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.1 配置Entity Framework数据库上下文（MySQL）</span></span><br><span class="line"><span class="comment">// 注册DbContext，设置为Scoped生命周期（每请求一个实例）</span></span><br><span class="line">builder.Services.AddDbContext&lt;SkyDbContext&gt;(options =&gt;</span><br><span class="line">    options.UseMySql(</span><br><span class="line">        <span class="comment">// 从配置文件获取连接字符串，支持不同环境使用不同数据库配置</span></span><br><span class="line">        builder.Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>),</span><br><span class="line">        <span class="comment">// 明确指定MySQL服务器版本，确保EF Core生成兼容的SQL语句</span></span><br><span class="line">        <span class="comment">// 这对于确保查询性能和可靠性至关重要</span></span><br><span class="line">        <span class="keyword">new</span> MySqlServerVersion(<span class="keyword">new</span> Version(<span class="number">9</span>, <span class="number">3</span>, <span class="number">0</span>))</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.2 配置Redis分布式缓存</span></span><br><span class="line"><span class="comment">// 注册IDistributedCache接口实现，提供统一的缓存访问API</span></span><br><span class="line">builder.Services.AddStackExchangeRedisCache(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用配置文件中的Redis连接字符串，便于在不同环境中使用不同配置</span></span><br><span class="line">    options.Configuration = builder.Configuration.GetConnectionString(<span class="string">&quot;Redis&quot;</span>);</span><br><span class="line">    <span class="comment">// 可选：设置实例名称，用于在Redis中区分不同应用的缓存</span></span><br><span class="line">    <span class="comment">// options.InstanceName = &quot;SkyTakeOut:&quot;;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.3 注册Redis连接多路复用器（高级Redis访问）</span></span><br><span class="line"><span class="comment">// 使用单例模式确保应用程序全局共享同一连接，避免连接泄漏和资源浪费</span></span><br><span class="line">builder.Services.AddSingleton&lt;IConnectionMultiplexer&gt;(sp =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 从配置中解析Redis设置并创建连接配置对象</span></span><br><span class="line">    <span class="keyword">var</span> configuration = ConfigurationOptions.Parse(</span><br><span class="line">        builder.Configuration.GetConnectionString(<span class="string">&quot;Redis&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可选：配置高级Redis连接选项</span></span><br><span class="line">    <span class="comment">// configuration.DefaultDatabase = 0;</span></span><br><span class="line">    <span class="comment">// configuration.ConnectTimeout = 5000;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建并返回连接实例，支持自动重连和命令多路复用</span></span><br><span class="line">    <span class="keyword">return</span> ConnectionMultiplexer.Connect(configuration);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 应用程序配置与服务注册</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1 JWT认证配置</span></span><br><span class="line"><span class="comment">// 将配置节绑定到强类型对象，实现类型安全的配置访问</span></span><br><span class="line"><span class="comment">// 这比直接访问Configuration字符串更安全可靠</span></span><br><span class="line">builder.Services.Configure&lt;JwtProperties&gt;(builder.Configuration.GetSection(<span class="string">&quot;JwtConfig&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.2 MinIO对象存储配置</span></span><br><span class="line"><span class="comment">// 通过Options模式注册配置对象，可通过依赖注入在服务中使用</span></span><br><span class="line">builder.Services.Configure&lt;MinioProperties&gt;(builder.Configuration.GetSection(<span class="string">&quot;MinioSettings&quot;</span>));</span><br><span class="line"><span class="comment">// 同时注册单例实例，兼容需要直接注入MinioProperties的服务</span></span><br><span class="line">builder.Services.AddSingleton(sp =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> minioSettings = builder.Configuration.GetSection(<span class="string">&quot;MinioSettings&quot;</span>).Get&lt;MinioProperties&gt;();</span><br><span class="line">    <span class="comment">// 提供默认值，增强健壮性，防止配置缺失导致的NullReferenceException</span></span><br><span class="line">    <span class="keyword">return</span> minioSettings ?? <span class="keyword">new</span> MinioProperties();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ASP.NET Core框架服务配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.1 MVC控制器和API功能</span></span><br><span class="line"><span class="comment">// 注册MVC控制器服务，启用API路由和模型绑定功能</span></span><br><span class="line">builder.Services.AddControllers()</span><br><span class="line">    <span class="comment">// 添加全局异常处理过滤器，实现统一的异常处理和响应格式</span></span><br><span class="line">    <span class="comment">// 避免在控制器中编写重复的try-catch块</span></span><br><span class="line">    .AddGlobalExceptionHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 应用程序业务服务注册</span></span><br><span class="line"><span class="comment">// 使用扩展方法批量注册所有业务服务和数据访问组件</span></span><br><span class="line"><span class="comment">// 这种方式提高了Program.cs的清晰度，并使服务注册更加模块化</span></span><br><span class="line">builder.Services.RegisterAllServices();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 应用程序构建与HTTP请求管道配置</span></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 构建应用程序实例</span></span><br><span class="line"><span class="comment">// 完成依赖注入容器配置，创建应用程序实例</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 环境特定配置</span></span><br><span class="line"><span class="comment">// 根据环境配置不同的中间件和行为（开发、测试、生产）</span></span><br><span class="line"><span class="keyword">if</span> (app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 可在此处添加仅用于开发环境的中间件</span></span><br><span class="line">    <span class="comment">// 例如：app.UseDeveloperExceptionPage();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 中间件管道配置（按处理顺序注册）</span></span><br><span class="line"><span class="comment">// 注意：中间件的注册顺序决定了它们的执行顺序，对应用行为有重大影响</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.1 基础设施中间件 - 处理所有请求的基础组件</span></span><br><span class="line"><span class="comment">// 配置HTTP请求路由系统</span></span><br><span class="line">app.UseRouting();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 可选：添加CORS中间件（如果需要跨域支持）</span></span><br><span class="line"><span class="comment">// app.UseCors(&quot;AllowFrontend&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 自定义JSON格式化中间件</span></span><br><span class="line"><span class="comment">// 处理请求和响应中的JSON序列化/反序列化</span></span><br><span class="line">app.UseMiddleware&lt;JsonFormatterMiddleware&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 身份验证与授权中间件</span></span><br><span class="line"><span class="comment">// JWT令牌验证中间件，在请求到达控制器前验证身份</span></span><br><span class="line">app.UseMiddleware&lt;JwtTokenValidationMiddleware&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.5 终端中间件 - 处理请求的最终阶段</span></span><br><span class="line"><span class="comment">// 将HTTP请求路由到相应的控制器和操作方法</span></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"><span class="comment">// 应用程序启动（Application Launch）</span></span><br><span class="line"><span class="comment">// ========================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动Web主机并开始监听HTTP请求</span></span><br><span class="line"><span class="comment">// 程序将持续运行，直到被明确停止或发生未处理异常</span></span><br><span class="line">app.Run();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注：可通过扩展Program.cs添加以下功能:</span></span><br><span class="line"><span class="comment">// 1. 应用程序启动和关闭时的日志记录</span></span><br><span class="line"><span class="comment">// 2. 应用程序健康检查配置 (AddHealthChecks/UseHealthChecks)</span></span><br><span class="line"><span class="comment">// 3. 后台服务注册 (AddHostedService)</span></span><br></pre></td></tr></table></figure>

<h2 id="3、Redis配置"><a href="#3、Redis配置" class="headerlink" title="3、Redis配置"></a>3、Redis配置</h2><p>由于会在此处和以后使用Redis，因此需要设定Redis使用的相关内容，均在“ProgramBackEnd\SkyCommon\redisCache”文件夹下</p>
<h3 id="1、ISerializer"><a href="#1、ISerializer" class="headerlink" title="1、ISerializer"></a>1、ISerializer</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.redisCache</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化器接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义对象与字符串之间的转换操作，为缓存系统提供数据序列化能力。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口抽象了序列化和反序列化的具体实现，允许在不改变客户端代码的情况下</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 切换不同的序列化策略（如JSON、XML、ProtoBuf等）。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现此接口时应考虑以下因素：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;list type=&quot;bullet&quot;&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>序列化性能与结果大小的平衡<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>处理特殊类型（如DateTime、循环引用等）的策略<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>类型安全性和数据完整性<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>兼容性和版本控制<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/list&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口主要设计用于与缓存系统（如Redis）配合使用，支持复杂对象的存储和检索。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISerializer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将对象序列化为字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要序列化的对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>要序列化的对象实例<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>序列化后的字符串表示，可存储在缓存系统中<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当提供的对象为null且类型不允许为null时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当序列化过程中遇到错误时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法应能处理包括复杂对象、集合和常见数据类型在内的各种C#对象。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 对于值类型和字符串等简单类型，可以考虑特殊优化以提高性能。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> var user = new User &#123; Id = 101, Name = &quot;张三&quot; &#125;;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> string serialized = serializer.Serialize(user);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> // 可能的结果: &#123;&quot;Id&quot;:101,&quot;Name&quot;:&quot;张三&quot;&#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">Serialize</span>&lt;<span class="title">T</span>&gt;(<span class="params">T obj</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将字符串反序列化为对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>目标对象类型，必须与序列化时使用的类型兼容<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要反序列化的字符串，通常是<span class="doctag">&lt;see cref=&quot;Serialize&#123;T&#125;&quot;/&gt;</span>方法的输出<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>反序列化后的对象实例<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当提供的字符串为null或空时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;FormatException&quot;&gt;</span>当字符串格式无效或与目标类型不兼容时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当反序列化过程中遇到其他错误时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法应能够从序列化的字符串中恢复完整的对象状态，包括复杂的对象图。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 实现时应考虑类型验证和错误处理，确保即使输入数据有问题也能提供清晰的错误信息。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;example&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> string json = &quot;&#123;\&quot;Id\&quot;:101,\&quot;Name\&quot;:\&quot;张三\&quot;&#125;&quot;;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> User user = serializer.Deserialize&amp;lt;User&amp;gt;(json);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> // user.Id == 101, user.Name == &quot;张三&quot;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/example&gt;</span></span></span><br><span class="line">        <span class="function">T <span class="title">Deserialize</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2、JsonSerializer"><a href="#2、JsonSerializer" class="headerlink" title="2、JsonSerializer"></a>2、JsonSerializer</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.redisCache</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JSON序列化器实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于.NET 6内置的高性能System.Text.Json库实现ISerializer接口，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供对象与JSON字符串之间的转换功能。作为应用程序中的默认序列化机制，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 专为Redis缓存中复杂对象的存储和检索而优化。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此实现选择System.Text.Json而非Newtonsoft.Json的优势：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;list type=&quot;bullet&quot;&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>更高的性能和更低的内存占用<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>与.NET Core/.NET 6深度集成<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;item&gt;</span>免除额外的第三方依赖<span class="doctag">&lt;/item&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/list&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JsonSerializer</span> : <span class="title">ISerializer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> JSON序列化选项，控制序列化的行为和结果格式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> JsonSerializerOptions _serializerOptions;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，初始化序列化器并配置默认选项</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">JsonSerializer</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 配置JSON序列化选项</span></span><br><span class="line">            _serializerOptions = <span class="keyword">new</span> JsonSerializerOptions</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用驼峰命名法（如firstName而非FirstName）</span></span><br><span class="line">                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 忽略null值属性，减小序列化结果大小</span></span><br><span class="line">                DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 允许注释，提高JSON的可读性（在反序列化时）</span></span><br><span class="line">                ReadCommentHandling = JsonCommentHandling.Skip,</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对特殊字符进行转义（如中文字符不会被转为\uXXXX格式）</span></span><br><span class="line">                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将对象序列化为JSON字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要序列化的对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>要序列化的对象实例<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>序列化后的JSON字符串<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当对象为null且类型不允许为null时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;JsonException&quot;&gt;</span>当序列化过程中出现JSON相关错误时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotSupportedException&quot;&gt;</span>当对象包含不支持序列化的类型时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Serialize</span>&lt;<span class="title">T</span>&gt;(<span class="params">T obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 对象为null时进行检查（值类型不会为null）</span></span><br><span class="line">                <span class="keyword">if</span> (obj == <span class="literal">null</span> &amp;&amp; <span class="literal">default</span>(T) != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(obj), <span class="string">&quot;序列化的对象不能为null&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用System.Text.Json库的序列化方法</span></span><br><span class="line">                <span class="comment">// 使用完全限定名称以避免与当前类的名称冲突</span></span><br><span class="line">                <span class="keyword">return</span> System.Text.Json.JsonSerializer.Serialize(obj, _serializerOptions);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (JsonException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 重新抛出更明确的异常，包含原始异常作为内部异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonException(<span class="string">$&quot;序列化类型&#x27;<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>&#x27;的对象到JSON时失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException &amp;&amp; ex <span class="keyword">is</span> <span class="keyword">not</span> JsonException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换其他异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;执行JSON序列化时发生意外错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将JSON字符串反序列化为对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>目标对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要反序列化的JSON字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>反序列化后的对象实例<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当JSON字符串为null或空时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;JsonException&quot;&gt;</span>当JSON格式无效或与目标类型不兼容时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotSupportedException&quot;&gt;</span>当JSON包含目标类型不支持的属性时<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">Deserialize</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证输入</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(<span class="keyword">value</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(<span class="keyword">value</span>), <span class="string">&quot;要反序列化的JSON字符串不能为null或空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 调用System.Text.Json库的反序列化方法</span></span><br><span class="line">                <span class="comment">// 使用完全限定名称以避免与当前类的名称冲突</span></span><br><span class="line">                <span class="keyword">return</span> System.Text.Json.JsonSerializer.Deserialize&lt;T&gt;(<span class="keyword">value</span>, _serializerOptions);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (JsonException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 提供更具体的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JsonException(<span class="string">$&quot;将JSON反序列化为类型&#x27;<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>&#x27;时失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException &amp;&amp; ex <span class="keyword">is</span> <span class="keyword">not</span> JsonException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换其他可能的异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;执行JSON反序列化时发生意外错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3、IRedisCache"><a href="#3、IRedisCache" class="headerlink" title="3、IRedisCache"></a>3、IRedisCache</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.redisCache</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Redis缓存访问抽象接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与Redis缓存交互的核心操作，提供类型安全的数据存储和检索功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口封装了Redis操作的复杂性，使应用程序代码可以简洁地使用缓存，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 而不需要直接处理序列化、连接管理等底层细节。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现此接口时应考虑：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 序列化/反序列化策略</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 缓存键的命名约定</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 错误处理和重试机制</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 性能和连接管理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRedisCache</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步从缓存中获取指定键的值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要返回的对象类型，必须支持序列化/反序列化<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>缓存键，应遵循应用程序定义的命名约定<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果找到键且反序列化成功，则返回反序列化后的对象；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果未找到键、值已过期或反序列化失败，则返回 null</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当<span class="doctag">&lt;paramref name=&quot;key&quot;/&gt;</span>为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当缓存操作失败时可能抛出，例如连接问题<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法不会在缓存未命中时自动填充缓存，调用方应当实现缓存回填逻辑。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用示例：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> var product = await _redisCache.GetAsync&amp;lt;Product&amp;gt;(&quot;product:1001&quot;);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> if (product == null) &#123;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     product = await _productRepository.GetByIdAsync(1001);</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     if (product != null)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>         await _redisCache.SetAsync(&quot;product:1001&quot;, product, TimeSpan.FromHours(1));</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &#125;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;T?&gt; GetAsync&lt;T&gt;(<span class="built_in">string</span> key);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步将值存储在缓存中，使用指定的键</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要缓存的对象类型，必须支持序列化<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>缓存键，应遵循一致的命名模式，如&quot;实体类型:ID&quot;格式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要缓存的对象，不应为null<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;expiry&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 可选的过期时间；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果为null，则使用默认过期策略（由实现定义，通常为项目配置的全局过期时间）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务，完成后表示缓存设置成功<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当<span class="doctag">&lt;paramref name=&quot;key&quot;/&gt;</span>或<span class="doctag">&lt;paramref name=&quot;value&quot;/&gt;</span>为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当缓存操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键已经存在，此方法会覆盖原有的值和过期时间。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 建议根据数据更新频率和访问模式合理设置过期时间：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 频繁变化的数据：短过期时间或考虑不缓存</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 静态或很少变化的数据：较长过期时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 用户特定的数据：考虑会话生命周期或用户活动时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">SetAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span>, TimeSpan? expiry = <span class="literal">null</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步从缓存中移除指定键的值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>要移除的缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键存在且被成功移除，则返回 true；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键不存在，则返回 false</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当<span class="doctag">&lt;paramref name=&quot;key&quot;/&gt;</span>为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当缓存操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当实体数据更新或删除时，应调用此方法以保持缓存与数据源的一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 考虑在数据变更事件或事务完成后自动执行缓存失效操作。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">RemoveAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步检查缓存中是否存在指定的键</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>要检查的缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果缓存中存在指定的键且未过期，则返回 true；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 否则返回 false</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当<span class="doctag">&lt;paramref name=&quot;key&quot;/&gt;</span>为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当缓存操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法可用于在执行可能昂贵的获取和设置操作前进行检查。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注意：在分布式环境中，键的存在状态可能在此方法返回后立即改变，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 因此应谨慎使用此方法来做决策，特别是在高并发场景下。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">ExistsAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、RedisCacheImpl"><a href="#4、RedisCacheImpl" class="headerlink" title="4、RedisCacheImpl"></a>4、RedisCacheImpl</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> StackExchange.Redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.redisCache</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Redis缓存服务实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于StackExchange.Redis提供高性能的分布式缓存访问能力，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现IRedisCache接口定义的核心缓存操作。此实现将对象序列化为</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串并存储在Redis中，确保类型安全和高效的数据存取。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedisCacheImpl</span> : <span class="title">IRedisCache</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Redis数据库实例</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 提供对Redis命令的直接访问，支持所有Redis操作。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 由ConnectionMultiplexer管理，线程安全且可在多个请求中重用。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDatabase _db;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 序列化器接口实例</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 负责对象与字符串之间的转换，使Redis能够存储复杂对象。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 典型实现包括JSON序列化、二进制序列化等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISerializer _serializer;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化Redis数据库和序列化器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;redis&quot;&gt;</span>Redis连接多路复用器，管理与Redis服务器的连接池<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;serializer&quot;&gt;</span>用于序列化和反序列化对象的组件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当任一依赖项为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RedisCacheImpl</span>(<span class="params">IConnectionMultiplexer redis, ISerializer serializer</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 验证参数，确保依赖项有效</span></span><br><span class="line">            <span class="keyword">if</span> (redis == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(redis));</span><br><span class="line">            <span class="keyword">if</span> (serializer == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(serializer));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化成员</span></span><br><span class="line">            _db = redis.GetDatabase();  <span class="comment">// 获取Redis数据库实例，默认使用database 0</span></span><br><span class="line">            _serializer = serializer;   <span class="comment">// 设置序列化器</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从Redis缓存中异步获取值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要返回的对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键存在且反序列化成功，则返回反序列化后的对象；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键不存在或已过期，则返回默认值(null或值类型的默认值)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当key为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当Redis操作失败或反序列化出错时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">T</span>?&gt; <span class="title">GetAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(key), <span class="string">&quot;缓存键不能为null或空字符串&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从Redis获取字符串值</span></span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">value</span> = <span class="keyword">await</span> _db.StringGetAsync(key);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果值不存在，直接返回类型的默认值</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">value</span>.IsNull)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">default</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将字符串值反序列化为请求的类型并返回</span></span><br><span class="line">                <span class="keyword">return</span> _serializer.Deserialize&lt;T&gt;(<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RedisException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换Redis特定异常，提供更多上下文信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;从Redis获取键&#x27;<span class="subst">&#123;key&#125;</span>&#x27;时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获其他异常（如序列化错误）</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;处理缓存键&#x27;<span class="subst">&#123;key&#125;</span>&#x27;时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将值异步存储到Redis缓存中</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>要缓存的对象类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要缓存的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;expiry&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 可选的过期时间；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果为null，则数据将永久保存直到显式删除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当key为null或value为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当Redis操作失败或序列化出错时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SetAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span>, TimeSpan? expiry = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(key), <span class="string">&quot;缓存键不能为null或空字符串&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(<span class="keyword">value</span>), <span class="string">&quot;缓存值不能为null&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将对象序列化为字符串</span></span><br><span class="line">                <span class="keyword">var</span> serializedValue = _serializer.Serialize(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用指定的键值和过期时间将序列化后的值存储到Redis</span></span><br><span class="line">                <span class="comment">// 如果操作成功，StringSetAsync返回true，但我们不需要检查这个结果</span></span><br><span class="line">                <span class="keyword">await</span> _db.StringSetAsync(key, serializedValue, expiry);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RedisException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;向Redis设置键&#x27;<span class="subst">&#123;key&#125;</span>&#x27;时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;序列化或缓存数据时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 从Redis缓存中异步移除指定键的值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>要移除的缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键存在且被成功移除，则返回true；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果键不存在，则返回false</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当key为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当Redis操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">RemoveAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(key), <span class="string">&quot;缓存键不能为null或空字符串&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从Redis中删除指定的键</span></span><br><span class="line">                <span class="comment">// KeyDeleteAsync方法返回一个布尔值，表示键是否存在并被删除</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> _db.KeyDeleteAsync(key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RedisException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;从Redis删除键&#x27;<span class="subst">&#123;key&#125;</span>&#x27;时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步检查Redis缓存中是否存在指定的键</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>要检查的缓存键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果缓存中存在指定的键，则返回true；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 否则返回false</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当key为null或空字符串时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当Redis操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">ExistsAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(key), <span class="string">&quot;缓存键不能为null或空字符串&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 检查Redis中是否存在指定的键</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> _db.KeyExistsAsync(key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (RedisException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;检查Redis键&#x27;<span class="subst">&#123;key&#125;</span>&#x27;存在性时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、MinioProperties"><a href="#4、MinioProperties" class="headerlink" title="4、MinioProperties"></a>4、MinioProperties</h2><p>MinioProperties用来承接设置中Minio的必要参数</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyCommon.properties</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MinIO对象存储服务配置属性类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 封装与MinIO服务连接所需的配置信息，用于文件上传、下载和管理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MinIO是一个高性能的对象存储服务，兼容Amazon S3 API，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用于存储图片、文档、视频等非结构化数据。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类通常通过appsettings.json的&quot;MinioSettings&quot;节配置，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 并通过依赖注入在应用程序中使用。配置示例：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;code&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> &quot;MinioSettings&quot;: &#123;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>   &quot;Endpoint&quot;: &quot;localhost:9000&quot;,</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>   &quot;AccessKey&quot;: &quot;minioadmin&quot;,</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>   &quot;SecretKey&quot;: &quot;minioadmin&quot;,</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>   &quot;BucketName&quot;: &quot;myBucket&quot;,</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>   &quot;UseSSL&quot;: false</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> &#125;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/code&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MinioProperties</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> MinIO服务端点地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 格式为&quot;主机名:端口&quot;，例如&quot;localhost:9000&quot;或&quot;minio.example.com:9000&quot;。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 不包含协议前缀(http://或https://)，协议由<span class="doctag">&lt;see cref=&quot;UseSSL&quot;/&gt;</span>属性决定。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Endpoint &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> MinIO访问密钥（Access Key）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于访问MinIO服务的身份标识，相当于用户名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认MinIO安装通常使用&quot;minioadmin&quot;作为默认访问密钥。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? AccessKey &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> MinIO密钥（Secret Key）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于验证访问MinIO服务的密码凭证。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认MinIO安装通常使用&quot;minioadmin&quot;作为默认密钥。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生产环境应使用强密钥并妥善保管。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? SecretKey &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> MinIO存储桶名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 存储桶是存储对象的容器，类似于文件系统中的顶级目录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 名称必须符合DNS命名规则：仅小写字母、数字、点(.)和连字符(-)，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 长度3-63个字符，不能以点或连字符开头或结尾。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? BucketName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否使用SSL加密连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当设置为true时，使用HTTPS协议连接MinIO服务；</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当设置为false时，使用HTTP协议连接MinIO服务。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生产环境通常应启用SSL以确保数据传输安全。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> UseSSL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4、CommonController"><a href="#4、CommonController" class="headerlink" title="4、CommonController"></a>4、CommonController</h1><p>文件上传控制器</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.controller.admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 管理端通用功能控制器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供文件上传等通用功能的API端点，供管理后台使用。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此控制器处理与业务逻辑无关的通用操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/common/upload&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CommonController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 文件上传服务接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IFileUploadService _fileUploadService;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化控制器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fileUploadService&quot;&gt;</span>文件上传服务，处理文件存储逻辑<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CommonController</span>(<span class="params">IFileUploadService fileUploadService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _fileUploadService = fileUploadService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(fileUploadService));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 文件上传接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 接收客户端发送的文件并上传至存储服务（如MinIO），返回可访问的URL。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主要用于上传图片等资源文件，供其他功能引用。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;file&quot;&gt;</span>待上传的文件表单数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含上传成功后文件访问URL的结果对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>上传成功，返回文件URL<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>文件无效或为空<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Upload(IFormFile <span class="keyword">file</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 上传文件并获取URL</span></span><br><span class="line">            <span class="built_in">string</span> url = <span class="keyword">await</span> _fileUploadService.UploadFileAsync(<span class="keyword">file</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回包含URL的成功结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="5、FileUploadService"><a href="#5、FileUploadService" class="headerlink" title="5、FileUploadService"></a>5、FileUploadService</h1><p>文件上传服务相关代码</p>
<h2 id="1、IFileUploadService"><a href="#1、IFileUploadService" class="headerlink" title="1、IFileUploadService"></a>1、IFileUploadService</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 文件上传服务接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义文件上传相关的操作，支持将客户端上传的文件保存到存储系统（如MinIO、Azure Blob等）。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口将文件存储的实现细节与业务逻辑分离，使得控制器可以不关心具体的存储机制。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现此接口时，应考虑：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 文件类型验证和安全检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 文件大小限制</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 生成唯一的文件名以避免冲突</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 错误处理和异常管理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 存储服务的配置和连接管理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IFileUploadService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步上传文件到存储系统</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;file&quot;&gt;</span>要上传的文件，通常来自HTTP请求的表单数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 上传成功后文件的访问URL，客户端可通过此URL获取文件内容</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当文件参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当文件内容为空或格式无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当上传过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法负责将文件保存到配置的存储系统，并返回可访问的URL。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 实现应考虑生成唯一文件名、设置适当的内容类型、处理潜在的存储错误等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">string</span>&gt; <span class="title">UploadFileAsync</span>(<span class="params">IFormFile <span class="keyword">file</span></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、FileUploadServiceImpl"><a href="#2、FileUploadServiceImpl" class="headerlink" title="2、FileUploadServiceImpl"></a>2、FileUploadServiceImpl</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Minio;</span><br><span class="line"><span class="keyword">using</span> Minio.DataModel.Args;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.properties;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 文件上传服务的MinIO实现</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 负责处理文件上传逻辑，将文件保存到MinIO对象存储服务。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 支持生成唯一文件名、自动创建目录结构，并返回可访问的文件URL。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FileUploadServiceImpl</span> : <span class="title">IFileUploadService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> MinIO配置选项</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> MinioProperties _minioProperties;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;minioProperties&quot;&gt;</span>MinIO配置信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当MinIO配置为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FileUploadServiceImpl</span>(<span class="params">MinioProperties minioProperties</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _minioProperties = minioProperties ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(minioProperties));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 异步将文件上传到MinIO存储服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;file&quot;&gt;</span>要上传的文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>上传成功后的文件访问URL<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当文件无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当上传过程出现问题时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">UploadFileAsync</span>(<span class="params">IFormFile <span class="keyword">file</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 验证文件有效性</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">file</span> == <span class="literal">null</span> || <span class="keyword">file</span>.Length == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;文件不能为空或大小为零&quot;</span>, <span class="keyword">nameof</span>(<span class="keyword">file</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 2. 创建MinIO客户端</span></span><br><span class="line">                <span class="keyword">var</span> minioClient = <span class="keyword">new</span> MinioClient()</span><br><span class="line">                    .WithEndpoint(_minioProperties.Endpoint)</span><br><span class="line">                    .WithCredentials(_minioProperties.AccessKey, _minioProperties.SecretKey)</span><br><span class="line">                    .WithSSL(_minioProperties.UseSSL)</span><br><span class="line">                    .Build();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 确保目标存储桶存在</span></span><br><span class="line">                <span class="keyword">var</span> bucketName = _minioProperties.BucketName;</span><br><span class="line">                <span class="keyword">var</span> bucketExistsArgs = <span class="keyword">new</span> BucketExistsArgs().WithBucket(bucketName);</span><br><span class="line">                <span class="built_in">bool</span> bucketExists = <span class="keyword">await</span> minioClient.BucketExistsAsync(bucketExistsArgs);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!bucketExists)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 如果存储桶不存在，则创建它</span></span><br><span class="line">                    <span class="keyword">var</span> makeBucketArgs = <span class="keyword">new</span> MakeBucketArgs().WithBucket(bucketName);</span><br><span class="line">                    <span class="keyword">await</span> minioClient.MakeBucketAsync(makeBucketArgs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 构建文件路径和名称</span></span><br><span class="line">                <span class="comment">// 使用日期作为目录，确保文件组织有序</span></span><br><span class="line">                <span class="built_in">string</span> dateDir = DateTime.Now.ToString(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成不带连字符的GUID，确保文件名唯一性</span></span><br><span class="line">                <span class="built_in">string</span> uuid = Guid.NewGuid().ToString(<span class="string">&quot;N&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保留原始文件扩展名，确保文件类型可识别</span></span><br><span class="line">                <span class="built_in">string</span> extension = Path.GetExtension(<span class="keyword">file</span>.FileName);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 组合最终的对象名：日期目录/UUID+原始扩展名</span></span><br><span class="line">                <span class="built_in">string</span> objectName = <span class="string">$&quot;<span class="subst">&#123;dateDir&#125;</span>/<span class="subst">&#123;uuid&#125;</span><span class="subst">&#123;extension&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 执行文件上传</span></span><br><span class="line">                <span class="keyword">using</span> <span class="keyword">var</span> stream = <span class="keyword">file</span>.OpenReadStream();</span><br><span class="line">                <span class="keyword">var</span> putObjectArgs = <span class="keyword">new</span> PutObjectArgs()</span><br><span class="line">                    .WithBucket(bucketName)</span><br><span class="line">                    .WithObject(objectName)</span><br><span class="line">                    .WithStreamData(stream)</span><br><span class="line">                    .WithObjectSize(<span class="keyword">file</span>.Length)</span><br><span class="line">                    .WithContentType(<span class="keyword">file</span>.ContentType);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">await</span> minioClient.PutObjectAsync(putObjectArgs);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 构建并返回可访问的URL</span></span><br><span class="line">                <span class="built_in">string</span>? endpointUrl = _minioProperties.Endpoint;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(endpointUrl))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;MinIO端点配置无效&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确保URL包含协议前缀</span></span><br><span class="line">                <span class="keyword">if</span> (!endpointUrl.StartsWith(<span class="string">&quot;http&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    endpointUrl = (_minioProperties.UseSSL ? <span class="string">&quot;https://&quot;</span> : <span class="string">&quot;http://&quot;</span>) + endpointUrl;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 组合完整URL：端点/存储桶名/对象名</span></span><br><span class="line">                <span class="built_in">string</span> url = <span class="string">$&quot;<span class="subst">&#123;endpointUrl&#125;</span>/<span class="subst">&#123;bucketName&#125;</span>/<span class="subst">&#123;objectName&#125;</span>&quot;</span>;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;文件上传成功: <span class="subst">&#123;url&#125;</span>&quot;</span>); <span class="comment">// 记录成功信息</span></span><br><span class="line">                <span class="keyword">return</span> url;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentException &amp;&amp; ex <span class="keyword">is</span> <span class="keyword">not</span> BaseException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 记录异常并转换为应用程序特定的异常</span></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;上传文件时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">$&quot;文件上传失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6、Dish相关代码"><a href="#6、Dish相关代码" class="headerlink" title="6、Dish相关代码"></a>6、Dish相关代码</h1><h2 id="1、DishController"><a href="#1、DishController" class="headerlink" title="1、DishController"></a>1、DishController</h2><p>ProgramBackEnd\SkyServer\controller\admin\DishController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"><span class="keyword">using</span> StackExchange.Redis;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.controller.admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品管理控制器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供管理端菜品相关的API接口，包括菜品的增删改查、状态管理等功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法都带有缓存清理机制，确保数据一致性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/dish&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DishController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Redis连接多路复用器，用于缓存操作</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IConnectionMultiplexer _redis;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志记录器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;DishController&gt; _logger;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品服务接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDishService _dishService;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化控制器</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishService&quot;&gt;</span>菜品服务，处理菜品相关业务逻辑<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;redis&quot;&gt;</span>Redis连接，用于缓存管理<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器，用于记录操作日志<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DishController</span>(<span class="params">IDishService dishService, IConnectionMultiplexer redis, ILogger&lt;DishController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dishService = dishService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishService));</span><br><span class="line">            _redis = redis ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(redis));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 保存菜品基本信息和口味数据，并清理相关缓存。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含菜品信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>保存结果，成功返回提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>保存成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>请求数据无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Save([FromBody] DishDTO dishDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 调用服务层保存菜品和口味信息</span></span><br><span class="line">            <span class="keyword">await</span> _dishService.SaveWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建缓存键，基于分类ID</span></span><br><span class="line">            <span class="built_in">string</span> key = <span class="string">$&quot;dish_<span class="subst">&#123;dishDTO.CategoryId&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清理相关缓存，确保数据一致性</span></span><br><span class="line">            CleanCache(key);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回成功结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;保存成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据查询条件获取菜品分页列表，支持按名称、分类和状态筛选。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishPageQueryDTO&quot;&gt;</span>分页查询参数，包含页码、每页大小和筛选条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果，包含总记录数和当前页数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>查询成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>查询参数无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;page&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;PageResult&gt;&gt; Page([FromQuery] DishPageQueryDTO dishPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录查询参数，便于问题排查</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;菜品分页查询:&#123;@DishPageQueryDTO&#125;&quot;</span>, dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层执行分页查询</span></span><br><span class="line">            <span class="keyword">var</span> pageResult = <span class="keyword">await</span> _dishService.PageQuery(dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回查询结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;PageResult&gt;.Success(pageResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量删除菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持单个或多个菜品的删除操作，同时清理相关缓存。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>菜品ID列表，多个ID用逗号分隔<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>删除结果，成功返回提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>删除成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>请求参数无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;409&quot;&gt;</span>菜品在售或被关联，无法删除<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpDelete</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Delete([FromQuery] <span class="built_in">string</span> ids)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 解析逗号分隔的ID字符串为长整型列表</span></span><br><span class="line">            <span class="keyword">var</span> idList = !<span class="built_in">string</span>.IsNullOrEmpty(ids)</span><br><span class="line">                ? ids.Split(<span class="string">&#x27;,&#x27;</span>).Select(<span class="built_in">long</span>.Parse).ToList()</span><br><span class="line">                : <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录操作信息，便于审计和问题排查</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;菜品批量删除：&#123;@Ids&#125;&quot;</span>, idList);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层执行删除操作</span></span><br><span class="line">            <span class="keyword">await</span> _dishService.DeleteBatch(idList);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清理所有菜品相关缓存，确保数据一致性</span></span><br><span class="line">            CleanCache(<span class="string">&quot;dish_*&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回成功结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询菜品详情</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定菜品的完整信息，包括基本信息和口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品详情，包含菜品基本信息和口味数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>查询成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>指定ID的菜品不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;DishVO&gt;&gt; GetById([FromRoute] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录查询信息</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;根据ID查询菜品：&#123;Id&#125;&quot;</span>, id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层获取菜品详情</span></span><br><span class="line">            DishVO dishVO = <span class="keyword">await</span> _dishService.GetByIdWithFlavor(id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回查询结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;DishVO&gt;.Success(dishVO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品的基本信息和口味数据，同时清理相关缓存。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含更新后的菜品信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>更新结果，成功返回提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>修改成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>请求数据无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>指定ID的菜品不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPut</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Update([FromBody] DishDTO dishDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录操作信息，但避免记录大量图片数据</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;修改菜品：ID=&#123;Id&#125;, Name=&#123;Name&#125;&quot;</span>, dishDTO.Id, dishDTO.Name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层执行更新操作</span></span><br><span class="line">            <span class="keyword">await</span> _dishService.UpdateWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清理所有菜品相关缓存，确保数据一致性</span></span><br><span class="line">            CleanCache(<span class="string">&quot;dish_*&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回成功结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改菜品状态（起售/停售）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品的销售状态，同时清理相关缓存。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 停售操作可能同时影响关联的套餐状态。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1表示起售，0表示停售<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，成功返回提示信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>操作成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>请求参数无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>指定ID的菜品不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;status/&#123;status&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; StartOrStop([FromRoute] <span class="built_in">int</span> status, [FromQuery] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录操作信息</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;修改菜品状态：status=&#123;Status&#125;, id=&#123;Id&#125;&quot;</span>, status, id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层执行状态更新</span></span><br><span class="line">            <span class="keyword">await</span> _dishService.StartOrStop(status, id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清理所有菜品相关缓存，确保数据一致性</span></span><br><span class="line">            CleanCache(<span class="string">&quot;dish_*&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回成功结果，根据状态值提供具体信息</span></span><br><span class="line">            <span class="built_in">string</span> message = status == <span class="number">1</span> ? <span class="string">&quot;菜品已起售&quot;</span> : <span class="string">&quot;菜品已停售&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID查询菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定分类下的所有菜品，主要用于套餐管理和点餐页面。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryId&quot;&gt;</span>菜品分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>查询成功<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>请求参数无效<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;list&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;List&lt;Dish&gt;&gt;&gt; List([FromQuery] <span class="built_in">long</span> categoryId)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 记录查询信息</span></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;根据分类ID查询菜品：&#123;CategoryId&#125;&quot;</span>, categoryId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层获取菜品列表</span></span><br><span class="line">            List&lt;Dish&gt; list = <span class="keyword">await</span> _dishService.List(categoryId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回查询结果</span></span><br><span class="line">            <span class="keyword">return</span> Result&lt;List&lt;Dish&gt;&gt;.Success(list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 清理Redis缓存数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据指定的模式匹配缓存键并删除，确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持精确键名和通配符模式。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pattern&quot;&gt;</span>缓存键模式，如&quot;dish_123&quot;或&quot;dish_*&quot;<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CleanCache</span>(<span class="params"><span class="built_in">string</span> pattern</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 获取Redis数据库实例</span></span><br><span class="line">                <span class="keyword">var</span> db = _redis.GetDatabase();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取Redis服务器端点</span></span><br><span class="line">                <span class="keyword">var</span> endpoint = _redis.GetEndPoints().FirstOrDefault();</span><br><span class="line">                <span class="keyword">if</span> (endpoint == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _logger.LogWarning(<span class="string">&quot;无法获取Redis服务器端点，缓存清理操作已跳过&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取服务器实例，用于执行键查找操作</span></span><br><span class="line">                <span class="keyword">var</span> server = _redis.GetServer(endpoint);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查找匹配模式的所有键</span></span><br><span class="line">                <span class="keyword">var</span> keys = server.Keys(pattern: pattern).ToArray();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果找到匹配的键，则批量删除</span></span><br><span class="line">                <span class="keyword">if</span> (keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 执行批量删除操作</span></span><br><span class="line">                    db.KeyDelete(keys);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 记录清理信息</span></span><br><span class="line">                    _logger.LogInformation(<span class="string">&quot;已清理&#123;Count&#125;个匹配&#x27;&#123;Pattern&#125;&#x27;的缓存键&quot;</span>, keys.Length, pattern);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _logger.LogDebug(<span class="string">&quot;未找到匹配&#x27;&#123;Pattern&#125;&#x27;的缓存键&quot;</span>, pattern);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 缓存清理失败不应影响主要业务流程，只记录错误</span></span><br><span class="line">                _logger.LogError(ex, <span class="string">&quot;清理缓存时发生错误，模式：&#123;Pattern&#125;&quot;</span>, pattern);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、IDishService"><a href="#2、IDishService" class="headerlink" title="2、IDishService"></a>2、IDishService</h2><p>ProgramBackEnd\SkyServer\service\IDishService.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品服务接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义系统中与菜品相关的业务操作，包括菜品的增删改查、状态管理和分页查询等功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该接口处理菜品及其关联的口味数据，支持完整的菜品生命周期管理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口的实现应考虑：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 数据验证和业务规则检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 事务管理，特别是涉及多表操作时</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 缓存策略，提高查询性能</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 关联数据的处理（如菜品与口味的关系）</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDishService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 保存菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含菜品基本信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当dishDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当保存过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法将执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 保存菜品基本信息到dish表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 处理菜品的口味数据，保存到dish_flavor表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 设置创建和更新信息（时间、用户ID）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">SaveWithFlavor</span>(<span class="params">DishDTO dishDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishPageQueryDTO&quot;&gt;</span>分页查询条件，包含页码、每页大小、名称搜索、分类和状态筛选<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果，包含总记录数和当前页的菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持的查询条件包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 菜品名称模糊搜索</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 根据分类ID筛选</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 根据菜品状态筛选（起售/停售）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询结果会根据创建时间降序排列，并包含菜品关联的分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">DishPageQueryDTO dishPageQueryDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID获取菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品视图对象，包含菜品基本信息和口味数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当菜品不存在或查询失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法查询单个菜品的完整信息，包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 菜品的基本属性（名称、价格、图片等）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 所有关联的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 菜品所属分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;DishVO&gt; <span class="title">GetByIdWithFlavor</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含更新后的菜品信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当dishDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当更新过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 更新菜品基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 删除原有的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 添加新的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 4. 更新修改时间和修改人信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">UpdateWithFlavor</span>(<span class="params">DishDTO dishDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量删除菜品及其口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>要删除的菜品ID集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当ID集合为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当有菜品正在起售或被套餐关联时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除操作会进行以下业务检查：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证菜品是否处于停售状态（起售中的菜品不能删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 验证菜品是否被套餐关联（被关联的菜品不能删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除后会同时清理菜品关联的所有口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteBatch</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; ids</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 切换菜品的售卖状态（起售/停售）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1表示起售，0表示停售<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值无效或ID无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当菜品状态设置为停售(0)时，会自动将包含该菜品的套餐也设置为停售状态。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这确保了数据的一致性，防止顾客点到无法提供的菜品。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID查询菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryId&quot;&gt;</span>菜品分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定分类下的菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法主要用于：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 在套餐管理中选择菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 在客户端展示某一分类下的所有菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的菜品默认按创建时间降序排列，且只包含状态为启用(1)的菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;Dish&gt;&gt; List(<span class="built_in">long</span> categoryId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3、DishServiceImpl"><a href="#3、DishServiceImpl" class="headerlink" title="3、DishServiceImpl"></a>3、DishServiceImpl</h2><p>ProgramBackEnd\SkyServer\service\Impl\DishServiceImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.context;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.utils;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品服务实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品管理的核心业务逻辑实现，包括菜品的CRUD操作、状态管理、</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 以及与菜品口味和套餐的关联处理。所有数据库操作均采用异步方式，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复杂操作使用事务确保数据一致性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DishServiceImpl</span> : <span class="title">IDishService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品数据访问接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDishMapper _dishMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品口味数据访问接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDishFlavorMapper _dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐菜品关系数据访问接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISetmealDishMapper _setmealDishMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐数据访问接口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISetmealMapper _setmealMapper;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文，用于事务管理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化所需服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishMapper&quot;&gt;</span>菜品数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishFlavorMapper&quot;&gt;</span>菜品口味数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDishMapper&quot;&gt;</span>套餐菜品关系数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealMapper&quot;&gt;</span>套餐数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当任何依赖项为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DishServiceImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IDishMapper dishMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            IDishFlavorMapper dishFlavorMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            ISetmealDishMapper setmealDishMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            ISetmealMapper setmealMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dishMapper = dishMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishMapper));</span><br><span class="line">            _dishFlavorMapper = dishFlavorMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishFlavorMapper));</span><br><span class="line">            _setmealDishMapper = setmealDishMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealDishMapper));</span><br><span class="line">            _setmealMapper = setmealMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealMapper));</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量删除菜品及其口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>待删除的菜品ID集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当菜品不能删除时抛出，包含具体原因<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当数据库操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteBatch</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; ids</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ids == <span class="literal">null</span> || ids.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 空集合无需操作</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 业务规则验证1: 检查是否有起售中的菜品</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> ids)</span><br><span class="line">                &#123;</span><br><span class="line">                    Dish dish = <span class="keyword">await</span> _dishMapper.GetById(id);</span><br><span class="line">                    <span class="keyword">if</span> (dish == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 菜品不存在，跳过该ID</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 状态为1表示菜品正在售卖中，不允许删除</span></span><br><span class="line">                    <span class="keyword">if</span> (dish.Status == <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;起售中的菜品不能删除，请先停售再删除&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 业务规则验证2: 检查菜品是否被套餐关联</span></span><br><span class="line">                List&lt;<span class="built_in">long</span>&gt; setmealIds = <span class="keyword">await</span> _setmealDishMapper.GetSetmealIdsByDishIds(ids);</span><br><span class="line">                <span class="keyword">if</span> (setmealIds != <span class="literal">null</span> &amp;&amp; setmealIds.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;菜品已被套餐关联，请先解除关联再删除&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 通过业务验证后，执行删除操作</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> ids)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 1. 删除菜品基本数据</span></span><br><span class="line">                    <span class="keyword">await</span> _dishMapper.DeleteById(id);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2. 级联删除菜品关联的口味数据</span></span><br><span class="line">                    <span class="keyword">await</span> _dishFlavorMapper.DeleteByDishId(id);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 所有操作成功，提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 发生异常时回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重新抛出异常，保留原始异常信息</span></span><br><span class="line">                <span class="comment">// 如果是业务异常(BaseException)则直接抛出，其他异常包装后抛出</span></span><br><span class="line">                <span class="keyword">if</span> (ex <span class="keyword">is</span> BaseException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;删除菜品失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID获取菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含菜品基本信息和口味数据的视图对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当查询失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;DishVO&gt; <span class="title">GetByIdWithFlavor</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 查询菜品基本信息</span></span><br><span class="line">            Dish dish = <span class="keyword">await</span> _dishMapper.GetById(id) ?? <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">$&quot;未找到ID为<span class="subst">&#123;id&#125;</span>的菜品&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 查询菜品关联的口味数据</span></span><br><span class="line">            List&lt;DishFlavor&gt; dishFlavors = <span class="keyword">await</span> _dishFlavorMapper.GetByDishId(id);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 构建并填充返回的视图对象</span></span><br><span class="line">            DishVO dishVO = <span class="keyword">new</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用工具类复制基本属性</span></span><br><span class="line">            PropertyUtil.CopyProperties(dish, dishVO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置口味数据集合</span></span><br><span class="line">            dishVO.Flavors = dishFlavors ?? <span class="keyword">new</span> List&lt;DishFlavor&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dishVO;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID查询启用状态的菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;categoryId&quot;&gt;</span>菜品分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定分类下的启用状态菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Dish&gt;&gt; List(<span class="built_in">long</span> categoryId)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 创建查询条件对象</span></span><br><span class="line">            Dish queryDish = <span class="keyword">new</span>()</span><br><span class="line">            &#123;</span><br><span class="line">                CategoryId = categoryId,</span><br><span class="line">                Status = <span class="number">1</span>  <span class="comment">// 1表示菜品启用（在售）状态</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用数据访问层执行查询</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> _dishMapper.List(queryDish);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishPageQueryDTO&quot;&gt;</span>分页查询参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果，包含总记录数和当前页数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">DishPageQueryDTO dishPageQueryDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dishPageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishPageQueryDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用数据访问层执行分页查询</span></span><br><span class="line">            (<span class="built_in">long</span> total, IList dishList) = <span class="keyword">await</span> _dishMapper.PageQuery(dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 封装并返回分页查询结果</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PageResult(total, dishList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 保存菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含菜品基本信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当dishDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当保存过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SaveWithFlavor</span>(<span class="params">DishDTO dishDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dishDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishDTO), <span class="string">&quot;菜品数据不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 准备菜品基本信息</span></span><br><span class="line">            Dish dish = <span class="keyword">new</span>();</span><br><span class="line">            PropertyUtil.CopyProperties(dishDTO, dish);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取当前登录用户ID并设置审计字段</span></span><br><span class="line">            <span class="built_in">long</span> currentUserId = BaseContext.GetCurrentId() ?? <span class="number">0</span>;</span><br><span class="line">            DateTime now = DateTime.Now;</span><br><span class="line"></span><br><span class="line">            dish.CreateTime = now;</span><br><span class="line">            dish.UpdateTime = now;</span><br><span class="line">            dish.CreateUser = currentUserId;</span><br><span class="line">            dish.UpdateUser = currentUserId;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 保存菜品基本信息</span></span><br><span class="line">            <span class="keyword">await</span> _dishMapper.Insert(dish);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 插入后dish对象会被自动更新主键值</span></span><br><span class="line">            <span class="built_in">long</span> dishId = dish.Id;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 处理菜品口味数据</span></span><br><span class="line">            List&lt;DishFlavor&gt; flavors = dishDTO.Flavors;</span><br><span class="line">            <span class="keyword">if</span> (flavors != <span class="literal">null</span> &amp;&amp; flavors.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 为每个口味设置关联的菜品ID</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> flavor <span class="keyword">in</span> flavors)</span><br><span class="line">                &#123;</span><br><span class="line">                    flavor.DishId = dishId;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 批量保存口味数据</span></span><br><span class="line">                <span class="keyword">await</span> _dishFlavorMapper.InsertBatch(flavors);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜品起售停售状态管理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1表示起售，0表示停售<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentException&quot;&gt;</span>当状态值无效时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当菜品不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当操作过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (status != <span class="number">0</span> &amp;&amp; status != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;无效的状态值，只能为0(停售)或1(起售)&quot;</span>, <span class="keyword">nameof</span>(status));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 创建菜品更新对象，仅设置需要更新的字段</span></span><br><span class="line">                Dish dish = <span class="keyword">new</span>()</span><br><span class="line">                &#123;</span><br><span class="line">                    Id = id,</span><br><span class="line">                    Status = status,</span><br><span class="line">                    <span class="comment">// 设置审计字段</span></span><br><span class="line">                    UpdateTime = DateTime.Now,</span><br><span class="line">                    UpdateUser = BaseContext.GetCurrentId() ?? <span class="number">0</span></span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 更新菜品状态</span></span><br><span class="line">                <span class="keyword">await</span> _dishMapper.Update(dish);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 级联处理：当菜品停售时，相关联的套餐也需要停售</span></span><br><span class="line">                <span class="keyword">if</span> (status == <span class="number">0</span>) <span class="comment">// 0表示停售</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 3.1 查询包含此菜品的所有套餐</span></span><br><span class="line">                    List&lt;<span class="built_in">long</span>&gt; dishIds = <span class="keyword">new</span>() &#123; id &#125;;</span><br><span class="line">                    List&lt;<span class="built_in">long</span>&gt; setmealIds = <span class="keyword">await</span> _setmealDishMapper.GetSetmealIdsByDishIds(dishIds);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 3.2 将关联的套餐也设置为停售状态</span></span><br><span class="line">                    <span class="keyword">if</span> (setmealIds != <span class="literal">null</span> &amp;&amp; setmealIds.Count &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">long</span> currentUserId = BaseContext.GetCurrentId() ?? <span class="number">0</span>;</span><br><span class="line">                        DateTime now = DateTime.Now;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="built_in">long</span> setmealId <span class="keyword">in</span> setmealIds)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 创建套餐更新对象</span></span><br><span class="line">                            Setmeal setmeal = <span class="keyword">new</span>()</span><br><span class="line">                            &#123;</span><br><span class="line">                                Id = setmealId,</span><br><span class="line">                                Status = <span class="number">0</span>, <span class="comment">// 停售</span></span><br><span class="line">                                UpdateTime = now,</span><br><span class="line">                                UpdateUser = currentUserId</span><br><span class="line">                            &#125;;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 更新套餐状态</span></span><br><span class="line">                            <span class="keyword">await</span> _setmealMapper.Update(setmeal);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 包装异常信息并重新抛出</span></span><br><span class="line">                <span class="built_in">string</span> action = status == <span class="number">1</span> ? <span class="string">&quot;起售&quot;</span> : <span class="string">&quot;停售&quot;</span>;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;菜品<span class="subst">&#123;action&#125;</span>操作失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品及其口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishDTO&quot;&gt;</span>菜品数据传输对象，包含更新后的菜品信息和口味数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当dishDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当菜品不存在时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当更新过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UpdateWithFlavor</span>(<span class="params">DishDTO dishDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dishDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishDTO), <span class="string">&quot;菜品更新数据不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dishDTO.Id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;无效的菜品ID&quot;</span>, <span class="keyword">nameof</span>(dishDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 准备菜品基本信息</span></span><br><span class="line">            Dish dish = <span class="keyword">new</span>();</span><br><span class="line">            PropertyUtil.CopyProperties(dishDTO, dish);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置审计字段</span></span><br><span class="line">            dish.UpdateTime = DateTime.Now;</span><br><span class="line">            dish.UpdateUser = BaseContext.GetCurrentId() ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 2. 更新菜品基本信息</span></span><br><span class="line">                <span class="keyword">await</span> _dishMapper.Update(dish);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 重建口味数据（先删除后新增）</span></span><br><span class="line">                <span class="comment">// 3.1 删除原有的口味数据</span></span><br><span class="line">                <span class="keyword">await</span> _dishFlavorMapper.DeleteByDishId(dishDTO.Id);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3.2 添加新的口味数据</span></span><br><span class="line">                List&lt;DishFlavor&gt; flavors = dishDTO.Flavors;</span><br><span class="line">                <span class="keyword">if</span> (flavors != <span class="literal">null</span> &amp;&amp; flavors.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 为每个口味设置关联的菜品ID</span></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> flavor <span class="keyword">in</span> flavors)</span><br><span class="line">                    &#123;</span><br><span class="line">                        flavor.DishId = dishDTO.Id;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 批量插入新的口味数据</span></span><br><span class="line">                    <span class="keyword">await</span> _dishFlavorMapper.InsertBatch(flavors);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;更新菜品信息失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4、IDishMapper"><a href="#4、IDishMapper" class="headerlink" title="4、IDishMapper"></a>4、IDishMapper</h2><p>ProgramBackEnd\SkyServer\mapper\IDishMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与菜品相关的数据库操作，提供对菜品数据的增删改查功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法均为异步实现，支持高并发数据访问场景。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口是系统数据访问层与业务逻辑层之间的桥梁，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现类通常使用Entity Framework Core或其他ORM框架与数据库交互。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID统计菜品数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>该分类下的菜品数量<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法主要用于在尝试删除分类前，检查是否有菜品关联该分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法只删除菜品基本信息，不处理关联的口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在业务层通常需要配合删除口味数据，并通过事务保证数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询菜品详情</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品对象，如果不存在则可能返回null<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法只返回菜品基本信息，不包含口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如需获取完整信息，应在业务层配合口味查询。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;Dish&gt; <span class="title">GetById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入新菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>要插入的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行后，<span class="doctag">&lt;paramref name=&quot;dish&quot;/&gt;</span>对象的Id属性会被设置为数据库生成的ID值。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这使得调用方可以获取新插入记录的ID，用于后续操作。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Insert</span>(<span class="params">Dish dish</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据条件查询菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>包含查询条件的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>符合条件的菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;paramref name=&quot;dish&quot;/&gt;</span>对象的非null属性将作为查询条件：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - CategoryId: 按分类筛选</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Status: 按状态筛选(1-起售，0-停售)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name: 按名称模糊匹配</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的菜品按创建时间降序排序。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;Dish&gt;&gt; List(Dish dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishPageQueryDTO&quot;&gt;</span>分页查询条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含总记录数和当前页菜品列表的元组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回元组中：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - total: 满足条件的总记录数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - dishList: 当前页的菜品视图对象列表，包含分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 结果按创建时间降序排序，支持按名称模糊查询、分类和状态筛选。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        Task&lt;(<span class="built_in">long</span> total, IList dishList)&gt; PageQuery(DishPageQueryDTO dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>包含更新字段的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法采用选择性更新策略，只更新<span class="doctag">&lt;paramref name=&quot;dish&quot;/&gt;</span>对象中非默认值的属性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这意味着：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 字符串属性为null时不会被更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 数值类型属性为0时不会被更新（除非显式需要更新为0）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 日期类型属性为默认值时不会被更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 确保在调用此方法前设置必要的审计字段（如UpdateTime、UpdateUser）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">Dish dish</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5、DishMapperImpl"><a href="#5、DishMapperImpl" class="headerlink" title="5、DishMapperImpl"></a>5、DishMapperImpl</h2><p>ProgramBackEnd\SkyServer\controller\admin\DishController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现IDishMapper接口，提供对菜品数据的增删改查操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有数据库交互均采用异步方式执行，支持高并发环境下的数据访问需求。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类处理与dish表及关联表的所有数据库交互，包括：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 基本的CRUD操作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 条件查询和计数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 分页查询并关联分类数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 按特定条件筛选菜品列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DishMapperImpl</span> : <span class="title">IDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DishMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID统计关联的菜品数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>该分类下的菜品数量<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于验证分类是否可删除，如果分类下有菜品，通常不应该允许删除该分类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 查询指定分类ID的菜品数量</span></span><br><span class="line">            <span class="built_in">int</span> total = <span class="keyword">await</span> _skyDbContext.Dishes</span><br><span class="line">                .Where(d =&gt; d.CategoryId == id)</span><br><span class="line">                .CountAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> total;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当删除操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行物理删除，从数据库中永久移除记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注意：此操作不会级联删除关联的口味数据，应由调用方处理关联表数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查找要删除的菜品记录</span></span><br><span class="line">                <span class="keyword">var</span> dish = <span class="keyword">await</span> _skyDbContext.Dishes.FindAsync(id);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 如果菜品存在，则从DbContext中删除，否则不执行任何操作</span></span><br><span class="line">                <span class="keyword">if</span> (dish != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _skyDbContext.Dishes.Remove(dish);</span><br><span class="line">                    <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 注意：当记录不存在时，我们不抛出异常</span></span><br><span class="line">                <span class="comment">// 这与SQL DELETE语句的行为一致，它在记录不存在时也会成功执行</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将异常转换为更具体的错误信息，便于定位问题</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;删除菜品(ID:<span class="subst">&#123;id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询菜品详情</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品对象，如果不存在则抛出异常<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;Exception&quot;&gt;</span>当菜品不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法只返回菜品基本信息，不包含口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 口味数据需通过专门的方法查询。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Dish&gt; <span class="title">GetById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用FirstOrDefaultAsync查询，结果为null时抛出自定义异常</span></span><br><span class="line">                <span class="keyword">var</span> dish = <span class="keyword">await</span> _skyDbContext.Dishes</span><br><span class="line">                    .FirstOrDefaultAsync(d =&gt; d.Id == id);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果菜品不存在，抛出业务异常</span></span><br><span class="line">                <span class="keyword">if</span> (dish == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;未找到ID为<span class="subst">&#123;id&#125;</span>的菜品&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> dish;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex.Message != <span class="string">$&quot;未找到ID为<span class="subst">&#123;id&#125;</span>的菜品&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换数据库异常，但保留我们自己的业务异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;查询菜品(ID:<span class="subst">&#123;id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入新菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>要插入的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 执行此方法后，dish对象的Id属性会被设置为数据库生成的主键值，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 便于后续操作（如添加口味数据）使用此ID。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Insert</span>(<span class="params">Dish dish</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 将菜品实体添加到DbContext中</span></span><br><span class="line">            <span class="keyword">await</span> _skyDbContext.Dishes.AddAsync(dish);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 保存更改到数据库并自动设置生成的主键值</span></span><br><span class="line">            <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            <span class="comment">// 注意：EF Core会自动将生成的主键ID回填到dish对象中</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据条件查询菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>包含查询条件的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>符合条件的菜品列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持以下条件查询：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 按菜品名称模糊搜索</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 按分类ID精确匹配</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 按菜品状态筛选</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 结果会按创建时间降序排序，通常用于前台展示和套餐管理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Dish&gt;&gt; List(Dish dish)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 构建基础查询</span></span><br><span class="line">                IQueryable&lt;Dish&gt; query = _skyDbContext.Dishes.AsQueryable();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 应用动态查询条件</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.1 按名称模糊查询（如果提供了名称）</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(dish.Name))</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(d =&gt; d.Name != <span class="literal">null</span> &amp;&amp; d.Name.Contains(dish.Name));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.2 按分类ID筛选（如果提供了分类ID且大于0）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.CategoryId &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(d =&gt; d.CategoryId == dish.CategoryId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.3 按状态筛选（如果提供了状态）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Status.HasValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(d =&gt; d.Status == dish.Status);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 应用排序（创建时间降序）</span></span><br><span class="line">                query = query.OrderByDescending(d =&gt; d.CreateTime);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 执行查询并返回结果列表</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> query.ToListAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换为应用程序异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;查询菜品列表时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询菜品，并关联分类信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishPageQueryDTO&quot;&gt;</span>分页查询参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含总记录数和当前页菜品列表的元组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 关联菜品表和分类表，获取分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 应用过滤条件（名称、分类ID、状态）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 计算总记录数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 4. 执行分页查询并排序</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 5. 将结果转换为前端所需的视图对象</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;(<span class="built_in">long</span> total, IList dishList)&gt; PageQuery(DishPageQueryDTO dishPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1. 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (dishPageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishPageQueryDTO), <span class="string">&quot;查询参数不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 规范化分页参数，确保有效值</span></span><br><span class="line">            <span class="built_in">int</span> page = Math.Max(<span class="number">1</span>, dishPageQueryDTO.Page);</span><br><span class="line">            <span class="built_in">int</span> pageSize = Math.Max(<span class="number">1</span>, dishPageQueryDTO.PageSize);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 3. 构建菜品和分类的关联查询</span></span><br><span class="line">                <span class="comment">// 使用左外连接，确保即使菜品没有关联的分类也能被查询到</span></span><br><span class="line">                <span class="keyword">var</span> query = <span class="keyword">from</span> d <span class="keyword">in</span> _skyDbContext.Dishes</span><br><span class="line">                            <span class="keyword">join</span> c <span class="keyword">in</span> _skyDbContext.Categories</span><br><span class="line">                            <span class="keyword">on</span> d.CategoryId <span class="keyword">equals</span> c.Id <span class="keyword">into</span> categoryGroup</span><br><span class="line">                            <span class="keyword">from</span> c <span class="keyword">in</span> categoryGroup.DefaultIfEmpty()</span><br><span class="line">                            <span class="keyword">select</span> <span class="keyword">new</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">// 菜品基本信息</span></span><br><span class="line">                                d.Id,</span><br><span class="line">                                d.Name,</span><br><span class="line">                                d.CategoryId,</span><br><span class="line">                                d.Price,</span><br><span class="line">                                d.Image,</span><br><span class="line">                                d.Description,</span><br><span class="line">                                d.Status,</span><br><span class="line">                                d.CreateTime,</span><br><span class="line">                                d.UpdateTime,</span><br><span class="line">                                d.CreateUser,</span><br><span class="line">                                d.UpdateUser,</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 分类名称（来自分类表）</span></span><br><span class="line">                                CategoryName = c.Name</span><br><span class="line">                            &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 应用查询条件</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4.1 按名称模糊查询</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(dishPageQueryDTO.Name))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">string</span> name = dishPageQueryDTO.Name.Trim();</span><br><span class="line">                    query = query.Where(d =&gt; d.Name != <span class="literal">null</span> &amp;&amp; d.Name.Contains(name));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4.2 按分类ID筛选</span></span><br><span class="line">                <span class="keyword">if</span> (dishPageQueryDTO.CategoryId.HasValue &amp;&amp; dishPageQueryDTO.CategoryId &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(d =&gt; d.CategoryId == dishPageQueryDTO.CategoryId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4.3 按状态筛选</span></span><br><span class="line">                <span class="keyword">if</span> (dishPageQueryDTO.Status.HasValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(d =&gt; d.Status == dishPageQueryDTO.Status);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 查询总记录数（用于分页）</span></span><br><span class="line">                <span class="built_in">long</span> total = <span class="keyword">await</span> query.LongCountAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 执行分页查询</span></span><br><span class="line">                <span class="keyword">var</span> dishDataList = <span class="keyword">await</span> query</span><br><span class="line">                    <span class="comment">// 主排序：按创建时间降序</span></span><br><span class="line">                    .OrderByDescending(d =&gt; d.CreateTime)</span><br><span class="line">                    <span class="comment">// 次排序：按ID升序（确保排序稳定性）</span></span><br><span class="line">                    .ThenBy(d =&gt; d.Id)</span><br><span class="line">                    <span class="comment">// 分页：跳过前面页的记录</span></span><br><span class="line">                    .Skip((page - <span class="number">1</span>) * pageSize)</span><br><span class="line">                    <span class="comment">// 分页：获取当前页的记录数</span></span><br><span class="line">                    .Take(pageSize)</span><br><span class="line">                    <span class="comment">// 执行查询并获取结果</span></span><br><span class="line">                    .ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 7. 将查询结果转换为视图对象</span></span><br><span class="line">                <span class="keyword">var</span> dishList = dishDataList.Select(d =&gt; <span class="keyword">new</span> DishVO(</span><br><span class="line">                    d.Id,</span><br><span class="line">                    d.Name,</span><br><span class="line">                    d.CategoryId,</span><br><span class="line">                    d.Price,</span><br><span class="line">                    d.Image,</span><br><span class="line">                    d.Description,</span><br><span class="line">                    d.Status,</span><br><span class="line">                    d.UpdateTime,</span><br><span class="line">                    d.CategoryName,</span><br><span class="line">                    <span class="keyword">new</span> List&lt;DishFlavor&gt;() <span class="comment">// 初始化空的口味列表</span></span><br><span class="line">                )).ToList();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 8. 返回查询结果：总记录数和当前页数据</span></span><br><span class="line">                <span class="keyword">return</span> (total, dishList);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (ex <span class="keyword">is</span> <span class="keyword">not</span> ArgumentNullException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换异常，提供更明确的上下文信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;执行菜品分页查询时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dish&quot;&gt;</span>包含更新字段的菜品对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当菜品不存在或更新失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法采用选择性更新策略，只更新非默认值的字段，具体规则如下：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 字符串属性不为null时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 数值类型属性不为0时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 可空类型有值时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新时间总是更新（即使为默认值）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此行为模拟MyBatis的动态SQL功能，避免不必要的字段更新。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">Dish dish</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查找数据库中已存在的菜品记录</span></span><br><span class="line">                <span class="keyword">var</span> existingDish = <span class="keyword">await</span> _skyDbContext.Dishes.FindAsync(dish.Id);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果菜品不存在，抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (existingDish == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;未找到ID为<span class="subst">&#123;dish.Id&#125;</span>的菜品&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 选择性更新各个字段</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新名称（如果提供了新值）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Name != <span class="literal">null</span>)</span><br><span class="line">                    existingDish.Name = dish.Name;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新分类ID（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.CategoryId != <span class="number">0</span>)</span><br><span class="line">                    existingDish.CategoryId = dish.CategoryId;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新价格（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Price != <span class="number">0</span>)</span><br><span class="line">                    existingDish.Price = dish.Price;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新图片路径（如果提供了新值）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Image != <span class="literal">null</span>)</span><br><span class="line">                    existingDish.Image = dish.Image;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新描述信息（如果提供了新值）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Description != <span class="literal">null</span>)</span><br><span class="line">                    existingDish.Description = dish.Description;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新状态（如果提供了值）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.Status.HasValue)</span><br><span class="line">                    existingDish.Status = dish.Status;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新时间总是更新（用于记录最后修改时间）</span></span><br><span class="line">                existingDish.UpdateTime = dish.UpdateTime;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新修改人（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (dish.UpdateUser != <span class="number">0</span>)</span><br><span class="line">                    existingDish.UpdateUser = dish.UpdateUser;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 保存所有更改到数据库</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (!(ex <span class="keyword">is</span> InvalidOperationException &amp;&amp; ex.Message.StartsWith(<span class="string">&quot;未找到ID&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换其他异常，但保留&quot;菜品不存在&quot;的业务异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;更新菜品(ID:<span class="subst">&#123;dish.Id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6、IDishFlavorMapper"><a href="#6、IDishFlavorMapper" class="headerlink" title="6、IDishFlavorMapper"></a>6、IDishFlavorMapper</h2><p>ProgramBackEnd\SkyServer\mapper\IDishFlavorMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品口味数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与菜品口味（DishFlavor）相关的数据库操作，提供对口味数据的增删改查功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口负责处理菜品与其对应口味选项之间的关系，支持批量操作和按菜品ID查询。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品口味是菜品的重要属性，如辣度、甜度、口味偏好等。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 每个菜品可以有多个口味选项，用户可以根据自己的喜好进行选择。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口的实现应确保口味数据与菜品数据的一致性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDishFlavorMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID删除所有关联的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当菜品被删除或更新时，需要先删除相关的口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行级联删除操作，删除指定菜品ID关联的所有口味记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当删除操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteByDishId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID查询所有口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品口味列表，如果没有相关口味则返回空列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于获取指定菜品的所有口味选项，常用于：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 展示菜品详情时显示口味信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 编辑菜品时加载已有的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 用户点餐时展示可选的口味选项</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询过程中发生错误时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;DishFlavor&gt;&gt; GetByDishId(<span class="built_in">long</span> id);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量插入菜品口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flavors&quot;&gt;</span>口味数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于在添加或更新菜品时，批量保存口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 调用此方法前应确保：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 每个DishFlavor对象都已设置正确的DishId</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 列表中不包含重复的口味定义</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当flavors参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当批量插入过程中发生错误时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">InsertBatch</span>(<span class="params">List&lt;DishFlavor&gt; flavors</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7、DishFlavorMapperImpl"><a href="#7、DishFlavorMapperImpl" class="headerlink" title="7、DishFlavorMapperImpl"></a>7、DishFlavorMapperImpl</h2><p>ProgramBackEnd\SkyServer\mapper\Impl\DishFlavorMapperImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜品口味数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现对dish_flavor表的数据访问操作，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供菜品口味数据的增删改查功能，支持批量操作和按菜品ID查询。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类负责菜品口味数据的持久化，确保口味数据与菜品的一致性和关联性，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是实现菜品个性化定制的重要组成部分。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DishFlavorMapperImpl</span> : <span class="title">IDishFlavorMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DishFlavorMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID删除所有关联的口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishId&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当删除操作失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法在更新菜品时用于清除旧的口味数据，或在删除菜品时级联删除口味数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用批量删除策略，避免多次数据库操作，提高性能。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteByDishId</span>(<span class="params"><span class="built_in">long</span> dishId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查询需要删除的口味记录</span></span><br><span class="line">                <span class="comment">// 使用ToListAsync()立即执行查询，将结果加载到内存</span></span><br><span class="line">                <span class="keyword">var</span> flavorsToDelete = <span class="keyword">await</span> _skyDbContext.DishFlavors</span><br><span class="line">                    .Where(df =&gt; df.DishId == dishId)</span><br><span class="line">                    .ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 执行批量删除操作（如果存在要删除的记录）</span></span><br><span class="line">                <span class="keyword">if</span> (flavorsToDelete.Any())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 使用RemoveRange进行批量删除，比单条删除更高效</span></span><br><span class="line">                    _skyDbContext.DishFlavors.RemoveRange(flavorsToDelete);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 提交更改到数据库</span></span><br><span class="line">                    <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果没有找到匹配的记录，无需执行任何操作</span></span><br><span class="line">                <span class="comment">// 这与SQL DELETE语句的行为一致：没有匹配记录时不报错</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换为应用程序异常，提供更有意义的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;删除菜品口味数据时发生错误(菜品ID:<span class="subst">&#123;dishId&#125;</span>): <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID查询所有口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>菜品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>菜品口味列表，如果没有相关口味则返回空列表<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询过程中发生错误时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于获取菜品的完整口味信息，常用于编辑菜品和展示菜品详情。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的列表已按口味添加顺序排序，便于前端展示。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;DishFlavor&gt;&gt; GetByDishId(<span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 查询指定菜品ID的所有口味数据</span></span><br><span class="line">                <span class="comment">// 注意：此处可以根据需要添加排序条件，如按ID或Name排序</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">await</span> _skyDbContext.DishFlavors</span><br><span class="line">                    .Where(df =&gt; df.DishId == id)</span><br><span class="line">                    .ToListAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 提供详细的错误信息，便于问题排查</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;查询菜品口味数据时发生错误(菜品ID:<span class="subst">&#123;id&#125;</span>): <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量插入菜品口味数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flavors&quot;&gt;</span>口味数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当批量插入过程中发生错误时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法使用高效的批量插入策略，一次性将多个口味记录添加到数据库。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 在添加或更新菜品时，通常会先删除旧口味，再批量插入新口味。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InsertBatch</span>(<span class="params">List&lt;DishFlavor&gt; flavors</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 输入验证：如果列表为空，直接返回，无需进行数据库操作</span></span><br><span class="line">            <span class="keyword">if</span> (flavors == <span class="literal">null</span> || flavors.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用AddRangeAsync方法批量添加实体，比逐个添加更高效</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.DishFlavors.AddRangeAsync(flavors);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将更改保存到数据库</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换异常，提供更具体的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;批量插入菜品口味数据时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8、ISetmealMapper"><a href="#8、ISetmealMapper" class="headerlink" title="8、ISetmealMapper"></a>8、ISetmealMapper</h2><p>ProgramBackEnd\SkyServer\mapper\ISetmealMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与套餐（Setmeal）相关的数据库操作，提供对setmeal表的基本访问功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口支持套餐数据的查询和更新操作，是套餐管理功能的数据访问层基础。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐是由多个菜品组合而成的销售单元，具有自己的价格和状态。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口的实现应确保套餐数据的完整性和一致性，特别是在更新操作中。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISetmealMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID统计套餐数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定分类下的套餐数量<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法主要用于以下场景：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 在尝试删除分类前，检查该分类是否有关联的套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 统计各分类下的套餐分布情况</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 验证某分类是否可以进行特定操作</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新套餐信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmeal&quot;&gt;</span>包含要更新字段的套餐对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行选择性更新，只更新setmeal对象中非默认值的字段。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 常用场景包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 修改套餐基本信息（名称、价格、描述等）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐状态（启用/停用）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐图片</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 调用此方法前应确保已设置必要的审计字段（如UpdateTime、UpdateUser）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmeal参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当更新操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">Setmeal setmeal</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="9、SetmealMapperImpl"><a href="#9、SetmealMapperImpl" class="headerlink" title="9、SetmealMapperImpl"></a>9、SetmealMapperImpl</h2><p>ProgramBackEnd\SkyServer\mapper\Impl\SetmealMapperImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现ISetmealMapper接口，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供对套餐（Setmeal）数据的统计和更新功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类处理与setmeal表的交互，确保套餐数据的一致性和完整性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现了选择性字段更新策略，只更新明确设置了值的属性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealMapperImpl</span> : <span class="title">ISetmealMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID统计套餐数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>该分类下的套餐数量<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法常用于检查分类是否可以被删除，如果分类下存在套餐，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通常不允许删除该分类以维护数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 执行查询，计算指定分类下的套餐总数</span></span><br><span class="line">                <span class="built_in">int</span> total = <span class="keyword">await</span> _skyDbContext.Setmeals</span><br><span class="line">                    .Where(s =&gt; s.CategoryId == id)</span><br><span class="line">                    .CountAsync();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> total;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将数据库异常转换为更具体的应用异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;统计分类ID为<span class="subst">&#123;id&#125;</span>的套餐数量时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新套餐信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmeal&quot;&gt;</span>包含要更新字段的套餐对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当套餐不存在或更新失败时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法实现了选择性更新策略，只有非默认值的字段会被更新：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 字符串属性不为null时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 数值类型属性不为0时更新（除非显式需要更新为0）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 可空类型属性有值时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 日期类型属性不为默认值时更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此行为模拟了MyBatis的动态SQL功能，避免不必要的字段更新。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">Setmeal setmeal</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (setmeal == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmeal), <span class="string">&quot;套餐对象不能为null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查找数据库中已存在的套餐记录</span></span><br><span class="line">                <span class="keyword">var</span> existingSetmeal = <span class="keyword">await</span> _skyDbContext.Setmeals.FindAsync(setmeal.Id);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果找不到套餐，抛出业务异常</span></span><br><span class="line">                <span class="keyword">if</span> (existingSetmeal == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;未找到ID为<span class="subst">&#123;setmeal.Id&#125;</span>的套餐&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 选择性更新属性（只更新非默认值）</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新名称（如果提供）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Name != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Name = setmeal.Name;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新分类ID（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.CategoryId != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.CategoryId = setmeal.CategoryId;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新价格（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Price != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.Price = setmeal.Price;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新状态（如果提供）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Status.HasValue)</span><br><span class="line">                    existingSetmeal.Status = setmeal.Status;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新描述（如果提供）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Description != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Description = setmeal.Description;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新图片（如果提供）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Image != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Image = setmeal.Image;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新时间（如果提供非默认值）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.UpdateTime != <span class="literal">default</span>)</span><br><span class="line">                    existingSetmeal.UpdateTime = setmeal.UpdateTime;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新用户ID（如果不为默认值0）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.UpdateUser != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.UpdateUser = setmeal.UpdateUser;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 保存所有更改到数据库</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (!(ex <span class="keyword">is</span> InvalidOperationException &amp;&amp; ex.Message.StartsWith(<span class="string">&quot;未找到ID&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换数据库异常，但保留&quot;套餐不存在&quot;类型的业务异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;更新套餐(ID:<span class="subst">&#123;setmeal.Id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="10、ISetmealDishMapper"><a href="#10、ISetmealDishMapper" class="headerlink" title="10、ISetmealDishMapper"></a>10、ISetmealDishMapper</h2><p>ProgramBackEnd\SkyServer\mapper\ISetmealDishMapper.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐菜品关系数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义套餐与菜品之间关联关系的数据访问操作。此接口主要负责维护</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> setmeal_dish表的数据，管理套餐和菜品之间的多对多关系。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐（Setmeal）通常由多个菜品（Dish）组成，而同一个菜品也可以出现在多个套餐中，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 形成多对多的关系。此接口的实现提供了查询这种关系的能力，主要用于业务规则校验</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 和关联数据处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISetmealDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID集合查询关联的套餐ID集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>菜品ID集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含这些菜品的套餐ID集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于确定哪些套餐包含了指定的菜品。典型用例包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 检查菜品是否可以删除（若被套餐引用则不可删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 当菜品状态变更时，同步更新相关套餐的状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 分析菜品的使用情况，如查询某菜品被多少套餐引用</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果没有套餐包含这些菜品，将返回空列表而不是null。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当ids参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;<span class="built_in">long</span>&gt;&gt; GetSetmealIdsByDishIds(List&lt;<span class="built_in">long</span>&gt; ids);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="11、SetmealDishMapperImpl"><a href="#11、SetmealDishMapperImpl" class="headerlink" title="11、SetmealDishMapperImpl"></a>11、SetmealDishMapperImpl</h2><p>ProgramBackEnd\SkyServer\mapper\Impl\SetmealDishMapperImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐菜品关系数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现ISetmealDishMapper接口，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供套餐与菜品关联关系的数据访问能力。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类负责维护setmeal_dish表的数据访问，处理套餐和菜品之间的多对多关系。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过查询此关系表，可以实现如确定菜品是否可删除、修改菜品状态时同步</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新相关套餐状态等业务功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealDishMapperImpl</span> : <span class="title">ISetmealDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealDishMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID列表获取关联的套餐ID列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>菜品ID列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>与这些菜品关联的套餐ID列表（已去重）<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法查询所有引用了指定菜品的套餐，主要用于：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 检查菜品是否可以删除（若被套餐引用则通常不允许删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 当菜品状态变更为停售时，同步停售包含该菜品的套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 分析菜品使用情况，了解哪些菜品被多个套餐引用</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询会自动去重，确保结果中每个套餐ID只出现一次，即使某个套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 包含了多个指定的菜品。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;<span class="built_in">long</span>&gt;&gt; GetSetmealIdsByDishIds(List&lt;<span class="built_in">long</span>&gt; ids)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证：如果为空或无元素，直接返回空列表</span></span><br><span class="line">            <span class="keyword">if</span> (ids == <span class="literal">null</span> || ids.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 查询与指定菜品ID列表相关的所有套餐ID</span></span><br><span class="line">                <span class="comment">// 相当于SQL: SELECT DISTINCT setmeal_id FROM setmeal_dish WHERE dish_id IN (...)</span></span><br><span class="line">                <span class="keyword">var</span> setmealIds = <span class="keyword">await</span> _skyDbContext.SetmealDishes</span><br><span class="line">                    .Where(sd =&gt; ids.Contains(sd.DishId))  <span class="comment">// 筛选包含指定菜品的记录</span></span><br><span class="line">                    .Select(sd =&gt; sd.SetmealId)            <span class="comment">// 提取套餐ID</span></span><br><span class="line">                    .Distinct()                            <span class="comment">// 去除重复记录</span></span><br><span class="line">                    .ToListAsync();                        <span class="comment">// 执行查询并获取结果</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> setmealIds;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换为特定异常，提供更明确的错误上下文</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;查询包含指定菜品的套餐时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7、结果展示"><a href="#7、结果展示" class="headerlink" title="7、结果展示"></a>7、结果展示</h1><h2 id="1、查"><a href="#1、查" class="headerlink" title="1、查"></a>1、查</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605095954849.png" alt="image-20250605095954849"></p>
<h2 id="2、增"><a href="#2、增" class="headerlink" title="2、增"></a>2、增</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605100036195.png" alt="image-20250605100036195"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605100052720.png" alt="image-20250605100052720"></p>
<h2 id="3、改"><a href="#3、改" class="headerlink" title="3、改"></a>3、改</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605100103038.png" alt="image-20250605100103038"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605100109877.png" alt="image-20250605100109877"></p>
<h2 id="4、删"><a href="#4、删" class="headerlink" title="4、删"></a>4、删</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605100213588.png" alt="image-20250605100213588"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605100219666.png" alt="image-20250605100219666"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/05/28/NET-ASP-16/">https://alsl521.github.io/2025/05/28/NET-ASP-16/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ASP.NET学习记录-15-实战-Day02</div></div><div class="info-2"><div class="info-item-1">1、员工管理界面 1、新增员工1、EmployeeController.csProgramBackEnd\SkyServer\controller\admin\EmployeeController.cs 该文件中添加如下内容： 1234567891011121314151617181920212223/// &lt;summary&gt;/// 新增员工接口/// &lt;para&gt;/// 创建新员工账户，设置默认密码并保存员工基本信息。/// 只有已认证的管理员可以调用此接口。/// &lt;/para&gt;/// &lt;/summary&gt;/// &lt;param name=&quot;employeeDTO&quot;&gt;员工数据传输对象，包含新员工的基本信息&lt;/param&gt;/// &lt;returns&gt;统一封装的成功结果对象&lt;/returns&gt;/// &lt;response code=&quot;200&quot;&gt;返回保存成功的信息&lt;/response&gt;[HttpPost]public async...</div></div></div></a><a class="pagination-related" href="/2025/06/05/NET-ASP-17/" title="NET-ASP-17-实战-Day04"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">NET-ASP-17-实战-Day04</div></div><div class="info-2"><div class="info-item-1">1、事务管理在 C# .NET ASP.NET Core 中，确保事务一致性主要通过数据库事务机制实现，确保多个操作要么全部成功，要么全部失败。以下是常见的实现方式及其示例： 1. Entity Framework Core 事务（推荐）方式 1：使用 DbContext.Database.BeginTransaction() 123456789101112131415161718192021using (var transaction = context.Database.BeginTransaction())&#123;    try    &#123;        // 操作 1：插入订单        context.Orders.Add(order);        await context.SaveChangesAsync();        // 操作 2：更新库存        product.Stock -= order.Quantity;        context.Products.Update(product);        await...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/09/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-09</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-04-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-04-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/11/NET-ASP-05/" title="ASP.NET学习记录-05-模型数据绑定"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">ASP.NET学习记录-05-模型数据绑定</div></div><div class="info-2"><div class="info-item-1">1、模型绑定定义模型绑定是ASP.NET Core中将HTTP请求数据自动映射到方法参数或对象属性的机制。其核心工作流程：  数据来源：  路由参数（URL片段） 查询字符串（?key&#x3D;value） 请求体（表单&#x2F;JSON&#x2F;XML） 请求头 文件上传   典型应用：   12345678910111213// 自动绑定路由参数和查询参数[HttpGet(&quot;/products/&#123;id&#125;&quot;)]public IActionResult GetProduct(int id, [FromQuery] string category) &#123;    // id来自路由参数，category来自查询字符串&#125;// 自动绑定JSON请求体[HttpPost]public IActionResult Create([FromBody] Product product)&#123;    //...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E9%83%A8%E7%BD%B2Redis"><span class="toc-number">1.</span> <span class="toc-text">1、部署Redis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E9%83%A8%E7%BD%B2Minio"><span class="toc-number">2.</span> <span class="toc-text">2、部署Minio</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">3、系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81appsettings-json"><span class="toc-number">3.1.</span> <span class="toc-text">1、appsettings.json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Program-cs"><span class="toc-number">3.2.</span> <span class="toc-text">2、Program.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Redis%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">3、Redis配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81ISerializer"><span class="toc-number">3.3.1.</span> <span class="toc-text">1、ISerializer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81JsonSerializer"><span class="toc-number">3.3.2.</span> <span class="toc-text">2、JsonSerializer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81IRedisCache"><span class="toc-number">3.3.3.</span> <span class="toc-text">3、IRedisCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81RedisCacheImpl"><span class="toc-number">3.3.4.</span> <span class="toc-text">4、RedisCacheImpl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81MinioProperties"><span class="toc-number">3.4.</span> <span class="toc-text">4、MinioProperties</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81CommonController"><span class="toc-number">4.</span> <span class="toc-text">4、CommonController</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81FileUploadService"><span class="toc-number">5.</span> <span class="toc-text">5、FileUploadService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81IFileUploadService"><span class="toc-number">5.1.</span> <span class="toc-text">1、IFileUploadService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81FileUploadServiceImpl"><span class="toc-number">5.2.</span> <span class="toc-text">2、FileUploadServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81Dish%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">6、Dish相关代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81DishController"><span class="toc-number">6.1.</span> <span class="toc-text">1、DishController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81IDishService"><span class="toc-number">6.2.</span> <span class="toc-text">2、IDishService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81DishServiceImpl"><span class="toc-number">6.3.</span> <span class="toc-text">3、DishServiceImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81IDishMapper"><span class="toc-number">6.4.</span> <span class="toc-text">4、IDishMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81DishMapperImpl"><span class="toc-number">6.5.</span> <span class="toc-text">5、DishMapperImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81IDishFlavorMapper"><span class="toc-number">6.6.</span> <span class="toc-text">6、IDishFlavorMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81DishFlavorMapperImpl"><span class="toc-number">6.7.</span> <span class="toc-text">7、DishFlavorMapperImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81ISetmealMapper"><span class="toc-number">6.8.</span> <span class="toc-text">8、ISetmealMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81SetmealMapperImpl"><span class="toc-number">6.9.</span> <span class="toc-text">9、SetmealMapperImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81ISetmealDishMapper"><span class="toc-number">6.10.</span> <span class="toc-text">10、ISetmealDishMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81SetmealDishMapperImpl"><span class="toc-number">6.11.</span> <span class="toc-text">11、SetmealDishMapperImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">7.</span> <span class="toc-text">7、结果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%9F%A5"><span class="toc-number">7.1.</span> <span class="toc-text">1、查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%A2%9E"><span class="toc-number">7.2.</span> <span class="toc-text">2、增</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%94%B9"><span class="toc-number">7.3.</span> <span class="toc-text">3、改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%A0"><span class="toc-number">7.4.</span> <span class="toc-text">4、删</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/05/NET-ASP-17/" title="NET-ASP-17-实战-Day04">NET-ASP-17-实战-Day04</a><time datetime="2025-06-05T01:57:52.000Z" title="发表于 2025-06-05 09:57:52">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03">NET-ASP-16-实战-Day03</a><time datetime="2025-05-28T02:57:23.000Z" title="发表于 2025-05-28 10:57:23">2025-05-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02">ASP.NET学习记录-15-实战-Day02</a><time datetime="2025-05-26T11:25:36.000Z" title="发表于 2025-05-26 19:25:36">2025-05-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/NET-ASP-14/" title="ASP.NET学习记录-14-实战-Day01">ASP.NET学习记录-14-实战-Day01</a><time datetime="2025-05-25T12:02:17.000Z" title="发表于 2025-05-25 20:02:17">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>