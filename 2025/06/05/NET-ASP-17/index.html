<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>NET-ASP-17-实战-Day04 | kyl的博客</title><meta name="author" content="kyl"><meta name="copyright" content="kyl"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:type" content="article">
<meta property="og:title" content="NET-ASP-17-实战-Day04">
<meta property="og:url" content="https://alsl521.github.io/2025/06/05/NET-ASP-17/index.html">
<meta property="og:site_name" content="kyl的博客">
<meta property="og:description" content="C# .NET ASP.NET Core 基础入门 简单学习 实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4">
<meta property="article:published_time" content="2025-06-05T01:57:52.000Z">
<meta property="article:modified_time" content="2025-06-05T07:16:57.721Z">
<meta property="article:author" content="kyl">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "NET-ASP-17-实战-Day04",
  "url": "https://alsl521.github.io/2025/06/05/NET-ASP-17/",
  "image": "https://avatars.githubusercontent.com/u/61216968?s=400&u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&v=4",
  "datePublished": "2025-06-05T01:57:52.000Z",
  "dateModified": "2025-06-05T07:16:57.721Z",
  "author": [
    {
      "@type": "Person",
      "name": "kyl",
      "url": "https://alsl521.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://alsl521.github.io/2025/06/05/NET-ASP-17/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NET-ASP-17-实战-Day04',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">kyl的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">NET-ASP-17-实战-Day04</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">NET-ASP-17-实战-Day04</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-05T01:57:52.000Z" title="发表于 2025-06-05 09:57:52">2025-06-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-05T07:16:57.721Z" title="更新于 2025-06-05 15:16:57">2025-06-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/ASP/">ASP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="1、事务管理"><a href="#1、事务管理" class="headerlink" title="1、事务管理"></a>1、事务管理</h1><p>在 C# .NET ASP.NET Core 中，确保事务一致性主要通过数据库事务机制实现，确保多个操作要么全部成功，要么全部失败。以下是常见的实现方式及其示例：</p>
<h3 id="1-Entity-Framework-Core-事务（推荐）"><a href="#1-Entity-Framework-Core-事务（推荐）" class="headerlink" title="1. Entity Framework Core 事务（推荐）"></a><strong>1. Entity Framework Core 事务（推荐）</strong></h3><p><strong>方式 1：使用 <code>DbContext.Database.BeginTransaction()</code></strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> transaction = context.Database.BeginTransaction())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 操作 1：插入订单</span></span><br><span class="line">        context.Orders.Add(order);</span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 操作 2：更新库存</span></span><br><span class="line">        product.Stock -= order.Quantity;</span><br><span class="line">        context.Products.Update(product);</span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        transaction.Commit(); <span class="comment">// 提交事务</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        transaction.Rollback(); <span class="comment">// 回滚事务</span></span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方式 2：使用 <code>ExecutionStrategy</code>（自动重试）</strong></p>
<p>适用于分布式数据库（如 Azure SQL），支持瞬态错误重试：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strategy = context.Database.CreateExecutionStrategy();</span><br><span class="line"><span class="keyword">await</span> strategy.ExecuteAsync(<span class="keyword">async</span> () =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> transaction = context.Database.BeginTransaction())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> context.Orders.AddAsync(order);</span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        product.Stock -= order.Quantity;</span><br><span class="line">        context.Products.Update(product);</span><br><span class="line">        <span class="keyword">await</span> context.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        transaction.Commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-使用-TransactionScope（跨资源事务）"><a href="#2-使用-TransactionScope（跨资源事务）" class="headerlink" title="2. 使用 TransactionScope（跨资源事务）"></a><strong>2. 使用 <code>TransactionScope</code>（跨资源事务）</strong></h3><p>适用于跨多个数据库或外部服务的分布式事务（需启用 <code>MSDTC</code> 服务）：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = <span class="keyword">new</span> TransactionScope(TransactionScopeAsyncFlowOption.Enabled))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 操作 1：数据库 A</span></span><br><span class="line">        <span class="keyword">await</span> dbContextA.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 操作 2：数据库 B</span></span><br><span class="line">        <span class="keyword">await</span> dbContextB.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 操作 3：调用外部 API</span></span><br><span class="line">        <span class="keyword">await</span> httpClient.PostAsync(<span class="string">&quot;api/payment&quot;</span>, ...);</span><br><span class="line"></span><br><span class="line">        scope.Complete(); <span class="comment">// 标记事务成功</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 自动回滚（未调用 Complete()）</span></span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：SQLite 不支持分布式事务，SQL Server 需配置 MSDTC。</p>
</blockquote>
<h3 id="3-基于仓储模式的-Unit-of-Work（UoW）"><a href="#3-基于仓储模式的-Unit-of-Work（UoW）" class="headerlink" title="3. 基于仓储模式的 Unit of Work（UoW）"></a><strong>3. 基于仓储模式的 Unit of Work（UoW）</strong></h3><p>通过封装事务逻辑，统一管理多个仓储操作：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitOfWork</span> : <span class="title">IUnitOfWork</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> AppDbContext _context;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnitOfWork</span>(<span class="params">AppDbContext context</span>)</span> =&gt; _context = context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">CommitAsync</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> transaction = <span class="keyword">await</span> _context.Database.BeginTransactionAsync())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> _context.SaveChangesAsync();</span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IUnitOfWork _uow;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span>(<span class="params">IUnitOfWork uow</span>)</span> =&gt; _uow = uow;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">CreateOrderAsync</span>(<span class="params">Order order</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 操作多个仓储...</span></span><br><span class="line">        <span class="keyword">await</span> _orderRepository.AddAsync(order);</span><br><span class="line">        <span class="keyword">await</span> _inventoryRepository.UpdateStockAsync(...);</span><br><span class="line">        <span class="keyword">await</span> _uow.CommitAsync(); <span class="comment">// 统一提交事务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-显式-ADO-NET-事务"><a href="#4-显式-ADO-NET-事务" class="headerlink" title="4. 显式 ADO.NET 事务"></a><strong>4. 显式 ADO.NET 事务</strong></h3><p>直接使用 <code>SqlTransaction</code> 控制事务：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(connectionString))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> connection.OpenAsync();</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> transaction = connection.BeginTransaction())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 命令 1</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> cmd1 = <span class="keyword">new</span> SqlCommand(<span class="string">&quot;INSERT INTO Orders ...&quot;</span>, connection, transaction))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> cmd1.ExecuteNonQueryAsync();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 命令 2</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> cmd2 = <span class="keyword">new</span> SqlCommand(<span class="string">&quot;UPDATE Products SET Stock ...&quot;</span>, connection, transaction))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> cmd2.ExecuteNonQueryAsync();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-事务一致性形式总结"><a href="#5-事务一致性形式总结" class="headerlink" title="5.事务一致性形式总结"></a>5.<strong>事务一致性形式总结</strong></h3><table>
<thead>
<tr>
<th align="left"><strong>形式</strong></th>
<th align="left"><strong>适用场景</strong></th>
<th align="left"><strong>优点</strong></th>
<th align="left"><strong>缺点</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">EF Core 事务（<code>BeginTransaction</code>）</td>
<td align="left">单个数据库操作</td>
<td align="left">简单、与 EF Core 深度集成</td>
<td align="left">仅限单个 DbContext</td>
</tr>
<tr>
<td align="left"><code>TransactionScope</code></td>
<td align="left">跨数据库&#x2F;外部服务</td>
<td align="left">支持分布式事务</td>
<td align="left">需 MSDTC、性能开销大</td>
</tr>
<tr>
<td align="left">Unit of Work (UoW)</td>
<td align="left">领域驱动设计（DDD）、复杂业务逻辑</td>
<td align="left">高内聚、易测试</td>
<td align="left">需额外抽象层</td>
</tr>
<tr>
<td align="left">ADO.NET 显式事务</td>
<td align="left">原生 SQL 操作</td>
<td align="left">完全控制、高性能</td>
<td align="left">代码冗余、需手动管理连接</td>
</tr>
</tbody></table>
<h1 id="2、SetmealController"><a href="#2、SetmealController" class="headerlink" title="2、SetmealController"></a>2、SetmealController</h1><p>ProgramBackEnd\SkyServer\controller\admin\SetmealController.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.service;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.controller.admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐管理控制器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供套餐相关的CRUD操作API，包括新增、分页查询、删除、修改、查询详情和起售停售功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有操作都会记录日志，并返回统一格式的响应结果。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/setmeal&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">ApiExplorerSettings(GroupName = <span class="string">&quot;套餐相关接口&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISetmealService _setmealService;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;SetmealController&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealService&quot;&gt;</span>套餐服务接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志记录器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealController</span>(<span class="params">ISetmealService setmealService, ILogger&lt;SetmealController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _setmealService = setmealService ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealService));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDTO&quot;&gt;</span>套餐数据传输对象，包含套餐基本信息和关联菜品<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，成功时返回成功消息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回成功结果<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>参数错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Save([FromBody] SetmealDTO setmealDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始新增套餐: &#123;@SetmealDTO&#125;&quot;</span>, <span class="keyword">new</span> &#123; setmealDTO.Id, setmealDTO.Name, setmealDTO.Price, DishCount = setmealDTO.SetmealDishes?.Count ?? <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> _setmealService.SaveWithDish(setmealDTO);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;套餐新增成功: &#123;SetmealName&#125;&quot;</span>, setmealDTO.Name);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;套餐添加成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询套餐列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealPageQueryDTO&quot;&gt;</span>分页查询参数，包含页码、每页大小和筛选条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果，包含总记录数和当前页数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回查询结果<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;page&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;PageResult&gt;&gt; Page([FromQuery] SetmealPageQueryDTO setmealPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分页查询套餐: 第&#123;Page&#125;页，每页&#123;PageSize&#125;条&quot;</span>,</span><br><span class="line">                setmealPageQueryDTO.Page, setmealPageQueryDTO.PageSize);</span><br><span class="line"></span><br><span class="line">            PageResult pageResult = <span class="keyword">await</span> _setmealService.PageQuery(setmealPageQueryDTO);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;分页查询套餐完成: 共&#123;Total&#125;条记录&quot;</span>, pageResult.Total);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;PageResult&gt;.Success(pageResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量删除套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>套餐ID列表，多个ID用逗号分隔<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，成功时返回成功消息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回成功结果<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>参数错误或某些套餐不能删除<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpDelete</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Delete([FromQuery] <span class="built_in">string</span> ids)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 将逗号分隔的ID字符串解析为长整型列表</span></span><br><span class="line">            List&lt;<span class="built_in">long</span>&gt; idList = ids.Split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">                .Where(s =&gt; !<span class="built_in">string</span>.IsNullOrWhiteSpace(s))</span><br><span class="line">                .Select(s =&gt; <span class="built_in">long</span>.Parse(s.Trim()))</span><br><span class="line">                .ToList();</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始删除套餐，ID列表: &#123;IDs&#125;&quot;</span>, <span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, idList));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用服务层执行批量删除</span></span><br><span class="line">            <span class="keyword">await</span> _setmealService.DeleteBatch(idList);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;套餐删除成功，ID列表: &#123;IDs&#125;&quot;</span>, ids);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;套餐删除成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询套餐详情</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>套餐详情，包含基本信息和关联菜品<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回套餐详情<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>套餐不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;SetmealVO&gt;&gt; GetById([FromRoute] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;根据ID查询套餐: &#123;ID&#125;&quot;</span>, id);</span><br><span class="line"></span><br><span class="line">            SetmealVO setmealVO = <span class="keyword">await</span> _setmealService.GetByIdWithDish(id);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;查询套餐成功: &#123;ID&#125;, 名称: &#123;Name&#125;&quot;</span>, id, setmealVO.Name);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;SetmealVO&gt;.Success(setmealVO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 修改套餐信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDTO&quot;&gt;</span>套餐数据，包含要更新的信息和关联菜品<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，成功时返回成功消息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回成功结果<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>参数错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>套餐不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPut</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; Update([FromBody] SetmealDTO setmealDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始修改套餐，ID: &#123;ID&#125;, 名称: &#123;Name&#125;&quot;</span>, setmealDTO.Id, setmealDTO.Name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> _setmealService.Update(setmealDTO);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;套餐修改成功，ID: &#123;ID&#125;&quot;</span>, setmealDTO.Id);</span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;套餐修改成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐起售/停售状态管理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1表示起售，0表示停售<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果，成功时返回成功消息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;200&quot;&gt;</span>返回成功结果<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;400&quot;&gt;</span>状态值无效或套餐无法更改为指定状态<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;404&quot;&gt;</span>套餐不存在<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;response code=&quot;500&quot;&gt;</span>服务器内部错误<span class="doctag">&lt;/response&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;status/&#123;status&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; StartOrStop([FromRoute] <span class="built_in">int</span> status, [FromQuery] <span class="built_in">long</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;开始更新套餐状态，ID: &#123;ID&#125;, 状态: &#123;Status&#125;&quot;</span>, id, status == <span class="number">1</span> ? <span class="string">&quot;起售&quot;</span> : <span class="string">&quot;停售&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> _setmealService.StartOrStop(status, id);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> message = status == <span class="number">1</span> ? <span class="string">&quot;套餐起售成功&quot;</span> : <span class="string">&quot;套餐停售成功&quot;</span>;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;套餐状态更新成功，ID: &#123;ID&#125;, 状态: &#123;Status&#125;&quot;</span>, id, status == <span class="number">1</span> ? <span class="string">&quot;起售&quot;</span> : <span class="string">&quot;停售&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3、SetmealService"><a href="#3、SetmealService" class="headerlink" title="3、SetmealService"></a>3、SetmealService</h1><h2 id="1、ISetmealService"><a href="#1、ISetmealService" class="headerlink" title="1、ISetmealService"></a>1、ISetmealService</h2><p>ProgramBackEnd\SkyServer\service\ISetmealService.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐服务接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义套餐相关的核心业务逻辑操作，包括套餐的CRUD操作、</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态管理以及与菜品的关联处理。所有方法均采用异步设计。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISetmealService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量删除套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>要删除的套餐ID列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当套餐处于启用状态无法删除时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法会执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 验证所有套餐的状态，确保没有处于启用状态的套餐（启用状态套餐不允许删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 删除套餐基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 删除套餐与菜品的关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 整个过程在事务中执行，确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteBatch</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; ids</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询套餐及其包含的菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含套餐详情和关联菜品的视图对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span>当套餐不存在时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的视图对象包含：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐的基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐所属分类名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐包含的所有菜品列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;SetmealVO&gt; <span class="title">GetByIdWithDish</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealPageQueryDTO&quot;&gt;</span>分页查询参数，包含页码、每页大小和筛选条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>分页结果，包含总记录数和当前页数据集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 支持的筛选条件包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐名称（模糊匹配）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐分类（精确匹配）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐状态（精确匹配）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 结果默认按更新时间降序排序。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">SetmealPageQueryDTO setmealPageQueryDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增套餐及其关联的菜品</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDTO&quot;&gt;</span>套餐数据，包含套餐基本信息和关联菜品列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmealDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法会执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 保存套餐的基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 保存套餐与菜品的关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 整个过程在事务中执行，确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">SaveWithDish</span>(<span class="params">SetmealDTO setmealDTO</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 套餐起售/停售状态管理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>目标状态：1表示起售，0表示停售<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;BaseException&quot;&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 当套餐包含未启售菜品且尝试将套餐状态设置为起售时抛出</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 业务规则：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 当套餐状态更改为起售(1)时，会检查该套餐中所有菜品是否均为启用状态，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   若存在未启用的菜品，则不允许套餐起售</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 当套餐状态更改为停售(0)时，直接更新状态，无额外校验</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新套餐及其关联菜品信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDTO&quot;&gt;</span>套餐数据，包含更新后的套餐信息和关联菜品<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmealDTO为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法会执行以下操作：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 1. 更新套餐的基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 2. 删除原有的套餐菜品关联数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 3. 重新建立套餐与菜品的关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 整个过程在事务中执行，确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">SetmealDTO setmealDTO</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、SetmealServiceImpl"><a href="#2、SetmealServiceImpl" class="headerlink" title="2、SetmealServiceImpl"></a>2、SetmealServiceImpl</h2><p>ProgramBackEnd\SkyServer\service\Impl\SetmealServiceImpl.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.context;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.exception;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.utils;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.mapper;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.service.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐服务实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供套餐相关的业务逻辑实现，包括套餐的CRUD操作、状态管理以及与菜品的关联处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有数据库操作均采用异步方式，复杂操作使用事务确保数据一致性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 主要功能包括：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 套餐的新增、分页查询、修改、删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 套餐的启用/停用状态管理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 套餐与菜品关联关系的维护</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 业务规则验证（如：起售中的套餐不能删除，套餐起售前确保其包含的菜品全部为启用状态）</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealServiceImpl</span> : <span class="title">ISetmealService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISetmealMapper _setmealMapper;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ISetmealDishMapper _setmealDishMapper;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDishMapper _dishMapper;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化所需服务</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealMapper&quot;&gt;</span>套餐数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDishMapper&quot;&gt;</span>套餐菜品关系数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dishMapper&quot;&gt;</span>菜品数据访问接口<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>数据库上下文，用于事务管理<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当任何依赖项为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealServiceImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            ISetmealMapper setmealMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            ISetmealDishMapper setmealDishMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            IDishMapper dishMapper,</span></span></span><br><span class="line"><span class="params"><span class="function">            SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _setmealMapper = setmealMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealMapper));</span><br><span class="line">            _setmealDishMapper = setmealDishMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealDishMapper));</span><br><span class="line">            _dishMapper = dishMapper ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(dishMapper));</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteBatch</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; ids</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数校验 - 如果ID列表为空则直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (ids == <span class="literal">null</span> || ids.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用EF Core事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 第一步：检查所有套餐状态，确保没有正在启用的套餐</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="built_in">long</span> id <span class="keyword">in</span> ids)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 获取套餐信息</span></span><br><span class="line">                    Setmeal setmeal = <span class="keyword">await</span> _setmealMapper.GetById(id);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 业务规则：起售中的套餐不能删除</span></span><br><span class="line">                    <span class="keyword">if</span> (setmeal != <span class="literal">null</span> &amp;&amp; setmeal.Status == <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;起售中的套餐不能删除&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 第二步：执行删除操作，确保关联数据一并删除</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="built_in">long</span> setmealId <span class="keyword">in</span> ids)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 1. 删除套餐表中的主数据</span></span><br><span class="line">                    <span class="keyword">await</span> _setmealMapper.DeleteById(setmealId);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2. 删除套餐菜品关系表中的关联数据</span></span><br><span class="line">                    <span class="keyword">await</span> _setmealDishMapper.DeleteBySetmealId(setmealId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 发生异常时回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 业务异常直接抛出，技术异常包装后抛出</span></span><br><span class="line">                <span class="keyword">if</span> (ex <span class="keyword">is</span> BaseException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;批量删除套餐失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;SetmealVO&gt; <span class="title">GetByIdWithDish</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查询套餐基本信息</span></span><br><span class="line">                <span class="keyword">var</span> setmeal = <span class="keyword">await</span> _setmealMapper.GetById(id);</span><br><span class="line">                <span class="keyword">if</span> (setmeal == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">$&quot;套餐不存在：ID <span class="subst">&#123;id&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 创建返回的视图对象并复制套餐基本属性</span></span><br><span class="line">                SetmealVO setmealVO = <span class="keyword">new</span> SetmealVO();</span><br><span class="line">                PropertyUtil.CopyProperties(setmeal, setmealVO);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 查询套餐关联的菜品数据</span></span><br><span class="line">                <span class="keyword">var</span> setmealDishes = <span class="keyword">await</span> _skyDbContext.SetmealDishes</span><br><span class="line">                    .Where(sd =&gt; sd.SetmealId == id)</span><br><span class="line">                    .ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 设置关联的菜品数据</span></span><br><span class="line">                setmealVO.SetmealDishes = setmealDishes ?? <span class="keyword">new</span> List&lt;SetmealDish&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 查询并设置分类名称，增强数据展示</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.CategoryId &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> category = <span class="keyword">await</span> _skyDbContext.Categories.FindAsync(setmeal.CategoryId);</span><br><span class="line">                    <span class="keyword">if</span> (category != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        setmealVO.CategoryName = category.Name;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> setmealVO;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BaseException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 业务异常直接抛出</span></span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 技术异常包装后抛出</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;查询套餐详情失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PageResult&gt; <span class="title">PageQuery</span>(<span class="params">SetmealPageQueryDTO setmealPageQueryDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数校验</span></span><br><span class="line">            <span class="keyword">if</span> (setmealPageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealPageQueryDTO), <span class="string">&quot;分页查询参数不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从DTO中获取分页参数</span></span><br><span class="line">                <span class="built_in">int</span> page = setmealPageQueryDTO.Page;</span><br><span class="line">                <span class="built_in">int</span> pageSize = setmealPageQueryDTO.PageSize;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确保页码和每页记录数有效</span></span><br><span class="line">                <span class="keyword">if</span> (page &lt;= <span class="number">0</span>) page = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (pageSize &lt;= <span class="number">0</span>) pageSize = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用数据访问层执行分页查询</span></span><br><span class="line">                (<span class="built_in">long</span> total, List&lt;SetmealVO&gt; setmealVOList) = <span class="keyword">await</span> _setmealMapper.PageQuery(setmealPageQueryDTO);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 构造并返回分页结果</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PageResult(total, setmealVOList);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 包装异常信息并重新抛出</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;分页查询套餐数据失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SaveWithDish</span>(<span class="params">SetmealDTO setmealDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数校验</span></span><br><span class="line">            <span class="keyword">if</span> (setmealDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealDTO), <span class="string">&quot;套餐数据不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用EF Core事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 准备套餐实体对象</span></span><br><span class="line">                Setmeal setmeal = <span class="keyword">new</span> Setmeal();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 复制基本属性(从DTO到实体)</span></span><br><span class="line">                PropertyUtil.CopyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 设置创建和更新相关的审计字段</span></span><br><span class="line">                <span class="keyword">var</span> now = DateTime.Now;</span><br><span class="line">                <span class="built_in">long</span> userId = BaseContext.GetCurrentId() ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                setmeal.CreateTime = now;</span><br><span class="line">                setmeal.UpdateTime = now;</span><br><span class="line">                setmeal.CreateUser = userId;</span><br><span class="line">                setmeal.UpdateUser = userId;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 向套餐表插入数据</span></span><br><span class="line">                <span class="keyword">await</span> _setmealMapper.Insert(setmeal);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 获取生成的套餐ID（这个ID会在Insert操作后自动回填到setmeal对象）</span></span><br><span class="line">                <span class="built_in">long</span> setmealId = setmeal.Id;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 处理套餐菜品关联信息</span></span><br><span class="line">                <span class="keyword">if</span> (setmealDTO.SetmealDishes != <span class="literal">null</span> &amp;&amp; setmealDTO.SetmealDishes.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 为每个关联的菜品设置套餐ID</span></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> dish <span class="keyword">in</span> setmealDTO.SetmealDishes)</span><br><span class="line">                    &#123;</span><br><span class="line">                        dish.SetmealId = setmealId;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 批量保存套餐和菜品的关联关系</span></span><br><span class="line">                    <span class="keyword">await</span> _setmealDishMapper.InsertBatch(setmealDTO.SetmealDishes);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 7. 所有操作成功，提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 发生异常时回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重新抛出异常，保留原始异常信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;保存套餐失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">StartOrStop</span>(<span class="params"><span class="built_in">int</span> status, <span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数校验</span></span><br><span class="line">            <span class="keyword">if</span> (status != <span class="number">0</span> &amp;&amp; status != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;状态值必须为0(停售)或1(起售)&quot;</span>, <span class="keyword">nameof</span>(status));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用EF Core事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 业务规则：起售套餐时，需要判断套餐内是否有停售菜品，如果有则不允许起售</span></span><br><span class="line">                <span class="keyword">if</span> (status == <span class="number">1</span>) <span class="comment">// 1表示启用</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 1. 查询套餐中包含的所有菜品关联数据</span></span><br><span class="line">                    <span class="keyword">var</span> setmealDishes = <span class="keyword">await</span> _skyDbContext.SetmealDishes</span><br><span class="line">                        .Where(sd =&gt; sd.SetmealId == id)</span><br><span class="line">                        .ToListAsync();</span><br><span class="line">                        </span><br><span class="line">                    <span class="comment">// 2. 验证关联菜品是否都已启用</span></span><br><span class="line">                    <span class="keyword">if</span> (setmealDishes != <span class="literal">null</span> &amp;&amp; setmealDishes.Count &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 获取套餐中所有菜品ID</span></span><br><span class="line">                        <span class="keyword">var</span> dishIds = setmealDishes.Select(sd =&gt; sd.DishId).ToList();</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 查询这些菜品的状态</span></span><br><span class="line">                        <span class="keyword">var</span> dishes = <span class="keyword">await</span> _skyDbContext.Dishes</span><br><span class="line">                            .Where(d =&gt; dishIds.Contains(d.Id))</span><br><span class="line">                            .ToListAsync();</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 检查是否有停售的菜品</span></span><br><span class="line">                        <span class="keyword">foreach</span> (<span class="keyword">var</span> dish <span class="keyword">in</span> dishes)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (dish.Status == <span class="number">0</span>) <span class="comment">// 0表示菜品停售</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(<span class="string">&quot;套餐内包含未启售菜品，无法启售&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 创建更新对象，仅设置需要更新的字段</span></span><br><span class="line">                Setmeal setmeal = <span class="keyword">new</span> Setmeal</span><br><span class="line">                &#123;</span><br><span class="line">                    Id = id,</span><br><span class="line">                    Status = status,</span><br><span class="line">                    UpdateTime = DateTime.Now,</span><br><span class="line">                    UpdateUser = BaseContext.GetCurrentId() ?? <span class="number">0</span></span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 更新套餐状态</span></span><br><span class="line">                <span class="keyword">await</span> _setmealMapper.Update(setmeal);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 5. 提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (BaseException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 业务异常直接抛出</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 包装技术异常</span></span><br><span class="line">                <span class="built_in">string</span> action = status == <span class="number">1</span> ? <span class="string">&quot;起售&quot;</span> : <span class="string">&quot;停售&quot;</span>;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;套餐<span class="subst">&#123;action&#125;</span>失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">SetmealDTO setmealDTO</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数校验</span></span><br><span class="line">            <span class="keyword">if</span> (setmealDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealDTO), <span class="string">&quot;套餐数据不能为空&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setmealDTO.Id &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;套餐ID无效&quot;</span>, <span class="keyword">nameof</span>(setmealDTO));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用EF Core事务确保数据一致性</span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> transaction = <span class="keyword">await</span> _skyDbContext.Database.BeginTransactionAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 创建套餐实体并复制属性</span></span><br><span class="line">                Setmeal setmeal = <span class="keyword">new</span> Setmeal();</span><br><span class="line">                PropertyUtil.CopyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 设置更新时间和更新人</span></span><br><span class="line">                setmeal.UpdateTime = DateTime.Now;</span><br><span class="line">                setmeal.UpdateUser = BaseContext.GetCurrentId() ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 修改套餐表基本信息</span></span><br><span class="line">                <span class="keyword">await</span> _setmealMapper.Update(setmeal);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 获取套餐ID</span></span><br><span class="line">                <span class="built_in">long</span> setmealId = setmealDTO.Id;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 删除套餐和菜品的原有关联关系</span></span><br><span class="line">                <span class="keyword">await</span> _setmealDishMapper.DeleteBySetmealId(setmealId);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 重新建立套餐和菜品的关联关系</span></span><br><span class="line">                <span class="keyword">if</span> (setmealDTO.SetmealDishes != <span class="literal">null</span> &amp;&amp; setmealDTO.SetmealDishes.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 为每个菜品设置套餐ID</span></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> dish <span class="keyword">in</span> setmealDTO.SetmealDishes)</span><br><span class="line">                    &#123;</span><br><span class="line">                        dish.SetmealId = setmealId;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 批量插入新的关联关系</span></span><br><span class="line">                    <span class="keyword">await</span> _setmealDishMapper.InsertBatch(setmealDTO.SetmealDishes);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 7. 提交事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.CommitAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 发生异常时回滚事务</span></span><br><span class="line">                <span class="keyword">await</span> transaction.RollbackAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 重新抛出异常，根据类型提供适当的错误信息</span></span><br><span class="line">                <span class="keyword">if</span> (ex <span class="keyword">is</span> ArgumentException || ex <span class="keyword">is</span> ArgumentNullException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span>; <span class="comment">// 参数异常直接抛出</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;更新套餐失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="4、SetmealMapper"><a href="#4、SetmealMapper" class="headerlink" title="4、SetmealMapper"></a>4、SetmealMapper</h1><h2 id="1、ISetmealMapper"><a href="#1、ISetmealMapper" class="headerlink" title="1、ISetmealMapper"></a>1、ISetmealMapper</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义与套餐（Setmeal）相关的数据库操作，提供对setmeal表的基本访问功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口支持套餐数据的增删改查操作，是套餐管理功能的数据访问层基础。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐是由多个菜品组合而成的销售单元，具有自己的价格和状态。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口的实现应确保套餐数据的完整性和一致性，特别是在更新和删除操作中。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法均采用异步设计模式，以提高系统性能和响应能力。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISetmealMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据分类ID统计套餐数量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>分类ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定分类下的套餐数量<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法主要用于以下场景：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 在尝试删除分类前，检查该分类是否有关联的套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 统计各分类下的套餐分布情况</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 验证某分类是否可以进行特定操作</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID删除套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealId&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行物理删除操作，从数据库中永久移除指定套餐记录。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通常与删除套餐菜品关系表中的数据配合使用，以确保数据一致性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注意：调用此方法前应确认套餐状态为停售，以避免删除正在使用的套餐。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当删除操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> setmealId</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据ID查询套餐信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>套餐实体对象，若不存在则返回null<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于获取套餐的基本信息，不包含与之关联的菜品数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 常用于以下场景：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 检查套餐是否存在</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 获取套餐的状态、价格等基本信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 作为修改套餐前的数据准备</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐状态变更前的验证</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task&lt;Setmeal&gt; <span class="title">GetById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmeal&quot;&gt;</span>套餐实体对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于向数据库添加新的套餐记录，会自动获取并回填生成的主键ID。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 调用此方法前应确保已设置必要的字段（如名称、分类、价格等）和审计字段</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> （如创建时间、创建人等）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 新增套餐后，通常还需要添加套餐与菜品的关联关系数据。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmeal参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当插入操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Insert</span>(<span class="params">Setmeal setmeal</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询套餐</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealPageQueryDTO&quot;&gt;</span>分页查询参数，包含页码、每页大小和筛选条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含总记录数和当前页数据的元组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行套餐的分页查询，支持多条件筛选：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 可按套餐名称模糊匹配</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 可按分类ID精确匹配</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 可按套餐状态精确匹配</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询结果包含套餐基本信息和所属分类名称，默认按创建时间降序排列。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的元组中包含两部分数据：总记录数和当前页的套餐列表。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当查询参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当查询操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        Task&lt;(<span class="built_in">long</span> total, List&lt;SetmealVO&gt; setmealVOList)&gt; PageQuery(SetmealPageQueryDTO setmealPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新套餐信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmeal&quot;&gt;</span>包含要更新字段的套餐对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行选择性更新，只更新setmeal对象中非默认值的字段。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 常用场景包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 修改套餐基本信息（名称、价格、描述等）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐状态（启用/停用）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐图片</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 调用此方法前应确保已设置必要的审计字段（如UpdateTime、UpdateUser）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmeal参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当更新操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Update</span>(<span class="params">Setmeal setmeal</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2、SetmealMapperImpl"><a href="#2、SetmealMapperImpl" class="headerlink" title="2、SetmealMapperImpl"></a>2、SetmealMapperImpl</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.dto;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.vo;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现ISetmealMapper接口，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供对套餐（Setmeal）数据的完整CRUD操作支持。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类处理与setmeal表的直接交互，确保套餐数据的一致性和完整性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现了选择性字段更新策略，只更新显式设置了值的属性，避免不必要的数据库操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法均采用异步实现，遵循Entity Framework Core的最佳实践。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealMapperImpl</span> : <span class="title">ISetmealMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">CountByCategoryId</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 执行查询，计算指定分类下的套餐总数</span></span><br><span class="line">                <span class="built_in">int</span> total = <span class="keyword">await</span> _skyDbContext.Setmeals</span><br><span class="line">                    .Where(s =&gt; s.CategoryId == id)</span><br><span class="line">                    .CountAsync();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> total;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将数据库异常转换为更具体的应用异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;统计分类ID为<span class="subst">&#123;id&#125;</span>的套餐数量时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteById</span>(<span class="params"><span class="built_in">long</span> setmealId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 先查询再删除，确保实体存在并被正确跟踪</span></span><br><span class="line">                <span class="keyword">var</span> setmeal = <span class="keyword">await</span> _skyDbContext.Setmeals.FindAsync(setmealId);</span><br><span class="line">                <span class="keyword">if</span> (setmeal != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 从DbContext中移除实体</span></span><br><span class="line">                    _skyDbContext.Setmeals.Remove(setmeal);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 提交更改到数据库</span></span><br><span class="line">                    <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果实体不存在，不执行任何操作（与接口行为一致）</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换数据库异常，提供更详细的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;删除套餐(ID:<span class="subst">&#123;setmealId&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Setmeal&gt; <span class="title">GetById</span>(<span class="params"><span class="built_in">long</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用FindAsync方法根据主键查询单个实体</span></span><br><span class="line">                <span class="keyword">var</span> setmeal = <span class="keyword">await</span> _skyDbContext.Setmeals.FindAsync(id);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果找不到套餐，抛出异常提供明确的错误信息</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;未找到ID为<span class="subst">&#123;id&#125;</span>的套餐&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> setmeal;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (!(ex <span class="keyword">is</span> InvalidOperationException &amp;&amp; ex.Message.StartsWith(<span class="string">&quot;未找到ID&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 只包装技术异常，保留业务异常的原始信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;查询套餐(ID:<span class="subst">&#123;id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Insert</span>(<span class="params">Setmeal setmeal</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (setmeal == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmeal), <span class="string">&quot;套餐对象不能为null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将套餐实体添加到DbContext</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.Setmeals.AddAsync(setmeal);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存更改，EF Core会自动将生成的ID赋值回实体对象</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换数据库异常，提供更具体的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;添加套餐记录时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;(<span class="built_in">long</span> total, List&lt;SetmealVO&gt; setmealVOList)&gt; PageQuery(SetmealPageQueryDTO setmealPageQueryDTO)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (setmealPageQueryDTO == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealPageQueryDTO), <span class="string">&quot;查询参数不能为null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 构建基础查询 - 联结套餐表和分类表</span></span><br><span class="line">                <span class="keyword">var</span> query = <span class="keyword">from</span> s <span class="keyword">in</span> _skyDbContext.Setmeals</span><br><span class="line">                            <span class="keyword">join</span> c <span class="keyword">in</span> _skyDbContext.Categories</span><br><span class="line">                            <span class="keyword">on</span> s.CategoryId <span class="keyword">equals</span> c.Id <span class="keyword">into</span> categoryJoin</span><br><span class="line">                            <span class="keyword">from</span> category <span class="keyword">in</span> categoryJoin.DefaultIfEmpty() <span class="comment">// 左连接</span></span><br><span class="line">                            <span class="keyword">select</span> <span class="keyword">new</span> SetmealVO</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">// 套餐基本信息</span></span><br><span class="line">                                Id = s.Id,</span><br><span class="line">                                CategoryId = s.CategoryId,</span><br><span class="line">                                Name = s.Name,</span><br><span class="line">                                Price = s.Price,</span><br><span class="line">                                Status = s.Status,</span><br><span class="line">                                Description = s.Description,</span><br><span class="line">                                Image = s.Image,</span><br><span class="line">                                UpdateTime = s.UpdateTime,</span><br><span class="line">                                <span class="comment">// 分类名称</span></span><br><span class="line">                                CategoryName = category.Name</span><br><span class="line">                            &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 应用动态筛选条件</span></span><br><span class="line">                <span class="comment">// 2.1 名称条件 - 模糊匹配，确保处理null值</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(setmealPageQueryDTO.Name))</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(s =&gt; s.Name != <span class="literal">null</span> &amp;&amp; s.Name.Contains(setmealPageQueryDTO.Name));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.2 状态条件 - 精确匹配</span></span><br><span class="line">                <span class="keyword">if</span> (setmealPageQueryDTO.Status.HasValue)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(s =&gt; s.Status == setmealPageQueryDTO.Status.Value);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.3 分类ID条件 - 精确匹配，忽略无效值</span></span><br><span class="line">                <span class="keyword">if</span> (setmealPageQueryDTO.CategoryId.HasValue &amp;&amp; setmealPageQueryDTO.CategoryId.Value &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    query = query.Where(s =&gt; s.CategoryId == setmealPageQueryDTO.CategoryId.Value);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 应用排序 - 按更新时间降序</span></span><br><span class="line">                query = query.OrderByDescending(s =&gt; s.UpdateTime);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4. 执行查询获取总记录数</span></span><br><span class="line">                <span class="built_in">long</span> total = <span class="keyword">await</span> query.CountAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 5. 执行分页查询获取当前页数据</span></span><br><span class="line">                <span class="comment">// 确保页码和每页大小的有效性</span></span><br><span class="line">                <span class="built_in">int</span> page = Math.Max(<span class="number">1</span>, setmealPageQueryDTO.Page);</span><br><span class="line">                <span class="built_in">int</span> pageSize = Math.Max(<span class="number">1</span>, setmealPageQueryDTO.PageSize);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算分页边界并执行查询</span></span><br><span class="line">                List&lt;SetmealVO&gt; setmealVOList = <span class="keyword">await</span> query</span><br><span class="line">                    .Skip((page - <span class="number">1</span>) * pageSize)</span><br><span class="line">                    .Take(pageSize)</span><br><span class="line">                    .ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 6. 返回结果元组：总记录数和当前页数据列表</span></span><br><span class="line">                <span class="keyword">return</span> (total, setmealVOList);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换为应用异常并提供详细的错误上下文</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;分页查询套餐信息失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Update</span>(<span class="params">Setmeal setmeal</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (setmeal == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmeal), <span class="string">&quot;套餐对象不能为null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查找数据库中已存在的套餐记录</span></span><br><span class="line">                <span class="keyword">var</span> existingSetmeal = <span class="keyword">await</span> _skyDbContext.Setmeals.FindAsync(setmeal.Id);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果找不到套餐，抛出业务异常</span></span><br><span class="line">                <span class="keyword">if</span> (existingSetmeal == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">$&quot;未找到ID为<span class="subst">&#123;setmeal.Id&#125;</span>的套餐&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 选择性更新属性（只更新非默认值）</span></span><br><span class="line">                <span class="comment">// 2.1 更新文本类属性（只在非null时更新）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Name != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Name = setmeal.Name;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Description != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Description = setmeal.Description;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Image != <span class="literal">null</span>)</span><br><span class="line">                    existingSetmeal.Image = setmeal.Image;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 2.2 更新数值类属性（只在非默认值时更新）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.CategoryId != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.CategoryId = setmeal.CategoryId;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Price != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.Price = setmeal.Price;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.3 更新可空类型属性（只在有值时更新）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.Status.HasValue)</span><br><span class="line">                    existingSetmeal.Status = setmeal.Status;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.4 更新审计字段（只在有效值时更新）</span></span><br><span class="line">                <span class="keyword">if</span> (setmeal.UpdateTime != <span class="literal">default</span>)</span><br><span class="line">                    existingSetmeal.UpdateTime = setmeal.UpdateTime;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (setmeal.UpdateUser != <span class="number">0</span>)</span><br><span class="line">                    existingSetmeal.UpdateUser = setmeal.UpdateUser;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 保存所有更改到数据库</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex) <span class="keyword">when</span> (!(ex <span class="keyword">is</span> InvalidOperationException &amp;&amp; ex.Message.StartsWith(<span class="string">&quot;未找到ID&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 捕获并转换数据库异常，但保留&quot;套餐不存在&quot;类型的业务异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;更新套餐(ID:<span class="subst">&#123;setmeal.Id&#125;</span>)时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="5、SetmealDishMapper"><a href="#5、SetmealDishMapper" class="headerlink" title="5、SetmealDishMapper"></a>5、SetmealDishMapper</h1><h2 id="1、ISetmealDishMapper"><a href="#1、ISetmealDishMapper" class="headerlink" title="1、ISetmealDishMapper"></a>1、ISetmealDishMapper</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐菜品关系数据访问接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义套餐与菜品之间关联关系的数据访问操作。此接口主要负责维护</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> setmeal_dish表的数据，实现套餐和菜品之间多对多关系的增删改查。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐（Setmeal）通常由多个菜品（Dish）组成，而同一个菜品也可以出现在多个套餐中，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 形成多对多的关系。此接口提供了维护这种关系的核心操作：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 批量新增套餐菜品关系</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 根据套餐ID删除关联关系</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 根据菜品ID查询关联的套餐</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此接口的实现应确保数据一致性，特别是在批量操作和删除操作中。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法均采用异步设计模式，提高系统的并发处理能力。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISetmealDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据套餐ID删除套餐和菜品的关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealId&quot;&gt;</span>套餐ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于以下场景：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 删除套餐时，需要同时删除其关联的菜品关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐内容时，先删除旧关系，再建立新关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 套餐数据清理和维护</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 执行物理删除，将从数据库中彻底移除记录，不可恢复。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当删除操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">DeleteBySetmealId</span>(<span class="params"><span class="built_in">long</span> setmealId</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 根据菜品ID集合查询关联的套餐ID集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ids&quot;&gt;</span>菜品ID集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>包含这些菜品的套餐ID集合（已去重）<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于确定哪些套餐包含了指定的菜品。典型用例包括：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 检查菜品是否可以删除（若被套餐引用则不可删除）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 当菜品状态变更时，同步更新相关套餐的状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 分析菜品的使用情况，如查询某菜品被多少套餐引用</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回的套餐ID列表是去重后的结果，即使一个套餐包含了多个查询菜品，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 该套餐ID也只会在结果中出现一次。如果没有套餐包含这些菜品，将返回空列表。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当ids参数为null时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当数据库操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        Task&lt;List&lt;<span class="built_in">long</span>&gt;&gt; GetSetmealIdsByDishIds(List&lt;<span class="built_in">long</span>&gt; ids);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 批量插入套餐菜品关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;setmealDishes&quot;&gt;</span>套餐菜品关系对象集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法用于以下场景：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 创建新套餐时，建立套餐与多个菜品的关联</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - 更新套餐时，重建套餐与菜品的关联关系</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 调用此方法前，应确保集合中的每个对象都已正确设置以下属性：</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - SetmealId：套餐ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - DishId：菜品ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Name：菜品名称（可选，但推荐设置以便于查询显示）</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Price：菜品价格</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> - Copies：菜品份数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此方法执行批量插入操作，相比多次单条插入具有更高的性能。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当setmealDishes参数为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;InvalidOperationException&quot;&gt;</span>当插入操作失败时可能抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">InsertBatch</span>(<span class="params">List&lt;SetmealDish&gt; setmealDishes</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、SetmealDishMapperImpl"><a href="#2、SetmealDishMapperImpl" class="headerlink" title="2、SetmealDishMapperImpl"></a>2、SetmealDishMapperImpl</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyPojo.entity;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyServer.config;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.mapper.Impl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 套餐菜品关系数据访问实现类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于Entity Framework Core实现ISetmealDishMapper接口，</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供套餐与菜品关联关系的完整数据访问操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/para&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此类负责维护setmeal_dish表的数据访问，处理套餐和菜品之间的多对多关系。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 支持的主要功能包括：</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 根据套餐ID删除关联关系记录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 根据菜品ID查询关联的套餐</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> - 批量插入套餐菜品关系</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有方法均采用异步实现，并提供完整的异常处理，确保数据操作的可靠性。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SetmealDishMapperImpl</span> : <span class="title">ISetmealDishMapper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> SkyDbContext _skyDbContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，通过依赖注入初始化数据库上下文</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;skyDbContext&quot;&gt;</span>应用程序数据库上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ArgumentNullException&quot;&gt;</span>当数据库上下文为null时抛出<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SetmealDishMapperImpl</span>(<span class="params">SkyDbContext skyDbContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _skyDbContext = skyDbContext ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(skyDbContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteBySetmealId</span>(<span class="params"><span class="built_in">long</span> setmealId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 查找与指定套餐ID关联的所有记录</span></span><br><span class="line">                <span class="keyword">var</span> relationsToDelete = <span class="keyword">await</span> _skyDbContext.SetmealDishes</span><br><span class="line">                    .Where(sd =&gt; sd.SetmealId == setmealId)</span><br><span class="line">                    .ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 检查是否找到了关联记录</span></span><br><span class="line">                <span class="keyword">if</span> (relationsToDelete.Any())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 3. 批量删除这些关系记录（比单条删除更高效）</span></span><br><span class="line">                    _skyDbContext.SetmealDishes.RemoveRange(relationsToDelete);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 4. 提交更改到数据库</span></span><br><span class="line">                    <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果没有找到关联记录，则不执行任何操作，静默完成</span></span><br><span class="line">                <span class="comment">// 这符合&quot;幂等性&quot;原则，多次调用得到相同结果</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (DbUpdateException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 数据库更新异常，提供更具体的错误上下文</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;删除套餐(ID:<span class="subst">&#123;setmealId&#125;</span>)的关联菜品时发生数据库错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 其他类型的异常，转换为应用异常并保留原始信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;删除套餐(ID:<span class="subst">&#123;setmealId&#125;</span>)和菜品的关联关系时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;<span class="built_in">long</span>&gt;&gt; GetSetmealIdsByDishIds(List&lt;<span class="built_in">long</span>&gt; ids)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证：如果为空或无元素，直接返回空列表</span></span><br><span class="line">            <span class="keyword">if</span> (ids == <span class="literal">null</span> || ids.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 构建查询 - 找出包含指定菜品的所有套餐ID</span></span><br><span class="line">                <span class="comment">// 相当于SQL: SELECT DISTINCT setmeal_id FROM setmeal_dish WHERE dish_id IN (...)</span></span><br><span class="line">                <span class="keyword">var</span> query = _skyDbContext.SetmealDishes</span><br><span class="line">                    .Where(sd =&gt; ids.Contains(sd.DishId))  <span class="comment">// 筛选包含指定菜品的记录</span></span><br><span class="line">                    .Select(sd =&gt; sd.SetmealId)            <span class="comment">// 提取套餐ID</span></span><br><span class="line">                    .Distinct();                           <span class="comment">// 去除重复记录</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 执行查询并将结果转换为列表</span></span><br><span class="line">                <span class="keyword">var</span> setmealIds = <span class="keyword">await</span> query.ToListAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 返回结果（即使为空列表也是有效返回值）</span></span><br><span class="line">                <span class="keyword">return</span> setmealIds;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 转换为应用异常并提供详细的错误上下文</span></span><br><span class="line">                <span class="built_in">string</span> idList = <span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;查询包含指定菜品(IDs:<span class="subst">&#123;idList&#125;</span>)的套餐时发生错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;inheritdoc/&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InsertBatch</span>(<span class="params">List&lt;SetmealDish&gt; setmealDishes</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 参数验证</span></span><br><span class="line">            <span class="keyword">if</span> (setmealDishes == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(setmealDishes), <span class="string">&quot;套餐菜品关系集合不能为null&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 空集合检查 - 提前返回避免不必要的数据库操作</span></span><br><span class="line">            <span class="keyword">if</span> (setmealDishes.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 1. 使用AddRangeAsync批量添加实体（性能优于逐个添加）</span></span><br><span class="line">                <span class="keyword">await</span> _skyDbContext.SetmealDishes.AddRangeAsync(setmealDishes);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. 一次性保存所有更改到数据库</span></span><br><span class="line">                <span class="built_in">int</span> affectedRows = <span class="keyword">await</span> _skyDbContext.SaveChangesAsync();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 3. 验证操作结果（可选，但有助于及早发现问题）</span></span><br><span class="line">                <span class="keyword">if</span> (affectedRows != setmealDishes.Count)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 记录警告日志（若有日志系统）或进行其他适当处理</span></span><br><span class="line">                    <span class="comment">// 这里我们选择不抛出异常，因为部分成功也是可接受的</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (DbUpdateException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 数据库更新异常，提供更具体的错误信息</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;批量插入套餐菜品关系时发生数据库错误: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 其他异常，转换为应用异常并提供上下文</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(</span><br><span class="line">                    <span class="string">$&quot;批量插入<span class="subst">&#123;setmealDishes.Count&#125;</span>条套餐菜品关系数据失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6、结果展示"><a href="#6、结果展示" class="headerlink" title="6、结果展示"></a>6、结果展示</h1><h2 id="1、增"><a href="#1、增" class="headerlink" title="1、增"></a>1、增</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605150728134.png" alt="image-20250605150728134"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605150736036.png" alt="image-20250605150736036"></p>
<h2 id="2、改"><a href="#2、改" class="headerlink" title="2、改"></a>2、改</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605150752851.png" alt="image-20250605150752851"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605150850902.png" alt="image-20250605150850902"></p>
<h2 id="3、查"><a href="#3、查" class="headerlink" title="3、查"></a>3、查</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605150917726.png" alt="image-20250605150917726"></p>
<h2 id="4、删"><a href="#4、删" class="headerlink" title="4、删"></a>4、删</h2><p><img src="/2023/12/08/CPlusPlus02/mage-20250605150932235.png" alt="image-20250605150932235"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605150942622.png" alt="image-20250605150942622"></p>
<h1 id="6、店铺状态设定"><a href="#6、店铺状态设定" class="headerlink" title="6、店铺状态设定"></a>6、店铺状态设定</h1><p>设定店铺状态通过Redis实现</p>
<h2 id="1、ShopController"><a href="#1、ShopController" class="headerlink" title="1、ShopController"></a>1、ShopController</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Caching.Distributed;</span><br><span class="line"><span class="keyword">using</span> ProgramBackEnd.SkyCommon.result;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Text.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ProgramBackEnd.SkyServer.controller.admin</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 店铺相关接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/admin/shop&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    [<span class="meta">ApiExplorerSettings(GroupName = <span class="string">&quot;店铺相关接口&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShopController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> KEY = <span class="string">&quot;SHOP_STATUS&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDistributedCache _cache;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;ShopController&gt; _logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cache&quot;&gt;</span>分布式缓存服务<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logger&quot;&gt;</span>日志服务<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ShopController</span>(<span class="params">IDistributedCache cache, ILogger&lt;ShopController&gt; logger</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _cache = cache ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(cache));</span><br><span class="line">            _logger = logger ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(logger));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 设置店铺的营业状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;status&quot;&gt;</span>状态值：1表示营业中，0表示打烊中<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>操作结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPut(<span class="string">&quot;&#123;status&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">string</span>&gt;&gt; SetStatus([FromRoute] <span class="built_in">int</span> status)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;设置店铺的营业状态为：&#123;Status&#125;&quot;</span>, status == <span class="number">1</span> ? <span class="string">&quot;营业中&quot;</span> : <span class="string">&quot;打烊中&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将整数值转换为字节数组存储</span></span><br><span class="line">            <span class="keyword">await</span> _cache.SetStringAsync(KEY, status.ToString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">string</span>&gt;.Success(<span class="string">&quot;设置店铺营业状态成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取店铺的营业状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>店铺状态：1表示营业中，0表示打烊中<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;status&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Result&lt;<span class="built_in">int</span>&gt;&gt; GetStatus()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从缓存中获取状态</span></span><br><span class="line">            <span class="built_in">string</span> <span class="keyword">value</span> = <span class="keyword">await</span> _cache.GetStringAsync(KEY);</span><br><span class="line">            <span class="built_in">int</span> status = <span class="built_in">string</span>.IsNullOrEmpty(<span class="keyword">value</span>) ? <span class="number">0</span> : <span class="built_in">int</span>.Parse(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;获取到店铺的营业状态为：&#123;Status&#125;&quot;</span>, status == <span class="number">1</span> ? <span class="string">&quot;营业中&quot;</span> : <span class="string">&quot;打烊中&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result&lt;<span class="built_in">int</span>&gt;.Success(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/12/08/CPlusPlus02/mage-20250605151604667.png" alt="image-20250605151604667"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605151631367.png" alt="image-20250605151631367"></p>
<p><img src="/2023/12/08/CPlusPlus02/mage-20250605151644776.png" alt="image-20250605151644776"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alsl521.github.io">kyl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alsl521.github.io/2025/06/05/NET-ASP-17/">https://alsl521.github.io/2025/06/05/NET-ASP-17/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://alsl521.github.io" target="_blank">kyl的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post-share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">NET-ASP-16-实战-Day03</div></div><div class="info-2"><div class="info-item-1">1、部署Redis首先搜寻并拉取Redis  随后输入如下代码运行Redis 1docker run -p 6379:6379 -d redis:latest redis-server  随后在下面的页面配置密码  通过输入 123redis-cliconfig set requirepass [mypassword]config get requirepass  设定、查看密码  2、部署Minio首先拉取Minio  随后输入 1docker run -d -p 9000:9000 -p 9090:9090 --name minio --restart=always -e &quot;MINIO_BROWSER_REDIRECT_URL=http://localhost:9000&quot; -e &quot;MINIO_ROOT_USER=minioadmin&quot; -e &quot;MINIO_ROOT_PASSWORD=minioadmin&quot; minio/minio:RELEASE.2024-09-13T20-26-02Z server /data...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/08/NET-ASP-01/" title="ASP.NET学习记录-01-基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-01-基础知识</div></div><div class="info-2"><div class="info-item-1">视频教程为：ASP.NET Core Deep-Dive in .NET 9 | Udemy 1、.NET Core.NET Core 是微软开发的开源、跨平台应用程序开发框架，旨在为现代云原生、微服务及高性能场景提供支持。以下是其核心特性与定位的详细说明：  一、核心定义与定位 跨平台支持 .NET Core 可在 Windows、Linux、macOS 等操作系统上运行，并支持 x86、x64、ARM 等多种架构。 这种跨平台能力使其成为开发云原生、容器化应用（如 Docker）的理想选择。  开源与社区驱动 作为 MIT 协议下的开源项目，.NET Core 的代码托管于 GitHub，接受社区贡献，确保了技术透明度和快速迭代。    二、架构与技术特性 模块化设计 采用包化（Packages）管理，开发者可按需引用组件，减少应用体积，与传统的 .NET Framework 打包式安装形成对比。例如，通过 1dotnet restore  命令可动态还原依赖的 NuGet 包。  高性能运行时  RyuJIT 编译器：相比传统 JIT，性能提升约 25%，支持 SIMD...</div></div></div></a><a class="pagination-related" href="/2025/04/08/NET-ASP-02/" title="ASP.NET学习记录-02-最小API模式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">ASP.NET学习记录-02-最小API模式</div></div><div class="info-2"><div class="info-item-1">1、创建第一个ASP.NET应用（Minimal API）1.创建新项目 选择新的空项目  设定基本信息  使用最新版.NET作为学习内容  2.项目架构简介与解析 1. 解决方案（Solution） 名称：MyFirstWebApplication 作用： 作为容器管理多个相关项目（当前仅包含一个项目 WebApplication）。 支持团队协作和复杂应用的模块化开发（如Web API、类库、单元测试等）。   关键点： 可通过解决方案配置统一管理所有项目的依赖和环境设置。   新增项目 右键单击解决方案-&gt;添加-&gt;新建项目      2. 项目（Project: WebApplication） 核心结构：包含构建和运行Web应用所需的所有文件与配置，分为以下关键部分：  a. Connected Services 文件夹 作用： 存储与外部服务的连接配置（如数据库、Azure服务、第三方API）。 通过右键添加服务（如Entity Framework、Azure认证），自动生成连接配置文件。   示例：添加Azure...</div></div></div></a><a class="pagination-related" href="/2025/04/09/NET-ASP-03/" title="ASP.NET学习记录-03-中间件管道"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-09</div><div class="info-item-2">ASP.NET学习记录-03-中间件管道</div></div><div class="info-2"><div class="info-item-1">1、中间件管道简介在 C# ASP.NET Core 中，中间件管道是处理 HTTP 请求和响应的核心机制，通过将多个中间件按顺序串联成一个处理流程，实现灵活的请求处理和业务逻辑组合。以下是其核心要点：  1. 中间件管道的基本概念 中间件（Middleware）：是管道中的独立组件，负责处理 HTTP 请求和响应。每个中间件可以：  对请求进行预处理（如日志、身份验证）。  调用下一个中间件（通过 next()），或直接终止处理（短路）。  对响应进行后处理（如修改响应头、记录耗时）。      管道（Pipeline）：由多个中间件按注册顺序串联而成，形成一个“请求→处理→响应”的流程。请求按顺序经过所有中间件，而响应则逆序返回  。    2. 管道的工作模式：1-n 然后 n-1 请求阶段（正向传递）：请求从第一个中间件开始，依次传递至最后一个中间件（终结点），形成“1→2→3”的顺序 。  响应阶段（逆向返回）：处理完成后，响应从终结点开始，逆序返回至第一个中间件，形成“3→2→1”的顺序  。 示例 123Middleware One: Request Start...</div></div></div></a><a class="pagination-related" href="/2025/04/10/NET-ASP-04/" title="ASP.NET学习记录-04-路由"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-10</div><div class="info-item-2">ASP.NET学习记录-04-路由</div></div><div class="info-2"><div class="info-item-1">1、Routing和Endpoints简介在ASP.NET Core中，**路由（Routing）和终结点（Endpoints）**是处理HTTP请求的核心机制，它们共同构成了请求分发的管道系统。以下是对两者的详细介绍：  一、路由（Routing）路由的核心作用是将传入的HTTP请求根据URL路径和HTTP方法匹配到对应的处理逻辑（终结点）。在ASP.NET Core中，路由系统被称为终结点路由（Endpoint Routing）。 主要功能与工作流程 匹配请求：通过UseRouting中间件（即EndpointRoutingMiddleware）扫描应用中所有注册的终结点，根据请求的URL和HTTP方法选择最匹配的终结点 。示例代码：  12345app.UseRouting();app.UseEndpoints(endpoints =&gt; &#123;    endpoints.MapGet(&quot;/&quot;, async context =&gt; &#123; ......</div></div></div></a><a class="pagination-related" href="/2025/04/11/NET-ASP-05/" title="ASP.NET学习记录-05-模型数据绑定"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">ASP.NET学习记录-05-模型数据绑定</div></div><div class="info-2"><div class="info-item-1">1、模型绑定定义模型绑定是ASP.NET Core中将HTTP请求数据自动映射到方法参数或对象属性的机制。其核心工作流程：  数据来源：  路由参数（URL片段） 查询字符串（?key&#x3D;value） 请求体（表单&#x2F;JSON&#x2F;XML） 请求头 文件上传   典型应用：   12345678910111213// 自动绑定路由参数和查询参数[HttpGet(&quot;/products/&#123;id&#125;&quot;)]public IActionResult GetProduct(int id, [FromQuery] string category) &#123;    // id来自路由参数，category来自查询字符串&#125;// 自动绑定JSON请求体[HttpPost]public IActionResult Create([FromBody] Product product)&#123;    //...</div></div></div></a><a class="pagination-related" href="/2025/04/15/NET-ASP-09/" title="ASP.NET学习记录-09-MVC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="info-item-2">ASP.NET学习记录-09-MVC</div></div><div class="info-2"><div class="info-item-1">1、MVC PatternASP.NET中的MVC（Model-View-Controller）模式是一种软件架构设计模式，它将应用程序分为三个核心组件：模型（Model）、视图（View）和控制器（Controller），以实现关注点分离，提升代码可维护性和可扩展性。  以下是其具体内涵及在ASP.NET中的应用特点： 1....</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/61216968?s=400&amp;u=d5b61cbc7946e6309e4318dabc2d459a18e0fe55&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kyl</div><div class="author-info-description">用于记录平时学习的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/alsl521" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:852970167@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">1、事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Entity-Framework-Core-%E4%BA%8B%E5%8A%A1%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. Entity Framework Core 事务（推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-TransactionScope%EF%BC%88%E8%B7%A8%E8%B5%84%E6%BA%90%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. 使用 TransactionScope（跨资源事务）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8E%E4%BB%93%E5%82%A8%E6%A8%A1%E5%BC%8F%E7%9A%84-Unit-of-Work%EF%BC%88UoW%EF%BC%89"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. 基于仓储模式的 Unit of Work（UoW）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%98%BE%E5%BC%8F-ADO-NET-%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. 显式 ADO.NET 事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BA%8B%E5%8A%A1%E4%B8%80%E8%87%B4%E6%80%A7%E5%BD%A2%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="toc-number">1.0.5.</span> <span class="toc-text">5.事务一致性形式总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81SetmealController"><span class="toc-number">2.</span> <span class="toc-text">2、SetmealController</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81SetmealService"><span class="toc-number">3.</span> <span class="toc-text">3、SetmealService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ISetmealService"><span class="toc-number">3.1.</span> <span class="toc-text">1、ISetmealService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81SetmealServiceImpl"><span class="toc-number">3.2.</span> <span class="toc-text">2、SetmealServiceImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81SetmealMapper"><span class="toc-number">4.</span> <span class="toc-text">4、SetmealMapper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ISetmealMapper"><span class="toc-number">4.1.</span> <span class="toc-text">1、ISetmealMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81SetmealMapperImpl"><span class="toc-number">4.2.</span> <span class="toc-text">2、SetmealMapperImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81SetmealDishMapper"><span class="toc-number">5.</span> <span class="toc-text">5、SetmealDishMapper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ISetmealDishMapper"><span class="toc-number">5.1.</span> <span class="toc-text">1、ISetmealDishMapper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81SetmealDishMapperImpl"><span class="toc-number">5.2.</span> <span class="toc-text">2、SetmealDishMapperImpl</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">6.</span> <span class="toc-text">6、结果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%A2%9E"><span class="toc-number">6.1.</span> <span class="toc-text">1、增</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%94%B9"><span class="toc-number">6.2.</span> <span class="toc-text">2、改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%9F%A5"><span class="toc-number">6.3.</span> <span class="toc-text">3、查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%A0"><span class="toc-number">6.4.</span> <span class="toc-text">4、删</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81%E5%BA%97%E9%93%BA%E7%8A%B6%E6%80%81%E8%AE%BE%E5%AE%9A"><span class="toc-number">7.</span> <span class="toc-text">6、店铺状态设定</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ShopController"><span class="toc-number">7.1.</span> <span class="toc-text">1、ShopController</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/05/NET-ASP-17/" title="NET-ASP-17-实战-Day04">NET-ASP-17-实战-Day04</a><time datetime="2025-06-05T01:57:52.000Z" title="发表于 2025-06-05 09:57:52">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/28/NET-ASP-16/" title="NET-ASP-16-实战-Day03">NET-ASP-16-实战-Day03</a><time datetime="2025-05-28T02:57:23.000Z" title="发表于 2025-05-28 10:57:23">2025-05-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/26/NET-ASP-15/" title="ASP.NET学习记录-15-实战-Day02">ASP.NET学习记录-15-实战-Day02</a><time datetime="2025-05-26T11:25:36.000Z" title="发表于 2025-05-26 19:25:36">2025-05-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/25/NET-ASP-14/" title="ASP.NET学习记录-14-实战-Day01">ASP.NET学习记录-14-实战-Day01</a><time datetime="2025-05-25T12:02:17.000Z" title="发表于 2025-05-25 20:02:17">2025-05-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/NET-ASP-13/" title="ASP.NET学习记录-13-实践2-数据库进阶">ASP.NET学习记录-13-实践2-数据库进阶</a><time datetime="2025-04-21T08:39:19.000Z" title="发表于 2025-04-21 16:39:19">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By kyl</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>